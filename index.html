<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v5.1ï¼ˆæ•£å‰¤ãƒ¢ãƒ¼ãƒ‰æ”¹å–„ï¼‰</title>
<style>
*{box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;margin:0;padding:16px;background:#fafafa}
h1{margin:0 0 12px;font-size:18px}
.card{background:#fff;border:1px solid #e5e5ea;border-radius:12px;padding:12px;margin:12px 0;box-shadow:0 1px 3px rgba(0,0,0,0.05)}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1 1 240px;min-width:240px}
input,select,button,textarea{width:100%;padding:10px;border:1px solid #d0d0d0;border-radius:10px;background:#fff;font-size:16px;transition:all 0.2s}
input:focus,select:focus{outline:none;border-color:#0a84ff;box-shadow:0 0 0 3px rgba(10,132,255,0.1)}
button{background:#0a84ff;color:#fff;border:0;cursor:pointer;font-weight:500}
button:hover{background:#0970d9}
button:active{transform:scale(0.98)}
button.secondary{background:#f2f2f7;color:#111;border:1px solid #d0d0d0}
button.secondary:hover{background:#e5e5ea}
button.danger{background:#ff3b30}
button.danger:hover{background:#e5342b}
button.ghost{background:#fff;color:#0a84ff;border:1px solid #bcd6ff}
button.ghost:hover{background:#f0f7ff}
.drug-row{border:1px dashed #d0d0d0;border-radius:10px;padding:10px;margin:10px 0;background:#fafbfc}
.drug-row:hover{background:#f5f7fa}
.drug-group{border:2px solid #0a84ff;border-radius:12px;padding:12px;margin:12px 0;background:#f0f7ff}
.drug-group-header{font-weight:600;color:#0a84ff;margin-bottom:8px}
pre.readonly{white-space:pre-wrap;background:#fcfcfd;border:1px solid #eee;border-radius:10px;padding:10px;min-height:100px;font-family:ui-monospace,Menlo,monospace;line-height:1.5}
.input-wrap{position:relative}

/* ã‚µã‚¸ã‚§ã‚¹ãƒˆ */
.suggest{position:absolute;z-index:9999;background:#fff;border:1px solid #d0d0d0;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.15);overflow:auto;max-height:220px;display:none;top:100%;left:0;right:0;margin-top:2px}
.suggest-item{padding:8px 12px;cursor:pointer;border-bottom:1px solid #f0f0f0}
.suggest-item:last-child{border-bottom:none}
.suggest-item:hover,.suggest-item.active{background:#eef5ff}

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
.status{padding:8px 12px;border-radius:8px;background:#e8f4fd;color:#0a84ff;font-size:14px;margin-top:8px}
.status.success{background:#d4f4dd;color:#34c759}
.status.error{background:#ffe5e5;color:#ff3b30}
.status.warning{background:#fff3cd;color:#ff9500}

/* ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¨ãƒªã‚¢ */
.file-upload-area{border:2px dashed #d0d0d0;border-radius:10px;padding:20px;text-align:center;transition:all 0.3s;cursor:pointer;background:#fafbfc}
.file-upload-area:hover{border-color:#0a84ff;background:#f0f7ff}
.file-upload-area.dragover{border-color:#0a84ff;background:#e8f4fd}
.file-input-hidden{display:none}
.file-upload-btn{display:inline-block;padding:8px 20px;background:#0a84ff;color:white;border-radius:8px;cursor:pointer;font-weight:500;margin-bottom:8px}
.file-upload-btn:hover{background:#0970d9}
.file-name{color:#34c759;font-weight:500;margin-top:8px}

/* å®Ÿéš›ã®æŠ•ä¸é‡è¡¨ç¤º */
.actual-dose{background:#e8f4fd;padding:8px 12px;border-radius:8px;margin-top:8px;font-weight:600;color:#0a84ff}

/* è¤‡æ•°è¦æ ¼ãƒ¢ãƒ¼ãƒ‰ */
.multi-spec-toggle{background:#fff3cd;padding:8px 12px;border-radius:8px;margin:8px 0;display:flex;align-items:center;gap:8px}
.multi-spec-toggle input{width:auto}

/* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
@media (min-width:1100px){
.layout{display:grid;grid-template-columns:1.1fr 1fr;gap:16px}
.panel-left{position:sticky;top:8px;align-self:start;max-height:calc(100vh - 16px);overflow:auto}
.panel-right{max-height:calc(100vh - 16px);overflow:auto}
}

.small{font-size:13px;color:#666}
label{display:block;margin-bottom:4px;font-size:14px;color:#333;font-weight:500}
details summary{cursor:pointer;font-weight:600;margin-bottom:8px}
details summary:hover{color:#0a84ff}
hr{border:0;border-top:1px solid #e5e5ea;margin:12px 0}

/* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
.drug-row{animation:fadeIn 0.3s ease}
</style>

</head>
<body>
<h1>ğŸ¥ è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v5.1ï¼ˆæ•£å‰¤ãƒ¢ãƒ¼ãƒ‰æ”¹å–„ï¼‰</h1>

<div class="layout">
  <!-- å·¦ãƒ‘ãƒãƒ«ï¼šå…¥åŠ› -->
  <div class="panel-left">
    <div class="card">
      <h3>ğŸ“Š åŸºæœ¬æƒ…å ±</h3>
      <div class="row">
        <div class="col">
          <label>ä½“é‡ï¼ˆkgï¼‰</label>
          <input type="number" id="weight" step="0.01" placeholder="ä¾‹: 5.5"/>
        </div>
        <div class="col">
          <label>æ—¥æ•°</label>
          <input type="number" id="days" value="7" min="1"/>
        </div>
        <div class="col">
          <label>å›æ•°/æ—¥</label>
          <select id="timesPerDay">
            <option value="1">SIDï¼ˆ1å›/æ—¥ï¼‰</option>
            <option value="2" selected>BIDï¼ˆ2å›/æ—¥ï¼‰</option>
            <option value="3">TIDï¼ˆ3å›/æ—¥ï¼‰</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>å‡¦æ–¹å½¢æ…‹ï¼ˆå…¨ä½“ï¼‰</label>
          <select id="globalForm">
            <option value="POWDER" selected>æ•£å‰¤ï¼ˆéŒ å‰¤ã‚’ç²‰ç •ï¼‰</option>
            <option value="TAB">éŒ å‰¤ï¼ˆãã®ã¾ã¾ï¼‰</option>
          </select>
        </div>
        <div class="col">
          <label style="margin-top:24px">
            <input type="checkbox" id="bunpo" style="width:auto;margin-right:8px" checked>
            åˆ†åŒ…æ©Ÿä½¿ç”¨ï¼ˆ+20å††/åŒ…ï¼‰
          </label>
        </div>
      </div>
      <div class="multi-spec-toggle">
        <input type="checkbox" id="multiSpecMode" style="width:auto">
        <label for="multiSpecMode" style="margin:0">ğŸ¯ è¤‡æ•°è¦æ ¼æœ€é©åŒ–ãƒ¢ãƒ¼ãƒ‰ï¼ˆåŒã˜è–¬å‰¤åã§è¤‡æ•°ã®å«æœ‰é‡ã‚’ç™»éŒ²å¯èƒ½ï¼‰</label>
      </div>
    </div>

```
<div class="card">
  <h3>ğŸ’Š è–¬å‰¤å…¥åŠ›</h3>
  <div id="tabletList"></div>
  <div class="row">
    <div class="col"><button id="addDrug">ï¼‹ è–¬å‰¤ã‚’è¿½åŠ </button></div>
    <div class="col"><button id="clearAll" class="ghost">å…¥åŠ›ã‚¯ãƒªã‚¢</button></div>
  </div>
</div>

<!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼†CSVç®¡ç† -->
<div class="card">
  <details open>
    <summary>ğŸ“¦ å‡¦æ–¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ & ãƒ‡ãƒ¼ã‚¿ç®¡ç†</summary>
    <div class="row" style="margin-top:8px">
      <div class="col">
        <label>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå</label>
        <input id="tplName" placeholder="ä¾‹ï¼šä¸‹ç—¢æ­¢ã‚ã‚»ãƒƒãƒˆ"/>
      </div>
      <div class="col">
        <label>&nbsp;</label>
        <div class="row" style="gap:6px">
          <button id="saveTpl" style="flex:1">ä¿å­˜</button>
          <button id="overwriteTpl" class="secondary" style="flex:1">ä¸Šæ›¸ã</button>
        </div>
      </div>
    </div>
    <div class="row" style="margin-top:6px">
      <div class="col">
        <label>ä¿å­˜æ¸ˆã¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</label>
        <select id="tplSelect">
          <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
        </select>
      </div>
      <div class="col">
        <label>&nbsp;</label>
        <div class="row" style="gap:6px">
          <button id="loadTpl" class="secondary" style="flex:1">èª­è¾¼</button>
          <button id="deleteTpl" class="danger" style="flex:1">å‰Šé™¤</button>
        </div>
      </div>
    </div>
    <hr/>
    <div class="row">
      <div class="col">
        <label class="small">è–¬å‰¤CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿</label>
        <div class="file-upload-area" id="fileUploadArea">
          <div class="file-upload-btn">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
          <div class="small">ã¾ãŸã¯ã“ã“ã«CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
          <div class="file-name" id="fileName" style="display:none;"></div>
        </div>
        <input type="file" id="csvInput" accept=".csv" class="file-input-hidden"/>
        <div class="small" style="margin-top:4px;">åˆ—ï¼šè–¬å‰¤å, å‰¤å‹, å˜ä¾¡ï¼ˆä»•å…¥ï¼‰, å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰</div>
      </div>
      <div class="col">
        <label>&nbsp;</label>
        <button id="exportCsv" class="secondary">ğŸ“¥ ç¾åœ¨ã®è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãå‡ºã—</button>
        <button id="clearCsvData" class="danger" style="margin-top:6px;">ğŸ—‘ï¸ è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>
      </div>
    </div>
    <div class="status" id="csvStatus"></div>
  </details>
</div>
```

  </div>

  <!-- å³ãƒ‘ãƒãƒ«ï¼šå‡ºåŠ› -->

  <div class="panel-right">
    <div class="card">
      <h3>ğŸ”§ å‡ºåŠ›æ“ä½œ</h3>
      <div class="row">
        <div class="col"><button id="copySimple" class="secondary">ğŸ“‹ ç°¡æ˜“ç‰ˆã‚’ã‚³ãƒ”ãƒ¼</button></div>
        <div class="col"><button id="copyDetail" class="secondary">ğŸ“Š è©³ç´°ç‰ˆã‚’ã‚³ãƒ”ãƒ¼</button></div>
      </div>
    </div>

```
<div class="card">
  <h3>ğŸ“‹ ã‚«ãƒ«ãƒ†è²¼ä»˜ç”¨ï¼ˆç°¡æ˜“ç‰ˆï¼‰</h3>
  <pre id="outputSimple" class="readonly">ã¾ã è¨ˆç®—ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
```

å·¦å´ã§å¿…è¦ãªæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</pre>
</div>

```
<div class="card">
  <h3>ğŸ§® è¨ˆç®—æ ¹æ‹ ï¼ˆè©³ç´°ç‰ˆï¼‰</h3>
  <pre id="outputDetail" class="readonly">ã¾ã è¨ˆç®—ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
```

å·¦å´ã§å¿…è¦ãªæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</pre>
</div>

  </div>
</div>

<script>
/**
 * è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v5.1
 * 
 * æ–°æ©Ÿèƒ½ï¼ˆv5.1ï¼‰:
 * - æ•£å‰¤ãƒ¢ãƒ¼ãƒ‰ã®æ”¹å–„
 *   æ•£å‰¤ãƒ¢ãƒ¼ãƒ‰ã¯ã€ŒéŒ å‰¤ã‚’ç²‰ç •ã—ã¦ç²‰è–¬ã«ã™ã‚‹ã€ãƒ¢ãƒ¼ãƒ‰
 *   å˜ä½ã¯å¸¸ã« mg/éŒ ã€å††/éŒ  ã§è¡¨ç¤º
 *   è¨ˆç®—çµæœã¯ã€Œâ—‹éŒ åˆ†ã‚’ç²‰ç •ã€ã¨è¡¨ç¤º
 * 
 * æ©Ÿèƒ½ï¼ˆv5.0ï¼‰:
 * - è¤‡æ•°è¦æ ¼æœ€é©åŒ–æ©Ÿèƒ½
 *   åŒã˜è–¬å‰¤ã§è¤‡æ•°ã®å«æœ‰é‡ãŒã‚ã‚‹å ´åˆã€å¤§ãã„ã‚µã‚¤ã‚ºã‹ã‚‰ä½¿ç”¨ã—ã¦æœ€é©åŒ–
 *   ä¾‹ï¼šã‚»ãƒ•ã‚¡ã‚¯ãƒªã‚¢ 75mg, 300mg, 600mg â†’ è‡ªå‹•çš„ã«æœ€é©ãªçµ„ã¿åˆã‚ã›ã‚’è¨ˆç®—
 * - å®Ÿéš›ã®æŠ•ä¸é‡ï¼ˆmg/kgï¼‰è¡¨ç¤ºæ©Ÿèƒ½
 *   è¨ˆç®—å¾Œã®å®Ÿéš›ã®æŠ•ä¸é‡ã‚’è¡¨ç¤º
 */

/* ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ====== */
function byId(id) { return document.getElementById(id); }
function ceil10(y) { return Math.ceil(y / 10) * 10; }
function ceilYen(y) { return Math.ceil(y); }
function markupFor(p) { 
  if (p <= 10) return 3; 
  if (p <= 50) return 2; 
  if (p <= 100) return 1.8; 
  if (p <= 500) return 1.5; 
  return 1.2; 
}

/* å…¨è§’â†’åŠè§’å¤‰æ› + å˜ä½é™¤å»ã—ã¦æ•°å€¤åŒ– */
function toNumber(v) {
  if (v == null) return NaN;
  var s = String(v).trim()
    .replace(/[ï¼-ï¼™]/g, function(ch) { return String.fromCharCode(ch.charCodeAt(0) - 0xFEE0); })
    .replace(/[ï¼ï¼Œ]/g, function(ch) { return ch === 'ï¼' ? '.' : ','; })
    .replace(/[^0-9\.\-]/g, ''); 
  if (s === '') return NaN;
  return parseFloat(s);
}

/* è–¬å‰¤åã‹ã‚‰å«æœ‰é‡ã‚’è‡ªå‹•æŠ½å‡º */
function extractUnitFromName(name) {
  if (!name) return null;
  
  var normalizedName = name
    .replace(/[ï¼-ï¼™]/g, function(ch) { return String.fromCharCode(ch.charCodeAt(0) - 0xFEE0); })
    .replace(/ï¼/g, '.');
  
  var patterns = [
    /(\d+(?:\.\d+)?)\s*mg/i,
    /(\d+(?:\.\d+)?)\s*ï½ï½‡/,
    /(\d+(?:\.\d+)?)\s*ã/,
    /(\d+(?:\.\d+)?)\s*ml/i,
    /(\d+(?:\.\d+)?)\s*mL/,
    /(\d+(?:\.\d+)?)\s*Î¼g/i,
    /(\d+(?:\.\d+)?)\s*mcg/i,
    /(\d+(?:\.\d+)?)\s*g(?!\/)/i,
  ];
  
  for (var i = 0; i < patterns.length; i++) {
    var match = normalizedName.match(patterns[i]);
    if (match) {
      var value = parseFloat(match[1]);
      
      if (patterns[i].toString().indexOf('Î¼g') > -1 || patterns[i].toString().indexOf('mcg') > -1) {
        value = value / 1000;
      } else if (patterns[i].toString().indexOf('g(?!') > -1) {
        value = value * 1000;
      }
      
      return value;
    }
  }
  
  return null;
}

/* è–¬å‰¤åã®ãƒ™ãƒ¼ã‚¹åã‚’å–å¾—ï¼ˆå«æœ‰é‡éƒ¨åˆ†ã‚’é™¤å»ï¼‰ */
function getBaseDrugName(name) {
  if (!name) return "";
  // æ•°å­—ã¨mg/ml/gç­‰ã®å˜ä½ã‚’é™¤å»
  return name.replace(/\d+(?:\.\d+)?\s*(?:mg|ï½ï½‡|ã|ml|mL|Î¼g|mcg|g)/gi, '').trim();
}

/* ====== ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼ ====== */
var KEY_MASTER = "drugMasterSimple";
var KEY_TPL = "rxTemplatesV1";

/* ====== CSVè–¬å‰¤ãƒã‚¹ã‚¿ãƒ¼ç®¡ç† ====== */
var DRUGS = (function() { 
  try { 
    return JSON.parse(localStorage.getItem(KEY_MASTER)) || []; 
  } catch(e) { 
    console.error("è–¬å‰¤ãƒã‚¹ã‚¿ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
    return []; 
  } 
})();

function saveDrugs(list) { 
  try { 
    localStorage.setItem(KEY_MASTER, JSON.stringify(list)); 
  } catch(e) {
    console.error("è–¬å‰¤ãƒã‚¹ã‚¿ãƒ¼ä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
    alert("è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  } 
}

function updateCsvStatus() { 
  var statusEl = byId("csvStatus");
  var count = DRUGS.length || 0;
  statusEl.textContent = "è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ï¼š" + count + "ä»¶ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ä¿å­˜ï¼‰";
  statusEl.className = count > 0 ? "status success" : "status";
}

/* ====== ã‚µã‚¸ã‚§ã‚¹ãƒˆæ©Ÿèƒ½ï¼ˆè–¬å‰¤åè‡ªå‹•è£œå®Œï¼‰ ====== */
function attachAutocomplete(input, unitEl, costEl) {
  var box = document.createElement("div");
  box.className = "suggest";
  input.parentNode.appendChild(box);
  var active = -1;
  
  function close() { 
    box.style.display = "none"; 
    box.innerHTML = ""; 
    active = -1; 
  }
  
  function open() { 
    box.style.display = "block"; 
  }
  
  function render(list) {
    box.innerHTML = "";
    if (list.length === 0) {
      close();
      return;
    }
    
    list.forEach(function(name) {
      var div = document.createElement("div");
      div.className = "suggest-item";
      div.textContent = name;
      div.addEventListener("mousedown", function(e) { 
        e.preventDefault(); 
        select(name); 
      });
      box.appendChild(div);
    });
    open();
  }
  
  function filter(q) {
    q = (q || "").trim().toLowerCase();
    if (!q) { 
      close(); 
      return; 
    }
    
    var names = DRUGS.map(function(d) { return d["è–¬å‰¤å"]; }).filter(Boolean);
    var starts = names.filter(function(n) { return n.toLowerCase().indexOf(q) === 0; });
    var contains = names.filter(function(n) { return n.toLowerCase().indexOf(q) > 0; });
    var all = starts.concat(contains)
      .filter(function(v, i, a) { return a.indexOf(v) === i; })
      .slice(0, 80);
    render(all);
  }
  
  function select(val) {
    input.value = val;
    var rec = null;
    for (var i = 0; i < DRUGS.length; i++) { 
      if (DRUGS[i]["è–¬å‰¤å"] === val) { 
        rec = DRUGS[i]; 
        break; 
      } 
    }
    
    if (rec) {
      var extractedUnit = extractUnitFromName(val);
      
      // æ•£å‰¤ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚éŒ å‰¤ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ã€éŒ å‰¤ã®å˜ä½ã‚’ä½¿ç”¨
      unitEl.value = rec["å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"] || extractedUnit || ""; 
      costEl.value = rec["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"] || ""; 
    } else {
      var extractedUnit = extractUnitFromName(val);
      if (extractedUnit) {
        unitEl.value = extractedUnit;
      }
    }
    close();
    recalc();
  }
  
  input.addEventListener("input", function() { filter(input.value); });
  input.addEventListener("focus", function() { if (input.value) filter(input.value); });
  input.addEventListener("blur", function() { setTimeout(close, 200); });
  
  input.addEventListener("keydown", function(e) {
    var items = box.querySelectorAll(".suggest-item");
    if (e.key === "ArrowDown") { 
      if (items.length) { 
        active = (active + 1) % items.length; 
        for (var i = 0; i < items.length; i++) {
          items[i].classList.toggle("active", i === active);
        }
        e.preventDefault(); 
      } 
    } else if (e.key === "ArrowUp") { 
      if (items.length) { 
        active = (active - 1 + items.length) % items.length; 
        for (var i = 0; i < items.length; i++) {
          items[i].classList.toggle("active", i === active);
        }
        e.preventDefault(); 
      } 
    } else if (e.key === "Enter") { 
      if (active >= 0 && items[active]) { 
        select(items[active].textContent); 
        e.preventDefault(); 
      } 
    } else if (e.key === "Escape") { 
      close(); 
    }
  });
}

/* ====== è–¬å‰¤è¡Œã®ä½œæˆã¨ç®¡ç† ====== */
var listEl = byId("tabletList");

function makeRow(data) {
  var row = document.createElement("div");
  row.className = "drug-row";
  row.innerHTML =
    '<div class="row">' +
      '<div class="col"><label>è–¬å‰¤å</label><div class="input-wrap"><input class="drugName" placeholder="é¸æŠã¾ãŸã¯å…¥åŠ›"/></div></div>' +
      '<div class="col"><label class="unitLabel">å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰</label><input type="number" class="unitMg" step="0.01" placeholder="ä¾‹: 10"/></div>' +
      '<div class="col"><label class="costLabel">å˜ä¾¡ï¼ˆå††/éŒ ï¼‰</label><input type="number" class="cost" step="0.01" placeholder="ä¾‹: 50"/></div>' +
    '</div>' +
    '<div class="row">' +
      '<div class="col"><label>è–¬ç”¨é‡ï¼ˆmg/kgï¼‰</label><input type="number" class="dose" step="0.01" placeholder="ä¾‹: 0.5"/></div>' +
      '<div class="col"><label>&nbsp;</label><button class="removeBtn danger">å‰Šé™¤</button></div>' +
    '</div>';
    
  var nameEl = row.querySelector(".drugName");
  var unitEl = row.querySelector(".unitMg");
  var costEl = row.querySelector(".cost");
  var doseEl = row.querySelector(".dose");
  
  attachAutocomplete(nameEl, unitEl, costEl);
  
  nameEl.addEventListener("blur", function() {
    if (nameEl.value && !unitEl.value) {
      var extracted = extractUnitFromName(nameEl.value);
      if (extracted) {
        unitEl.value = extracted;
        recalc();
      }
    }
  });
  
  row.querySelector(".removeBtn").addEventListener("click", function() { 
    if (listEl.children.length > 1 || confirm("æœ€å¾Œã®è–¬å‰¤è¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
      row.remove(); 
      recalc(); 
    }
  });
  
  var inputs = row.querySelectorAll("input");
  for (var i = 0; i < inputs.length; i++) { 
    inputs[i].addEventListener("input", recalc); 
  }
  
  if (data) {
    nameEl.value = data.name || "";
    unitEl.value = (data.unit != null ? data.unit : "");
    costEl.value = (data.cost != null ? data.cost : "");
    doseEl.value = (data.dose != null ? data.dose : "");
  }
  
  return row;
}

function addRow(data) { 
  listEl.appendChild(makeRow(data)); 
  updateFormLabels();
  recalc(); 
}

/* ====== ãƒ©ãƒ™ãƒ«æ›´æ–°ï¼ˆéŒ å‰¤/æ•£å‰¤ï¼‰ ====== */
function updateFormLabels() {
  var isTab = byId("globalForm").value === "TAB";
  // æ•£å‰¤ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚éŒ å‰¤ã®å˜ä½ã§è¡¨ç¤ºï¼ˆéŒ å‰¤ã‚’ç²‰ç •ã™ã‚‹ãŸã‚ï¼‰
  Array.prototype.forEach.call(document.querySelectorAll(".unitLabel"), function(el) {
    el.textContent = "å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰";
  });
  Array.prototype.forEach.call(document.querySelectorAll(".costLabel"), function(el) {
    el.textContent = "å˜ä¾¡ï¼ˆå††/éŒ ï¼‰";
  });
}

/* ====== ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç† ====== */
function loadTemplates() { 
  try { 
    return JSON.parse(localStorage.getItem(KEY_TPL)) || []; 
  } catch(e) { 
    console.error("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
    return []; 
  } 
}

function saveTemplates(arr) { 
  try { 
    localStorage.setItem(KEY_TPL, JSON.stringify(arr)); 
  } catch(e) {
    console.error("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
    alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
  } 
}

function refreshTplSelect() {
  var sel = byId("tplSelect");
  if (!sel) return;
  
  var arr = loadTemplates();
  sel.innerHTML = '<option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>';
  
  for (var i = 0; i < arr.length; i++) { 
    var o = document.createElement("option");
    o.value = i;
    o.textContent = arr[i].name;
    sel.appendChild(o);
  }
}

function currentFormData() {
  var items = [], rows = listEl.querySelectorAll(".drug-row");
  for (var i = 0; i < rows.length; i++) {
    items.push({
      name: rows[i].querySelector(".drugName").value.trim(),
      unit: toNumber(rows[i].querySelector(".unitMg").value),
      cost: toNumber(rows[i].querySelector(".cost").value),
      dose: toNumber(rows[i].querySelector(".dose").value)
    });
  }
  
  return {
    name: byId("tplName").value.trim(),
    mode: byId("globalForm").value,
    bunpo: byId("bunpo").checked,
    multiSpec: byId("multiSpecMode").checked,
    days: parseInt(byId("days").value || "0", 10),
    tpd: parseInt(byId("timesPerDay").value || "0", 10),
    weight: toNumber(byId("weight").value),
    items: items.filter(function(x) { return x.name; })
  };
}

function applyFormData(data) {
  if (!data) return;
  
  byId("globalForm").value = data.mode || "POWDER";
  byId("bunpo").checked = data.bunpo !== undefined ? data.bunpo : true;
  byId("multiSpecMode").checked = data.multiSpec || false;
  if (data.days) byId("days").value = data.days;
  if (data.tpd) byId("timesPerDay").value = data.tpd;
  if (data.weight) byId("weight").value = data.weight;
  
  listEl.innerHTML = "";
  var its = data.items || [];
  if (its.length === 0) { 
    addRow(); 
  } else { 
    for (var i = 0; i < its.length; i++) { 
      addRow(its[i]); 
    } 
  }
  updateFormLabels();
  recalc();
}

/* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ“ä½œã‚¤ãƒ™ãƒ³ãƒˆ */
byId("saveTpl").addEventListener("click", function() {
  var data = currentFormData();
  if (!data.name) { 
    alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); 
    return; 
  }
  
  var arr = loadTemplates();
  for (var i = 0; i < arr.length; i++) { 
    if (arr[i].name === data.name) { 
      alert("åŒåã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚\nã€ä¸Šæ›¸ãã€ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚"); 
      return; 
    } 
  }
  
  arr.push(data);
  saveTemplates(arr);
  refreshTplSelect();
  alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ" + data.name + "ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
});

byId("overwriteTpl").addEventListener("click", function() {
  var data = currentFormData();
  if (!data.name) { 
    alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); 
    return; 
  }
  
  var arr = loadTemplates();
  var idx = -1;
  for (var i = 0; i < arr.length; i++) { 
    if (arr[i].name === data.name) { 
      idx = i; 
      break; 
    } 
  }
  
  if (idx < 0) { 
    alert("åŒåã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); 
    return; 
  }
  
  if (!confirm("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ" + data.name + "ã€ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ")) return;
  
  arr[idx] = data;
  saveTemplates(arr);
  refreshTplSelect();
  alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ" + data.name + "ã€ã‚’ä¸Šæ›¸ãã—ã¾ã—ãŸ");
});

byId("loadTpl").addEventListener("click", function() {
  var arr = loadTemplates();
  var idx = parseInt(byId("tplSelect").value || "-1", 10);
  
  if (!(idx >= 0 && arr[idx])) { 
    alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„"); 
    return; 
  }
  
  if (!confirm("ç¾åœ¨ã®å…¥åŠ›å†…å®¹ã‚’ç ´æ£„ã—ã¦ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ" + arr[idx].name + "ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ")) return;
  
  byId("tplName").value = arr[idx].name;
  applyFormData(arr[idx]);
});

byId("deleteTpl").addEventListener("click", function() {
  var arr = loadTemplates();
  var idx = parseInt(byId("tplSelect").value || "-1", 10);
  
  if (!(idx >= 0 && arr[idx])) { 
    alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„"); 
    return; 
  }
  
  if (!confirm("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ" + arr[idx].name + "ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) return;
  
  var name = arr[idx].name;
  arr.splice(idx, 1);
  saveTemplates(arr);
  refreshTplSelect();
  alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ" + name + "ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
});

/* ====== CSVèª­ã¿è¾¼ã¿/æ›¸ãå‡ºã— ====== */
var fileUploadArea = byId("fileUploadArea");
var csvInput = byId("csvInput");
var fileName = byId("fileName");

fileUploadArea.addEventListener("click", function(e) {
  e.preventDefault();
  csvInput.click();
});

fileUploadArea.addEventListener("dragover", function(e) {
  e.preventDefault();
  e.stopPropagation();
  fileUploadArea.classList.add("dragover");
});

fileUploadArea.addEventListener("dragleave", function(e) {
  e.preventDefault();
  e.stopPropagation();
  fileUploadArea.classList.remove("dragover");
});

fileUploadArea.addEventListener("drop", function(e) {
  e.preventDefault();
  e.stopPropagation();
  fileUploadArea.classList.remove("dragover");
  
  var files = e.dataTransfer.files;
  if (files.length > 0) {
    var file = files[0];
    if (file.type === "text/csv" || file.name.toLowerCase().endsWith(".csv")) {
      fileName.textContent = "ğŸ“„ " + file.name;
      fileName.style.display = "block";
      processCsvFile(file);
    } else {
      alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
    }
  }
});

csvInput.addEventListener("change", function(ev) {
  var file = ev.target.files && ev.target.files[0];
  if (file) {
    fileName.textContent = "ğŸ“„ " + file.name;
    fileName.style.display = "block";
    processCsvFile(file);
  }
});

function processCsvFile(file) {
  if (!file) return;
  
  var r = new FileReader();
  r.onload = function(e) {
    try {
      var text = e.target.result;
      var lines = text.split(/\r?\n/).filter(function(x) { return x.trim(); });
      
      if (lines.length < 2) { 
        alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã€ã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™"); 
        fileName.style.display = "none";
        return; 
      }
      
      var header = lines[0].split(",");
      
      function idxOf(col) {
        var i = header.indexOf(col);
        if (i >= 0) return i;
        for (var k = 0; k < header.length; k++) { 
          if (header[k].replace(/\s/g, "") === col.replace(/\s/g, "")) return k; 
        }
        return -1;
      }
      
      var idx = {
        name: idxOf("è–¬å‰¤å"),
        type: idxOf("å‰¤å‹"),
        cost: idxOf("å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"),
        unitTab: idxOf("å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰")
      };
      
      if (idx.name < 0) {
        alert("CSVã«ã€Œè–¬å‰¤åã€åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        fileName.style.display = "none";
        return;
      }
      
      var list = [];
      for (var i = 1; i < lines.length; i++) {
        var c = lines[i].split(",");
        var drugName = c[idx.name] || "";
        
        var extractedUnit = extractUnitFromName(drugName);
        
        var rec = {
          "è–¬å‰¤å": drugName,
          "å‰¤å‹": c[idx.type] || "",
          "å˜ä¾¡ï¼ˆä»•å…¥ï¼‰": toNumber(c[idx.cost]),
          "å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰": (idx.unitTab >= 0 && c[idx.unitTab]) ? toNumber(c[idx.unitTab]) : extractedUnit || "",
          "å«æœ‰é‡ï¼ˆmg/mLï¼‰": "" // æ•£å‰¤ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚éŒ å‰¤å˜ä½ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€mLã¯ä½¿ç”¨ã—ãªã„
        };
        
        // å«æœ‰é‡ãŒç©ºã®å ´åˆã€æŠ½å‡ºã—ãŸå€¤ã‚’ä½¿ç”¨
        if (rec["å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"] === "" && extractedUnit) {
          rec["å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"] = extractedUnit;
        }
        
        if (rec["è–¬å‰¤å"]) list.push(rec);
      }
      
      if (list.length === 0) {
        alert("æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
        fileName.style.display = "none";
        return;
      }
      
      DRUGS = list;
      saveDrugs(DRUGS);
      updateCsvStatus();
      alert("è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ" + list.length + "ä»¶ï¼‰");
      
      fileName.style.color = "#34c759";
      
    } catch(err) {
      console.error("CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
      alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      fileName.style.display = "none";
    }
  };
  
  r.onerror = function() {
    alert("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
    fileName.style.display = "none";
  };
  
  r.readAsText(file, "utf-8");
}

byId("clearCsvData").addEventListener("click", function() {
  if (DRUGS.length === 0) {
    alert("ã‚¯ãƒªã‚¢ã™ã‚‹è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
    return;
  }
  
  if (confirm("ä¿å­˜ã•ã‚Œã¦ã„ã‚‹è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ï¼ˆ" + DRUGS.length + "ä»¶ï¼‰ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) {
    DRUGS = [];
    saveDrugs(DRUGS);
    updateCsvStatus();
    fileName.style.display = "none";
    alert("è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ");
  }
});

byId("exportCsv").addEventListener("click", function() {
  if (DRUGS.length === 0) {
    alert("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
    return;
  }
  
  var header = ["è–¬å‰¤å", "å‰¤å‹", "å˜ä¾¡ï¼ˆä»•å…¥ï¼‰", "å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"];
  var rows = [header.join(",")];
  
  for (var i = 0; i < DRUGS.length; i++) {
    rows.push([
      DRUGS[i]["è–¬å‰¤å"],
      DRUGS[i]["å‰¤å‹"] || "",
      DRUGS[i]["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"] || 0,
      DRUGS[i]["å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"] || ""
    ].join(","));
  }
  
  var blob = new Blob([rows.join("\n")], {type: "text/csv;charset=utf-8"});
  var url = URL.createObjectURL(blob);
  var a = document.createElement("a");
  a.href = url;
  a.download = "drug_master_export_" + new Date().toISOString().slice(0, 10) + ".csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

/* ====== è²»ç”¨è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ====== */
function optimizeTablets(totalMg, unitMg) {
  if (!(unitMg > 0)) return {billed: 0, achievedMg: 0, split: ""};
  
  var q = Math.ceil(totalMg / (unitMg / 4));
  var billed = Math.ceil(q / 4);
  var achieved = billed * unitMg;
  var split = "";
  
  if (q % 4 === 2) split = "1/2";
  if (q % 4 === 1 || q % 4 === 3) split = "1/4";
  
  return {billed: billed, achievedMg: achieved, split: split};
}

/* è¤‡æ•°è¦æ ¼ã®æœ€é©åŒ–è¨ˆç®— */
function optimizeMultiSpec(totalMg, specs) {
  // å«æœ‰é‡ã®å¤§ãã„é †ã«ã‚½ãƒ¼ãƒˆ
  specs.sort(function(a, b) { return b.unit - a.unit; });
  
  var result = [];
  var remaining = totalMg;
  
  for (var i = 0; i < specs.length && remaining > 0; i++) {
    var spec = specs[i];
    
    if (spec.unit <= 0) continue;
    
    // ã“ã®è¦æ ¼ã§ä½•éŒ ä½¿ãˆã‚‹ã‹è¨ˆç®—
    var tablets = Math.floor(remaining / spec.unit);
    
    if (tablets > 0) {
      result.push({
        name: spec.name,
        unit: spec.unit,
        cost: spec.cost,
        tablets: tablets,
        totalMg: tablets * spec.unit
      });
      remaining -= tablets * spec.unit;
    }
  }
  
  // æ®‹ã‚ŠãŒã‚ã‚‹å ´åˆã€æœ€å°è¦æ ¼ã§ç«¯æ•°å‡¦ç†
  if (remaining > 0 && specs.length > 0) {
    var smallestSpec = specs[specs.length - 1];
    
    // 1/4éŒ å˜ä½ã¾ã§è€ƒæ…®
    var q = Math.ceil(remaining / (smallestSpec.unit / 4));
    var tablets = q / 4;
    
    if (tablets > 0) {
      result.push({
        name: smallestSpec.name,
        unit: smallestSpec.unit,
        cost: smallestSpec.cost,
        tablets: tablets,
        totalMg: tablets * smallestSpec.unit,
        split: q % 4 === 2 ? "1/2" : (q % 4 === 1 || q % 4 === 3) ? "1/4" : ""
      });
    }
  }
  
  return result;
}

function calcAll() {
  var days = parseInt(byId("days").value || "0", 10);
  var tpd = parseInt(byId("timesPerDay").value || "0", 10);
  var doses = tpd * days;
  var weight = toNumber(byId("weight").value);
  var mode = byId("globalForm").value;
  var bunpo = byId("bunpo").checked;
  var multiSpecMode = byId("multiSpecMode").checked;
  
  if (!weight || weight <= 0) {
    return {
      simple: "ä½“é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
      detail: "è¨ˆç®—ã«å¿…è¦ãªæƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚\nä½“é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"
    };
  }
  
  if (!days || days <= 0) {
    return {
      simple: "æ—¥æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
      detail: "è¨ˆç®—ã«å¿…è¦ãªæƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚\næ—¥æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"
    };
  }
  
  var subtotal = 0, items = 0, splitFee = 0, packFee = 0, scriptFee = 0;
  var detail = "", simpleLines = [];
  
  var rows = listEl.querySelectorAll(".drug-row");
  var drugGroups = {};
  
  // è–¬å‰¤ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
  for (var i = 0; i < rows.length; i++) {
    var name = rows[i].querySelector(".drugName").value.trim();
    var unit = toNumber(rows[i].querySelector(".unitMg").value);
    var cost = toNumber(rows[i].querySelector(".cost").value);
    var dose = toNumber(rows[i].querySelector(".dose").value);
    
    if (!name) continue;
    
    if (!(isFinite(unit) && unit > 0)) {
      detail += "âš ï¸ " + name + "ï¼šå«æœ‰é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\n\n";
      continue;
    }
    
    if (!(isFinite(cost) && cost > 0)) {
      detail += "âš ï¸ " + name + "ï¼šå˜ä¾¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\n\n";
      continue;
    }
    
    if (!(isFinite(dose) && dose > 0)) {
      detail += "âš ï¸ " + name + "ï¼šè–¬ç”¨é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\n\n";
      continue;
    }
    
    var baseName = multiSpecMode ? getBaseDrugName(name) : name;
    
    if (!drugGroups[baseName]) {
      drugGroups[baseName] = {
        specs: [],
        dose: dose
      };
    }
    
    drugGroups[baseName].specs.push({
      name: name,
      unit: unit,
      cost: cost
    });
    
    // æœ€å¤§ã®è–¬ç”¨é‡ã‚’æ¡ç”¨
    if (dose > drugGroups[baseName].dose) {
      drugGroups[baseName].dose = dose;
    }
  }
  
  var hasValidDrug = false;
  
  // å„è–¬å‰¤ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‡¦ç†
  for (var baseName in drugGroups) {
    var group = drugGroups[baseName];
    var mgPerDose = weight * group.dose;
    var totalMg = mgPerDose * doses;
    
    hasValidDrug = true;
    
    if (mode === "TAB") {
      if (multiSpecMode && group.specs.length > 1) {
        // è¤‡æ•°è¦æ ¼æœ€é©åŒ–ãƒ¢ãƒ¼ãƒ‰
        var optimized = optimizeMultiSpec(totalMg, group.specs);
        var groupCost = 0;
        var totalAchievedMg = 0;
        
        detail += "ã€éŒ å‰¤ã‚°ãƒ«ãƒ¼ãƒ—ã€‘" + baseName + "\n";
        detail += group.dose + "mg/kg Ã— " + tpd + "å› Ã— " + days + "æ—¥åˆ†ï¼ˆä½“é‡ï¼š" + weight + "kgï¼‰\n";
        detail += "â†’ ç›®æ¨™é‡ï¼š" + Math.round(totalMg * 100) / 100 + "mg\n\n";
        
        var simpleParts = [];
        
        for (var j = 0; j < optimized.length; j++) {
          var item = optimized[j];
          var pricePer = ceil10(item.cost * markupFor(item.cost));
          var itemCost = ceilYen(pricePer * Math.ceil(item.tablets));
          
          groupCost += itemCost;
          totalAchievedMg += item.totalMg;
          
          detail += "  ãƒ»" + item.name + " " + item.unit + "mg/éŒ \n";
          detail += "    ä½¿ç”¨é‡ï¼š" + item.tablets + "éŒ ";
          if (item.split) detail += "ï¼ˆ" + item.split + "éŒ åˆ†å‰²ï¼‰";
          detail += "\n";
          detail += "    è–¬å‰¤æ–™ï¼š" + itemCost + "å††ï¼ˆ" + pricePer + "å††/éŒ  Ã— " + Math.ceil(item.tablets) + "éŒ ï¼‰\n";
          
          if (item.split === "1/2") splitFee += 10 * doses;
          if (item.split === "1/4") splitFee += 20 * doses;
          
          simpleParts.push(item.name + " " + item.tablets + "t");
        }
        
        detail += "\n  åˆè¨ˆå®ŸæŠ•ä¸é‡ï¼š" + Math.round(totalAchievedMg * 100) / 100 + "mg\n";
        var actualDosePerKg = Math.round((totalAchievedMg / doses / weight) * 100) / 100;
        detail += "  â˜…å®Ÿéš›ã®æŠ•ä¸é‡ï¼š" + actualDosePerKg + "mg/kgï¼ˆç›®æ¨™ï¼š" + group.dose + "mg/kgï¼‰\n";
        detail += "  ã‚°ãƒ«ãƒ¼ãƒ—è–¬å‰¤æ–™ï¼š" + groupCost + "å††\n\n";
        
        subtotal += groupCost;
        items += optimized.length;
        simpleLines.push("[" + baseName + ": " + simpleParts.join(", ") + "]");
        
      } else {
        // å˜ä¸€è¦æ ¼ãƒ¢ãƒ¼ãƒ‰ï¼ˆå¾“æ¥ã®å‡¦ç†ï¼‰
        var spec = group.specs[0];
        var opt = optimizeTablets(totalMg, spec.unit);
        var pricePer = ceil10(spec.cost * markupFor(spec.cost));
        var drugCost = ceilYen(pricePer * opt.billed);
        
        subtotal += drugCost;
        items++;
        
        if (opt.split === "1/2") splitFee += 10 * doses;
        if (opt.split === "1/4") splitFee += 20 * doses;
        
        detail += "ã€éŒ å‰¤ã€‘" + spec.name + " " + spec.unit + "mg/éŒ \n" +
                  group.dose + "mg/kg Ã— " + tpd + "å› Ã— " + days + "æ—¥åˆ†ï¼ˆä½“é‡ï¼š" + weight + "kgï¼‰\n" +
                  "â†’ ç›®æ¨™é‡ï¼š" + Math.round(totalMg * 100) / 100 + "mgï¼ˆ" + opt.billed + "éŒ ";
        if (opt.split) detail += "ã€" + opt.split + "éŒ åˆ†å‰²";
        detail += "ï¼‰\n";
        
        var actualDosePerKg = Math.round((opt.achievedMg / doses / weight) * 100) / 100;
        detail += "â˜…å®Ÿéš›ã®æŠ•ä¸é‡ï¼š" + actualDosePerKg + "mg/kgï¼ˆç›®æ¨™ï¼š" + group.dose + "mg/kgï¼‰\n";
        detail += "è–¬å‰¤æ–™ï¼š" + drugCost + "å††ï¼ˆ" + pricePer + "å††/éŒ  Ã— " + opt.billed + "éŒ ï¼‰\n\n";
        
        simpleLines.push(spec.name + spec.unit + "mg " + opt.billed + "t");
      }
      
    } else {
      // æ•£å‰¤ãƒ¢ãƒ¼ãƒ‰ï¼ˆéŒ å‰¤ã‚’ç²‰ç •ï¼‰
      if (multiSpecMode && group.specs.length > 1) {
        // è¤‡æ•°è¦æ ¼æœ€é©åŒ–ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ•£å‰¤ï¼‰
        var optimized = optimizeMultiSpec(totalMg, group.specs);
        var groupCost = 0;
        var totalAchievedMg = 0;
        
        detail += "ã€æ•£å‰¤ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆéŒ å‰¤ã‚’ç²‰ç •ï¼‰ã€‘" + baseName + "\n";
        detail += group.dose + "mg/kg Ã— " + tpd + "å› Ã— " + days + "æ—¥åˆ†ï¼ˆä½“é‡ï¼š" + weight + "kgï¼‰\n";
        detail += "â†’ ç›®æ¨™é‡ï¼š" + Math.round(totalMg * 100) / 100 + "mg\n\n";
        
        var simpleParts = [];
        
        for (var j = 0; j < optimized.length; j++) {
          var item = optimized[j];
          var pricePer = ceil10(item.cost * markupFor(item.cost));
          var itemCost = ceilYen(pricePer * Math.ceil(item.tablets));
          
          groupCost += itemCost;
          totalAchievedMg += item.totalMg;
          
          detail += "  ãƒ»" + item.name + " " + item.unit + "mg/éŒ \n";
          detail += "    ä½¿ç”¨é‡ï¼š" + Math.ceil(item.tablets) + "éŒ åˆ†ã‚’ç²‰ç •";
          if (item.split) detail += "ï¼ˆ" + item.split + "éŒ åˆ†å‰²ï¼‰";
          detail += "\n";
          detail += "    è–¬å‰¤æ–™ï¼š" + itemCost + "å††ï¼ˆ" + pricePer + "å††/éŒ  Ã— " + Math.ceil(item.tablets) + "éŒ ï¼‰\n";
          
          if (item.split === "1/2") splitFee += 10 * doses;
          if (item.split === "1/4") splitFee += 20 * doses;
          
          simpleParts.push(item.name + " " + Math.ceil(item.tablets) + "éŒ åˆ†");
        }
        
        detail += "\n  åˆè¨ˆå®ŸæŠ•ä¸é‡ï¼š" + Math.round(totalAchievedMg * 100) / 100 + "mg\n";
        var actualDosePerKg = Math.round((totalAchievedMg / doses / weight) * 100) / 100;
        detail += "  â˜…å®Ÿéš›ã®æŠ•ä¸é‡ï¼š" + actualDosePerKg + "mg/kgï¼ˆç›®æ¨™ï¼š" + group.dose + "mg/kgï¼‰\n";
        detail += "  ã‚°ãƒ«ãƒ¼ãƒ—è–¬å‰¤æ–™ï¼š" + groupCost + "å††\n\n";
        
        subtotal += groupCost;
        items += optimized.length;
        simpleLines.push("[" + baseName + ": " + simpleParts.join(", ") + "]");
        
      } else {
        // å˜ä¸€è¦æ ¼ï¼ˆæ•£å‰¤ãƒ¢ãƒ¼ãƒ‰ï¼‰
        var spec = group.specs[0];
        var tabletCount = Math.ceil(totalMg / spec.unit);
        var pricePer = ceil10(spec.cost * markupFor(spec.cost));
        var drugCostP = ceilYen(pricePer * tabletCount);
        
        subtotal += drugCostP;
        items++;
        
        detail += "ã€æ•£å‰¤ã€‘" + spec.name + " " + spec.unit + "mg/éŒ \n" +
                  group.dose + "mg/kg Ã— " + tpd + "å› Ã— " + days + "æ—¥åˆ†ï¼ˆä½“é‡ï¼š" + weight + "kgï¼‰\n" +
                  "â†’ ç›®æ¨™é‡ï¼š" + Math.round(totalMg * 100) / 100 + "mgï¼ˆ" + tabletCount + "éŒ åˆ†ã‚’ç²‰ç •ï¼‰\n";
        
        var actualTotalMg = tabletCount * spec.unit;
        var actualDosePerKg = Math.round((actualTotalMg / doses / weight) * 100) / 100;
        detail += "â˜…å®Ÿéš›ã®æŠ•ä¸é‡ï¼š" + actualDosePerKg + "mg/kgï¼ˆç›®æ¨™ï¼š" + group.dose + "mg/kgï¼‰\n";
        detail += "è–¬å‰¤æ–™ï¼š" + drugCostP + "å††ï¼ˆ" + pricePer + "å††/éŒ  Ã— " + tabletCount + "éŒ ï¼‰\n\n";
        
        // ç°¡æ˜“ç‰ˆã®è¡¨ç¤ºã‚‚éŒ æ•°ã§çµ±ä¸€
        var displayName = spec.name;
        if (spec.unit) {
          displayName = spec.name.replace(/\d+mg/gi, '') + spec.unit + "mg";
        }
        simpleLines.push(displayName + " " + tabletCount + "éŒ åˆ†");
      }
    }
  }
  
  if (!hasValidDrug) {
    return {
      simple: "è–¬å‰¤æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
      detail: detail || "æœ‰åŠ¹ãªè–¬å‰¤æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\nè–¬å‰¤åã€å«æœ‰é‡ã€å˜ä¾¡ã€è–¬ç”¨é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"
    };
  }
  
  if (bunpo) packFee += 20 * doses;
  
  if (items > 0) scriptFee = ceilYen(80 * days + 40 * days * (items - 1));
  
  var total = ceilYen(subtotal + splitFee + packFee + scriptFee);
  
  var freq = (tpd === 1 ? "SID" : tpd === 2 ? "BID" : "TID");
  var tail = (mode === "TAB" ? "TAB " + doses + "ãƒ¶ " + freq + " " + days + "æ—¥åˆ†" : 
              "ç²‰ " + doses + "åŒ… " + freq + " " + days + "æ—¥åˆ†");
  
  var simple = "å†…æœè–¬ï¼ " + (doses ? ceil10(total / doses) : 0) + " x" + doses + "\n" +
               (simpleLines.length ? simpleLines.join("  ") + "\n" : "") +
               tail;
  
  if (multiSpecMode) {
    detail += "ã€è¤‡æ•°è¦æ ¼æœ€é©åŒ–ãƒ¢ãƒ¼ãƒ‰ï¼šONã€‘\n";
    detail += "åŒã˜è–¬å‰¤ã®è¤‡æ•°è¦æ ¼ã‚’è‡ªå‹•çš„ã«çµ„ã¿åˆã‚ã›ã¦ã„ã¾ã™\n\n";
  }
  
  detail += "ã€æ–™é‡‘å†…è¨³ã€‘\n";
  detail += "è–¬å‰¤æ–™ï¼š" + subtotal + "å††\n";
  if (splitFee > 0) detail += "åˆ†å‰²æ–™ï¼š" + splitFee + "å††\n";
  if (packFee > 0) detail += "åˆ†åŒ…æ–™ï¼ˆåˆ†åŒ…æ©Ÿä½¿ç”¨ï¼‰ï¼š" + packFee + "å††\n";
  detail += "å‡¦æ–¹æ–™ï¼š" + scriptFee + "å††\n";
  detail += "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";
  detail += "åˆè¨ˆï¼š" + total + "å††";
  
  return {simple: simple, detail: detail};
}

/* ====== å‡ºåŠ›æ›´æ–° ====== */
function recalc() {
  try {
    var r = calcAll();
    byId("outputSimple").textContent = r.simple;
    byId("outputDetail").textContent = r.detail;
  } catch(e) {
    console.error("è¨ˆç®—ã‚¨ãƒ©ãƒ¼:", e);
    byId("outputSimple").textContent = "è¨ˆç®—ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
    byId("outputDetail").textContent = "ã‚¨ãƒ©ãƒ¼: " + e.message;
  }
}

/* ====== åˆæœŸåŒ– ====== */
function init() {
  updateCsvStatus();
  addRow();
  refreshTplSelect();
  updateFormLabels();
  
  ["weight", "days", "timesPerDay", "globalForm", "bunpo", "multiSpecMode"].forEach(function(id) {
    var el = byId(id);
    el.addEventListener("input", function() { 
      if (id === "globalForm") updateFormLabels(); 
      recalc(); 
    });
    el.addEventListener("change", function() { 
      if (id === "globalForm") updateFormLabels(); 
      recalc(); 
    });
  });
  
  byId("addDrug").addEventListener("click", function() { addRow(); });
  
  byId("clearAll").addEventListener("click", function() { 
    if (confirm("ã™ã¹ã¦ã®è–¬å‰¤å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) {
      listEl.innerHTML = ""; 
      addRow(); 
    }
  });
  
  byId("copySimple").addEventListener("click", function() {
    var text = byId("outputSimple").textContent;
    if (!text || text.indexOf("å…¥åŠ›ã—ã¦ãã ã•ã„") >= 0) {
      alert("è¨ˆç®—çµæœãŒã‚ã‚Šã¾ã›ã‚“");
      return;
    }
    navigator.clipboard.writeText(text).then(function() {
      alert("ç°¡æ˜“ç‰ˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
    }).catch(function(err) {
      console.error("ã‚³ãƒ”ãƒ¼å¤±æ•—:", err);
      alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
    });
  });
  
  byId("copyDetail").addEventListener("click", function() {
    var text = byId("outputDetail").textContent;
    if (!text || text.indexOf("å…¥åŠ›ã—ã¦ãã ã•ã„") >= 0) {
      alert("è¨ˆç®—çµæœãŒã‚ã‚Šã¾ã›ã‚“");
      return;
    }
    navigator.clipboard.writeText(text).then(function() {
      alert("è©³ç´°ç‰ˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
    }).catch(function(err) {
      console.error("ã‚³ãƒ”ãƒ¼å¤±æ•—:", err);
      alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
    });
  });
  
  recalc();
}

init();
</script>

</body>
</html>