<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>è–¬å‰¤è²»ç”¨è¨ˆç®— v6.6</title>
    <style>
        :root { --primary: #0a84ff; --bg: #f5f5f7; --card: #ffffff; --border: #d2d2d7; --danger: #ff3b30; --select: #e1efff; }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 16px; color: #1d1d1f; }
        h1 { font-size: 18px; margin-bottom: 16px; color: var(--primary); text-align: center; }
        .layout { display: grid; grid-template-columns: 1fr; gap: 16px; max-width: 1200px; margin: 0 auto; }
        @media (min-width: 900px) { .layout { grid-template-columns: 1fr 1fr; } }
        .card { background: var(--card); border-radius: 12px; padding: 16px; border: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.02); margin-bottom: 16px; }
        .section-title { font-weight: bold; margin-bottom: 12px; font-size: 14px; color: #86868b; border-bottom: 1px solid #eee; padding-bottom: 4px; }
        .row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
        .col { flex: 1; min-width: 80px; position: relative; }
        label { display: block; font-size: 11px; margin-bottom: 4px; font-weight: 600; color: #666; }
        input, select, button { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 15px; outline: none; }
        button { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { opacity: 0.8; }
        button.secondary { background: #e5e5ea; color: #1d1d1f; border: 1px solid #d2d2d7; }
        button.danger { background: var(--danger); }
        .drug-row { background: #f9f9fb; border: 1px solid #e5e5ea; border-radius: 10px; padding: 12px; margin-bottom: 10px; }
        .suggest-container { position: absolute; top: 100%; left: 0; z-index: 9999; background: white; border: 1px solid var(--border); width: 100%; max-height: 200px; overflow-y: auto; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); display: none; }
        .suggest-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 13px; }
        .suggest-item.selected { background: var(--select); }
        .drop-zone { border: 2px dashed var(--primary); border-radius: 12px; padding: 15px; text-align: center; background: #f0f7ff; cursor: pointer; }
        .alert-text { color: var(--danger); font-weight: bold; }
        .alert-box { border: 2px solid var(--danger) !important; background: #fff2f2 !important; }
    </style>
</head>
<body>

<h1>ğŸ¥ è–¬å‰¤è²»ç”¨è¨ˆç®— v6.6</h1>

<div class="layout">
    <div class="panel">
        <div class="card">
            <div class="section-title">åŸºæœ¬è¨­å®š</div>
            <div class="row">
                <div class="col"><label>ä½“é‡ (kg)</label><input type="number" id="weight" step="0.01" value="5.0"></div>
                <div class="col"><label>æ—¥æ•°</label><input type="number" id="days" value="7"></div>
                <div class="col">
                    <label>å›æ•°/æ—¥</label>
                    <select id="timesPerDay">
                        <option value="1">SID</option>
                        <option value="2" selected>BID</option>
                        <option value="3">TID</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <label>å‡¦æ–¹å½¢æ…‹</label>
                    <select id="globalForm">
                        <option value="POWDER">ç²‰ (æ•£å‰¤)</option>
                        <option value="TAB" selected>éŒ å‰¤ (TAB)</option>
                    </select>
                </div>
                <div class="col" style="padding-top:20px">
                    <label><input type="checkbox" id="bunpo" checked style="width:auto"> åˆ†åŒ…æ©Ÿä½¿ç”¨ (+20å††/å›)</label>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="section-title">è–¬å‰¤å…¥åŠ›ï¼ˆâ†‘â†“ã‚­ãƒ¼ã§é¸æŠãƒ»Enterã§ç¢ºå®šï¼‰</div>
            <div id="tabletList"></div>
            <button id="addDrug" class="secondary">ï¼‹ è–¬å‰¤ã‚’è¿½åŠ </button>
        </div>

        <div class="card">
            <div id="dropZone" class="drop-zone">ğŸ“„ è–¬å‰¤CSVã‚’ãƒ‰ãƒ­ãƒƒãƒ—</div>
            <input type="file" id="csvInput" accept=".csv" style="display:none">
            <div id="csvStatus" style="font-size:11px; margin-top:5px; color:#666">ãƒ‡ãƒ¼ã‚¿æœªèª­ã¿è¾¼ã¿</div>
        </div>
    </div>

    <div class="panel">
        <div class="card" id="simpleCard">
            <div class="section-title">ã‚«ãƒ«ãƒ†è²¼ä»˜ç”¨</div>
            <pre id="outputSimple" style="font-family: inherit; font-size: 14px; line-height: 1.6;">æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</pre>
            <button id="copySimple" style="margin-top:8px">ğŸ“‹ æ›¸å¼ã‚’ã‚³ãƒ”ãƒ¼</button>
        </div>
        <div class="card">
            <div class="section-title">è¨ˆç®—æ ¹æ‹ ï¼ˆè–¬é‡/kgè¡¨ç¤ºï¼‰</div>
            <div id="outputDetail" style="font-size:12px; color:#666; line-height: 1.5; white-space: pre-wrap;">å¾…æ©Ÿä¸­...</div>
        </div>
    </div>
</div>

<script>
const byId = id => document.getElementById(id);
let DRUG_MASTER = JSON.parse(localStorage.getItem("drugMasterV6_5") || "[]");
let selectedSuggestIndex = -1;

const toNumber = v => {
    if(!v) return 0;
    const s = String(v).replace(/[ï¼-ï¼™]/g, m => String.fromCharCode(m.charCodeAt(0) - 65248)).replace(/[^0-9.]/g, '');
    return parseFloat(s) || 0;
};

const ceil1 = v => Math.ceil(v);
const ceil10 = v => Math.ceil(v / 10) * 10;

// 1/4éŒ å˜ä½ã®ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›
function formatTablets(t) {
    const whole = Math.floor(t);
    const frac = t - whole;
    let fracText = "";
    // æµ®å‹•å°æ•°ç‚¹ã®èª¤å·®å¯¾ç­–
    if (Math.abs(frac - 0.25) < 0.01) fracText = "1/4";
    else if (Math.abs(frac - 0.5) < 0.01) fracText = "1/2";
    else if (Math.abs(frac - 0.75) < 0.01) fracText = "3/4";
    
    if (whole === 0 && fracText) return fracText;
    if (whole > 0 && fracText) return `${whole} ${fracText}`;
    return whole > 0 ? whole : "0";
}

function calcAll() {
    const weight = toNumber(byId("weight").value);
    const days = parseInt(byId("days").value) || 0;
    const tpd = parseInt(byId("timesPerDay").value);
    const totalDoses = days * tpd;
    const isPowder = byId("globalForm").value === "POWDER";
    const useBunpo = byId("bunpo").checked;

    if (weight <= 0 || days <= 0) return;

    let medTotal = 0, drugLines = [], splitFeePerDay = 0, drugCount = 0;
    let detailHtml = "";
    let globalAlert = false;

    document.querySelectorAll(".drug-row").forEach(row => {
        const name = row.querySelector(".drugName").value;
        const unit = toNumber(row.querySelector(".unitMg").value);
        const cost = toNumber(row.querySelector(".cost").value);
        const dose = toNumber(row.querySelector(".dose").value);
        if (!name || unit <= 0) return;

        drugCount++;
        const targetMgPerDose = weight * dose;
        let finalTabletsTotal = 0;
        let usageText = "";

        // -----------------------------------------------------
        // ãƒ¢ãƒ¼ãƒ‰åˆ¥è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
        // -----------------------------------------------------
        if (!isPowder) {
            // â–  éŒ å‰¤ãƒ¢ãƒ¼ãƒ‰ (TAB)
            // 1å›é‡ã‚’1/4å˜ä½ã§ä¸¸ã‚ã‚‹ â†’ ãã‚Œã‚’æ—¥æ•°åˆ†
            const rawTabletsPerDose = targetMgPerDose / unit;
            const usagePerDose = Math.ceil(rawTabletsPerDose * 4) / 4;
            finalTabletsTotal = usagePerDose * totalDoses;
            usageText = `${formatTablets(usagePerDose)}t / å›`;

            // åˆ†å‰²æ‰‹æ•°æ–™åˆ¤å®šï¼ˆ1å›é‡ã«å¯¾ã—ã¦ï¼‰
            const frac = usagePerDose % 1;
            if (frac > 0) splitFeePerDay = Math.max(splitFeePerDay, frac === 0.5 ? 10 : 20);

        } else {
            // â–  æ•£å‰¤ãƒ¢ãƒ¼ãƒ‰ (POWDER)
            // å…¨æ—¥æ•°åˆ†ã®ç·é‡ã‚’è¨ˆç®— â†’ ç·é‡ã‚’1/4å˜ä½ã§ä¸¸ã‚ã‚‹
            const totalMgNeeded = targetMgPerDose * totalDoses;
            const rawTotalTablets = totalMgNeeded / unit;
            // ç·é‡ã‚’0.25åˆ»ã¿ã§åˆ‡ã‚Šä¸Šã’ï¼ˆèª¤å·®æœ€å°åŒ–ï¼‰
            finalTabletsTotal = Math.ceil(rawTotalTablets * 4) / 4;
            usageText = `${finalTabletsTotal}tåˆ†`;
            
            // æ•£å‰¤ã®å ´åˆã¯ã€Œç·é‡ã€ã§ã®åˆ†å‰²æ‰‹æ•°æ–™åˆ¤å®šã¯ä¸€èˆ¬ã«ã—ãªã„ãŒã€
            // è«‹æ±‚ä¸Š1/4å˜ä½ã‚’ä½¿ã†ãªã‚‰æ‰‹æ•°æ–™ã‚’å–ã‚‹ã‹ï¼Ÿ
            // ã“ã“ã§ã¯ã€Œæ•£å‰¤ã€ã¯åˆ†åŒ…æ–™ãŒãƒ¡ã‚¤ãƒ³ã®ãŸã‚ã€åˆ†å‰²æ–™ã¯åŠ ç®—ã—ãªã„ï¼ˆã‚ã‚‹ã„ã¯ãƒ«ãƒ¼ãƒ«ã«å¾“ã†ï¼‰
            // â€»ã€ŒéŒ å‰¤ã‚’åˆ†å‰²ã™ã‚‹å ´åˆã€ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã„ã€æ•£å‰¤ã§ã‚‚åˆ†å‰²ã—ã¦ä½œã‚‹ãªã‚‰åŠ ç®—ã™ã‚‹ãªã‚‰ä»¥ä¸‹
            // ä¸€æ—¦ã€æ•£å‰¤ãƒ¢ãƒ¼ãƒ‰ã§ã¯åˆ†å‰²æ–™ãƒ­ã‚¸ãƒƒã‚¯ã¯è‡ªå‹•é©ç”¨ã›ãšã€åˆ†åŒ…æ–™ã®ã¿ã¨ã™ã‚‹ã®ãŒä¸€èˆ¬çš„ã§ã™ãŒ
            // å¿…è¦ã§ã‚ã‚Œã°æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„ã€‚
        }

        // -----------------------------------------------------
        // è²»ç”¨è¨ˆç®—ï¼ˆå…±é€šï¼‰
        // -----------------------------------------------------
        // è«‹æ±‚ä¸Šã®éŒ æ•°ï¼šé–‹å°ã—ãŸéŒ å‰¤ã¨ã—ã¦ã€Œåˆ‡ã‚Šä¸Šã’ã€
        const billedQty = Math.ceil(finalTabletsTotal);

        let markup = 1.2;
        if (cost <= 10) markup = 3;
        else if (cost <= 50) markup = 2;
        else if (cost <= 100) markup = 1.8;
        else if (cost <= 500) markup = 1.5;
        
        const pricePerTablet = ceil1(cost * markup);
        const drugCost = pricePerTablet * billedQty;
        medTotal += drugCost;

        drugLines.push(`${name} ${usageText}`);

        // -----------------------------------------------------
        // ã‚¢ãƒ©ãƒ¼ãƒˆ & è©³ç´°è¡¨ç¤º
        // -----------------------------------------------------
        // å®ŸåŠ¹ç”¨é‡(mg/kg/å›)
        const actualMgTotal = finalTabletsTotal * unit;
        const actualMgPerDose = actualMgTotal / totalDoses;
        const actualMgPerKg = actualMgPerDose / weight;
        
        const deviation = dose > 0 ? (actualMgPerKg - dose) / dose : 0;
        const isAlert = Math.abs(deviation) >= 0.1;
        if(isAlert) globalAlert = true;

        const alertClass = isAlert ? 'class="alert-text"' : '';
        const devPercent = (deviation * 100).toFixed(1);

        detailHtml += `<strong>ã€${name}ã€‘</strong>\n`;
        detailHtml += `  æŒ‡ç¤º: ${dose.toFixed(2)} mg/kg (${targetMgPerDose.toFixed(2)}mg/å›)\n`;
        if (isPowder) {
            detailHtml += `  ç·é‡è¨ˆç®—: å¿…è¦${(targetMgPerDose*totalDoses).toFixed(1)}mg â†’ ${finalTabletsTotal}tåˆ† (è«‹æ±‚${billedQty}t)\n`;
        } else {
            detailHtml += `  å˜å›è¨ˆç®—: 1å›${formatTablets(finalTabletsTotal/totalDoses)}t Ã— ${totalDoses}å› = è¨ˆ${finalTabletsTotal}t (è«‹æ±‚${billedQty}t)\n`;
        }
        detailHtml += `  å®ŸåŠ¹: <span ${alertClass}>${actualMgPerKg.toFixed(2)} mg/kg</span> `;
        detailHtml += `<span ${alertClass}>(${devPercent > 0 ? '+' : ''}${devPercent}%)</span>\n`;
        detailHtml += `  è²»ç”¨: ${pricePerTablet}å†† Ã— ${billedQty}t = ${drugCost}å††\n\n`;
    });

    if (drugCount === 0) return;

    // è«¸çµŒè²»
    const scriptFee = (80 + (drugCount - 1) * 40) * days;
    const packFee = useBunpo ? (20 * totalDoses) : 0;
    const chouzaiTotal = packFee + (splitFeePerDay * days);

    const grandTotalRaw = medTotal + scriptFee + chouzaiTotal;
    const unitPrice = ceil10(grandTotalRaw / totalDoses);
    const finalTotal = unitPrice * totalDoses;

    // å‡ºåŠ›
    byId("simpleCard").className = globalAlert ? "card alert-box" : "card";
    const tpdText = byId("timesPerDay").options[byId("timesPerDay").selectedIndex].text;
    
    let footerLine = "";
    if (isPowder) {
        footerLine = `ç²‰ã€€${totalDoses}åˆ†åŒ…ã€€${tpdText}ã€€${days}æ—¥åˆ†`;
    } else {
        footerLine = `TAB ${totalDoses}ãƒ¶ ${tpdText} ${days}æ—¥åˆ†`;
    }

    byId("outputSimple").textContent = 
        `ãƒ»å†…æœè–¬ï¼ ${unitPrice}x${totalDoses}\n` +
        `${drugLines.join("\n")}\n` +
        `${footerLine}`;

    detailHtml += `------------------------------\n`;
    detailHtml += `å‡¦æ–¹æ–™ï¼š${scriptFee}å†† / è–¬å‰¤æ–™ï¼š${medTotal}å†† / èª¿å‰¤æ–™ï¼š${chouzaiTotal}å††\n`;
    detailHtml += `å˜ä¾¡ä¸¸ã‚(ï¼ )ï¼š${unitPrice}å†† (x${totalDoses}å›)\n`;
    detailHtml += `<strong>åˆè¨ˆï¼š${finalTotal.toLocaleString()}å††</strong>`;
    byId("outputDetail").innerHTML = detailHtml;
}

/* UIãƒ»ã‚µã‚¸ã‚§ã‚¹ãƒˆãƒ»CSV (å…±é€š) */
function handleKeyDown(e, el) {
    const container = el.parentElement.querySelector(".suggest-container");
    const items = container.querySelectorAll(".suggest-item");
    if (container.style.display !== "block") return;
    if (e.key === "ArrowDown") {
        e.preventDefault(); selectedSuggestIndex = Math.min(selectedSuggestIndex + 1, items.length - 1); updateSelection(items);
    } else if (e.key === "ArrowUp") {
        e.preventDefault(); selectedSuggestIndex = Math.max(selectedSuggestIndex - 1, -1); updateSelection(items);
    } else if (e.key === "Enter" && selectedSuggestIndex > -1) {
        e.preventDefault(); applySelection(items[selectedSuggestIndex], el);
    }
}
function updateSelection(items) { items.forEach((item, idx) => { item.classList.toggle("selected", idx === selectedSuggestIndex); if (idx === selectedSuggestIndex) item.scrollIntoView({ block: "nearest" }); }); }
function applySelection(item, inputEl) {
    inputEl.value = item.textContent;
    const row = inputEl.closest(".drug-row");
    row.querySelector(".unitMg").value = item.dataset.unit;
    row.querySelector(".cost").value = item.dataset.cost;
    inputEl.parentElement.querySelector(".suggest-container").style.display = "none";
    selectedSuggestIndex = -1; calcAll();
}
function showSuggest(el) {
    const q = el.value.trim().toLowerCase();
    const container = el.parentElement.querySelector(".suggest-container");
    if (!q || DRUG_MASTER.length === 0) { container.style.display = "none"; return; }
    const matches = DRUG_MASTER.filter(d => d.name.toLowerCase().includes(q)).slice(0, 15);
    if (matches.length === 0) { container.style.display = "none"; return; }
    container.innerHTML = matches.map(m => `<div class="suggest-item" data-unit="${m.unit}" data-cost="${m.cost}">${m.name}</div>`).join("");
    container.style.display = "block"; selectedSuggestIndex = -1;
    container.querySelectorAll(".suggest-item").forEach(item => { item.onmousedown = () => applySelection(item, el); });
}
function processCSV(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        const lines = e.target.result.split(/\r?\n/).filter(l => l.trim() !== "");
        const header = lines[0].split(",");
        const iN = header.findIndex(h => h.includes("è–¬å‰¤å")), iC = header.findIndex(h => h.includes("å˜ä¾¡")), iU = header.findIndex(h => h.includes("å«æœ‰é‡"));
        DRUG_MASTER = lines.slice(1).map(line => {
            const c = line.split(","); return { name: c[iN]?.trim(), cost: toNumber(c[iC]), unit: toNumber(c[iU]) };
        }).filter(d => d.name && d.unit > 0);
        localStorage.setItem("drugMasterV6_5", JSON.stringify(DRUG_MASTER));
        byId("csvStatus").textContent = DRUG_MASTER.length + "ä»¶ èª­è¾¼æ¸ˆ"; alert("æ›´æ–°å®Œäº†");
    };
    reader.readAsText(file, "UTF-8");
}
function addDrugRow() {
    const div = document.createElement("div"); div.className = "drug-row";
    div.innerHTML = `<div class="row"><div class="col" style="flex:2"><label>è–¬å‰¤å</label><input class="drugName" autocomplete="off"><div class="suggest-container"></div></div><div class="col"><label>mg/éŒ </label><input type="number" step="0.01" class="unitMg"></div><div class="col"><label>åŸä¾¡</label><input type="number" step="0.01" class="cost"></div><div class="col"><label>mg/kg</label><input type="number" step="0.01" class="dose"></div><div class="col" style="flex:0; min-width:44px"><label>&nbsp;</label><button class="danger" onclick="this.closest('.drug-row').remove();calcAll();">Ã—</button></div></div>`;
    byId("tabletList").appendChild(div);
    const input = div.querySelector(".drugName");
    input.addEventListener("input", () => showSuggest(input)); input.addEventListener("keydown", (e) => handleKeyDown(e, input)); input.addEventListener("blur", () => setTimeout(() => div.querySelector(".suggest-container").style.display="none", 200));
    div.querySelectorAll("input").forEach(i => i.addEventListener("input", calcAll));
}
window.onload = () => {
    addDrugRow();
    if(DRUG_MASTER.length > 0) byId("csvStatus").textContent = DRUG_MASTER.length + "ä»¶ èª­è¾¼æ¸ˆ";
    const dz = byId("dropZone"); dz.onclick = () => byId("csvInput").click();
    dz.ondragover = e => { e.preventDefault(); dz.style.background = "#e1efff"; }; dz.ondragleave = () => dz.style.background = "#f0f7ff"; dz.ondrop = e => { e.preventDefault(); dz.style.background = "#f0f7ff"; processCSV(e.dataTransfer.files[0]); };
    byId("csvInput").onchange = e => processCSV(e.target.files[0]);
    byId("addDrug").onclick = addDrugRow;
    ["weight", "days", "timesPerDay", "globalForm", "bunpo"].forEach(id => byId(id).onchange = calcAll);
    byId("copySimple").onclick = () => { navigator.clipboard.writeText(byId("outputSimple").textContent); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); };
};
</script>
</body>
</html>
