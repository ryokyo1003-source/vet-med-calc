<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>è–¬å‰¤è²»ç”¨è¨ˆç®— v6.4</title>
    <style>
        :root { --primary: #0a84ff; --bg: #f5f5f7; --card: #ffffff; --border: #d2d2d7; --danger: #ff3b30; --select: #e1efff; }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 16px; color: #1d1d1f; }
        h1 { font-size: 18px; margin-bottom: 16px; color: var(--primary); text-align: center; }
        .layout { display: grid; grid-template-columns: 1fr; gap: 16px; max-width: 1200px; margin: 0 auto; }
        @media (min-width: 900px) { .layout { grid-template-columns: 1fr 1fr; } }
        .card { background: var(--card); border-radius: 12px; padding: 16px; border: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.02); margin-bottom: 16px; }
        .section-title { font-weight: bold; margin-bottom: 12px; font-size: 14px; color: #86868b; border-bottom: 1px solid #eee; padding-bottom: 4px; }
        .row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
        .col { flex: 1; min-width: 80px; position: relative; }
        label { display: block; font-size: 11px; margin-bottom: 4px; font-weight: 600; color: #666; }
        input, select, button { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 15px; outline: none; }
        button { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { opacity: 0.8; }
        button.secondary { background: #e5e5ea; color: #1d1d1f; border: 1px solid #d2d2d7; }
        button.danger { background: var(--danger); }
        .drug-row { background: #f9f9fb; border: 1px solid #e5e5ea; border-radius: 10px; padding: 12px; margin-bottom: 10px; }
        .suggest-container { position: absolute; top: 100%; left: 0; z-index: 9999; background: white; border: 1px solid var(--border); width: 100%; max-height: 200px; overflow-y: auto; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); display: none; }
        .suggest-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 13px; }
        .suggest-item.selected { background: var(--select); }
        .drop-zone { border: 2px dashed var(--primary); border-radius: 12px; padding: 15px; text-align: center; background: #f0f7ff; cursor: pointer; }
        .alert-text { color: var(--danger); font-weight: bold; }
        .alert-box { border: 2px solid var(--danger) !important; background: #fff2f2 !important; }
    </style>
</head>
<body>

<h1>ğŸ¥ è–¬å‰¤è²»ç”¨è¨ˆç®— v6.4</h1>

<div class="layout">
    <div class="panel">
        <div class="card">
            <div class="section-title">åŸºæœ¬è¨­å®š</div>
            <div class="row">
                <div class="col"><label>ä½“é‡ (kg)</label><input type="number" id="weight" step="0.01" value="5.0"></div>
                <div class="col"><label>æ—¥æ•°</label><input type="number" id="days" value="7"></div>
                <div class="col">
                    <label>å›æ•°/æ—¥</label>
                    <select id="timesPerDay">
                        <option value="1">SID</option>
                        <option value="2" selected>BID</option>
                        <option value="3">TID</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <label>å‡¦æ–¹å½¢æ…‹</label>
                    <select id="globalForm">
                        <option value="POWDER">ç²‰ (æ•£å‰¤)</option>
                        <option value="TAB" selected>éŒ å‰¤</option>
                    </select>
                </div>
                <div class="col" style="padding-top:20px">
                    <label><input type="checkbox" id="bunpo" checked style="width:auto"> åˆ†åŒ…æ©Ÿä½¿ç”¨ (+20å††/å›)</label>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="section-title">è–¬å‰¤å…¥åŠ›ï¼ˆâ†‘â†“ã‚­ãƒ¼ã§é¸æŠãƒ»Enterã§ç¢ºå®šï¼‰</div>
            <div id="tabletList"></div>
            <button id="addDrug" class="secondary">ï¼‹ è–¬å‰¤ã‚’è¿½åŠ </button>
        </div>

        <div class="card">
            <div id="dropZone" class="drop-zone">ğŸ“„ è–¬å‰¤CSVã‚’ãƒ‰ãƒ­ãƒƒãƒ—</div>
            <input type="file" id="csvInput" accept=".csv" style="display:none">
            <div id="csvStatus" style="font-size:11px; margin-top:5px; color:#666">ãƒ‡ãƒ¼ã‚¿æœªèª­ã¿è¾¼ã¿</div>
        </div>
    </div>

    <div class="panel">
        <div class="card" id="simpleCard">
            <div class="section-title">ã‚«ãƒ«ãƒ†è²¼ä»˜ç”¨</div>
            <pre id="outputSimple" style="font-family: inherit; font-size: 14px;">æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</pre>
            <button id="copySimple" style="margin-top:8px">ğŸ“‹ æ›¸å¼ã‚’ã‚³ãƒ”ãƒ¼</button>
        </div>
        <div class="card">
            <div class="section-title">è¨ˆç®—æ ¹æ‹ ï¼ˆè–¬é‡/kgè¡¨ç¤ºï¼‰</div>
            <div id="outputDetail" style="font-size:12px; color:#666; line-height: 1.5; white-space: pre-wrap;">å¾…æ©Ÿä¸­...</div>
        </div>
    </div>
</div>

<script>
const byId = id => document.getElementById(id);
let DRUG_MASTER = JSON.parse(localStorage.getItem("drugMasterV6_4") || "[]");
let selectedSuggestIndex = -1;

const toNumber = v => {
    if(!v) return 0;
    const s = String(v).replace(/[ï¼-ï¼™]/g, m => String.fromCharCode(m.charCodeAt(0) - 65248)).replace(/[^0-9.]/g, '');
    return parseFloat(s) || 0;
};

const ceil1 =
