<!-- 🔧 index.html 全体：機能追加済 -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>薬剤計算アプリ</title>
  <style>
    body { font-family: sans-serif; padding: 2em; }
    label, input, button { display: block; margin: 0.5em 0; }
    input { padding: 0.5em; width: 100%; max-width: 300px; }
    button { padding: 0.5em 1em; font-size: 1em; }
    #doseBreakdown { margin-top: 1em; font-weight: bold; }
    #actualDosePerKg { margin-top: 0.5em; color: #555; }
  </style>
</head>
<body>
  <h1>薬剤自動計算ツール</h1>

  <label>薬剤名（例：セファクリア）<input id="drugName" /></label>
  <label>体重（kg）<input type="number" id="weight" /></label>
  <label>必要量（mg）<input type="number" id="requiredMg" /></label>
  <label>使用可能な錠剤含有量（mg）※カンマ区切り<input id="tabletOptions" placeholder="600,300,75" /></label>

  <button onclick="onCalculate()">計算する</button>

  <div id="doseBreakdown"></div>
  <div id="actualDosePerKg"></div>

  <script>
    function calculateDoseCombination(totalMgRequired, tabletOptionsMg) {
      tabletOptionsMg.sort((a, b) => b - a);
      const result = [];
      let remaining = totalMgRequired;

      for (let dose of tabletOptionsMg) {
        let count = Math.floor(remaining / dose);
        if (count > 0) {
          result.push({ dose, count });
          remaining -= dose * count;
        }
      }

      // 1/2錠, 1/4錠で残りを補完
      for (let frac of [0.5, 0.25]) {
        for (let dose of tabletOptionsMg) {
          let partial = dose * frac;
          if (remaining >= partial - 0.1) {
            result.push({ dose, count: frac });
            remaining -= partial;
            break;
          }
        }
      }

      return { result, overMg: totalMgRequired - remaining };
    }

    function displayDoseBreakdown(drugName, bodyWeightKg, totalRequiredMg, availableTabletsMg) {
      const { result, overMg } = calculateDoseCombination(totalRequiredMg, availableTabletsMg);

      const breakdownEl = document.getElementById('doseBreakdown');
      const actualDoseEl = document.getElementById('actualDosePerKg');

      let html = `<div>${drugName}</div>`;
      let totalActualMg = 0;

      result.forEach(({ dose, count }) => {
        let label = (count === 0.5) ? '1/2錠' : (count === 0.25) ? '1/4錠' : `${count}錠`;
        html += `<div> - ${dose}mg × ${label}</div>`;
        totalActualMg += dose * count;
      });

      const overPct = ((totalActualMg - totalRequiredMg) / totalRequiredMg * 100).toFixed(2);
      html += `<div> → 合計 ${totalActualMg.toFixed(1)}mg（+${overPct}%）</div>`;

      const actualPerKg = (totalActualMg / bodyWeightKg).toFixed(2);
      actualDoseEl.innerText = `実際の投与量：${actualPerKg} mg/kg`;

      breakdownEl.innerHTML = html;
    }

    function onCalculate() {
      const name = document.getElementById('drugName').value;
      const weight = parseFloat(document.getElementById('weight').value);
      const requiredMg = parseFloat(document.getElementById('requiredMg').value);
      const tabletStr = document.getElementById('tabletOptions').value;
      const tabletOptions = tabletStr.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));

      if (!name || !weight || !requiredMg || tabletOptions.length === 0) {
        alert('すべての項目を正しく入力してください。');
        return;
      }

      displayDoseBreakdown(name, weight, requiredMg, tabletOptions);
    }
  </script>
</body>
</html>
