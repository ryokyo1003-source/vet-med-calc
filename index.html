<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v3.1 ä¿®æ­£ç‰ˆï¼ˆæŠ˜ã‚ŠãŸãŸã¿çµ±åˆï¼‰</title>
<style>
:root{ --gap:14px; --fz:16px; --pad:10px; --btnh:42px; }
*{box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;margin:0;padding:16px;font-size:var(--fz);background:#fafafa}
h1{font-size:18px;margin:0 0 12px}
h3{margin:0 0 8px}
.row{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center}
.col{flex:1 1 220px;min-width:220px}
input,select,button,textarea{width:100%;font-size:var(--fz);padding:var(--pad);min-height:var(--btnh);border-radius:12px;border:1px solid #d0d0d0;background:#fff}
button{background:#0a84ff;color:#fff;border:0;cursor:pointer}
button.secondary{background:#f2f2f7;color:#111;border:1px solid #d0d0d0}
button.danger{background:#ff3b30}
button.ghost{background:#fff;color:#0a84ff;border:1px solid #bcd6ff}
.card{border:1px solid #e5e5ea;border-radius:14px;padding:14px;margin:14px 0;background:#fff}
.layout{display:block}
@media (min-width:1200px){
  .layout{display:grid;grid-template-columns:1.05fr 1fr;gap:18px;align-items:start}
  .panel-left{position:sticky;top:8px;height:calc(100vh - 16px);overflow:auto}
  .panel-right{max-height:calc(100vh - 16px);overflow:auto}
}
.muted{color:#666;font-size:13px}
.drug-row{border:1px dashed #d0d0d0;border-radius:12px;padding:12px;margin:10px 0}
.label-inline{display:flex;align-items:center;gap:8px}
.pill{padding:2px 8px;border-radius:999px;background:#f4f7ff;border:1px solid #dbe6ff}
pre.readonly{white-space:pre-wrap;background:#fcfcfd;border:1px solid #eee;border-radius:12px;padding:12px;min-height:120px;font-family:ui-monospace, Menlo, monospace}
details.fold{border:1px dashed #d8d8de;border-radius:12px;padding:10px}
details.fold > summary{cursor:pointer;list-style:none;font-weight:600}
details.fold > summary::-webkit-details-marker{display:none}
.section{margin-top:12px;padding-top:6px;border-top:1px solid #f0f0f0}
.section h3{margin:0 0 6px}
.list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
.rowline{display:flex;gap:8px;align-items:center}
.rowline .title{flex:1}
.hidden{display:none}
</style>
</head>
<body>
<h1>è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v3.1 ä¿®æ­£ç‰ˆ</h1>

<div class="layout">
  <!-- å·¦ãƒšã‚¤ãƒ³ï¼šå…¥åŠ› -->
  <div class="panel-left">
    <div class="card">
      <div class="row">
        <div class="col"><label>ä½“é‡ï¼ˆkgï¼‰</label><input type="number" id="weight" step="0.01" inputmode="decimal"/></div>
        <div class="col"><label>æ—¥æ•°</label><input type="number" id="days" value="7" min="1" inputmode="numeric"/></div>
        <div class="col"><label>å›æ•°/æ—¥</label>
          <select id="timesPerDay"><option value="1">SID</option><option value="2" selected>BID</option><option value="3">TID</option></select>
        </div>
      </div>
      <div class="row">
        <div class="col"><label>å‡¦æ–¹å½¢æ…‹ï¼ˆå…¨ä½“ï¼‰</label>
          <select id="globalForm">
            <option value="TAB" selected>éŒ å‰¤ï¼ˆTABï¼‰</option>
            <option value="POWDER">æ•£å‰¤</option>
          </select>
        </div>
        <div class="col">
          <label class="label-inline"><input type="checkbox" id="bunpo"/> åˆ†åŒ…ï¼ˆå…¨ä½“ä¸€æ‹¬ +20å††/å›ï¼‰</label>
          <div class="muted">ï¼ ï¼ï¼ˆåˆè¨ˆÃ·å›æ•°Ã—æ—¥æ•°ï¼‰ã‚’10å††å˜ä½ã§åˆ‡ä¸Šã’</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>ğŸ’Š è–¬å‰¤å…¥åŠ›</h3>
      <div id="tabletList"></div>
      <div class="row">
        <div class="col"><button id="addDrug">ï¼‹ è–¬å‰¤ã‚’è¿½åŠ </button></div>
        <div class="col"><button id="clearAll" class="ghost">å…¥åŠ›ã‚¯ãƒªã‚¢</button></div>
      </div>
    </div>

    <!-- æŠ˜ã‚ŠãŸãŸã¿ï¼šãƒ†ãƒ³ãƒ—ãƒ¬ï¼å±¥æ­´ï¼CSV -->
    <div class="card">
      <details class="fold" id="foldTools">
        <summary>ğŸ“¦ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ»å±¥æ­´ãƒ»CSVï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é–‹é–‰ï¼‰</summary>

        <div class="section">
          <h3>ğŸ§° å‡¦æ–¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h3>
          <div class="row">
            <div class="col"><input id="tplName" placeholder="ä¾‹ï¼‰ä¸‹ç—¢æ­¢ã‚ã‚»ãƒƒãƒˆ"/></div>
            <div class="col">
              <button id="saveTpl">ãƒ†ãƒ³ãƒ—ãƒ¬ä¿å­˜</button>
              <button id="overwriteTpl" class="ghost">åŒåã«ä¸Šæ›¸ã</button>
            </div>
          </div>
          <div class="row">
            <div class="col"><select id="tplSelect"></select></div>
            <div class="col">
              <button id="loadTpl" class="secondary">èª­è¾¼</button>
              <button id="deleteTpl" class="danger">å‰Šé™¤</button>
              <button id="exportTpl" class="ghost">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
              <button id="importTpl" class="ghost">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
            </div>
          </div>
        </div>

        <div class="section">
          <h3>ğŸ“š å‡¦æ–¹å±¥æ­´</h3>
          <div class="row">
            <div class="col"><input id="histFilter" placeholder="æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«/è–¬å‰¤åï¼‰"/></div>
            <div class="col">
              <button id="saveHistory" class="ghost">ã“ã®å‡¦æ–¹ã‚’å±¥æ­´ä¿å­˜</button>
              <button id="exportHist" class="ghost">å±¥æ­´ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
              <button id="clearHist" class="danger">å±¥æ­´å…¨å‰Šé™¤</button>
            </div>
          </div>
          <div id="historyList" class="list"></div>
        </div>

        <div class="section">
          <h3>ğŸ“¦ è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ï¼ˆCSVï¼‰</h3>
          <div class="row">
            <div class="col"><input type="file" id="csvInput" accept=".csv"/></div>
            <div class="col"><button id="saveCsv" class="secondary">ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’CSVä¿å­˜</button></div>
          </div>
          <div class="muted">åˆ—ï¼šè–¬å‰¤å, å‰¤å‹, å˜ä¾¡ï¼ˆä»•å…¥ï¼‰, å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰, ï¼ˆä»»æ„ï¼‰å«æœ‰é‡ï¼ˆmg/mLï¼‰</div>
        </div>

      </details>
    </div>
  </div>

  <!-- å³ãƒšã‚¤ãƒ³ï¼šå‡ºåŠ› -->
  <div class="panel-right">
    <div class="card">
      <div class="row">
        <div class="col"><button id="copySimple" class="secondary">ç°¡æ˜“ã‚’ã‚³ãƒ”ãƒ¼</button></div>
        <div class="col"><button id="copyDetail" class="secondary">è©³ç´°ã‚’ã‚³ãƒ”ãƒ¼</button></div>
      </div>
    </div>
    <div class="card">
      <h3>ğŸ“‹ ã‚«ãƒ«ãƒ†è²¼ä»˜ç”¨ï¼ˆç°¡æ˜“ï¼‰</h3>
      <pre id="outputSimple" class="readonly"></pre>
    </div>
    <div class="card">
      <h3>ğŸ§® è¨ˆç®—æ ¹æ‹ ï¼ˆè©³ç´°ï¼‰</h3>
      <pre id="outputDetail" class="readonly"></pre>
    </div>
  </div>
</div>

<!-- CSVé¸æŠç”¨ -->
<datalist id="drugList"></datalist>

<script>
/* ==== åŸºæœ¬ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==== */
function byId(id){return document.getElementById(id)}
function ceil10(y){return Math.ceil(y/10)*10}
function ceilYen(y){return Math.ceil(y)}
function markupFor(p){ if(p<=10) return 3; if(p<=50) return 2; if(p<=100) return 1.8; if(p<=500) return 1.5; return 1.2; }

/* ==== æ°¸ç¶šã‚­ãƒ¼ ==== */
var KEY_MASTER="drugMasterSimple";
var KEY_NOTES="drugNotesV1";
var KEY_TPL="rxTemplatesV1";
var KEY_HIST="rxHistoryV1";

/* ==== CSVãƒã‚¹ã‚¿ãƒ¼ ==== */
var DRUGS = (function(){ try{ return JSON.parse(localStorage.getItem(KEY_MASTER))||[]; }catch(e){ return []; } })();
function saveDrugs(list){ try{ localStorage.setItem(KEY_MASTER, JSON.stringify(list)); }catch(e){} }
function loadNotes(){ try{ return JSON.parse(localStorage.getItem(KEY_NOTES))||{}; }catch(e){ return {}; } }
function saveNotes(map){ try{ localStorage.setItem(KEY_NOTES, JSON.stringify(map)); }catch(e){} }

function refreshDatalist(){
  var dl=byId("drugList"); dl.innerHTML="";
  for(var i=0;i<DRUGS.length;i++){
    var opt=document.createElement("option");
    opt.value=DRUGS[i]["è–¬å‰¤å"];
    dl.appendChild(opt);
  }
}

/* ==== è–¬å‰¤è¡Œç”Ÿæˆ ==== */
function makeRow(data){
  var row=document.createElement("div"); row.className="drug-row";
  row.innerHTML =
    '<div class="row">'+
      '<div class="col"><label>è–¬å‰¤å</label><input type="text" class="drugName" list="drugList" placeholder="é¸æŠã¾ãŸã¯å…¥åŠ›"/></div>'+
      '<div class="col"><label class="unitLabel">å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰</label><input type="number" class="unitMg" step="0.01"/></div>'+
      '<div class="col"><label class="costLabel">å˜ä¾¡ï¼ˆå††/éŒ ï¼‰</label><input type="number" class="cost" step="0.01"/></div>'+
    '</div>'+
    '<div class="row">'+
      '<div class="col"><label class="label-inline">è–¬ç”¨é‡ï¼ˆmg/kgï¼‰ <span class="pill">å®ŸåŠ¹ï¼š<span class="effDose">-</span> mg/kg</span></label><input type="number" class="dose" step="0.01" placeholder="ä¾‹ï¼š10"/></div>'+
      '<div class="col"><button class="removeBtn danger">å‰Šé™¤</button></div>'+
    '</div>'+
    '<div class="row powderOnly hidden">'+
      '<div class="col">'+
        '<label><input type="checkbox" class="syrupChk"/> ã‚·ãƒ­ãƒƒãƒ—æº¶è§£ï¼ˆ+500å††ï¼‰</label>ã€€'+
        '<label><input type="checkbox" class="capsuleChk"/> ã‚«ãƒ—ã‚»ãƒ«è©°ã‚ï¼ˆ+800å††ï¼‰</label>'+
      '</div>'+
    '</div>'+
    '<div class="row">'+
      '<div class="col">'+
        '<label>ãƒ¡ãƒ¢ï¼ˆè–¬å‰¤ã”ã¨ã«ä¿å­˜ï¼‰</label>'+
        '<textarea class="noteArea" style="height:90px"></textarea>'+
        '<button class="secondary saveNoteBtn" style="margin-top:8px">ã“ã®è–¬ã®ãƒ¡ãƒ¢ã‚’ä¿å­˜</button>'+
        '<div class="muted">ç«¯æœ«ä¿å­˜ï¼è–¬å‰¤åã‚­ãƒ¼ã§è‡ªå‹•å¾©å…ƒ</div>'+
      '</div>'+
    '</div>';

  var nameInput=row.querySelector(".drugName");
  var unitInput=row.querySelector(".unitMg");
  var costInput=row.querySelector(".cost");
  var doseInput=row.querySelector(".dose");
  var effSpan=row.querySelector(".effDose");
  var noteArea=row.querySelector(".noteArea");
  var syrupChk=row.querySelector(".syrupChk");
  var capsuleChk=row.querySelector(".capsuleChk");

  if(data){
    nameInput.value = data.name || "";
    unitInput.value = (data.unit!=null?data.unit:"");
    costInput.value = (data.cost!=null?data.cost:"");
    doseInput.value = (data.dose!=null?data.dose:"");
    noteArea.value  = data.note || "";
    if(syrupChk) syrupChk.checked = !!data.syrup;
    if(capsuleChk) capsuleChk.checked = !!data.capsule;
  }

  function loadFromCsv(name){
    var d=null;
    for(var i=0;i<DRUGS.length;i++){ if(DRUGS[i]["è–¬å‰¤å"]===name){ d=DRUGS[i]; break; } }
    if(!d) return;
    var mode=byId("globalForm").value;
    if(mode==="TAB"){
      unitInput.value = d["å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"] || "";
      costInput.value = d["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"] || "";
    }else{
      unitInput.value = d["å«æœ‰é‡ï¼ˆmg/mLï¼‰"] || "";
      costInput.value = d["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"] || "";
    }
    var notes=loadNotes(); if(notes[name]) noteArea.value = notes[name];
    recalc();
  }

  nameInput.addEventListener("change", function(){ loadFromCsv(nameInput.value); });
  nameInput.addEventListener("blur",   function(){ loadFromCsv(nameInput.value); });

  row.querySelector(".saveNoteBtn").addEventListener("click", function(){
    var name=nameInput.value.trim(); if(!name){ alert("è–¬å‰¤åã‚’å…¥åŠ›/é¸æŠã—ã¦ãã ã•ã„"); return; }
    var notes=loadNotes(); notes[name]=noteArea.value||""; saveNotes(notes);
    alert("ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
  });

  row.querySelector(".removeBtn").addEventListener("click", function(){ row.remove(); recalc(); });
  var inputs=row.querySelectorAll("input,select,textarea");
  for(var i=0;i<inputs.length;i++){
    inputs[i].addEventListener("input", recalc);
    inputs[i].addEventListener("change", recalc);
  }
  return row;
}

var listEl = byId("tabletList");
function addRow(data){ listEl.appendChild(makeRow(data)); applyGlobalFormUI(); recalc(); }

byId("addDrug").addEventListener("click", function(){ addRow(); });
byId("clearAll").addEventListener("click", function(){ listEl.innerHTML=""; addRow(); });

/* å½¢æ…‹åˆ‡æ›¿ã®UIåæ˜  */
function applyGlobalFormUI(){
  var mode=byId("globalForm").value;
  var labels=document.querySelectorAll(".unitLabel");
  for(var i=0;i<labels.length;i++){ labels[i].textContent = (mode==="TAB"?"å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰":"å«æœ‰é‡ï¼ˆmg/mLï¼‰"); }
  var costLabels=document.querySelectorAll(".costLabel");
  for(i=0;i<costLabels.length;i++){ costLabels[i].textContent = (mode==="TAB"?"å˜ä¾¡ï¼ˆå††/éŒ ï¼‰":"å˜ä¾¡ï¼ˆå††/mLï¼‰"); }
  var powders=document.querySelectorAll(".powderOnly");
  for(i=0;i<powders.length;i++){ powders[i].classList.toggle("hidden", !(mode==="POWDER")); }
}
["weight","days","timesPerDay","bunpo","globalForm"].forEach(function(id){
  byId(id).addEventListener("input", function(){ applyGlobalFormUI(); recalc(); });
  byId(id).addEventListener("change",function(){ applyGlobalFormUI(); recalc(); });
});

/* 1/4éŒ æœ€é©åŒ– */
function optimizeTablets(totalMg, unitMgPerTab){
  if(!(unitMgPerTab>0)){ return {whole:0, halves:0, quarters:0, billed:0, achievedMg:0}; }
  var qNeeded = Math.ceil(totalMg / (unitMgPerTab/4));
  var whole   = Math.floor(qNeeded/4);
  var rem     = qNeeded % 4;
  var halves  = Math.floor(rem/2);
  var quarters= rem % 2;
  var billed  = Math.ceil(qNeeded/4);
  var achievedMg = (whole + halves*0.5 + quarters*0.25) * unitMgPerTab;
  return {whole:whole, halves:halves, quarters:quarters, billed:billed, achievedMg:achievedMg};
}

/* è¨ˆç®—æœ¬ä½“ */
function calcAll(){
  var days=parseInt(byId("days").value||"0",10);
  var tpd=parseInt(byId("timesPerDay").value||"0",10);
  var doses=tpd*days;
  var weight=parseFloat(byId("weight").value||"0");
  var mode=byId("globalForm").value;
  var bunpo=byId("bunpo").checked;

  var detail="", subtotal=0, items=0;
  var splitFeeTotal=0, packFeeTotal=0, syrupFeeTotal=0, capsuleFeeTotal=0;
  var needsHalf=false, needsQuarter=false;

  var rows=listEl.querySelectorAll(".drug-row");
  for(var r=0;r<rows.length;r++){
    var row=rows[r];
    var name=row.querySelector(".drugName").value.trim();
    var unit=parseFloat(row.querySelector(".unitMg").value||"0");
    var cost=parseFloat(row.querySelector(".cost").value||"0");
    var dose=parseFloat(row.querySelector(".dose").value||"0");
    var effSpan=row.querySelector(".effDose");
    var syrupChk=row.querySelector(".syrupChk");
    var capsuleChk=row.querySelector(".capsuleChk");
    var noteArea=row.querySelector(".noteArea");

    if(effSpan) effSpan.textContent="-";
    if(!name||!unit||!cost||!dose||!weight||!days||!tpd) continue;

    var mgPerDose=weight*dose;
    var totalMg  = mgPerDose*doses;
    var pricePer = ceil10(cost * markupFor(cost));

    if(mode==="TAB"){
      var opt=optimizeTablets(totalMg, unit);
      var billedTabs=opt.billed;
      var drugCost=ceilYen(pricePer*billedTabs);
      subtotal+=drugCost; items++;
      if(opt.quarters>0){ needsQuarter=true; } else if(opt.halves>0){ needsHalf=true; }
      var achievedMgPerKg=(opt.achievedMg/doses)/weight; if(effSpan && isFinite(achievedMgPerKg)) effSpan.textContent=achievedMgPerKg.toFixed(2);
      var parts=[]; if(opt.whole) parts.push(opt.whole+"t"); if(opt.halves) parts.push(opt.halves+"Ã—1/2t"); if(opt.quarters) parts.push(opt.quarters+"Ã—1/4t");
      var comp=parts.length?parts.join(" + "):"0t";
      detail += "ã€éŒ å‰¤ã€‘"+name+" "+unit+"mg/éŒ \n"
              + "ç›®æ¨™ï¼š"+dose+"mg/kg Ã— "+tpd+"å› Ã— "+days+"æ—¥ï¼ˆä½“é‡ï¼š"+weight+"kgï¼‰\n"
              + "å¿…è¦é‡ï¼š"+Math.round(totalMg)+"mg\n"
              + "â†’ å®Ÿèª¿æ•´ï¼š"+comp+"ï¼ˆè¨ˆ "+billedTabs+"éŒ  è£½é€ ï¼‰\n"
              + "ã€€å®ŸåŠ¹ç”¨é‡ï¼š"+(isFinite(achievedMgPerKg)?achievedMgPerKg.toFixed(2):"-")+" mg/kgï¼ˆåˆè¨ˆ "+Math.round(opt.achievedMg)+"mgï¼‰\n"
              + "è–¬å‰¤æ–™ï¼š"+drugCost+"å††ï¼ˆ"+pricePer+"å††/éŒ  Ã— "+billedTabs+"éŒ ï¼‰\n"
              + (noteArea.value?("ãƒ¡ãƒ¢ï¼š"+noteArea.value+"\n"):"")
              + "\n";
    }else{
      var ml=Math.ceil((totalMg/unit)*100)/100;
      var drugCostP=ceilYen(pricePer*ml);
      subtotal+=drugCostP; items++;
      var achievedP=(totalMg/doses)/weight; if(effSpan && isFinite(achievedP)) effSpan.textContent=achievedP.toFixed(2);
      var extra="";
      if(syrupChk && syrupChk.checked){ syrupFeeTotal+=500; extra+="ã‚·ãƒ­ãƒƒãƒ—æº¶è§£ï¼š500å††\n"; }
      if(capsuleChk && capsuleChk.checked){ capsuleFeeTotal+=800; extra+="ã‚«ãƒ—ã‚»ãƒ«è©°ã‚ï¼š800å††\n"; }
      detail += "ã€æ•£å‰¤ã€‘"+name+" "+(isFinite(unit)&&unit>0?unit+"mg/mL":"")+"\n"
              + "ç›®æ¨™ï¼š"+dose+"mg/kg Ã— "+tpd+"å› Ã— "+days+"æ—¥ï¼ˆä½“é‡ï¼š"+weight+"kgï¼‰\n"
              + "å¿…è¦é‡ï¼š"+Math.round(totalMg)+"mgï¼ˆç´„"+ml.toFixed(2)+"mLç›¸å½“ï¼‰\n"
              + "ã€€å®ŸåŠ¹ç”¨é‡ï¼š"+(isFinite(achievedP)?achievedP.toFixed(2):"-")+" mg/kg\n"
              + "è–¬å‰¤æ–™ï¼š"+drugCostP+"å††ï¼ˆ"+pricePer+"å††/mL Ã— "+ml.toFixed(2)+"mLï¼‰\n"
              + extra
              + (noteArea.value?("ãƒ¡ãƒ¢ï¼š"+noteArea.value+"\n"):"")
              + "\n";
    }
  }

  if(mode==="TAB"){
    if(needsQuarter) splitFeeTotal += 20*doses;
    else if(needsHalf) splitFeeTotal += 10*doses;
  }
  if(bunpo){ packFeeTotal += 20*doses; }
  var scriptFee = (items>0)?ceilYen(80*days + 40*days*(items-1)):0;
  var total = ceilYen(subtotal + splitFeeTotal + packFeeTotal + syrupFeeTotal + capsuleFeeTotal + scriptFee);
  return {detail:detail, subtotal:subtotal, splitFeeTotal:splitFeeTotal, packFeeTotal:packFeeTotal, syrupFeeTotal:syrupFeeTotal, capsuleFeeTotal:capsuleFeeTotal, scriptFee:scriptFee, total:total, items:items, mode:mode, doses:doses, days:days, tpd:tpd};
}

/* å‡ºåŠ› */
function buildSimple(obj){
  var unit = obj.doses>0 ? ceil10(obj.total/obj.doses) : 0;
  var freq = (obj.tpd===1?"SID":obj.tpd===2?"BID":"TID");
  var tail = (obj.mode==="TAB" ? "TAB "+obj.doses+"ãƒ¶ "+freq+" "+obj.days+"æ—¥åˆ†" : "ç²‰ "+obj.doses+"åŒ… "+freq+" "+obj.days+"æ—¥åˆ†");
  return "å†…æœè–¬ï¼ "+unit+" x"+obj.doses+"\n"+tail;
}
function recalc(){
  var r=calcAll(); if(!r) return;
  byId("outputSimple").textContent = buildSimple(r);
  var d=r.detail;
  if(r.splitFeeTotal>0) d += "åˆ†å‰²æ–™åˆè¨ˆï¼š"+r.splitFeeTotal+"å††\n";
  if(r.packFeeTotal>0)  d += "åˆ†åŒ…æ–™ï¼š"+r.packFeeTotal+"å††\n";
  if(r.syrupFeeTotal>0) d += "ã‚·ãƒ­ãƒƒãƒ—æº¶è§£åˆè¨ˆï¼š"+r.syrupFeeTotal+"å††\n";
  if(r.capsuleFeeTotal>0) d += "ã‚«ãƒ—ã‚»ãƒ«è©°ã‚åˆè¨ˆï¼š"+r.capsuleFeeTotal+"å††\n";
  d += "å‡¦æ–¹æ–™ï¼š"+r.scriptFee+"å††\nâ€”â€”â€”\nåˆè¨ˆï¼š"+r.total+"å††";
  byId("outputDetail").textContent = d;
}

/* ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ */
function copyPre(id){
  var text=byId(id).textContent;
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(text).then(function(){ alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); }).catch(function(){
      var ta=document.createElement("textarea"); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); ta.remove(); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
    });
  }else{
    var ta=document.createElement("textarea"); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); ta.remove(); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
  }
}
byId("copySimple").addEventListener("click", function(){ copyPre("outputSimple"); });
byId("copyDetail").addEventListener("click", function(){ copyPre("outputDetail"); });

/* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ»å±¥æ­´ */
function loadTemplates(){ try{ return JSON.parse(localStorage.getItem(KEY_TPL))||[]; }catch(e){ return []; } }
function saveTemplates(arr){ try{ localStorage.setItem(KEY_TPL, JSON.stringify(arr)); }catch(e){} }
function currentFormData(){
  var items=[], rows=listEl.querySelectorAll(".drug-row");
  for(var i=0;i<rows.length;i++){
    items.push({
      name: rows[i].querySelector(".drugName").value.trim(),
      unit: parseFloat(rows[i].querySelector(".unitMg").value||""),
      cost: parseFloat(rows[i].querySelector(".cost").value||""),
      dose: parseFloat(rows[i].querySelector(".dose").value||""),
      note: rows[i].querySelector(".noteArea").value||"",
      syrup: !!(rows[i].querySelector(".syrupChk") && rows[i].querySelector(".syrupChk").checked),
      capsule: !!(rows[i].querySelector(".capsuleChk") && rows[i].querySelector(".capsuleChk").checked)
    });
  }
  items = items.filter(function(x){ return x.name; });
  return { name: byId("tplName").value.trim(), mode: byId("globalForm").value, bunpo: byId("bunpo").checked, items: items };
}
function applyFormData(data){
  byId("globalForm").value = data.mode || "TAB";
  byId("bunpo").checked = !!data.bunpo;
  listEl.innerHTML=""; 
  var its = data.items||[];
  if(its.length===0){ addRow(); }
  else{ for(var i=0;i<its.length;i++){ addRow(its[i]); } }
  applyGlobalFormUI(); recalc();
}
function refreshTplSelect(){
  var sel=byId("tplSelect"), arr=loadTemplates(); sel.innerHTML="";
  for(var i=0;i<arr.length;i++){ var o=document.createElement("option"); o.value=i; o.textContent=arr[i].name; sel.appendChild(o); }
}
byId("saveTpl").addEventListener("click", function(){
  var data=currentFormData(); if(!data.name){ alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  var arr=loadTemplates(); for(var i=0;i<arr.length;i++){ if(arr[i].name===data.name){ alert("åŒåãŒã‚ã‚Šã¾ã™ã€‚ã€åŒåã«ä¸Šæ›¸ãã€ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚"); return; } }
  arr.push(data); saveTemplates(arr); refreshTplSelect(); alert("ä¿å­˜ã—ã¾ã—ãŸ");
});
byId("overwriteTpl").addEventListener("click", function(){
  var data=currentFormData(); if(!data.name){ alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  var arr=loadTemplates(); var idx=-1; for(var i=0;i<arr.length;i++){ if(arr[i].name===data.name){ idx=i; break; } }
  if(idx<0){ alert("åŒåãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã€ãƒ†ãƒ³ãƒ—ãƒ¬ä¿å­˜ã€ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚"); return; }
  arr[idx]=data; saveTemplates(arr); refreshTplSelect(); alert("ä¸Šæ›¸ãã—ã¾ã—ãŸ");
});
byId("loadTpl").addEventListener("click", function(){
  var arr=loadTemplates(); var idx=parseInt(byId("tplSelect").value||"-1",10);
  if(!(idx>=0 && arr[idx])){ alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
  byId("tplName").value=arr[idx].name; applyFormData(arr[idx]);
});
byId("deleteTpl").addEventListener("click", function(){
  var arr=loadTemplates(); var idx=parseInt(byId("tplSelect").value||"-1",10);
  if(!(idx>=0 && arr[idx])){ alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
  if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  arr.splice(idx,1); saveTemplates(arr); refreshTplSelect(); alert("å‰Šé™¤ã—ã¾ã—ãŸ");
});
byId("exportTpl").addEventListener("click", function(){
  var blob=new Blob([JSON.stringify(loadTemplates(),null,2)],{type:"application/json"});
  var url=URL.createObjectURL(blob); var a=document.createElement("a"); a.href=url; a.download="templates.json"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
byId("importTpl").addEventListener("click", function(){
  var inp=document.createElement("input"); inp.type="file"; inp.accept=".json,application/json";
  inp.onchange=function(e){
    var f=e.target.files[0]; if(!f) return;
    var r=new FileReader(); r.onload=function(ev){
      try{ var arr=JSON.parse(ev.target.result); if(!arr||!arr.length){ alert("ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™"); return; }
        saveTemplates(arr); refreshTplSelect(); alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ");
      }catch(e){ alert("JSONå½¢å¼ãŒä¸æ­£ã§ã™"); }
    }; r.readAsText(f,"utf-8");
  }; inp.click();
});

/* å±¥æ­´ */
function loadHistory(){ try{ return JSON.parse(localStorage.getItem(KEY_HIST))||[]; }catch(e){ return []; } }
function saveHistory(arr){ try{ localStorage.setItem(KEY_HIST, JSON.stringify(arr)); }catch(e){} }
function pushHistory(){
  var title = prompt("å±¥æ­´ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹ï¼šä¸‹ç—¢æ­¢ã‚ 10kg BID7æ—¥ï¼‰","");
  var simple=byId("outputSimple").textContent; var detail=byId("outputDetail").textContent; var snapshot=currentFormData();
  var item={ id:Date.now(), ts:new Date().toISOString(), title: title||(snapshot.items&&snapshot.items.slice(0,2).map(function(i){return i.name;}).join("ï¼‹")||"å‡¦æ–¹"), simple:simple, detail:detail, snapshot:snapshot };
  var arr=loadHistory(); arr.unshift(item); while(arr.length>100) arr.pop(); saveHistory(arr); renderHistory(); alert("å±¥æ­´ã«ä¿å­˜ã—ã¾ã—ãŸ");
}
function renderHistory(){
  var list=byId("historyList"); var filter=(byId("histFilter").value||"").trim().toLowerCase(); list.innerHTML="";
  var arr=loadHistory();
  for(var i=0;i<arr.length;i++){
    var it=arr[i]; if(filter){
      var hit=(it.title||"").toLowerCase().indexOf(filter)>=0;
      if(!hit && it.snapshot && it.snapshot.items){
        for(var j=0;j<it.snapshot.items.length;j++){
          if((it.snapshot.items[j].name||"").toLowerCase().indexOf(filter)>=0){ hit=true; break; }
        }
      }
      if(!hit) continue;
    }
    var line=document.createElement("div"); line.className="rowline";
    var when=new Date(it.ts);
    line.innerHTML =
      '<div class="title">'+ when.toLocaleString() +'ï½œ'+ (it.title||"å‡¦æ–¹") +'</div>'+
      '<button class="secondary" data-act="load">å†èª­è¾¼</button>'+
      '<button class="secondary" data-act="copyS">ç°¡æ˜“ã‚³ãƒ”ãƒ¼</button>'+
      '<button class="secondary" data-act="copyD">è©³ç´°ã‚³ãƒ”ãƒ¼</button>'+
      '<button class="danger" data-act="del">å‰Šé™¤</button>';
    line.querySelector('[data-act="load"]').addEventListener("click", function(s){ return function(){ applyFormData(s.snapshot); }; }(it));
    line.querySelector('[data-act="copyS"]').addEventListener("click", function(s){ return function(){ navigator.clipboard.writeText(s.simple); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); }; }(it));
    line.querySelector('[data-act="copyD"]').addEventListener("click", function(s){ return function(){ navigator.clipboard.writeText(s.detail); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); }; }(it));
    line.querySelector('[data-act="del"]').addEventListener("click", function(s){ return function(){ var arr2=loadHistory().filter(function(x){return x.id!==s.id}); saveHistory(arr2); renderHistory(); }; }(it));
    list.appendChild(line);
  }
}
byId("saveHistory").addEventListener("click", pushHistory);
byId("exportHist").addEventListener("click", function(){
  var blob=new Blob([JSON.stringify(loadHistory(),null,2)],{type:"application/json"});
  var url=URL.createObjectURL(blob); var a=document.createElement("a"); a.href=url; a.download="rx_history.json"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
byId("clearHist").addEventListener("click", function(){ if(!confirm("å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return; saveHistory([]); renderHistory(); });
byId("histFilter").addEventListener("input", renderHistory);

/* CSV å…¥å‡ºåŠ› */
byId("csvInput").addEventListener("change", function(ev){
  var f=ev.target.files && ev.target.files[0]; if(!f) return;
  var reader=new FileReader();
  reader.onload=function(e){
    var text=e.target.result;
    var lines=text.split(/\r?\n/).filter(function(x){return x.trim();});
    if(lines.length<2){ alert("CSVãŒç©ºã§ã™"); return; }
    var header=lines[0].split(",");
    var idx={ name:header.indexOf("è–¬å‰¤å"), type:header.indexOf("å‰¤å‹"), cost:header.indexOf("å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"), unitTab:header.indexOf("å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"), unitMl:header.indexOf("å«æœ‰é‡ï¼ˆmg/mL)") };
    if(idx.unitMl<0){
      for(var h=0;h<header.length;h++){ if(header[h].replace(/\s/g,'').indexOf("å«æœ‰é‡ï¼ˆmg/mLï¼‰")>=0){ idx.unitMl=h; break; } }
    }
    var list=[];
    for(var i=1;i<lines.length;i++){
      var c=lines[i].split(",");
      var rec={ "è–¬å‰¤å":c[idx.name]||"", "å‰¤å‹":c[idx.type]||"", "å˜ä¾¡ï¼ˆä»•å…¥ï¼‰":parseFloat(c[idx.cost]||"0")||0,
                "å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰": (idx.unitTab>=0 && c[idx.unitTab])?parseFloat(c[idx.unitTab]):"",
                "å«æœ‰é‡ï¼ˆmg/mLï¼‰": (idx.unitMl>=0 && c[idx.unitMl])?parseFloat(c[idx.unitMl]):"" };
      if(rec["è–¬å‰¤å"]) list.push(rec);
    }
    DRUGS=list; saveDrugs(DRUGS); refreshDatalist(); recalc();
    alert("è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ"+list.length+"ä»¶ï¼‰");
  };
  reader.readAsText(f,"utf-8");
});
byId("saveCsv").addEventListener("click", function(){
  var header=["è–¬å‰¤å","å‰¤å‹","å˜ä¾¡ï¼ˆä»•å…¥ï¼‰","å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰","å«æœ‰é‡ï¼ˆmg/mLï¼‰"];
  var rows=[header.join(",")];
  for(var i=0;i<DRUGS.length;i++){
    rows.push([DRUGS[i]["è–¬å‰¤å"],DRUGS[i]["å‰¤å‹"],DRUGS[i]["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"],DRUGS[i]["å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"]||"",DRUGS[i]["å«æœ‰é‡ï¼ˆmg/mLï¼‰"]||""].join(","));
  }
  var blob=new Blob([rows.join("\n")],{type:"text/csv"});
  var url=URL.createObjectURL(blob); var a=document.createElement("a"); a.href=url; a.download="drug_master_export.csv"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

/* åˆæœŸåŒ– */
function init(){
  refreshDatalist();
  addRow();               // â˜… åˆå›ã«å¿…ãšä¸€è¡Œè¿½åŠ 
  applyGlobalFormUI();
  recalc();
  refreshTplSelect();
  renderHistory();
  // æŠ˜ã‚ŠãŸãŸã¿ã¯åˆæœŸçŠ¶æ…‹ã§é–‰ã˜ã¦ãŠãï¼ˆé–‹ããŸã‘ã‚Œã°ä¸‹ã®1è¡Œã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
  var fold=byId("foldTools"); if(fold && fold.open) fold.open=false;
}
init();
</script>
</body>
</html>