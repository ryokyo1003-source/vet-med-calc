<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v2.3ï¼ˆiPhoneæœ€é©åŒ–ãƒ»æ··åˆåˆ†åŒ…ï¼‰</title>
<style>
:root{ --gap:14px; --fz:18px; --pad:14px; --btnh:50px; }
@media (min-width:768px){ :root{ --fz:16px; --pad:10px; --btnh:44px; } }
*{box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;margin:0;padding:16px;font-size:var(--fz);-webkit-text-size-adjust:100%;background:#fafafa}
h1{font-size:calc(var(--fz) + 2px);margin:0 0 8px 0}
.row{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center}
.col{flex:1 1 210px;min-width:210px}
input,select,button,textarea{width:100%;font-size:var(--fz);padding:var(--pad);min-height:var(--btnh);border-radius:12px;border:1px solid #d0d0d0;background:#fff}
button{background:#0a84ff;color:#fff;border:0;cursor:pointer}
button.secondary{background:#f2f2f7;color:#111;border:1px solid #d0d0d0}
button.danger{background:#ff3b30}
textarea{height:260px}
.card{border:1px solid #e5e5ea;border-radius:14px;padding:14px;margin:14px 0;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.muted{color:#666;font-size:calc(var(--fz) - 3px)}
.tabs{display:flex;gap:8px;margin-bottom:8px}
.tab{padding:10px 14px;border:1px solid #d0d0d0;border-radius:999px;background:#f2f2f7;cursor:pointer;user-select:none}
.tab.active{background:#e7f1ff;border-color:#7aa7ff}
.section{display:none}.section.active{display:block}
.drug-row{border:1px dashed #d0d0d0;border-radius:12px;padding:12px;margin:10px 0}
.actions{display:flex;gap:var(--gap);flex-wrap:wrap}
.dropdown{position:relative}
.suggest{position:absolute;top:100%;left:0;right:0;z-index:5;background:#fff;border:1px solid #d0d0d0;border-radius:10px;margin-top:6px;max-height:260px;overflow:auto;box-shadow:0 8px 20px rgba(0,0,0,.08)}
.suggest div{padding:12px;cursor:pointer}
.suggest div:hover{background:#eef5ff}
.switch{display:flex;align-items:center;gap:10px}
.stickybar{position:sticky;bottom:0;background:#fff;padding-top:8px}
kbd{background:#f2f2f7;border:1px solid #d0d0d0;border-radius:6px;padding:2px 6px}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef5ff;border:1px solid #cbdcff;color:#225}
hr{border:none;border-top:1px dashed #ddd;margin:10px 0}
</style>
</head>
<body>
<h1>è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v2.3ï¼ˆiPhoneæœ€é©åŒ–ãƒ»æ··åˆåˆ†åŒ…ï¼‰</h1>

<div class="card">
  <div class="row">
    <div class="col"><label>ä½“é‡ï¼ˆkgï¼‰</label><input type="number" id="weight" step="0.01" inputmode="decimal" placeholder="ä¾‹: 4.2"/></div>
    <div class="col"><label>æ—¥æ•°</label><input type="number" id="days" value="7" min="1" inputmode="numeric"/></div>
    <div class="col"><label>å›æ•°/æ—¥</label>
      <select id="timesPerDay"><option value="1">SIDï¼ˆ1å›/æ—¥ï¼‰</option><option value="2" selected>BIDï¼ˆ2å›/æ—¥ï¼‰</option><option value="3">TIDï¼ˆ3å›/æ—¥ï¼‰</option></select>
    </div>
  </div>
  <div class="row">
    <div class="col switch"><input type="checkbox" id="bunpo"/><label for="bunpo">åˆ†åŒ…æ©Ÿä½¿ç”¨ï¼ˆ+20å††/å›ï¼‰</label></div>
    <div class="col switch"><input type="checkbox" id="bundlePack"/><label for="bundlePack">éŒ å‰¤ã‚’åŒä¸€åŒ…ã§åˆ†åŒ…ï¼ˆåˆ†åŒ…æ–™ã¯1å›åˆ†ã®ã¿è¨ˆä¸Šï¼‰</label></div>
    <div class="col muted">ãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ ï¼š<kbd>å…±æœ‰</kbd> â†’ <kbd>ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ </kbd></div>
  </div>
  <div class="muted">è²»ç”¨ãƒ«ãƒ¼ãƒ«ï¼šå‡¦æ–¹æ–™=1å‰¤ç›®80å††/æ—¥ã€2å‰¤ç›®ä»¥é™40å††/æ—¥ï¼è–¬å‰¤æ–™=åŸä¾¡Ã—ä¿‚æ•°ï¼ˆï½10å††Ã—3ã€ï½50å††Ã—2ã€ï½100å††Ã—1.8ã€ï½500å††Ã—1.5ã€501å††ä»¥ä¸ŠÃ—1.2ï¼‰ã€10å††å˜ä½åˆ‡ã‚Šä¸Šã’ï¼åˆ†å‰²ï¼š1/2=+10å††/å›ã€1/4=+20å††/å›ï¼ã‚·ãƒ­ãƒƒãƒ—æº¶è§£=+500å††ï¼ã‚«ãƒ—ã‚»ãƒ«è©°ã‚=+800å††</div>
</div>

<div class="card">
  <div class="tabs">
    <div class="tab active" data-target="tab-tabl">éŒ å‰¤ãƒ»ã‚«ãƒ—ã‚»ãƒ«</div>
    <div class="tab" data-target="tab-syrp">ã‚·ãƒ­ãƒƒãƒ—ãƒ»ç²‰è–¬</div>
  </div>

  <!-- éŒ å‰¤ -->
  <div id="tab-tabl" class="section active">
    <div id="tabletList"></div>
    <button id="addTablet">ï¼‹ éŒ å‰¤ã‚’è¿½åŠ </button>
  </div>

  <!-- ã‚·ãƒ­ãƒƒãƒ— -->
  <div id="tab-syrp" class="section">
    <div id="syrupList"></div>
    <div class="row">
      <div class="col switch"><input type="checkbox" id="syrupDissolve"/><label for="syrupDissolve">ã‚·ãƒ­ãƒƒãƒ—ã«æº¶ã‹ã™ï¼ˆ+500å††ï¼‰</label></div>
    </div>
    <button id="addSyrup">ï¼‹ ã‚·ãƒ­ãƒƒãƒ—ãƒ»ç²‰è–¬ã‚’è¿½åŠ </button>
  </div>
</div>

<div class="card stickybar">
  <div class="row actions">
    <button id="calcBtn">è¨ˆç®—ã™ã‚‹</button>
    <button id="copyBtn" class="secondary">å‡ºåŠ›ã‚’ã‚³ãƒ”ãƒ¼</button>
    <button id="clearBtn" class="secondary">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
  <label>ğŸ“‹ ã‚«ãƒ«ãƒ†è²¼ä»˜ç”¨ å‡ºåŠ›ï¼ˆã‚³ãƒ”ãƒšï¼‰</label>
  <textarea id="output" readonly></textarea>
</div>

<div class="card">
  <h3>ğŸ“¦ è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ï¼ˆCSVï¼‰ <span class="badge">ç«¯æœ«ã«ä¿å­˜ã•ã‚Œã¾ã™</span></h3>
  <div class="row">
    <div class="col"><input type="file" id="csvInput" accept=".csv"/></div>
    <div class="col"><button id="saveCsv" class="secondary">ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’CSVä¿å­˜</button></div>
  </div>
  <div class="muted">CSVåˆ—è¦‹æœ¬ï¼šè–¬å‰¤å,å‰¤å‹,å˜ä¾¡ï¼ˆä»•å…¥ï¼‰,å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰,å«æœ‰é‡ï¼ˆmg/mLï¼‰</div>
</div>

<script>
function ceil10(y){return Math.ceil(y/10)*10}
function byId(id){return document.getElementById(id)}
const DEFAULT_DRUGS=[
  {è–¬å‰¤å:"ã‚¢ãƒ¢ã‚­ã‚·ã‚·ãƒªãƒ³",å‰¤å‹:"éŒ å‰¤","å˜ä¾¡ï¼ˆä»•å…¥ï¼‰":10,"å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰":100,"å«æœ‰é‡ï¼ˆmg/mLï¼‰":""},
  {è–¬å‰¤å:"ã‚¨ãƒ³ãƒ­ãƒ•ãƒ­ã‚­ã‚µã‚·ãƒ³",å‰¤å‹:"éŒ å‰¤","å˜ä¾¡ï¼ˆä»•å…¥ï¼‰":30,"å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰":50,"å«æœ‰é‡ï¼ˆmg/mLï¼‰":""},
  {è–¬å‰¤å:"ãƒ¡ãƒˆãƒ­ãƒ‹ãƒ€ã‚¾ãƒ¼ãƒ«",å‰¤å‹:"éŒ å‰¤","å˜ä¾¡ï¼ˆä»•å…¥ï¼‰":20,"å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰":250,"å«æœ‰é‡ï¼ˆmg/mLï¼‰":""},
  {è–¬å‰¤å:"FCVãƒªã‚­ãƒƒãƒ‰",å‰¤å‹:"ã‚·ãƒ­ãƒƒãƒ—","å˜ä¾¡ï¼ˆä»•å…¥ï¼‰":24,"å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰":"", "å«æœ‰é‡ï¼ˆmg/mLï¼‰":10},
  {è–¬å‰¤å:"ã‚¢ãƒˆãƒ”ã‚«å†…ç”¨æ¶²",å‰¤å‹:"ã‚·ãƒ­ãƒƒãƒ—","å˜ä¾¡ï¼ˆä»•å…¥ï¼‰":1000,"å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰":"", "å«æœ‰é‡ï¼ˆmg/mLï¼‰":8}
];
function loadDrugs(){const raw=localStorage.getItem("drugMasterV2");if(raw){try{return JSON.parse(raw)}catch(e){}}return DEFAULT_DRUGS}
function saveDrugs(list){localStorage.setItem("drugMasterV2",JSON.stringify(list))}
let DRUGS=loadDrugs();

document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    tab.classList.add("active");
    byId(tab.dataset.target).classList.add("active");
  });
});

function makeSuggest(nameInput, type, unitInput, costInput){
  const wrap=nameInput.parentElement, box=document.createElement("div");
  box.className="suggest"; box.style.display="none"; wrap.appendChild(box);
  function refresh(){
    const q=(nameInput.value||"").trim();
    const pool=DRUGS.filter(d=>d.å‰¤å‹===type);
    let list=pool;
    if(q){ // éƒ¨åˆ†ä¸€è‡´ï¼ˆå¤§æ–‡å­—å°æ–‡å­—ï¼†å…¨è§’åŠè§’ãã®ã¾ã¾ï¼‰
      list=pool.filter(d=>d.è–¬å‰¤å.includes(q));
    } else {
      list=pool.slice(0,100);
    }
    box.innerHTML=list.map(d=>`<div data-name="${d.è–¬å‰¤å}">${d.è–¬å‰¤å}</div>`).join("")||"<div>è©²å½“ãªã—</div>";
    box.style.display="block";
  }
  nameInput.addEventListener("input",refresh);
  nameInput.addEventListener("focus",refresh);
  document.addEventListener("click",(e)=>{ if(!wrap.contains(e.target)) box.style.display="none"; });
  box.addEventListener("click",(e)=>{
    const div=e.target.closest("div[data-name]"); if(!div) return;
    const name=div.dataset.name;
    const d=DRUGS.find(x=>x.è–¬å‰¤å===name && x.å‰¤å‹===type);
    if(d){
      nameInput.value=d.è–¬å‰¤å;
      unitInput.value=(type==="éŒ å‰¤"?d["å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"]:d["å«æœ‰é‡ï¼ˆmg/mLï¼‰"])||"";
      costInput.value=d["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"]||"";
    }
    box.style.display="none";
  });
}

function drugInputRow({type}){
  const row=document.createElement("div"); row.className="drug-row";
  row.innerHTML=`
    <div class="row">
      <div class="col dropdown"><label>è–¬å‰¤åï¼ˆ${type}ï¼‰</label><input type="text" class="drugName" placeholder="éƒ¨åˆ†ä¸€è‡´OKï¼ˆä¾‹ï¼šã‚·ãƒªãƒ³ï¼ã‚¨ãƒ³ãƒ­ï¼‰" autocomplete="off" inputmode="search"/></div>
      <div class="col"><label>${type==="éŒ å‰¤"?"å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰":"å«æœ‰é‡ï¼ˆmg/mLï¼‰"}</label><input type="number" class="unitMg" step="0.01" inputmode="decimal"/></div>
      <div class="col"><label>å˜ä¾¡ï¼ˆä»•å…¥ï¼‰${type==="éŒ å‰¤"?"ï¼ˆå††/éŒ ï¼‰":"ï¼ˆå††/mLï¼‰"}</label><input type="number" class="cost" step="0.01" inputmode="decimal"/></div>
    </div>
    <div class="row">
      <div class="col"><label>è–¬ç”¨é‡ï¼ˆmg/kgï¼‰</label><input type="number" class="dose" step="0.01" inputmode="decimal"/></div>
      <div class="col"><label>åˆ†å‰²</label><select class="split"><option value="1" selected>åˆ†å‰²ãªã—</option><option value="0.5">1/2ï¼ˆ+10å††/å›ï¼‰</option><option value="0.25">1/4ï¼ˆ+20å††/å›ï¼‰</option></select></div>
      <div class="col switch"><input type="checkbox" class="capsule"/><label>ã‚«ãƒ—ã‚»ãƒ«è©°ã‚ï¼ˆ+800å††ï¼‰</label></div>
      <div class="col"><button class="removeBtn danger">å‰Šé™¤</button></div>
    </div>
    <div class="row">
      <div class="col"><label>å‚™è€ƒ</label><input type="text" class="note" placeholder="ä¾‹ï¼šåˆ†å‰²å›°é›£ãªã©"/></div>
    </div>
  `;
  const nameInput=row.querySelector(".drugName");
  const unitInput=row.querySelector(".unitMg");
  const costInput=row.querySelector(".cost");
  makeSuggest(nameInput, type, unitInput, costInput);
  row.querySelector(".removeBtn").addEventListener("click",()=>row.remove());
  return row;
}

const tabletList=byId("tabletList"), syrupList=byId("syrupList");
function addTablet(){tabletList.appendChild(drugInputRow({type:"éŒ å‰¤"}))}
function addSyrup(){syrupList.appendChild(drugInputRow({type:"ã‚·ãƒ­ãƒƒãƒ—"}))}
byId("addTablet").addEventListener("click",addTablet);
byId("addSyrup").addEventListener("click",addSyrup);
addTablet();

byId("csvInput").addEventListener("change",(ev)=>{
  const f=ev.target.files&&ev.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=(e)=>{
    const text=e.target.result;
    const lines=text.split(/\r?\n/).filter(Boolean);
    const header=lines[0].split(",");
    function col(n){ return header.indexOf(n); }
    const idx={name:col("è–¬å‰¤å"),type:col("å‰¤å‹"),cost:col("å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"),unitTab:col("å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"),unitMl:col("å«æœ‰é‡ï¼ˆmg/mLï¼‰")};
    const list=[];
    for(let i=1;i<lines.length;i++){
      const cols=lines[i].split(",");
      if(cols.length<3) continue;
      const d={
        è–¬å‰¤å: cols[idx.name] || "",
        å‰¤å‹: cols[idx.type] || "",
        "å˜ä¾¡ï¼ˆä»•å…¥ï¼‰": parseFloat(cols[idx.cost] || "0") || 0,
        "å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰": idx.unitTab>=0 && cols[idx.unitTab]? parseFloat(cols[idx.unitTab]) : "",
        "å«æœ‰é‡ï¼ˆmg/mLï¼‰": idx.unitMl>=0 && cols[idx.unitMl]? parseFloat(cols[idx.unitMl]) : ""
      };
      if(d.è–¬å‰¤å) list.push(d);
    }
    DRUGS=list; saveDrugs(DRUGS);
    alert("è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆä»¶æ•°: "+list.length+"ï¼‰");
  };
  reader.readAsText(f,"utf-8");
});
byId("saveCsv").addEventListener("click",()=>{
  const header=["è–¬å‰¤å","å‰¤å‹","å˜ä¾¡ï¼ˆä»•å…¥ï¼‰","å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰","å«æœ‰é‡ï¼ˆmg/mLï¼‰"];
  const rows=[header.join(",")].concat(DRUGS.map(d=>[d.è–¬å‰¤å,d.å‰¤å‹,d["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"],d["å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"],d["å«æœ‰é‡ï¼ˆmg/mLï¼‰"]].join(",")));
  const blob=new Blob([rows.join("\n")],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="drug_master_export.csv"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

function markupFor(p){ if(p<=10) return 3; if(p<=50) return 2; if(p<=100) return 1.8; if(p<=500) return 1.5; return 1.2; }

function calcSection(type,container, opts){
  const days=parseInt(byId("days").value||"0");
  const timesPerDay=parseInt(byId("timesPerDay").value||"0");
  const weight=parseFloat(byId("weight").value||"0");
  const bunpo = byId("bunpo").checked;
  const bundlePack = byId("bundlePack").checked;
  let text=""; let subtotal=0; let packFee=0; let splitFee=0; let capsuleFee=0; let itemsCount=0;
  let needsPackOnce=false;

  container.querySelectorAll(".drug-row").forEach(row=>{
    const name=row.querySelector(".drugName").value.trim();
    const unitMg=parseFloat(row.querySelector(".unitMg").value||"0");
    const cost=parseFloat(row.querySelector(".cost").value||"0");
    const dose=parseFloat(row.querySelector(".dose").value||"0");
    const split=parseFloat(row.querySelector(".split").value||"1");
    const capsule=row.querySelector(".capsule")?.checked;
    if(!name||!unitMg||!cost||!dose||!weight||!days||!timesPerDay) return;

    const mgPerDose = weight * dose;              // 1å›æŠ•ä¸ mg
    const totalMg = mgPerDose * timesPerDay * days;

    if(type==="éŒ å‰¤"){
      const tabletCount = Math.ceil(totalMg / unitMg);  // ç«¯æ•°ã¯å»ƒæ£„â†’åˆ‡ä¸Šã’
      const pricePer = ceil10(cost * markupFor(cost));
      const drugCost = pricePer * tabletCount;

      // åˆ†åŒ…ï¼šåŒä¸€åŒ…ã§åˆ†åŒ…ONãªã‚‰ã€ä¸€æ‹¬ã§å¾Œè¨ˆç®—ã€‚å€‹åˆ¥ãªã‚‰ã“ã“ã§è¨ˆä¸Š
      let thisPack = 0;
      if(bunpo){
        if(bundlePack){ needsPackOnce = true; } else { thisPack = (20 * timesPerDay * days); }
      }

      let thisSplitFee = 0;
      if(split===0.5) thisSplitFee = 10 * (timesPerDay * days);
      if(split===0.25) thisSplitFee = 20 * (timesPerDay * days);

      const thisCapsuleFee = capsule ? 800 : 0;

      subtotal += drugCost; packFee += thisPack; splitFee += thisSplitFee; capsuleFee += thisCapsuleFee; itemsCount++;

      text += `ã€éŒ å‰¤ã€‘${name} ${unitMg}mg/éŒ 
${dose}mg/kg Ã— ${timesPerDay}å› Ã— ${days}æ—¥åˆ†ï¼ˆä½“é‡ï¼š${weight}kgï¼‰
â†’ å¿…è¦é‡ï¼š${Math.round(totalMg)}mgï¼ˆ${tabletCount}éŒ ï¼‰
è–¬å‰¤æ–™ï¼š${drugCost}å††ï¼ˆ${pricePer}å††/éŒ  Ã— ${tabletCount}éŒ ï¼‰
`;
      if(thisPack>0) text += `åˆ†åŒ…æ–™ï¼š${thisPack}å††\n`;
      if(thisSplitFee>0) text += `åˆ†å‰²æ–™ï¼š${thisSplitFee}å††\n`;
      if(thisCapsuleFee>0) text += `ã‚«ãƒ—ã‚»ãƒ«è©°ã‚ï¼š${thisCapsuleFee}å††\n`;
      text += `\n`;
    }else{
      const totalMl = totalMg / unitMg;
      const mlCount = Math.ceil(totalMl * 100) / 100;   // 0.01mLå˜ä½åˆ‡ä¸Šã’
      const pricePer = ceil10(cost * markupFor(cost));
      const drugCost = Math.ceil(pricePer * mlCount);   // é‡‘é¡ã¯å††å˜ä½åˆ‡ä¸Šã’
      subtotal += drugCost; itemsCount++;

      text += `ã€ã‚·ãƒ­ãƒƒãƒ—ã€‘${name} ${unitMg}mg/mL
${dose}mg/kg Ã— ${timesPerDay}å› Ã— ${days}æ—¥åˆ†ï¼ˆä½“é‡ï¼š${weight}kgï¼‰
â†’ å¿…è¦é‡ï¼š${Math.round(totalMg)}mgï¼ˆç´„${mlCount.toFixed(2)}mLï¼‰
è–¬å‰¤æ–™ï¼š${drugCost}å††ï¼ˆ${pricePer}å††/mL Ã— ${mlCount.toFixed(2)}mLï¼‰

`;
    }
  });

  // åŒä¸€åŒ…ã§åˆ†åŒ…ï¼šä¸€æ‹¬ã§åŠ ç®—ï¼ˆéŒ å‰¤ã®ç·å›æ•°åˆ†ã ã‘ï¼‰
  if(opts?.isTabletSection && bunpo && byId("bundlePack").checked){
    const days=parseInt(byId("days").value||"0");
    const tpd=parseInt(byId("timesPerDay").value||"0");
    if(needsPackOnce){ packFee += (20 * tpd * days); }
  }

  return { text, subtotal, packFee, splitFee, capsuleFee, itemsCount };
}

byId("calcBtn").addEventListener("click",()=>{
  const days=parseInt(byId("days").value||"0");
  const tablet = calcSection("éŒ å‰¤", byId("tabletList"), { isTabletSection:true });
  const syrup = calcSection("ã‚·ãƒ­ãƒƒãƒ—", byId("syrupList"));
  const syrupDissolve = byId("syrupDissolve").checked ? 500 : 0;

  const itemsTotal = tablet.itemsCount + syrup.itemsCount;
  let scriptFee = 0;
  if(itemsTotal > 0){ scriptFee = 80 * days + 40 * days * (itemsTotal - 1); }

  const total = tablet.subtotal + syrup.subtotal
              + tablet.packFee + tablet.splitFee + tablet.capsuleFee
              + scriptFee + syrupDissolve;

  let out = "";
  out += tablet.text;
  if(byId("bunpo").checked && byId("bundlePack").checked){ out += `â€»æ··åˆåˆ†åŒ…ï¼šåˆ†åŒ…æ–™ã¯åŒä¸€åŒ…ã¨ã—ã¦ä¸€æ‹¬è¨ˆä¸Šï¼ˆ20å††Ã—å›æ•°Ã—æ—¥æ•°ï¼‰\n\n`; }
  out += syrup.text;
  if(syrupDissolve) out += `ã€èª¿å‰¤ã€‘ã‚·ãƒ­ãƒƒãƒ—æº¶è§£ï¼š${syrupDissolve}å††\n\n`;

  out += `å‡¦æ–¹æ–™ï¼š${scriptFee}å††\n`;
  if(tablet.packFee>0) out += `åˆ†åŒ…æ–™åˆè¨ˆï¼š${tablet.packFee}å††\n`;
  if(tablet.splitFee>0) out += `åˆ†å‰²æ–™åˆè¨ˆï¼š${tablet.splitFee}å††\n`;
  if(tablet.capsuleFee>0) out += `ã‚«ãƒ—ã‚»ãƒ«è©°ã‚åˆè¨ˆï¼š${tablet.capsuleFee}å††\n`;
  out += `â€”â€”â€”\nåˆè¨ˆï¼š${total}å††`;

  byId("output").value = out.trim();
});

byId("copyBtn").addEventListener("click",async()=>{
  const ta=byId("output");
  try{ await navigator.clipboard.writeText(ta.value); alert("å‡ºåŠ›ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚"); }
  catch(e){ ta.focus(); ta.select(); document.execCommand("copy"); alert("å‡ºåŠ›ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚"); }
});
byId("clearBtn").addEventListener("click",()=>{ localStorage.removeItem("drugMasterV2"); location.reload(); });
</script>
</body>
</html>
