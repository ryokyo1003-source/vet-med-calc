<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v3.7ï¼ˆãƒ‡ãƒãƒƒã‚°æ¸ˆã¿ï¼‰</title>
<style>
*{box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;margin:0;padding:16px;background:#fafafa}
h1{margin:0 0 12px;font-size:18px}
.card{background:#fff;border:1px solid #e5e5ea;border-radius:12px;padding:12px;margin:12px 0;box-shadow:0 1px 3px rgba(0,0,0,0.05)}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1 1 240px;min-width:240px}
input,select,button,textarea{width:100%;padding:10px;border:1px solid #d0d0d0;border-radius:10px;background:#fff;font-size:16px;transition:all 0.2s}
input:focus,select:focus{outline:none;border-color:#0a84ff;box-shadow:0 0 0 3px rgba(10,132,255,0.1)}
button{background:#0a84ff;color:#fff;border:0;cursor:pointer;font-weight:500}
button:hover{background:#0970d9}
button:active{transform:scale(0.98)}
button.secondary{background:#f2f2f7;color:#111;border:1px solid #d0d0d0}
button.secondary:hover{background:#e5e5ea}
button.danger{background:#ff3b30}
button.danger:hover{background:#e5342b}
button.ghost{background:#fff;color:#0a84ff;border:1px solid #bcd6ff}
button.ghost:hover{background:#f0f7ff}
.drug-row{border:1px dashed #d0d0d0;border-radius:10px;padding:10px;margin:10px 0;background:#fafbfc}
.drug-row:hover{background:#f5f7fa}
pre.readonly{white-space:pre-wrap;background:#fcfcfd;border:1px solid #eee;border-radius:10px;padding:10px;min-height:100px;font-family:ui-monospace,Menlo,monospace;line-height:1.5}
.input-wrap{position:relative}

/* ã‚µã‚¸ã‚§ã‚¹ãƒˆ */
.suggest{position:absolute;z-index:9999;background:#fff;border:1px solid #d0d0d0;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.15);overflow:auto;max-height:220px;display:none;top:100%;left:0;right:0;margin-top:2px}
.suggest-item{padding:8px 12px;cursor:pointer;border-bottom:1px solid #f0f0f0}
.suggest-item:last-child{border-bottom:none}
.suggest-item:hover,.suggest-item.active{background:#eef5ff}

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
.status{padding:8px 12px;border-radius:8px;background:#e8f4fd;color:#0a84ff;font-size:14px;margin-top:8px}
.status.success{background:#d4f4dd;color:#34c759}
.status.error{background:#ffe5e5;color:#ff3b30}

/* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
@media (min-width:1100px){
  .layout{display:grid;grid-template-columns:1.1fr 1fr;gap:16px}
  .panel-left{position:sticky;top:8px;align-self:start;max-height:calc(100vh - 16px);overflow:auto}
  .panel-right{max-height:calc(100vh - 16px);overflow:auto}
}

.small{font-size:13px;color:#666}
label{display:block;margin-bottom:4px;font-size:14px;color:#333;font-weight:500}
details summary{cursor:pointer;font-weight:600;margin-bottom:8px}
details summary:hover{color:#0a84ff}
hr{border:0;border-top:1px solid #e5e5ea;margin:12px 0}

/* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
.drug-row{animation:fadeIn 0.3s ease}
</style>
</head>
<body>
<h1>ğŸ¥ è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v3.7ï¼ˆãƒ‡ãƒãƒƒã‚°æ¸ˆã¿ï¼‰</h1>

<div class="layout">
  <!-- å·¦ãƒ‘ãƒãƒ«ï¼šå…¥åŠ› -->
  <div class="panel-left">
    <div class="card">
      <h3>ğŸ“Š åŸºæœ¬æƒ…å ±</h3>
      <div class="row">
        <div class="col">
          <label>ä½“é‡ï¼ˆkgï¼‰</label>
          <input type="number" id="weight" step="0.01" placeholder="ä¾‹: 5.5"/>
        </div>
        <div class="col">
          <label>æ—¥æ•°</label>
          <input type="number" id="days" value="7" min="1"/>
        </div>
        <div class="col">
          <label>å›æ•°/æ—¥</label>
          <select id="timesPerDay">
            <option value="1">SIDï¼ˆ1å›/æ—¥ï¼‰</option>
            <option value="2" selected>BIDï¼ˆ2å›/æ—¥ï¼‰</option>
            <option value="3">TIDï¼ˆ3å›/æ—¥ï¼‰</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>å‡¦æ–¹å½¢æ…‹ï¼ˆå…¨ä½“ï¼‰</label>
          <select id="globalForm">
            <option value="TAB" selected>éŒ å‰¤ï¼ˆTABï¼‰</option>
            <option value="POWDER">æ•£å‰¤ï¼ˆç²‰è–¬ï¼‰</option>
          </select>
        </div>
        <div class="col">
          <label style="margin-top:24px">
            <input type="checkbox" id="bunpo" style="width:auto;margin-right:8px">
            åˆ†åŒ…ï¼ˆå…¨ä½“ä¸€æ‹¬ +20å††/å›ï¼‰
          </label>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>ğŸ’Š è–¬å‰¤å…¥åŠ›</h3>
      <div id="tabletList"></div>
      <div class="row">
        <div class="col"><button id="addDrug">ï¼‹ è–¬å‰¤ã‚’è¿½åŠ </button></div>
        <div class="col"><button id="clearAll" class="ghost">å…¥åŠ›ã‚¯ãƒªã‚¢</button></div>
      </div>
    </div>

    <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼†CSVç®¡ç† -->
    <div class="card">
      <details open>
        <summary>ğŸ“¦ å‡¦æ–¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ & ãƒ‡ãƒ¼ã‚¿ç®¡ç†</summary>
        <div class="row" style="margin-top:8px">
          <div class="col">
            <label>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå</label>
            <input id="tplName" placeholder="ä¾‹ï¼šä¸‹ç—¢æ­¢ã‚ã‚»ãƒƒãƒˆ"/>
          </div>
          <div class="col">
            <label>&nbsp;</label>
            <div class="row" style="gap:6px">
              <button id="saveTpl" style="flex:1">ä¿å­˜</button>
              <button id="overwriteTpl" class="secondary" style="flex:1">ä¸Šæ›¸ã</button>
            </div>
          </div>
        </div>
        <div class="row" style="margin-top:6px">
          <div class="col">
            <label>ä¿å­˜æ¸ˆã¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</label>
            <select id="tplSelect">
              <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
            </select>
          </div>
          <div class="col">
            <label>&nbsp;</label>
            <div class="row" style="gap:6px">
              <button id="loadTpl" class="secondary" style="flex:1">èª­è¾¼</button>
              <button id="deleteTpl" class="danger" style="flex:1">å‰Šé™¤</button>
            </div>
          </div>
        </div>
        <hr/>
        <div class="row">
          <div class="col">
            <label class="small">è–¬å‰¤CSVã‚’èª­ã¿è¾¼ã¿ï¼ˆåˆ—ï¼šè–¬å‰¤å, å‰¤å‹, å˜ä¾¡ï¼ˆä»•å…¥ï¼‰, å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰, å«æœ‰é‡ï¼ˆmg/mLï¼‰ï¼‰</label>
            <input type="file" id="csvInput" accept=".csv"/>
          </div>
          <div class="col">
            <label>&nbsp;</label>
            <button id="exportCsv" class="secondary">ç¾åœ¨ã®è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãå‡ºã—</button>
          </div>
        </div>
        <div class="status" id="csvStatus"></div>
      </details>
    </div>
  </div>

  <!-- å³ãƒ‘ãƒãƒ«ï¼šå‡ºåŠ› -->
  <div class="panel-right">
    <div class="card">
      <h3>ğŸ”§ å‡ºåŠ›æ“ä½œ</h3>
      <div class="row">
        <div class="col"><button id="copySimple" class="secondary">ğŸ“‹ ç°¡æ˜“ç‰ˆã‚’ã‚³ãƒ”ãƒ¼</button></div>
        <div class="col"><button id="copyDetail" class="secondary">ğŸ“Š è©³ç´°ç‰ˆã‚’ã‚³ãƒ”ãƒ¼</button></div>
      </div>
    </div>
    
    <div class="card">
      <h3>ğŸ“‹ ã‚«ãƒ«ãƒ†è²¼ä»˜ç”¨ï¼ˆç°¡æ˜“ç‰ˆï¼‰</h3>
      <pre id="outputSimple" class="readonly">ã¾ã è¨ˆç®—ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
å·¦å´ã§å¿…è¦ãªæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</pre>
    </div>
    
    <div class="card">
      <h3>ğŸ§® è¨ˆç®—æ ¹æ‹ ï¼ˆè©³ç´°ç‰ˆï¼‰</h3>
      <pre id="outputDetail" class="readonly">ã¾ã è¨ˆç®—ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
å·¦å´ã§å¿…è¦ãªæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</pre>
    </div>
  </div>
</div>

<script>
/**
 * è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v3.8
 * 
 * æ–°æ©Ÿèƒ½ï¼ˆv3.8ï¼‰:
 * - è–¬å‰¤åã‹ã‚‰å«æœ‰é‡ã‚’è‡ªå‹•æŠ½å‡º
 *   ä¾‹ï¼šã€Œãƒã‚¤ãƒˆãƒªãƒ«15mgã€â†’ å«æœ‰é‡15ã‚’è‡ªå‹•å…¥åŠ›
 *   å¯¾å¿œå˜ä½ï¼šmg, g, Î¼g, mcg, ml, mL
 * - CSVèª­ã¿è¾¼ã¿æ™‚ã‚‚è‡ªå‹•æŠ½å‡ºå¯¾å¿œ
 * - æ‰‹å‹•å…¥åŠ›æ™‚ã‚‚è‡ªå‹•æŠ½å‡ºå¯¾å¿œ
 */

/* ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ====== */
function byId(id) { return document.getElementById(id); }
function ceil10(y) { return Math.ceil(y / 10) * 10; }
function ceilYen(y) { return Math.ceil(y); }
function markupFor(p) { 
  if (p <= 10) return 3; 
  if (p <= 50) return 2; 
  if (p <= 100) return 1.8; 
  if (p <= 500) return 1.5; 
  return 1.2; 
}

/* å…¨è§’â†’åŠè§’å¤‰æ› + å˜ä½é™¤å»ã—ã¦æ•°å€¤åŒ– */
function toNumber(v) {
  if (v == null) return NaN;
  var s = String(v).trim()
    .replace(/[ï¼-ï¼™]/g, function(ch) { return String.fromCharCode(ch.charCodeAt(0) - 0xFEE0); })
    .replace(/[ï¼ï¼Œ]/g, function(ch) { return ch === 'ï¼' ? '.' : ','; })
    .replace(/[^0-9\.\-]/g, ''); // mgã€å††ãªã©é™¤å»
  if (s === '') return NaN;
  return parseFloat(s);
}

/* ====== ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼ ====== */
var KEY_MASTER = "drugMasterSimple";
var KEY_TPL = "rxTemplatesV1";

/* ====== CSVè–¬å‰¤ãƒã‚¹ã‚¿ãƒ¼ç®¡ç† ====== */
var DRUGS = (function() { 
  try { 
    return JSON.parse(localStorage.getItem(KEY_MASTER)) || []; 
  } catch(e) { 
    console.error("è–¬å‰¤ãƒã‚¹ã‚¿ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
    return []; 
  } 
})();

function saveDrugs(list) { 
  try { 
    localStorage.setItem(KEY_MASTER, JSON.stringify(list)); 
  } catch(e) {
    console.error("è–¬å‰¤ãƒã‚¹ã‚¿ãƒ¼ä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
    alert("è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  } 
}

function updateCsvStatus() { 
  var statusEl = byId("csvStatus");
  var count = DRUGS.length || 0;
  statusEl.textContent = "è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ï¼š" + count + "ä»¶ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ä¿å­˜ï¼‰";
  statusEl.className = count > 0 ? "status success" : "status";
}

/* ====== ã‚µã‚¸ã‚§ã‚¹ãƒˆæ©Ÿèƒ½ï¼ˆè–¬å‰¤åè‡ªå‹•è£œå®Œï¼‰ ====== */
function attachAutocomplete(input, unitEl, costEl) {
  var box = document.createElement("div");
  box.className = "suggest";
  input.parentNode.appendChild(box);
  var active = -1;
  
  function close() { 
    box.style.display = "none"; 
    box.innerHTML = ""; 
    active = -1; 
  }
  
  function open() { 
    box.style.display = "block"; 
  }
  
  function render(list) {
    box.innerHTML = "";
    if (list.length === 0) {
      close();
      return;
    }
    
    list.forEach(function(name) {
      var div = document.createElement("div");
      div.className = "suggest-item";
      div.textContent = name;
      div.addEventListener("mousedown", function(e) { 
        e.preventDefault(); 
        select(name); 
      });
      box.appendChild(div);
    });
    open();
  }
  
  function filter(q) {
    q = (q || "").trim().toLowerCase();
    if (!q) { 
      close(); 
      return; 
    }
    
    var names = DRUGS.map(function(d) { return d["è–¬å‰¤å"]; }).filter(Boolean);
    var starts = names.filter(function(n) { return n.toLowerCase().indexOf(q) === 0; });
    var contains = names.filter(function(n) { return n.toLowerCase().indexOf(q) > 0; });
    var all = starts.concat(contains)
      .filter(function(v, i, a) { return a.indexOf(v) === i; })
      .slice(0, 80);
    render(all);
  }
  
  function select(val) {
    input.value = val;
    var rec = null;
    for (var i = 0; i < DRUGS.length; i++) { 
      if (DRUGS[i]["è–¬å‰¤å"] === val) { 
        rec = DRUGS[i]; 
        break; 
      } 
    }
    
    if (rec) {
      if (byId("globalForm").value === "TAB") { 
        unitEl.value = rec["å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"] || ""; 
        costEl.value = rec["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"] || ""; 
      } else { 
        unitEl.value = rec["å«æœ‰é‡ï¼ˆmg/mLï¼‰"] || ""; 
        costEl.value = rec["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"] || ""; 
      }
    }
    close();
    recalc();
  }
  
  input.addEventListener("input", function() { filter(input.value); });
  input.addEventListener("focus", function() { if (input.value) filter(input.value); });
  input.addEventListener("blur", function() { setTimeout(close, 200); });
  
  input.addEventListener("keydown", function(e) {
    var items = box.querySelectorAll(".suggest-item");
    if (e.key === "ArrowDown") { 
      if (items.length) { 
        active = (active + 1) % items.length; 
        for (var i = 0; i < items.length; i++) {
          items[i].classList.toggle("active", i === active);
        }
        e.preventDefault(); 
      } 
    } else if (e.key === "ArrowUp") { 
      if (items.length) { 
        active = (active - 1 + items.length) % items.length; 
        for (var i = 0; i < items.length; i++) {
          items[i].classList.toggle("active", i === active);
        }
        e.preventDefault(); 
      } 
    } else if (e.key === "Enter") { 
      if (active >= 0 && items[active]) { 
        select(items[active].textContent); 
        e.preventDefault(); 
      } 
    } else if (e.key === "Escape") { 
      close(); 
    }
  });
}

/* ====== è–¬å‰¤è¡Œã®ä½œæˆã¨ç®¡ç† ====== */
var listEl = byId("tabletList");

function makeRow(data) {
  var row = document.createElement("div");
  row.className = "drug-row";
  row.innerHTML =
    '<div class="row">' +
      '<div class="col"><label>è–¬å‰¤å</label><div class="input-wrap"><input class="drugName" placeholder="é¸æŠã¾ãŸã¯å…¥åŠ›"/></div></div>' +
      '<div class="col"><label class="unitLabel">å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰</label><input type="number" class="unitMg" step="0.01" placeholder="ä¾‹: 10"/></div>' +
      '<div class="col"><label class="costLabel">å˜ä¾¡ï¼ˆå††/éŒ ï¼‰</label><input type="number" class="cost" step="0.01" placeholder="ä¾‹: 50"/></div>' +
    '</div>' +
    '<div class="row">' +
      '<div class="col"><label>è–¬ç”¨é‡ï¼ˆmg/kgï¼‰</label><input type="number" class="dose" step="0.01" placeholder="ä¾‹: 0.5"/></div>' +
      '<div class="col"><label>&nbsp;</label><button class="removeBtn danger">å‰Šé™¤</button></div>' +
    '</div>';
    
  var nameEl = row.querySelector(".drugName");
  var unitEl = row.querySelector(".unitMg");
  var costEl = row.querySelector(".cost");
  var doseEl = row.querySelector(".dose");
  
  attachAutocomplete(nameEl, unitEl, costEl);
  
  row.querySelector(".removeBtn").addEventListener("click", function() { 
    if (listEl.children.length > 1 || confirm("æœ€å¾Œã®è–¬å‰¤è¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
      row.remove(); 
      recalc(); 
    }
  });
  
  var inputs = row.querySelectorAll("input");
  for (var i = 0; i < inputs.length; i++) { 
    inputs[i].addEventListener("input", recalc); 
  }
  
  if (data) {
    nameEl.value = data.name || "";
    unitEl.value = (data.unit != null ? data.unit : "");
    costEl.value = (data.cost != null ? data.cost : "");
    doseEl.value = (data.dose != null ? data.dose : "");
  }
  
  return row;
}

function addRow(data) { 
  listEl.appendChild(makeRow(data)); 
  updateFormLabels();
  recalc(); 
}

/* ====== ãƒ©ãƒ™ãƒ«æ›´æ–°ï¼ˆéŒ å‰¤/æ•£å‰¤ï¼‰ ====== */
function updateFormLabels() {
  var isTab = byId("globalForm").value === "TAB";
  Array.prototype.forEach.call(document.querySelectorAll(".unitLabel"), function(el) {
    el.textContent = isTab ? "å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰" : "å«æœ‰é‡ï¼ˆmg/mLï¼‰";
  });
  Array.prototype.forEach.call(document.querySelectorAll(".costLabel"), function(el) {
    el.textContent = isTab ? "å˜ä¾¡ï¼ˆå††/éŒ ï¼‰" : "å˜ä¾¡ï¼ˆå††/mLï¼‰";
  });
}

/* ====== ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç† ====== */
function loadTemplates() { 
  try { 
    return JSON.parse(localStorage.getItem(KEY_TPL)) || []; 
  } catch(e) { 
    console.error("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
    return []; 
  } 
}

function saveTemplates(arr) { 
  try { 
    localStorage.setItem(KEY_TPL, JSON.stringify(arr)); 
  } catch(e) {
    console.error("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
    alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
  } 
}

function refreshTplSelect() {
  var sel = byId("tplSelect");
  if (!sel) return;
  
  var arr = loadTemplates();
  sel.innerHTML = '<option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>';
  
  for (var i = 0; i < arr.length; i++) { 
    var o = document.createElement("option");
    o.value = i;
    o.textContent = arr[i].name;
    sel.appendChild(o);
  }
}

function currentFormData() {
  var items = [], rows = listEl.querySelectorAll(".drug-row");
  for (var i = 0; i < rows.length; i++) {
    items.push({
      name: rows[i].querySelector(".drugName").value.trim(),
      unit: toNumber(rows[i].querySelector(".unitMg").value),
      cost: toNumber(rows[i].querySelector(".cost").value),
      dose: toNumber(rows[i].querySelector(".dose").value)
    });
  }
  
  return {
    name: byId("tplName").value.trim(),
    mode: byId("globalForm").value,
    bunpo: byId("bunpo").checked,
    days: parseInt(byId("days").value || "0", 10),
    tpd: parseInt(byId("timesPerDay").value || "0", 10),
    weight: toNumber(byId("weight").value),
    items: items.filter(function(x) { return x.name; })
  };
}

function applyFormData(data) {
  if (!data) return;
  
  byId("globalForm").value = data.mode || "TAB";
  byId("bunpo").checked = !!data.bunpo;
  if (data.days) byId("days").value = data.days;
  if (data.tpd) byId("timesPerDay").value = data.tpd;
  if (data.weight) byId("weight").value = data.weight;
  
  listEl.innerHTML = "";
  var its = data.items || [];
  if (its.length === 0) { 
    addRow(); 
  } else { 
    for (var i = 0; i < its.length; i++) { 
      addRow(its[i]); 
    } 
  }
  updateFormLabels();
  recalc();
}

/* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ“ä½œã‚¤ãƒ™ãƒ³ãƒˆ */
byId("saveTpl").addEventListener("click", function() {
  var data = currentFormData();
  if (!data.name) { 
    alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); 
    return; 
  }
  
  var arr = loadTemplates();
  for (var i = 0; i < arr.length; i++) { 
    if (arr[i].name === data.name) { 
      alert("åŒåã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚\nã€ä¸Šæ›¸ãã€ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚"); 
      return; 
    } 
  }
  
  arr.push(data);
  saveTemplates(arr);
  refreshTplSelect();
  alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ" + data.name + "ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
});

byId("overwriteTpl").addEventListener("click", function() {
  var data = currentFormData();
  if (!data.name) { 
    alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); 
    return; 
  }
  
  var arr = loadTemplates();
  var idx = -1;
  for (var i = 0; i < arr.length; i++) { 
    if (arr[i].name === data.name) { 
      idx = i; 
      break; 
    } 
  }
  
  if (idx < 0) { 
    alert("åŒåã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); 
    return; 
  }
  
  if (!confirm("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ" + data.name + "ã€ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ")) return;
  
  arr[idx] = data;
  saveTemplates(arr);
  refreshTplSelect();
  alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ" + data.name + "ã€ã‚’ä¸Šæ›¸ãã—ã¾ã—ãŸ");
});

byId("loadTpl").addEventListener("click", function() {
  var arr = loadTemplates();
  var idx = parseInt(byId("tplSelect").value || "-1", 10);
  
  if (!(idx >= 0 && arr[idx])) { 
    alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„"); 
    return; 
  }
  
  if (!confirm("ç¾åœ¨ã®å…¥åŠ›å†…å®¹ã‚’ç ´æ£„ã—ã¦ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ" + arr[idx].name + "ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ")) return;
  
  byId("tplName").value = arr[idx].name;
  applyFormData(arr[idx]);
});

byId("deleteTpl").addEventListener("click", function() {
  var arr = loadTemplates();
  var idx = parseInt(byId("tplSelect").value || "-1", 10);
  
  if (!(idx >= 0 && arr[idx])) { 
    alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„"); 
    return; 
  }
  
  if (!confirm("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ" + arr[idx].name + "ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) return;
  
  var name = arr[idx].name;
  arr.splice(idx, 1);
  saveTemplates(arr);
  refreshTplSelect();
  alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ" + name + "ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
});

/* ====== CSVèª­ã¿è¾¼ã¿/æ›¸ãå‡ºã— ====== */
byId("csvInput").addEventListener("change", function(ev) {
  var f = ev.target.files && ev.target.files[0];
  if (!f) return;
  
  var r = new FileReader();
  r.onload = function(e) {
    try {
      var text = e.target.result;
      var lines = text.split(/\r?\n/).filter(function(x) { return x.trim(); });
      
      if (lines.length < 2) { 
        alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã€ã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™"); 
        return; 
      }
      
      var header = lines[0].split(",");
      
      function idxOf(col) {
        var i = header.indexOf(col);
        if (i >= 0) return i;
        // ã‚¹ãƒšãƒ¼ã‚¹é™¤å»ã—ã¦å†æ¤œç´¢
        for (var k = 0; k < header.length; k++) { 
          if (header[k].replace(/\s/g, "") === col.replace(/\s/g, "")) return k; 
        }
        return -1;
      }
      
      var idx = {
        name: idxOf("è–¬å‰¤å"),
        type: idxOf("å‰¤å‹"),
        cost: idxOf("å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"),
        unitTab: idxOf("å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"),
        unitMl: idxOf("å«æœ‰é‡ï¼ˆmg/mLï¼‰")
      };
      
      if (idx.name < 0) {
        alert("CSVã«ã€Œè–¬å‰¤åã€åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        return;
      }
      
      var list = [];
      for (var i = 1; i < lines.length; i++) {
        var c = lines[i].split(",");
        var rec = {
          "è–¬å‰¤å": c[idx.name] || "",
          "å‰¤å‹": c[idx.type] || "",
          "å˜ä¾¡ï¼ˆä»•å…¥ï¼‰": toNumber(c[idx.cost]),
          "å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰": (idx.unitTab >= 0 && c[idx.unitTab]) ? toNumber(c[idx.unitTab]) : "",
          "å«æœ‰é‡ï¼ˆmg/mLï¼‰": (idx.unitMl >= 0 && c[idx.unitMl]) ? toNumber(c[idx.unitMl]) : ""
        };
        if (rec["è–¬å‰¤å"]) list.push(rec);
      }
      
      if (list.length === 0) {
        alert("æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
        return;
      }
      
      DRUGS = list;
      saveDrugs(DRUGS);
      updateCsvStatus();
      alert("è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ" + list.length + "ä»¶ï¼‰");
      
    } catch(err) {
      console.error("CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
      alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    }
  };
  r.readAsText(f, "utf-8");
});

byId("exportCsv").addEventListener("click", function() {
  if (DRUGS.length === 0) {
    alert("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
    return;
  }
  
  var header = ["è–¬å‰¤å", "å‰¤å‹", "å˜ä¾¡ï¼ˆä»•å…¥ï¼‰", "å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰", "å«æœ‰é‡ï¼ˆmg/mLï¼‰"];
  var rows = [header.join(",")];
  
  for (var i = 0; i < DRUGS.length; i++) {
    rows.push([
      DRUGS[i]["è–¬å‰¤å"],
      DRUGS[i]["å‰¤å‹"] || "",
      DRUGS[i]["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"] || 0,
      DRUGS[i]["å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"] || "",
      DRUGS[i]["å«æœ‰é‡ï¼ˆmg/mLï¼‰"] || ""
    ].join(","));
  }
  
  var blob = new Blob([rows.join("\n")], {type: "text/csv;charset=utf-8"});
  var url = URL.createObjectURL(blob);
  var a = document.createElement("a");
  a.href = url;
  a.download = "drug_master_export_" + new Date().toISOString().slice(0, 10) + ".csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

/* ====== è²»ç”¨è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ====== */
function optimizeTablets(totalMg, unitMg) {
  if (!(unitMg > 0)) return {billed: 0, achievedMg: 0, split: ""};
  
  // 1/4éŒ å˜ä½ã§ã®è¨ˆç®—
  var q = Math.ceil(totalMg / (unitMg / 4));
  var billed = Math.ceil(q / 4);
  var achieved = billed * unitMg;
  var split = "";
  
  if (q % 4 === 2) split = "1/2";
  if (q % 4 === 1 || q % 4 === 3) split = "1/4";
  
  return {billed: billed, achievedMg: achieved, split: split};
}

function calcAll() {
  var days = parseInt(byId("days").value || "0", 10);
  var tpd = parseInt(byId("timesPerDay").value || "0", 10);
  var doses = tpd * days;
  var weight = toNumber(byId("weight").value);
  var mode = byId("globalForm").value;
  var bunpo = byId("bunpo").checked;
  
  // åŸºæœ¬æƒ…å ±ãƒã‚§ãƒƒã‚¯
  if (!weight || weight <= 0) {
    return {
      simple: "ä½“é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
      detail: "è¨ˆç®—ã«å¿…è¦ãªæƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚\nä½“é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"
    };
  }
  
  if (!days || days <= 0) {
    return {
      simple: "æ—¥æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
      detail: "è¨ˆç®—ã«å¿…è¦ãªæƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚\næ—¥æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"
    };
  }
  
  var subtotal = 0, items = 0, splitFee = 0, packFee = 0, scriptFee = 0;
  var detail = "", simpleLines = [];
  
  var rows = listEl.querySelectorAll(".drug-row");
  var hasValidDrug = false;
  
  for (var i = 0; i < rows.length; i++) {
    var name = rows[i].querySelector(".drugName").value.trim();
    var unit = toNumber(rows[i].querySelector(".unitMg").value);
    var cost = toNumber(rows[i].querySelector(".cost").value);
    var dose = toNumber(rows[i].querySelector(".dose").value);
    
    // è–¬å‰¤æƒ…å ±ã®æ¤œè¨¼
    if (!name) continue;
    
    if (!(isFinite(unit) && unit > 0)) {
      detail += "âš ï¸ " + name + "ï¼šå«æœ‰é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\n\n";
      continue;
    }
    
    if (!(isFinite(cost) && cost > 0)) {
      detail += "âš ï¸ " + name + "ï¼šå˜ä¾¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\n\n";
      continue;
    }
    
    if (!(isFinite(dose) && dose > 0)) {
      detail += "âš ï¸ " + name + "ï¼šè–¬ç”¨é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\n\n";
      continue;
    }
    
    hasValidDrug = true;
    var mgPerDose = weight * dose;
    var totalMg = mgPerDose * doses;
    var pricePer = ceil10(cost * markupFor(cost));
    
    if (mode === "TAB") {
      var opt = optimizeTablets(totalMg, unit);
      var drugCost = ceilYen(pricePer * opt.billed);
      subtotal += drugCost;
      items++;
      
      if (opt.split === "1/2") splitFee += 10 * doses;
      if (opt.split === "1/4") splitFee += 20 * doses;
      
      detail += "ã€éŒ å‰¤ã€‘" + name + " " + unit + "mg/éŒ \n" +
                dose + "mg/kg Ã— " + tpd + "å› Ã— " + days + "æ—¥åˆ†ï¼ˆä½“é‡ï¼š" + weight + "kgï¼‰\n" +
                "â†’ å¿…è¦é‡ï¼š" + Math.round(totalMg * 100) / 100 + "mgï¼ˆ" + opt.billed + "éŒ ";
      if (opt.split) detail += "ã€" + opt.split + "éŒ åˆ†å‰²";
      detail += "ï¼‰\n" +
                "è–¬å‰¤æ–™ï¼š" + drugCost + "å††ï¼ˆ" + pricePer + "å††/éŒ  Ã— " + opt.billed + "éŒ ï¼‰\n\n";
      
      simpleLines.push(name + unit + "mg " + opt.billed + "t");
      
    } else {
      var ml = Math.ceil((totalMg / unit) * 100) / 100;
      var drugCostP = ceilYen(pricePer * ml);
      subtotal += drugCostP;
      items++;
      
      detail += "ã€æ•£å‰¤ã€‘" + name + " " + unit + "mg/mL\n" +
                dose + "mg/kg Ã— " + tpd + "å› Ã— " + days + "æ—¥åˆ†ï¼ˆä½“é‡ï¼š" + weight + "kgï¼‰\n" +
                "â†’ å¿…è¦é‡ï¼š" + Math.round(totalMg * 100) / 100 + "mgï¼ˆç´„" + ml + "mLï¼‰\n" +
                "è–¬å‰¤æ–™ï¼š" + drugCostP + "å††ï¼ˆ" + pricePer + "å††/mL Ã— " + ml + "mLï¼‰\n\n";
      
      simpleLines.push(name + " " + ml + "mL");
    }
  }
  
  if (!hasValidDrug) {
    return {
      simple: "è–¬å‰¤æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
      detail: detail || "æœ‰åŠ¹ãªè–¬å‰¤æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\nè–¬å‰¤åã€å«æœ‰é‡ã€å˜ä¾¡ã€è–¬ç”¨é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"
    };
  }
  
  // åˆ†åŒ…æ–™è¨ˆç®—
  if (bunpo) packFee += 20 * doses;
  
  // å‡¦æ–¹æ–™è¨ˆç®—
  if (items > 0) scriptFee = ceilYen(80 * days + 40 * days * (items - 1));
  
  // åˆè¨ˆè¨ˆç®—
  var total = ceilYen(subtotal + splitFee + packFee + scriptFee);
  
  // é »åº¦è¡¨ç¤º
  var freq = (tpd === 1 ? "SID" : tpd === 2 ? "BID" : "TID");
  var tail = (mode === "TAB" ? "TAB " + doses + "ãƒ¶ " + freq + " " + days + "æ—¥åˆ†" : 
              "ç²‰ " + doses + "åŒ… " + freq + " " + days + "æ—¥åˆ†");
  
  // ç°¡æ˜“ç‰ˆå‡ºåŠ›
  var simple = "å†…æœè–¬ï¼ " + (doses ? ceil10(total / doses) : 0) + " x" + doses + "\n" +
               (simpleLines.length ? simpleLines.join("  ") + "\n" : "") +
               tail;
  
  // è©³ç´°ç‰ˆå‡ºåŠ›ï¼ˆæ–™é‡‘å†…è¨³ï¼‰
  detail += "ã€æ–™é‡‘å†…è¨³ã€‘\n";
  detail += "è–¬å‰¤æ–™ï¼š" + subtotal + "å††\n";
  if (splitFee > 0) detail += "åˆ†å‰²æ–™ï¼š" + splitFee + "å††\n";
  if (packFee > 0) detail += "åˆ†åŒ…æ–™ï¼š" + packFee + "å††\n";
  detail += "å‡¦æ–¹æ–™ï¼š" + scriptFee + "å††\n";
  detail += "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";
  detail += "åˆè¨ˆï¼š" + total + "å††";
  
  return {simple: simple, detail: detail};
}

/* ====== å‡ºåŠ›æ›´æ–° ====== */
function recalc() {
  try {
    var r = calcAll();
    byId("outputSimple").textContent = r.simple;
    byId("outputDetail").textContent = r.detail;
  } catch(e) {
    console.error("è¨ˆç®—ã‚¨ãƒ©ãƒ¼:", e);
    byId("outputSimple").textContent = "è¨ˆç®—ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
    byId("outputDetail").textContent = "ã‚¨ãƒ©ãƒ¼: " + e.message;
  }
}

/* ====== åˆæœŸåŒ– ====== */
function init() {
  updateCsvStatus();
  addRow();
  refreshTplSelect();
  
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¥åŠ›å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
  ["weight", "days", "timesPerDay", "globalForm", "bunpo"].forEach(function(id) {
    var el = byId(id);
    el.addEventListener("input", function() { 
      if (id === "globalForm") updateFormLabels(); 
      recalc(); 
    });
    el.addEventListener("change", function() { 
      if (id === "globalForm") updateFormLabels(); 
      recalc(); 
    });
  });
  
  // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
  byId("addDrug").addEventListener("click", function() { addRow(); });
  
  byId("clearAll").addEventListener("click", function() { 
    if (confirm("ã™ã¹ã¦ã®è–¬å‰¤å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) {
      listEl.innerHTML = ""; 
      addRow(); 
    }
  });
  
  byId("copySimple").addEventListener("click", function() {
    var text = byId("outputSimple").textContent;
    if (!text || text.indexOf("å…¥åŠ›ã—ã¦ãã ã•ã„") >= 0) {
      alert("è¨ˆç®—çµæœãŒã‚ã‚Šã¾ã›ã‚“");
      return;
    }
    navigator.clipboard.writeText(text).then(function() {
      alert("ç°¡æ˜“ç‰ˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
    }).catch(function(err) {
      console.error("ã‚³ãƒ”ãƒ¼å¤±æ•—:", err);
      alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
    });
  });
  
  byId("copyDetail").addEventListener("click", function() {
    var text = byId("outputDetail").textContent;
    if (!text || text.indexOf("å…¥åŠ›ã—ã¦ãã ã•ã„") >= 0) {
      alert("è¨ˆç®—çµæœãŒã‚ã‚Šã¾ã›ã‚“");
      return;
    }
    navigator.clipboard.writeText(text).then(function() {
      alert("è©³ç´°ç‰ˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
    }).catch(function(err) {
      console.error("ã‚³ãƒ”ãƒ¼å¤±æ•—:", err);
      alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
    });
  });
  
  // åˆå›è¨ˆç®—
  recalc();
}

// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
init();
</script>
</body>
</html>
