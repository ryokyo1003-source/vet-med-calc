<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v3.1.2ï¼ˆã‚»ãƒ¼ãƒ•ãƒ¢ãƒ¼ãƒ‰ï¼‰</title>
<style>
*{box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;margin:0;padding:16px;background:#fafafa}
h1{margin:0 0 12px;font-size:18px}
.card{background:#fff;border:1px solid #e5e5ea;border-radius:12px;padding:12px;margin:12px 0}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1 1 240px;min-width:240px}
input,select,button,textarea{width:100%;padding:10px;border:1px solid #d0d0d0;border-radius:10px;background:#fff;font-size:16px}
button{background:#0a84ff;color:#fff;border:0;cursor:pointer}
button.secondary{background:#f2f2f7;color:#111;border:1px solid #d0d0d0}
button.danger{background:#ff3b30}
.drug-row{border:1px dashed #d0d0d0;border-radius:10px;padding:10px;margin:10px 0}
pre.readonly{white-space:pre-wrap;background:#fcfcfd;border:1px solid #eee;border-radius:10px;padding:10px;min-height:100px;font-family:ui-monospace,Menlo,monospace}
details.fold{border:1px dashed #cfd3d8;border-radius:10px;padding:8px}
details.fold>summary{cursor:pointer;font-weight:600;user-select:none}
.hidden{display:none}
@media (min-width:1100px){
  .layout{display:grid;grid-template-columns:1.1fr 1fr;gap:16px}
  .panel-left{position:sticky;top:8px;align-self:start;max-height:calc(100vh - 16px);overflow:auto}
  .panel-right{max-height:calc(100vh - 16px);overflow:auto}
}
</style>
<script>
// ã©ã“ã§æ­¢ã¾ã£ã¦ã„ã‚‹ã‹å³ã‚ã‹ã‚‹ã‚ˆã†ã«
window.onerror = function(msg, src, line, col, err){
  alert("JavaScriptã‚¨ãƒ©ãƒ¼: " + msg + "\\n" + (src||"") + "@" + line + ":" + col);
};
</script>
</head>
<body>
<h1>è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v3.1.2ï¼ˆã‚»ãƒ¼ãƒ•ãƒ¢ãƒ¼ãƒ‰ï¼‰</h1>

<div class="layout">
  <!-- å·¦ï¼šå…¥åŠ› -->
  <div class="panel-left">
    <div class="card">
      <div class="row">
        <div class="col">
          <label>ä½“é‡ï¼ˆkgï¼‰</label>
          <input type="number" id="weight" step="0.01" inputmode="decimal" />
        </div>
        <div class="col">
          <label>æ—¥æ•°</label>
          <input type="number" id="days" value="7" min="1" inputmode="numeric" />
        </div>
        <div class="col">
          <label>å›æ•°/æ—¥</label>
          <select id="timesPerDay">
            <option value="1">SID</option>
            <option value="2" selected>BID</option>
            <option value="3">TID</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>å‡¦æ–¹å½¢æ…‹ï¼ˆå…¨ä½“ï¼‰</label>
          <select id="globalForm">
            <option value="TAB" selected>éŒ å‰¤ï¼ˆTABï¼‰</option>
            <option value="POWDER">æ•£å‰¤</option>
          </select>
        </div>
        <div class="col">
          <label><input type="checkbox" id="bunpo"> åˆ†åŒ…ï¼ˆå…¨ä½“ä¸€æ‹¬ +20å††/å›ï¼‰</label>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>ğŸ’Š è–¬å‰¤å…¥åŠ›</h3>
      <div id="tabletList"></div>
      <div class="row">
        <div class="col"><button id="addDrug">ï¼‹ è–¬å‰¤ã‚’è¿½åŠ </button></div>
        <div class="col"><button id="clearAll" class="secondary">å…¥åŠ›ã‚¯ãƒªã‚¢</button></div>
      </div>
    </div>

    <!-- æŠ˜ã‚ŠãŸãŸã¿ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬/å±¥æ­´/CSVï¼‰ -->
    <div class="card">
      <details class="fold" id="foldTools">
        <summary>ğŸ“¦ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ»å±¥æ­´ãƒ»CSVï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é–‹é–‰ï¼‰</summary>

        <div style="margin-top:8px">
          <h4>ğŸ§° å‡¦æ–¹ãƒ†ãƒ³ãƒ—ãƒ¬</h4>
          <div class="row">
            <div class="col"><input id="tplName" placeholder="ä¾‹ï¼‰ä¸‹ç—¢æ­¢ã‚ã‚»ãƒƒãƒˆ"></div>
            <div class="col">
              <button id="saveTpl">ä¿å­˜</button>
              <button id="overwriteTpl" class="secondary">åŒåã«ä¸Šæ›¸ã</button>
            </div>
          </div>
          <div class="row" style="margin-top:6px">
            <div class="col"><select id="tplSelect"></select></div>
            <div class="col">
              <button id="loadTpl" class="secondary">èª­è¾¼</button>
              <button id="deleteTpl" class="danger">å‰Šé™¤</button>
              <button id="exportTpl" class="secondary">æ›¸ãå‡ºã—</button>
              <button id="importTpl" class="secondary">èª­ã¿è¾¼ã¿</button>
            </div>
          </div>
        </div>

        <hr/>

        <div>
          <h4>ğŸ“š å‡¦æ–¹å±¥æ­´</h4>
          <div class="row">
            <div class="col"><input id="histFilter" placeholder="æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«/è–¬å‰¤åï¼‰"></div>
            <div class="col">
              <button id="saveHistory" class="secondary">ã“ã®å‡¦æ–¹ã‚’å±¥æ­´ä¿å­˜</button>
              <button id="exportHist" class="secondary">æ›¸ãå‡ºã—</button>
              <button id="clearHist" class="danger">å…¨å‰Šé™¤</button>
            </div>
          </div>
          <div id="historyList" class="card" style="margin:8px 0"></div>
        </div>

        <hr/>

        <div>
          <h4>ğŸ“¦ è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ï¼ˆCSVï¼‰</h4>
          <div class="row">
            <div class="col"><input type="file" id="csvInput" accept=".csv"></div>
            <div class="col"><button id="saveCsv" class="secondary">ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãå‡ºã—</button></div>
          </div>
          <div style="font-size:13px;color:#666;margin-top:6px">
            åˆ—ï¼šè–¬å‰¤å, å‰¤å‹, å˜ä¾¡ï¼ˆä»•å…¥ï¼‰, å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰, ï¼ˆä»»æ„ï¼‰å«æœ‰é‡ï¼ˆmg/mLï¼‰
          </div>
        </div>

      </details>
    </div>
  </div>

  <!-- å³ï¼šå‡ºåŠ› -->
  <div class="panel-right">
    <div class="card">
      <div class="row">
        <div class="col"><button id="copySimple" class="secondary">ç°¡æ˜“ã‚’ã‚³ãƒ”ãƒ¼</button></div>
        <div class="col"><button id="copyDetail" class="secondary">è©³ç´°ã‚’ã‚³ãƒ”ãƒ¼</button></div>
      </div>
    </div>
    <div class="card">
      <h3>ğŸ“‹ ã‚«ãƒ«ãƒ†è²¼ä»˜ç”¨ï¼ˆç°¡æ˜“ï¼‰</h3>
      <pre id="outputSimple" class="readonly"></pre>
    </div>
    <div class="card">
      <h3>ğŸ§® è¨ˆç®—æ ¹æ‹ ï¼ˆè©³ç´°ï¼‰</h3>
      <pre id="outputDetail" class="readonly"></pre>
    </div>
  </div>
</div>

<datalist id="drugList"></datalist>

<script>
// ---- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
function byId(id){return document.getElementById(id)}
function ceil10(y){return Math.ceil(y/10)*10}
function ceilYen(y){return Math.ceil(y)}
function markupFor(p){ if(p<=10) return 3; if(p<=50) return 2; if(p<=100) return 1.8; if(p<=500) return 1.5; return 1.2; }

// ---- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼
var KEY_MASTER="drugMasterSimple";
var KEY_TPL="rxTemplatesV1";
var KEY_HIST="rxHistoryV1";
var KEY_NOTES="drugNotesV1";

// ---- CSV ãƒã‚¹ã‚¿ãƒ¼
var DRUGS = (function(){ try{ return JSON.parse(localStorage.getItem(KEY_MASTER))||[]; }catch(e){ return []; } })();
function saveDrugs(list){ try{ localStorage.setItem(KEY_MASTER, JSON.stringify(list)); }catch(e){} }
function refreshDatalist(){
  var dl=byId("drugList"); if(!dl) return;
  dl.innerHTML="";
  for(var i=0;i<DRUGS.length;i++){
    var o=document.createElement("option"); o.value=DRUGS[i]["è–¬å‰¤å"]; dl.appendChild(o);
  }
}

// ---- è–¬å‰¤è¡Œ
var listEl;
function makeRow(data){
  var row=document.createElement("div"); row.className="drug-row";
  row.innerHTML =
    '<div class="row">'+
      '<div class="col"><label>è–¬å‰¤å</label><input class="drugName" list="drugList" placeholder="é¸æŠ/å…¥åŠ›"/></div>'+
      '<div class="col"><label class="unitLabel">å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰</label><input type="number" class="unitMg" step="0.01"/></div>'+
      '<div class="col"><label class="costLabel">å˜ä¾¡ï¼ˆå††/éŒ ï¼‰</label><input type="number" class="cost" step="0.01"/></div>'+
    '</div>'+
    '<div class="row">'+
      '<div class="col"><label>è–¬ç”¨é‡ï¼ˆmg/kgï¼‰</label><input type="number" class="dose" step="0.01"/></div>'+
      '<div class="col"><button class="removeBtn danger">å‰Šé™¤</button></div>'+
    '</div>'+
    '<div class="row powderOnly hidden">'+
      '<div class="col">'+
        '<label><input type="checkbox" class="syrupChk"> ã‚·ãƒ­ãƒƒãƒ—æº¶è§£ï¼ˆ+500å††ï¼‰</label>ã€€'+
        '<label><input type="checkbox" class="capsuleChk"> ã‚«ãƒ—ã‚»ãƒ«è©°ã‚ï¼ˆ+800å††ï¼‰</label>'+
      '</div>'+
    '</div>'+
    '<div class="row">'+
      '<div class="col">'+
        '<label>ãƒ¡ãƒ¢</label>'+
        '<textarea class="noteArea" style="height:80px"></textarea>'+
        '<button class="secondary saveNoteBtn" style="margin-top:6px">ã“ã®è–¬ã®ãƒ¡ãƒ¢ã‚’ä¿å­˜</button>'+
      '</div>'+
    '</div>';

  var nameEl=row.querySelector(".drugName");
  var unitEl=row.querySelector(".unitMg");
  var costEl=row.querySelector(".cost");
  var doseEl=row.querySelector(".dose");
  var noteArea=row.querySelector(".noteArea");

  if(data){
    nameEl.value=data.name||"";
    unitEl.value=(data.unit!=null?data.unit:"");
    costEl.value=(data.cost!=null?data.cost:"");
    doseEl.value=(data.dose!=null?data.dose:"");
    noteArea.value=data.note||"";
  }

  nameEl.addEventListener("change", function(){
    var name=nameEl.value;
    var d=null; for(var i=0;i<DRUGS.length;i++){ if(DRUGS[i]["è–¬å‰¤å"]===name){ d=DRUGS[i]; break; } }
    if(!d) return;
    var mode=byId("globalForm").value;
    if(mode==="TAB"){ unitEl.value=d["å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"]||""; costEl.value=d["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"]||""; }
    else{ unitEl.value=d["å«æœ‰é‡ï¼ˆmg/mLï¼‰"]||""; costEl.value=d["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"]||""; }
    recalc();
  });

  row.querySelector(".saveNoteBtn").addEventListener("click", function(){
    var map; try{ map=JSON.parse(localStorage.getItem(KEY_NOTES))||{}; }catch(e){ map={}; }
    map[nameEl.value||""] = noteArea.value||"";
    try{ localStorage.setItem(KEY_NOTES, JSON.stringify(map)); }catch(e){}
    alert("ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
  });
  row.querySelector(".removeBtn").addEventListener("click", function(){ row.remove(); recalc(); });

  var inputs=row.querySelectorAll("input,select,textarea");
  for(var i=0;i<inputs.length;i++){
    inputs[i].addEventListener("input", recalc);
    inputs[i].addEventListener("change", recalc);
  }
  return row;
}
function addRow(data){ listEl.appendChild(makeRow(data)); applyGlobalFormUI(); recalc(); }

// ---- UIåˆ‡æ›¿
function applyGlobalFormUI(){
  var mode=byId("globalForm").value;
  var labels=document.querySelectorAll(".unitLabel");
  for(var i=0;i<labels.length;i++){ labels[i].textContent=(mode==="TAB"?"å«æœ‰é‡ï¼ˆmg/éŒ )":"å«æœ‰é‡ï¼ˆmg/mL)"); }
  var cl=document.querySelectorAll(".costLabel");
  for(i=0;i<cl.length;i++){ cl[i].textContent=(mode==="TAB"?"å˜ä¾¡ï¼ˆå††/éŒ )":"å˜ä¾¡ï¼ˆå††/mL)"); }
  var pow=document.querySelectorAll(".powderOnly");
  for(i=0;i<pow.length;i++){ pow[i].classList.toggle("hidden", !(mode==="POWDER")); }
}
["weight","days","timesPerDay","bunpo","globalForm"].forEach(function(id){
  byId(id).addEventListener("input", function(){ applyGlobalFormUI(); recalc(); });
  byId(id).addEventListener("change", function(){ applyGlobalFormUI(); recalc(); });
});

// ---- è¨ˆç®—
function optimizeTablets(totalMg, unitMgPerTab){
  if(!(unitMgPerTab>0)){ return {billed:0, achievedMg:0}; }
  var q = Math.ceil(totalMg / (unitMgPerTab/4)); // 1/4éŒ å˜ä½
  var billed = Math.ceil(q/4);
  var achievedMg = billed * unitMgPerTab;
  return {billed:billed, achievedMg:achievedMg};
}
function calcAll(){
  var days=parseInt(byId("days").value||"0",10);
  var tpd=parseInt(byId("timesPerDay").value||"0",10);
  var doses=tpd*days;
  var weight=parseFloat(byId("weight").value||"0");
  var mode=byId("globalForm").value;
  var bunpo=byId("bunpo").checked;

  var subtotal=0, items=0, splitFee=0, packFee=0, syrupFee=0, capsuleFee=0;
  var detail="";
  var rows=listEl.querySelectorAll(".drug-row");
  for(var i=0;i<rows.length;i++){
    var name=rows[i].querySelector(".drugName").value.trim();
    var unit=parseFloat(rows[i].querySelector(".unitMg").value||"0");
    var cost=parseFloat(rows[i].querySelector(".cost").value||"0");
    var dose=parseFloat(rows[i].querySelector(".dose").value||"0");
    var note=rows[i].querySelector(".noteArea").value||"";
    if(!name||!unit||!cost||!dose||!weight||!days||!tpd) continue;

    var mgPerDose=weight*dose, totalMg=mgPerDose*doses;
    var pricePer = ceil10(cost * markupFor(cost));

    if(mode==="TAB"){
      var opt=optimizeTablets(totalMg, unit);
      var drugCost=ceilYen(pricePer * opt.billed);
      subtotal+=drugCost; items++;
      splitFee+=0; //ï¼ˆã“ã“ã§ã¯1/2,1/4ã®ç²¾ç·»ãªåŠ ç®—ã¯ä¸€æ—¦ã‚ªãƒ•ã€‚å¾Œã§æˆ»ã›ã¾ã™ï¼‰
      detail += "ã€éŒ å‰¤ã€‘"+name+" "+unit+"mg/éŒ \n"
             +  "å¿…è¦é‡ï¼š"+Math.round(totalMg)+"mg â†’ "+opt.billed+"éŒ ï¼ˆ"+pricePer+"å††/éŒ ï¼‰\n"
             +  "è–¬å‰¤æ–™ï¼š"+drugCost+"å††\n"
             +  (note?("ãƒ¡ãƒ¢ï¼š"+note+"\n"):"")
             +  "\n";
    }else{
      var ml=Math.ceil((totalMg/unit)*100)/100;
      var drugCostP=ceilYen(pricePer*ml);
      subtotal+=drugCostP; items++;
      detail += "ã€æ•£å‰¤ã€‘"+name+" "+unit+"mg/mL ç›¸å½“\n"
             +  "å¿…è¦é‡ï¼š"+Math.round(totalMg)+"mgï¼ˆç´„"+ml.toFixed(2)+"mLï¼‰\n"
             +  "è–¬å‰¤æ–™ï¼š"+drugCostP+"å††\n"
             +  (note?("ãƒ¡ãƒ¢ï¼š"+note+"\n"):"")
             +  "\n";
    }
  }

  if(bunpo){ packFee += 20 * doses; }
  var scriptFee = items>0 ? ceilYen(80*days + 40*days*(items-1)) : 0;
  var total = ceilYen(subtotal + splitFee + packFee + syrupFee + capsuleFee + scriptFee);
  return {total:total, doses:doses, days:days, tpd:tpd, mode:mode, detail:detail, splitFee:splitFee, packFee:packFee, scriptFee:scriptFee};
}
function buildSimple(o){
  var unit = o.doses>0 ? ceil10(o.total/o.doses) : 0;
  var freq = (o.tpd===1?"SID":o.tpd===2?"BID":"TID");
  var tail = (o.mode==="TAB" ? "TAB "+o.doses+"ãƒ¶ "+freq+" "+o.days+"æ—¥åˆ†" : "ç²‰ "+o.doses+"åŒ… "+freq+" "+o.days+"æ—¥åˆ†");
  return "å†…æœè–¬ï¼ "+unit+" x"+o.doses+"\n"+tail;
}
function recalc(){
  var r=calcAll(); if(!r) return;
  byId("outputSimple").textContent = buildSimple(r);
  var d=r.detail;
  if(r.packFee>0) d += "åˆ†åŒ…æ–™ï¼š"+r.packFee+"å††\n";
  d += "å‡¦æ–¹æ–™ï¼š"+r.scriptFee+"å††\nâ€”â€”â€”\nåˆè¨ˆï¼š"+r.total+"å††";
  byId("outputDetail").textContent = d;
}

// ---- ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰
function copyPre(id){
  var text=byId(id).textContent || "";
  try{
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(text).then(function(){ alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); })
      .catch(function(){ legacyCopy(text); });
    }else{ legacyCopy(text); }
  }catch(e){ legacyCopy(text); }
}
function legacyCopy(text){
  var ta=document.createElement("textarea"); ta.value=text; document.body.appendChild(ta);
  ta.select(); document.execCommand("copy"); ta.remove(); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
}
byId("copySimple").addEventListener("click", function(){ copyPre("outputSimple"); });
byId("copyDetail").addEventListener("click", function(){ copyPre("outputDetail"); });

// ---- ãƒ†ãƒ³ãƒ—ãƒ¬ & å±¥æ­´ï¼ˆæœ€å°å‹•ä½œï¼‰
function loadTemplates(){ try{ return JSON.parse(localStorage.getItem(KEY_TPL))||[]; }catch(e){ return []; } }
function saveTemplates(arr){ try{ localStorage.setItem(KEY_TPL, JSON.stringify(arr)); }catch(e){} }
function currentFormData(){
  var rows=listEl.querySelectorAll(".drug-row"), items=[];
  for(var i=0;i<rows.length;i++){
    items.push({
      name: rows[i].querySelector(".drugName").value.trim(),
      unit: parseFloat(rows[i].querySelector(".unitMg").value||""),
      cost: parseFloat(rows[i].querySelector(".cost").value||""),
      dose: parseFloat(rows[i].querySelector(".dose").value||""),
      note: rows[i].querySelector(".noteArea").value||""
    });
  }
  return { name: byId("tplName").value.trim(), mode: byId("globalForm").value, bunpo: byId("bunpo").checked, items: items.filter(function(x){return x.name;}) };
}
function applyFormData(data){
  byId("globalForm").value = data.mode || "TAB";
  byId("bunpo").checked = !!data.bunpo;
  listEl.innerHTML="";
  var its=data.items||[];
  if(its.length===0){ addRow(); } else { for(var i=0;i<its.length;i++){ addRow(its[i]); } }
  applyGlobalFormUI(); recalc();
}
function refreshTplSelect(){
  var sel=byId("tplSelect"); sel.innerHTML="";
  var arr=loadTemplates();
  for(var i=0;i<arr.length;i++){ var o=document.createElement("option"); o.value=i; o.textContent=arr[i].name; sel.appendChild(o); }
}
byId("saveTpl").addEventListener("click", function(){
  var data=currentFormData(); if(!data.name){ alert("ãƒ†ãƒ³ãƒ—ãƒ¬åã‚’å…¥åŠ›"); return; }
  var arr=loadTemplates(); for(var i=0;i<arr.length;i++){ if(arr[i].name===data.name){ alert("åŒåãŒã‚ã‚Šã¾ã™ã€‚ã€åŒåã«ä¸Šæ›¸ãã€ã‚’ä½¿ç”¨"); return; } }
  arr.push(data); saveTemplates(arr); refreshTplSelect(); alert("ä¿å­˜ã—ã¾ã—ãŸ");
});
byId("overwriteTpl").addEventListener("click", function(){
  var data=currentFormData(); if(!data.name){ alert("ãƒ†ãƒ³ãƒ—ãƒ¬åã‚’å…¥åŠ›"); return; }
  var arr=loadTemplates(); var idx=-1; for(var i=0;i<arr.length;i++){ if(arr[i].name===data.name){ idx=i; break; } }
  if(idx<0){ alert("åŒåãƒ†ãƒ³ãƒ—ãƒ¬ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }
  arr[idx]=data; saveTemplates(arr); refreshTplSelect(); alert("ä¸Šæ›¸ãã—ã¾ã—ãŸ");
});
byId("loadTpl").addEventListener("click", function(){
  var arr=loadTemplates(); var idx=parseInt(byId("tplSelect").value||"-1",10);
  if(!(idx>=0 && arr[idx])){ alert("ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸æŠ"); return; }
  byId("tplName").value=arr[idx].name; applyFormData(arr[idx]);
});
byId("deleteTpl").addEventListener("click", function(){
  var arr=loadTemplates(); var idx=parseInt(byId("tplSelect").value||"-1",10);
  if(!(idx>=0 && arr[idx])){ alert("ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸æŠ"); return; }
  if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  arr.splice(idx,1); saveTemplates(arr); refreshTplSelect(); alert("å‰Šé™¤ã—ã¾ã—ãŸ");
});

// ---- å±¥æ­´
function loadHistory(){ try{ return JSON.parse(localStorage.getItem(KEY_HIST))||[]; }catch(e){ return []; } }
function saveHistory(arr){ try{ localStorage.setItem(KEY_HIST, JSON.stringify(arr)); }catch(e){} }
function pushHistory(){
  var title=prompt("å±¥æ­´ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹ï¼šä¸‹ç—¢æ­¢ã‚ 10kg BID7æ—¥ï¼‰","");
  var item={ id:Date.now(), ts:new Date().toISOString(), title:title||"å‡¦æ–¹", simple:byId("outputSimple").textContent, detail:byId("outputDetail").textContent, snapshot:currentFormData() };
  var arr=loadHistory(); arr.unshift(item); while(arr.length>100) arr.pop(); saveHistory(arr); renderHistory(); alert("å±¥æ­´ã«ä¿å­˜ã—ã¾ã—ãŸ");
}
function renderHistory(){
  var list=byId("historyList"); list.innerHTML="";
  var filter=(byId("histFilter").value||"").toLowerCase();
  var arr=loadHistory();
  for(var i=0;i<arr.length;i++){
    var it=arr[i]; if(filter && (it.title||"").toLowerCase().indexOf(filter)<0) continue;
    var line=document.createElement("div"); line.style.display="flex"; line.style.gap="8px"; line.style.alignItems="center";
    var when=new Date(it.ts).toLocaleString();
    var title=document.createElement("div"); title.style.flex="1"; title.textContent=when+"ï½œ"+(it.title||"å‡¦æ–¹");
    var b1=document.createElement("button"); b1.className="secondary"; b1.textContent="å†èª­è¾¼"; b1.onclick=(function(s){return function(){ applyFormData(s.snapshot); };})(it);
    var b2=document.createElement("button"); b2.className="secondary"; b2.textContent="ç°¡æ˜“ã‚³ãƒ”ãƒ¼"; b2.onclick=(function(s){return function(){ navigator.clipboard.writeText(s.simple); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); };})(it);
    var b3=document.createElement("button"); b3.className="secondary"; b3.textContent="è©³ç´°ã‚³ãƒ”ãƒ¼"; b3.onclick=(function(s){return function(){ navigator.clipboard.writeText(s.detail); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); };})(it);
    var b4=document.createElement("button"); b4.className="danger"; b4.textContent="å‰Šé™¤"; b4.onclick=(function(s){return function(){ var arr2=loadHistory().filter(function(x){return x.id!==s.id}); saveHistory(arr2); renderHistory(); };})(it);
    line.appendChild(title); line.appendChild(b1); line.appendChild(b2); line.appendChild(b3); line.appendChild(b4);
    list.appendChild(line);
  }
}
byId("saveHistory").addEventListener("click", pushHistory);
byId("exportHist").addEventListener("click", function(){
  var blob=new Blob([JSON.stringify(loadHistory(),null,2)],{type:"application/json"});
  var url=URL.createObjectURL(blob); var a=document.createElement("a"); a.href=url; a.download="rx_history.json"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
byId("clearHist").addEventListener("click", function(){ if(!confirm("ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return; saveHistory([]); renderHistory(); });
byId("histFilter").addEventListener("input", renderHistory);

// ---- CSV
byId("csvInput").addEventListener("change", function(ev){
  var f=ev.target.files && ev.target.files[0]; if(!f) return;
  var r=new FileReader();
  r.onload=function(e){
    var text=e.target.result;
    var lines=text.split(/\r?\n/).filter(function(x){return x.trim();});
    if(lines.length<2){ alert("CSVãŒç©ºã§ã™"); return; }
    var header=lines[0].split(",");
    var idx={ name:header.indexOf("è–¬å‰¤å"), cost:header.indexOf("å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"), unitTab:header.indexOf("å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"), unitMl:header.indexOf("å«æœ‰é‡ï¼ˆmg/mL)") };
    if(idx.unitMl<0){
      for(var h=0;h<header.length;h++){ if(header[h].replace(/\s/g,'').indexOf("å«æœ‰é‡ï¼ˆmg/mLï¼‰")>=0){ idx.unitMl=h; break; } }
    }
    var list=[];
    for(var i=1;i<lines.length;i++){
      var c=lines[i].split(",");
      var rec={"è–¬å‰¤å":c[idx.name]||"","å˜ä¾¡ï¼ˆä»•å…¥ï¼‰":parseFloat(c[idx.cost]||"0")||0,"å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰": (idx.unitTab>=0&&c[idx.unitTab])?parseFloat(c[idx.unitTab]):"","å«æœ‰é‡ï¼ˆmg/mLï¼‰": (idx.unitMl>=0&&c[idx.unitMl])?parseFloat(c[idx.unitMl]):""};
      if(rec["è–¬å‰¤å"]) list.push(rec);
    }
    DRUGS=list; try{ localStorage.setItem(KEY_MASTER, JSON.stringify(list)); }catch(e){}
    refreshDatalist(); alert("è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ"+list.length+"ä»¶ï¼‰");
  };
  r.readAsText(f,"utf-8");
});
byId("saveCsv").addEventListener("click", function(){
  var header=["è–¬å‰¤å","å˜ä¾¡ï¼ˆä»•å…¥ï¼‰","å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰","å«æœ‰é‡ï¼ˆmg/mLï¼‰"];
  var rows=[header.join(",")];
  for(var i=0;i<DRUGS.length;i++){ rows.push([DRUGS[i]["è–¬å‰¤å"],DRUGS[i]["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"],DRUGS[i]["å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"]||"",DRUGS[i]["å«æœ‰é‡ï¼ˆmg/mLï¼‰"]||""].join(",")); }
  var blob=new Blob([rows.join("\n")],{type:"text/csv"});
  var url=URL.createObjectURL(blob); var a=document.createElement("a"); a.href=url; a.download="drug_master_export.csv"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

// ---- åˆæœŸåŒ–
function init(){
  listEl = byId("tabletList");
  refreshDatalist();
  addRow();                 // â˜… ã¾ãš1è¡Œ
  applyGlobalFormUI();      // â˜… ãƒ©ãƒ™ãƒ«ç­‰åæ˜ 
  recalc();                 // â˜… å‡ºåŠ›æ›´æ–°
  // ãƒ†ãƒ³ãƒ—ãƒ¬/å±¥æ­´ã®UIåˆæœŸåŒ–
  refreshTplSelect();
  renderHistory();
  // æŠ˜ã‚ŠãŸãŸã¿ã¯åˆæœŸçŠ¶æ…‹ã§é–‰ï¼ˆé–‹ãã£ã±ãªã—ã«ã—ãŸã„å ´åˆã¯ä¸‹ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
  var fold=byId("foldTools"); if(fold && fold.open) fold.open=false;
}
init();
</script>
</body>
</html>
