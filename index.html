<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v2.4ï¼ˆTAB/ç²‰åˆ‡æ›¿å¯¾å¿œï¼‰</title>
<style>
:root{ --gap:14px; --fz:18px; --pad:14px; --btnh:50px; }
@media (min-width:768px){ :root{ --fz:16px; --pad:10px; --btnh:44px; } }
*{box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;margin:0;padding:16px;font-size:var(--fz);-webkit-text-size-adjust:100%;background:#fafafa}
h1{font-size:calc(var(--fz) + 2px);margin:0 0 8px 0}
.row{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center}
.col{flex:1 1 210px;min-width:210px}
input,select,button,textarea{width:100%;font-size:var(--fz);padding:var(--pad);min-height:var(--btnh);border-radius:12px;border:1px solid #d0d0d0;background:#fff}
button{background:#0a84ff;color:#fff;border:0;cursor:pointer}
button.secondary{background:#f2f2f7;color:#111;border:1px solid #d0d0d0}
button.danger{background:#ff3b30}
textarea{height:160px}
.card{border:1px solid #e5e5ea;border-radius:14px;padding:14px;margin:14px 0;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.muted{color:#666;font-size:calc(var(--fz) - 3px)}
.tabs{display:flex;gap:8px;margin-bottom:8px}
.tab{padding:10px 14px;border:1px solid #d0d0d0;border-radius:999px;background:#f2f2f7;cursor:pointer;user-select:none}
.tab.active{background:#e7f1ff;border-color:#7aa7ff}
.section{display:none}.section.active{display:block}
.drug-row{border:1px dashed #d0d0d0;border-radius:12px;padding:12px;margin:10px 0}
.switch{display:flex;align-items:center;gap:10px}
kbd{background:#f2f2f7;border:1px solid #d0d0d0;border-radius:6px;padding:2px 6px}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef5ff;border:1px solid #cbdcff;color:#225}
.layout{display:block}
@media (min-width:1000px){
  .layout{display:grid;grid-template-columns:1.1fr 1fr;gap:18px;align-items:start}
  .panel-left{position:sticky;top:10px;align-self:start;height:calc(100vh - 20px);overflow:auto;padding-right:2px}
  .panel-right{max-height:calc(100vh - 20px);overflow:auto;padding-left:2px}
}
.panel-right textarea{height:220px}
.small{font-size:0.85em;color:#666}
</style>
</head>
<body>
<h1>è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v2.4ï¼ˆTAB/ç²‰åˆ‡æ›¿å¯¾å¿œï¼‰</h1>

<div class="layout">
  <!-- å·¦ï¼šå…¥åŠ› -->
  <div class="panel-left">
    <div class="card">
      <div class="row">
        <div class="col"><label>ä½“é‡ï¼ˆkgï¼‰</label><input type="number" id="weight" step="0.01"/></div>
        <div class="col"><label>æ—¥æ•°</label><input type="number" id="days" value="7" min="1"/></div>
        <div class="col"><label>å›æ•°/æ—¥</label>
          <select id="timesPerDay"><option value="1">SID</option><option value="2" selected>BID</option><option value="3">TID</option></select>
        </div>
      </div>
      <div class="row">
        <div class="col switch"><input type="checkbox" id="bunpo"/><label for="bunpo">åˆ†åŒ…æ©Ÿä½¿ç”¨ï¼ˆ+20å††/å›ï¼‰</label></div>
      </div>
    </div>

    <div class="card">
      <div class="tabs">
        <div class="tab active" data-target="tab-tabl">éŒ å‰¤ãƒ»ã‚«ãƒ—ã‚»ãƒ«</div>
        <div class="tab" data-target="tab-syrp">ã‚·ãƒ­ãƒƒãƒ—ãƒ»ç²‰è–¬</div>
      </div>
      <div id="tab-tabl" class="section active">
        <div id="tabletList"></div>
        <button id="addTablet">ï¼‹ éŒ å‰¤ã‚’è¿½åŠ </button>
      </div>
      <div id="tab-syrp" class="section">
        <div id="syrupList"></div>
        <button id="addSyrup">ï¼‹ ã‚·ãƒ­ãƒƒãƒ—ãƒ»ç²‰è–¬ã‚’è¿½åŠ </button>
      </div>
    </div>
  </div>

  <!-- å³ï¼šå‡ºåŠ› -->
  <div class="panel-right">
    <div class="card">
      <div class="row" style="gap:10px">
        <button id="calcBtn">è¨ˆç®—ã™ã‚‹</button>
        <button id="copySimple" class="secondary">ç°¡æ˜“ã‚’ã‚³ãƒ”ãƒ¼</button>
        <button id="copyDetail" class="secondary">è©³ç´°ã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>
    <div class="card">
      <h3>ğŸ“‹ ã‚«ãƒ«ãƒ†è²¼ä»˜ç”¨ï¼ˆç°¡æ˜“ï¼‰</h3>
      <textarea id="outputSimple" readonly></textarea>
    </div>
    <div class="card">
      <h3>ğŸ§® è¨ˆç®—æ ¹æ‹ ï¼ˆè©³ç´°ï¼‰</h3>
      <textarea id="outputDetail" readonly></textarea>
    </div>
  </div>
</div>

<script>
function ceil10(y){return Math.ceil(y/10)*10}
function ceilYen(y){return Math.ceil(y)}
function byId(id){return document.getElementById(id)}

/* ===== å…¥åŠ›è¡Œç”Ÿæˆ ===== */
function makeDrugRow({type}){
  const row=document.createElement("div"); row.className="drug-row";
  row.innerHTML=`
    <div class="row">
      <div class="col"><label>è–¬å‰¤å</label><input type="text" class="drugName"/></div>
      <div class="col"><label>å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰</label><input type="number" class="unitMg"/></div>
      <div class="col"><label>å˜ä¾¡ï¼ˆå††/éŒ ï¼‰</label><input type="number" class="cost"/></div>
    </div>
    <div class="row">
      <div class="col"><label>è–¬ç”¨é‡ï¼ˆmg/kgï¼‰</label><input type="number" class="dose"/></div>
      <div class="col"><label>å‡¦æ–¹å½¢æ…‹</label>
        <select class="split">
          <option value="powder">æ•£å‰¤</option>
          <option value="1" selected>åˆ†å‰²ãªã—</option>
          <option value="0.5">1/2ï¼ˆ+10å††/å›ï¼‰</option>
          <option value="0.25">1/4ï¼ˆ+20å††/å›ï¼‰</option>
        </select>
      </div>
    </div>`;
  return row;
}
function addTablet(){byId("tabletList").appendChild(makeDrugRow({type:"éŒ å‰¤"}))}
function addSyrup(){byId("syrupList").appendChild(makeDrugRow({type:"ã‚·ãƒ­ãƒƒãƒ—"}))}
byId("addTablet").addEventListener("click",addTablet);
byId("addSyrup").addEventListener("click",addSyrup);
addTablet();

/* ===== è¨ˆç®— ===== */
function calcSection(type, container){
  const days=parseInt(byId("days").value||"0");
  const tpd=parseInt(byId("timesPerDay").value||"0");
  const weight=parseFloat(byId("weight").value||"0");

  let detail="", subtotal=0, itemsCount=0;
  let anyPowder=false, anyTab=false;

  container.querySelectorAll(".drug-row").forEach(row=>{
    const name=row.querySelector(".drugName").value.trim();
    const unit=parseFloat(row.querySelector(".unitMg").value||"0");
    const cost=parseFloat(row.querySelector(".cost").value||"0");
    const dose=parseFloat(row.querySelector(".dose").value||"0");
    const splitRaw=row.querySelector(".split").value;

    if(!name||!unit||!cost||!dose||!weight) return;
    const mgPerDose=weight*dose;
    const totalMg=mgPerDose*tpd*days;
    const tabletCount=Math.ceil(totalMg/unit);
    const pricePer=ceil10(cost);
    const drugCost=ceilYen(pricePer*tabletCount);
    subtotal+=drugCost; itemsCount++;

    if(splitRaw==="powder"){ anyPowder=true; }
    else{ anyTab=true; }

    detail+=`ã€${type}ã€‘${name} ${unit}mg/éŒ 
${dose}mg/kg Ã— ${tpd}å› Ã— ${days}æ—¥åˆ†ï¼ˆä½“é‡ï¼š${weight}kgï¼‰
â†’ ${Math.round(totalMg)}mgï¼ˆ${tabletCount}éŒ ï¼‰
è–¬å‰¤æ–™ï¼š${drugCost}å††\n\n`;
  });
  return {detail, subtotal, itemsCount, anyPowder, anyTab};
}

function buildSimpleLine({tablet, syrup, total}){
  const d=parseInt(byId("days").value||"0");
  const tpd=parseInt(byId("timesPerDay").value||"0");
  const doses=tpd*d;
  const unit=doses>0?ceil10(total/doses):0;
  const freqLabel=(tpd===1?"SID":tpd===2?"BID":"TID");

  const lines=[`å†…æœè–¬ï¼ ${unit} x${doses}`];
  if(tablet.anyTab) lines.push(`TAB ${doses}ãƒ¶ ${freqLabel} ${d}æ—¥åˆ†`);
  if(tablet.anyPowder) lines.push(`ç²‰ ${doses}åŒ… ${freqLabel} ${d}æ—¥åˆ†`);
  if(syrup.itemsCount>0) lines.push(`ã‚·ãƒ­ãƒƒãƒ— ${doses}mL ${freqLabel} ${d}æ—¥åˆ†`);
  return lines.join("\n");
}

byId("calcBtn").addEventListener("click",()=>{
  const tablet=calcSection("éŒ å‰¤",byId("tabletList"));
  const syrup=calcSection("ã‚·ãƒ­ãƒƒãƒ—",byId("syrupList"));
  const days=parseInt(byId("days").value||"0");
  const itemsTotal=tablet.itemsCount+syrup.itemsCount;
  const scriptFee=(itemsTotal>0)?ceilYen(80*days+40*days*(itemsTotal-1)):0;
  const total=ceilYen(tablet.subtotal+syrup.subtotal+scriptFee);
  window.__lastTotal=total;

  byId("outputSimple").value=buildSimpleLine({tablet,syrup,total});
  byId("outputDetail").value=tablet.detail+syrup.detail+`å‡¦æ–¹æ–™ï¼š${scriptFee}å††\nâ€”â€”â€”\nåˆè¨ˆï¼š${total}å††`;
});

function tryClipboard(id){const ta=byId(id);ta.select();document.execCommand("copy");alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");}
byId("copySimple").addEventListener("click",()=>tryClipboard("outputSimple"));
byId("copyDetail").addEventListener("click",()=>tryClipboard("outputDetail"));
</script>
</body>
</html>
