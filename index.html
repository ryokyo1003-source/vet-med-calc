<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v3.7ï¼ˆè¤‡æ•°è¦æ ¼æœ€é©åŒ–ï¼‰</title>
<style>
*{box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;margin:0;padding:16px;background:#fafafa}
h1{margin:0 0 12px;font-size:18px}
.card{background:#fff;border:1px solid #e5e5ea;border-radius:12px;padding:12px;margin:12px 0}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1 1 240px;min-width:240px}
input,select,button,textarea{width:100%;padding:10px;border:1px solid #d0d0d0;border-radius:10px;background:#fff;font-size:16px}
button{background:#0a84ff;color:#fff;border:0;cursor:pointer}
button.secondary{background:#f2f2f7;color:#111;border:1px solid #d0d0d0}
button.danger{background:#ff3b30}
button.ghost{background:#fff;color:#0a84ff;border:1px solid #bcd6ff}
.drug-row{border:1px dashed #d0d0d0;border-radius:10px;padding:10px;margin:10px 0}
pre.readonly{white-space:pre-wrap;background:#fcfcfd;border:1px solid #eee;border-radius:10px;padding:10px;min-height:100px;font-family:ui-monospace,Menlo,monospace}
.input-wrap{position:relative}
/* ã‚µã‚¸ã‚§ã‚¹ãƒˆ */
.suggest{position:absolute;z-index:9999;background:#fff;border:1px solid #d0d0d0;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.1);overflow:auto;max-height:220px;display:none}
.suggest-item{padding:6px 10px;cursor:pointer}
.suggest-item:hover,.suggest-item.active{background:#eef5ff}
@media (min-width:1100px){
  .layout{display:grid;grid-template-columns:1.1fr 1fr;gap:16px}
  .panel-left{position:sticky;top:8px;align-self:start;max-height:calc(100vh - 16px);overflow:auto}
  .panel-right{max-height:calc(100vh - 16px);overflow:auto}
}
.small{font-size:13px;color:#666}
</style>
</head>
<body>
<h1>è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v3.7</h1>

<div class="layout">
  <!-- å·¦ï¼šå…¥åŠ› -->
  <div class="panel-left">
    <div class="card">
      <div class="row">
        <div class="col">
          <label>ä½“é‡ï¼ˆkgï¼‰</label>
          <input type="number" id="weight" step="0.01"/>
        </div>
        <div class="col">
          <label>æ—¥æ•°</label>
          <input type="number" id="days" value="7" min="1"/>
        </div>
        <div class="col">
          <label>å›æ•°/æ—¥</label>
          <select id="timesPerDay">
            <option value="1">SID</option>
            <option value="2" selected>BID</option>
            <option value="3">TID</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>å‡¦æ–¹å½¢æ…‹ï¼ˆå…¨ä½“ï¼‰</label>
          <select id="globalForm">
            <option value="TAB" selected>éŒ å‰¤ï¼ˆTABï¼‰</option>
            <option value="POWDER">æ•£å‰¤</option>
          </select>
        </div>
        <div class="col">
          <label><input type="checkbox" id="bunpo"> åˆ†åŒ…ï¼ˆå…¨ä½“ä¸€æ‹¬ +20å††/å›ï¼‰</label>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>ğŸ’Š è–¬å‰¤å…¥åŠ›</h3>
      <div id="tabletList"></div>
      <div class="row">
        <div class="col"><button id="addDrug">ï¼‹ è–¬å‰¤ã‚’è¿½åŠ </button></div>
        <div class="col"><button id="clearAll" class="ghost">å…¥åŠ›ã‚¯ãƒªã‚¢</button></div>
      </div>
    </div>

    <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ï¼†CSV -->
    <div class="card">
      <details open>
        <summary><strong>ğŸ“¦ å‡¦æ–¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ & CSV</strong></summary>
        <div class="row" style="margin-top:8px">
          <div class="col"><input id="tplName" placeholder="ãƒ†ãƒ³ãƒ—ãƒ¬åï¼ˆä¾‹ï¼šä¸‹ç—¢æ­¢ã‚ã‚»ãƒƒãƒˆï¼‰"/></div>
          <div class="col">
            <button id="saveTpl">ä¿å­˜</button>
            <button id="overwriteTpl" class="secondary">åŒåã«ä¸Šæ›¸ã</button>
          </div>
        </div>
        <div class="row" style="margin-top:6px">
          <div class="col"><select id="tplSelect"></select></div>
          <div class="col">
            <button id="loadTpl" class="secondary">èª­è¾¼</button>
            <button id="deleteTpl" class="danger">å‰Šé™¤</button>
          </div>
        </div>
        <hr/>
        <div class="row">
          <div class="col">
            <label class="small">è–¬å‰¤CSVã‚’èª­ã¿è¾¼ã¿ï¼ˆåˆ—ï¼šè–¬å‰¤å, å‰¤å‹, å˜ä¾¡ï¼ˆä»•å…¥ï¼‰, å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰, å«æœ‰é‡ï¼ˆmg/mLï¼‰ï¼‰</label>
            <input type="file" id="csvInput" accept=".csv"/>
          </div>
          <div class="col">
            <button id="exportCsv" class="secondary">ç¾åœ¨ã®è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãå‡ºã—</button>
          </div>
        </div>
        <div class="small" id="csvStatus" style="margin-top:6px"></div>
      </details>
    </div>
  </div>

  <!-- å³ï¼šå‡ºåŠ› -->
  <div class="panel-right">
    <div class="card">
      <div class="row">
        <div class="col"><button id="copySimple" class="secondary">ç°¡æ˜“ã‚’ã‚³ãƒ”ãƒ¼</button></div>
        <div class="col"><button id="copyDetail" class="secondary">è©³ç´°ã‚’ã‚³ãƒ”ãƒ¼</button></div>
      </div>
    </div>
    <div class="card"><h3>ğŸ“‹ ã‚«ãƒ«ãƒ†è²¼ä»˜ç”¨ï¼ˆç°¡æ˜“ï¼‰</h3><pre id="outputSimple" class="readonly"></pre></div>
    <div class="card"><h3>ğŸ§® è¨ˆç®—æ ¹æ‹ ï¼ˆè©³ç´°ï¼‰</h3><pre id="outputDetail" class="readonly"></pre></div>
  </div>
</div>

<script>
/* ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
function byId(id){return document.getElementById(id)}
function ceil10(y){return Math.ceil(y/10)*10}
function ceilYen(y){return Math.ceil(y)}
function markupFor(p){ if(p<=10) return 3; if(p<=50) return 2; if(p<=100) return 1.8; if(p<=500) return 1.5; return 1.2; }
/* å…¨è§’â†’åŠè§’ + å˜ä½é™¤å»ã—ã¦æ•°å€¤åŒ– */
function toNumber(v){
  if(v==null) return NaN;
  var s=String(v).trim()
    .replace(/[ï¼-ï¼™]/g,function(ch){return String.fromCharCode(ch.charCodeAt(0)-0xFEE0);})
    .replace(/[ï¼ï¼Œ]/g,function(ch){return ch==='ï¼'?'.':','})
    .replace(/[^0-9\.\-]/g,'');
  if(s==='') return NaN;
  return parseFloat(s);
}
function fmtQuarter(n){ // 1/4åˆ»ã¿ã®å°æ•°è¡¨è¨˜
  return (Math.round(n*4)/4).toFixed(2).replace(/\.00$/,'').replace(/\.25$/,' .25').replace(' .25','.25').replace(/\.50$/,' .5').replace(' .5','.5').replace(/\.75$/,' .75').replace(' .75','.75').replace(/^0$/,'0');
}

/* ====== ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼ ====== */
var KEY_MASTER="drugMasterSimple";
var KEY_TPL="rxTemplatesV1";

/* ====== CSVè–¬å‰¤ãƒã‚¹ã‚¿ãƒ¼ ====== */
var DRUGS=(function(){ try{ return JSON.parse(localStorage.getItem(KEY_MASTER))||[]; }catch(e){ return []; } })();
function saveDrugs(list){ try{ localStorage.setItem(KEY_MASTER, JSON.stringify(list)); }catch(e){} }
function updateCsvStatus(){ byId("csvStatus").textContent="è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ï¼š"+(DRUGS.length||0)+"ä»¶ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ä¿å­˜ï¼‰"; }

/* ====== ã‚µã‚¸ã‚§ã‚¹ãƒˆï¼ˆè–¬å‰¤åï¼‰ ====== */
function attachAutocomplete(input, unitEl, costEl){
  var box=document.createElement("div"); box.className="suggest"; input.parentNode.appendChild(box);
  var active=-1;
  function close(){ box.style.display="none"; box.innerHTML=""; active=-1; }
  function open(){ box.style.display="block"; }
  function render(list){
    box.innerHTML="";
    list.forEach(function(name){
      var div=document.createElement("div"); div.className="suggest-item"; div.textContent=name;
      div.addEventListener("mousedown", function(e){ e.preventDefault(); select(name); });
      box.appendChild(div);
    });
    if(list.length===0) close(); else open();
  }
  function filter(q){
    q=(q||"").trim().toLowerCase();
    if(!q){ close(); return; }
    var names=DRUGS.map(function(d){return d["è–¬å‰¤å"];}).filter(Boolean);
    // é‡è¤‡æ’é™¤
    names = names.filter(function(v,i,a){ return a.indexOf(v)===i; });
    var starts=names.filter(function(n){return n.toLowerCase().indexOf(q)===0;});
    var contains=names.filter(function(n){return n.toLowerCase().indexOf(q)>0;});
    var all=starts.concat(contains).filter(function(v,i,a){return a.indexOf(v)===i;}).slice(0,80);
    render(all);
  }
  function select(val){
    input.value=val;
    // ä»£è¡¨å€¤ã¨ã—ã¦ã€Œæœ€å¤§è¦æ ¼ã€ã‚’å…¥ã‚Œã¦ãŠãï¼ˆè¡¨ç¤ºç”¨ï¼‰ã€‚è¨ˆç®—ã¯è¤‡æ•°è¦æ ¼ã§è‡ªå‹•æœ€é©åŒ–ã•ã‚Œã‚‹ã€‚
    var recs=DRUGS.filter(function(d){return d["è–¬å‰¤å"]===val && d["å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"]>0;});
    if(recs.length>0){
      recs.sort(function(a,b){ return (b["å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"]||0) - (a["å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"]||0); });
      unitEl.value = recs[0]["å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"] || "";
      costEl.value = recs[0]["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"] || "";
    }else{
      // æ•£å‰¤ãªã©
      var one=DRUGS.find(function(d){return d["è–¬å‰¤å"]===val;});
      if(one){ unitEl.value = one["å«æœ‰é‡ï¼ˆmg/mL)"]||one["å«æœ‰é‡ï¼ˆmg/mLï¼‰ã€]||one["å«æœ‰é‡ï¼ˆmg/mLï¼‰"]||""; costEl.value = one["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"]||"";}
    }
    close(); recalc();
  }
  input.addEventListener("input", function(){ filter(input.value); });
  input.addEventListener("focus", function(){ if(input.value) filter(input.value); });
  input.addEventListener("blur", function(){ setTimeout(close,100); });
  input.addEventListener("keydown", function(e){
    var items=box.querySelectorAll(".suggest-item");
    if(e.key==="ArrowDown"){ if(items.length){ active=(active+1)%items.length; for(var i=0;i<items.length;i++) items[i].classList.toggle("active", i===active); e.preventDefault(); } }
    else if(e.key==="ArrowUp"){ if(items.length){ active=(active-1+items.length)%items.length; for(i=0;i<items.length;i++) items[i].classList.toggle("active", i===active); e.preventDefault(); } }
    else if(e.key==="Enter"){ if(active>=0 && items[active]){ select(items[active].textContent); e.preventDefault(); } }
    else if(e.key==="Escape"){ close(); }
  });
}

/* ====== è–¬å‰¤è¡Œ ====== */
var listEl=byId("tabletList");
function makeRow(data){
  var row=document.createElement("div"); row.className="drug-row";
  row.innerHTML=
    '<div class="row">'+
      '<div class="col"><label>è–¬å‰¤å</label><div class="input-wrap"><input class="drugName" placeholder="é¸æŠ/å…¥åŠ›"/></div></div>'+
      '<div class="col"><label class="unitLabel">å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰</label><input type="number" class="unitMg" step="0.01"/></div>'+
      '<div class="col"><label class="costLabel">å˜ä¾¡ï¼ˆå††/éŒ ï¼‰</label><input type="number" class="cost" step="0.01"/></div>'+
    '</div>'+
    '<div class="row">'+
      '<div class="col"><label>è–¬ç”¨é‡ï¼ˆmg/kgï¼‰</label><input type="number" class="dose" step="0.01"/></div>'+
      '<div class="col"><button class="removeBtn danger">å‰Šé™¤</button></div>'+
    '</div>';
  var nameEl=row.querySelector(".drugName");
  var unitEl=row.querySelector(".unitMg");
  var costEl=row.querySelector(".cost");
  var doseEl=row.querySelector(".dose");
  attachAutocomplete(nameEl,unitEl,costEl);

  row.querySelector(".removeBtn").addEventListener("click",function(){ row.remove(); recalc(); });
  var inputs=row.querySelectorAll("input"); for(var i=0;i<inputs.length;i++){ inputs[i].addEventListener("input", recalc); }

  if(data){
    nameEl.value=data.name||"";
    unitEl.value=(data.unit!=null?data.unit:"");
    costEl.value=(data.cost!=null?data.cost:"");
    doseEl.value=(data.dose!=null?data.dose:"");
  }
  return row;
}
function addRow(data){ listEl.appendChild(makeRow(data)); recalc(); }

/* ====== ãƒ©ãƒ™ãƒ«æ›´æ–°ï¼ˆéŒ å‰¤/æ•£å‰¤ï¼‰ ====== */
function updateFormLabels(){
  var isTab = byId("globalForm").value==="TAB";
  Array.prototype.forEach.call(document.querySelectorAll(".unitLabel"),function(el){
    el.textContent = isTab ? "å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰" : "å«æœ‰é‡ï¼ˆmg/mLï¼‰";
  });
  Array.prototype.forEach.call(document.querySelectorAll(".costLabel"),function(el){
    el.textContent = isTab ? "å˜ä¾¡ï¼ˆå††/éŒ ï¼‰" : "å˜ä¾¡ï¼ˆå††/mLï¼‰";
  });
}

/* ====== ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ ====== */
function loadTemplates(){ try{ return JSON.parse(localStorage.getItem(KEY_TPL))||[]; }catch(e){ return []; } }
function saveTemplates(arr){ try{ localStorage.setItem(KEY_TPL, JSON.stringify(arr)); }catch(e){} }
function refreshTplSelect(){
  var sel=byId("tplSelect"); if(!sel) return;
  var arr=loadTemplates(); sel.innerHTML="";
  for(var i=0;i<arr.length;i++){ var o=document.createElement("option"); o.value=i; o.textContent=arr[i].name; sel.appendChild(o); }
}
function currentFormData(){
  var items=[], rows=listEl.querySelectorAll(".drug-row");
  for(var i=0;i<rows.length;i++){
    items.push({
      name: rows[i].querySelector(".drugName").value.trim(),
      unit: toNumber(rows[i].querySelector(".unitMg").value),
      cost: toNumber(rows[i].querySelector(".cost").value),
      dose: toNumber(rows[i].querySelector(".dose").value)
    });
  }
  return {
    name: byId("tplName").value.trim(),
    mode: byId("globalForm").value,
    bunpo: byId("bunpo").checked,
    days: parseInt(byId("days").value||"0",10),
    tpd: parseInt(byId("timesPerDay").value||"0",10),
    weight: toNumber(byId("weight").value),
    items: items.filter(function(x){return x.name;})
  };
}
function applyFormData(data){
  if(!data) return;
  byId("globalForm").value = data.mode || "TAB";
  byId("bunpo").checked   = !!data.bunpo;
  if(data.days)  byId("days").value = data.days;
  if(data.tpd)   byId("timesPerDay").value = data.tpd;
  if(data.weight)byId("weight").value = data.weight;

  listEl.innerHTML="";
  var its=data.items||[];
  if(its.length===0){ addRow(); } else { for(var i=0;i<its.length;i++){ addRow(its[i]); } }
  updateFormLabels();
  recalc();
}
byId("saveTpl").addEventListener("click", function(){
  var data=currentFormData(); if(!data.name){ alert("ãƒ†ãƒ³ãƒ—ãƒ¬åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  var arr=loadTemplates(); for(var i=0;i<arr.length;i++){ if(arr[i].name===data.name){ alert("åŒåãŒã‚ã‚Šã¾ã™ã€‚ã€åŒåã«ä¸Šæ›¸ãã€ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚"); return; } }
  arr.push(data); saveTemplates(arr); refreshTplSelect(); alert("ä¿å­˜ã—ã¾ã—ãŸ");
});
byId("overwriteTpl").addEventListener("click", function(){
  var data=currentFormData(); if(!data.name){ alert("ãƒ†ãƒ³ãƒ—ãƒ¬åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  var arr=loadTemplates(); var idx=-1; for(var i=0;i<arr.length;i++){ if(arr[i].name===data.name){ idx=i; break; } }
  if(idx<0){ alert("åŒåãƒ†ãƒ³ãƒ—ãƒ¬ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }
  arr[idx]=data; saveTemplates(arr); refreshTplSelect(); alert("ä¸Šæ›¸ãã—ã¾ã—ãŸ");
});
byId("loadTpl").addEventListener("click", function(){
  var arr=loadTemplates(); var idx=parseInt(byId("tplSelect").value||"-1",10);
  if(!(idx>=0 && arr[idx])){ alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
  byId("tplName").value=arr[idx].name; applyFormData(arr[idx]);
});
byId("deleteTpl").addEventListener("click", function(){
  var arr=loadTemplates(); var idx=parseInt(byId("tplSelect").value||"-1",10);
  if(!(idx>=0 && arr[idx])){ alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
  if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  arr.splice(idx,1); saveTemplates(arr); refreshTplSelect(); alert("å‰Šé™¤ã—ã¾ã—ãŸ");
});

/* ====== CSV èª­ã¿è¾¼ã¿ï¼æ›¸ãå‡ºã— ====== */
byId("csvInput").addEventListener("change", function(ev){
  var f=ev.target.files && ev.target.files[0]; if(!f) return;
  var r=new FileReader();
  r.onload=function(e){
    var text=e.target.result;
    var lines=text.split(/\r?\n/).filter(function(x){return x.trim();});
    if(lines.length<2){ alert("CSVãŒç©ºã§ã™"); return; }
    var header=lines[0].split(",");
    function idxOf(col){
      var i=header.indexOf(col);
      if(i>=0) return i;
      for(var k=0;k<header.length;k++){ if(header[k].replace(/\s/g,"")==col.replace(/\s/g,"")) return k; }
      return -1;
    }
    var idx={
      name: idxOf("è–¬å‰¤å"),
      type: idxOf("å‰¤å‹"),
      cost: idxOf("å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"),
      unitTab: idxOf("å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"),
      unitMl: idxOf("å«æœ‰é‡ï¼ˆmg/mLï¼‰")
    };
    var list=[];
    for(var i=1;i<lines.length;i++){
      var c=lines[i].split(",");
      var rec={
        "è–¬å‰¤å": c[idx.name]||"",
        "å‰¤å‹": c[idx.type]||"",
        "å˜ä¾¡ï¼ˆä»•å…¥ï¼‰": toNumber(c[idx.cost]),
        "å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰": (idx.unitTab>=0 && c[idx.unitTab])?toNumber(c[idx.unitTab]):"",
        "å«æœ‰é‡ï¼ˆmg/mLï¼‰": (idx.unitMl>=0 && c[idx.unitMl])?toNumber(c[idx.unitMl]):""
      };
      if(rec["è–¬å‰¤å"]) list.push(rec);
    }
    DRUGS=list; saveDrugs(DRUGS); updateCsvStatus();
    alert("è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ"+list.length+"ä»¶ï¼‰");
  };
  r.readAsText(f,"utf-8");
});
byId("exportCsv").addEventListener("click", function(){
  var header=["è–¬å‰¤å","å‰¤å‹","å˜ä¾¡ï¼ˆä»•å…¥ï¼‰","å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰","å«æœ‰é‡ï¼ˆmg/mLï¼‰"];
  var rows=[header.join(",")];
  for(var i=0;i<DRUGS.length;i++){
    rows.push([
      DRUGS[i]["è–¬å‰¤å"],
      DRUGS[i]["å‰¤å‹"]||"",
      DRUGS[i]["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"]||0,
      DRUGS[i]["å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"]||"",
      DRUGS[i]["å«æœ‰é‡ï¼ˆmg/mLï¼‰"]||""
    ].join(","));
  }
  var blob=new Blob([rows.join("\n")],{type:"text/csv"});
  var url=URL.createObjectURL(blob); var a=document.createElement("a"); a.href=url; a.download="drug_master_export.csv"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

/* ====== è¤‡æ•°è¦æ ¼æœ€é©åŒ–ï¼ˆéŒ å‰¤ç”¨ï¼‰ ======
  - åŒåè–¬å‰¤ã®è¦æ ¼ï¼ˆmg/éŒ ï¼‰ã‚’ã™ã¹ã¦å–å¾—
  - å˜ä¾¡â†’é™¢å†…ä¾¡æ ¼(å€ç‡)ã‚’è¦æ ¼ã”ã¨ã«ç®—å‡º
  - å¤§ãã„è¦æ ¼ã‹ã‚‰å¿…è¦é‡ã‚’å‰²ã‚Šå½“ã¦
  - æœ€å°è¦æ ¼ã§ 1/4 éŒ ã¾ã§åˆ†å‰²ã—æ®‹é‡ã‚’åŸ‹ã‚ã‚‹
  - åˆ†å‰²æ–™ã¯æœ€å°è¦æ ¼ã® 1/2=10å††/å›, 1/4=20å††/å› ã‚’åŠ ç®—
*/
function getTabletStrengths(name){
  var arr=DRUGS.filter(function(d){return d["è–¬å‰¤å"]===name && d["å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"]>0;})
               .map(function(d){
                 var unit=d["å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"];
                 var raw=d["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"]||0;
                 var pricePer = ceil10(raw*markupFor(raw)); // ä¾¡æ ¼è¡¨ãƒ«ãƒ¼ãƒ«
                 return {unitMg:unit, pricePer:pricePer, rawCost:raw};
               });
  // åŒã˜å«æœ‰é‡ãŒè¤‡æ•°è¡Œã‚ã£ã¦ã‚‚é‡è¤‡æ’é™¤ï¼ˆé«˜ã„æ–¹/æœ€æ–°ã‚’å„ªå…ˆã§ãã‚‹ã‚ˆã† rawCost ã¯ä½¿ã‚ãªã„ï¼‰:
  var seen={}; var out=[];
  for(var i=0;i<arr.length;i++){ if(!seen[arr[i].unitMg]){ seen[arr[i].unitMg]=true; out.push(arr[i]); } }
  out.sort(function(a,b){return b.unitMg-a.unitMg;});
  return out;
}

function optimizeMultiStrength(totalMg, strengths){
  // strengths: desc by unitMg
  var plan=[], remain=totalMg;
  if(strengths.length===0) return {plan:[], achieved:0, splitFeePerDose:0};

  // å¤§ãã„è¦æ ¼ã‹ã‚‰ä¸¸éŒ 
  for(var i=0;i<strengths.length-1;i++){
    var s=strengths[i];
    var cnt=Math.floor(remain / s.unitMg);
    if(cnt>0){
      plan.push({unitMg:s.unitMg, billed:cnt, displayCount:cnt, pricePer:s.pricePer, split:""});
      remain -= cnt*s.unitMg;
    }
  }
  // æœ€å°è¦æ ¼ã§ 1/4 éŒ åˆ»ã¿
  var last=strengths[strengths.length-1];
  var q = Math.ceil(remain / (last.unitMg/4)); // 1/4 éŒ å˜ä½ã§å¿…è¦æ•°
  var billed = Math.ceil(q/4);                 // å®Ÿéš›ã«å¿…è¦ãªéŒ å‰¤æšæ•°
  var displayCount = q/4;                      // è¡¨ç¤ºä¸Šã¯ 0.25å˜ä½
  var split = "";
  if(q%4===2) split="1/2";
  if(q%4===1 || q%4===3) split="1/4";
  if(displayCount>0){
    plan.push({unitMg:last.unitMg, billed:billed, displayCount:displayCount, pricePer:last.pricePer, split:split});
  }
  var achieved = plan.reduce(function(sum,x){ return sum + x.billed*x.unitMg; }, 0);
  var splitFeePerDose = 0;
  // åˆ†å‰²æ–™ã¯æœ€å°è¦æ ¼ã® split ç¨‹åº¦ã§æ±ºã‚ã‚‹ï¼ˆå…¨å›æ•°åŒä¸€å‰æï¼‰
  if(split==="1/2") splitFeePerDose = 10;
  if(split==="1/4") splitFeePerDose = 20;

  return {plan:plan, achieved:achieved, splitFeePerDose:splitFeePerDose};
}

/* ====== è²»ç”¨è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ====== */
function calcAll(){
  var days=parseInt(byId("days").value||"0",10);
  var tpd =parseInt(byId("timesPerDay").value||"0",10);
  var doses=tpd*days;
  var weight=toNumber(byId("weight").value);
  var mode=byId("globalForm").value;
  var bunpo=byId("bunpo").checked;

  var subtotal=0, items=0, splitFee=0, packFee=0, scriptFee=0;
  var detail="", simpleLines=[];

  var rows=listEl.querySelectorAll(".drug-row");
  for(var i=0;i<rows.length;i++){
    var name = rows[i].querySelector(".drugName").value.trim();
    var unit = toNumber(rows[i].querySelector(".unitMg").value);
    var cost = toNumber(rows[i].querySelector(".cost").value);
    var dose = toNumber(rows[i].querySelector(".dose").value);

    if(!(name && isFinite(dose) && dose>0 && isFinite(weight) && weight>0 && days>0 && tpd>0)) continue;

    var mgPerDose=weight*dose;
    var totalMg=mgPerDose*doses;

    if(mode==="TAB"){
      var strengths=getTabletStrengths(name); // CSV ã«åŒåè¤‡æ•°è¦æ ¼ãŒã‚ã‚Œã°ã“ã¡ã‚‰ã‚’ä½¿ç”¨
      var usedMulti = strengths.length>0;

      if(usedMulti){
        var opt=optimizeMultiStrength(totalMg, strengths);
        // ã‚³ã‚¹ãƒˆé›†è¨ˆ
        var drugCost = 0;
        var parts = [];
        for(var k=0;k<opt.plan.length;k++){
          var p = opt.plan[k];
          drugCost += ceilYen(p.pricePer * p.billed);
          parts.push(p.unitMg+"mgÃ—"+fmtQuarter(p.displayCount)+"t");
        }
        subtotal += drugCost; items++;

        // åˆ†å‰²æ–™ï¼ˆæœ€å°è¦æ ¼åˆ†ï¼‰
        if(opt.splitFeePerDose>0) splitFee += opt.splitFeePerDose * doses;

        // å‡ºåŠ›
        detail += "ã€éŒ å‰¤ã€‘"+name+"\n"
               +  dose+"mg/kg Ã— "+tpd+"å› Ã— "+days+"æ—¥åˆ†ï¼ˆä½“é‡ï¼š"+weight+"kgï¼‰\n"
               +  "â†’ å¿…è¦é‡ï¼š"+Math.round(totalMg)+"mg\n"
               +  "â†’ "+parts.join(" + ")+"\n"
               +  "è–¬å‰¤æ–™ï¼š"+drugCost+"å††\n\n";

        // ç°¡æ˜“
        var simpleParts=[];
        for(k=0;k<opt.plan.length;k++){
          var sp=opt.plan[k];
          simpleParts.push(name+sp.unitMg+"mg "+fmtQuarter(sp.displayCount)+"t");
        }
        simpleLines = simpleLines.concat(simpleParts);

      }else{
        // CSVãŒç„¡ã„/å˜ä¸€è¦æ ¼å…¥åŠ› â†’ æ—§æ¥ã®å˜ä¸€æœ€é©åŒ–ã§è¨ˆç®—
        if(!(isFinite(unit) && unit>0 && isFinite(cost) && cost>0)) continue;
        var pricePer=ceil10(cost*markupFor(cost));
        // 1/4 åˆ»ã¿æœ€é©åŒ–ï¼ˆå˜ä¸€è¦æ ¼ï¼‰
        var q=Math.ceil(totalMg/(unit/4));
        var billed=Math.ceil(q/4);
        var split="";
        if(q%4===2) split="1/2";
        if(q%4===1 || q%4===3) split="1/4";
        var displayCount=q/4;
        var drugCost=ceilYen(pricePer*billed);
        subtotal+=drugCost; items++;
        if(split==="1/2") splitFee+=10*doses;
        if(split==="1/4") splitFee+=20*doses;

        detail += "ã€éŒ å‰¤ã€‘"+name+" "+unit+"mg/éŒ \n"
               +  dose+"mg/kg Ã— "+tpd+"å› Ã— "+days+"æ—¥åˆ†ï¼ˆä½“é‡ï¼š"+weight+"kgï¼‰\n"
               +  "â†’ å¿…è¦é‡ï¼š"+Math.round(totalMg)+"mgï¼ˆ"+fmtQuarter(displayCount)+"éŒ ç›¸å½“ï¼‰\n"
               +  "è–¬å‰¤æ–™ï¼š"+drugCost+"å††ï¼ˆ"+pricePer+"å††/éŒ  Ã— "+billed+"éŒ ï¼‰\n\n";
        simpleLines.push(name+unit+"mg "+fmtQuarter(displayCount)+"t");
      }

    }else{
      // æ•£å‰¤ï¼šå¾“æ¥é€šã‚Šï¼ˆè¤‡æ•°æ¿ƒåº¦ã¯ç¨€ãªã®ã§å˜ä¸€æ‰±ã„ï¼‰
      if(!(isFinite(unit) && unit>0 && isFinite(cost) && cost>0)) continue;
      var pricePerP=ceil10(cost*markupFor(cost));
      var ml=Math.ceil((totalMg/unit)*100)/100;
      var drugCostP=ceilYen(pricePerP*ml);
      subtotal+=drugCostP; items++;

      detail += "ã€æ•£å‰¤ã€‘"+name+" "+unit+"mg/mL\n"
             +  dose+"mg/kg Ã— "+tpd+"å› Ã— "+days+"æ—¥åˆ†ï¼ˆä½“é‡ï¼š"+weight+"kgï¼‰\n"
             +  "â†’ å¿…è¦é‡ï¼š"+Math.round(totalMg)+"mgï¼ˆç´„"+ml+"mLï¼‰\n"
             +  "è–¬å‰¤æ–™ï¼š"+drugCostP+"å††\n\n";
      simpleLines.push(name+" "+ml+"mL");
    }
  }

  // åˆ†åŒ…
  if(bunpo){ packFee += 20*doses; }
  // å‡¦æ–¹æ–™
  if(items>0) scriptFee = ceilYen(80*days + 40*days*(items-1));
  var total = ceilYen(subtotal + splitFee + packFee + scriptFee);

  var freq=(tpd===1?"SID":tpd===2?"BID":"TID");
  var tail=(byId("globalForm").value==="TAB" ? "TAB "+doses+"ãƒ¶ "+freq+" "+days+"æ—¥åˆ†" : "ç²‰ "+doses+"åŒ… "+freq+" "+days+"æ—¥åˆ†");
  var simple="å†…æœè–¬ï¼ "+ (doses?ceil10(total/doses):0) +" x"+doses+"\n"
            + (simpleLines.length?simpleLines.join("  ")+"\n":"")
            + tail;

  if(packFee>0) detail += "åˆ†åŒ…æ–™ï¼š"+packFee+"å††\n";
  if(splitFee>0) detail += "åˆ†å‰²æ–™ï¼š"+splitFee+"å††\n";
  detail += "å‡¦æ–¹æ–™ï¼š"+scriptFee+"å††\nâ€”â€”â€”\nåˆè¨ˆï¼š"+total+"å††";

  return {simple:simple, detail:detail};
}

/* ====== å‡ºåŠ›æ›´æ–° ====== */
function recalc(){
  var r=calcAll();
  byId("outputSimple").textContent=r.simple;
  byId("outputDetail").textContent=r.detail;
}

/* ====== åˆæœŸåŒ– ====== */
function init(){
  updateCsvStatus();
  addRow();
  refreshTplSelect();

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¥åŠ›å¤‰æ›´ã§å†è¨ˆç®— & ãƒ©ãƒ™ãƒ«æ›´æ–°
  ["weight","days","timesPerDay","globalForm","bunpo"].forEach(function(id){
    var el=byId(id);
    el.addEventListener("input", function(){ if(id==="globalForm") updateFormLabels(); recalc(); });
    el.addEventListener("change", function(){ if(id==="globalForm") updateFormLabels(); recalc(); });
  });
}
function addRow(data){ listEl.appendChild(makeRow(data)); recalc(); }

byId("addDrug").addEventListener("click",function(){ addRow(); });
byId("clearAll").addEventListener("click",function(){ listEl.innerHTML=""; addRow(); });

byId("copySimple").addEventListener("click",function(){
  navigator.clipboard.writeText(byId("outputSimple").textContent); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
});
byId("copyDetail").addEventListener("click",function(){
  navigator.clipboard.writeText(byId("outputDetail").textContent); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
});

/* ====== åˆæœŸåŒ– ====== */
function addRow(data){ 
  listEl.appendChild(makeRow(data)); 
  recalc(); 
}

function init(){
  updateCsvStatus();
  addRow();            // åˆæœŸ1è¡Œ
  refreshTplSelect();

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¥åŠ›å¤‰æ›´ã§å†è¨ˆç®— & ãƒ©ãƒ™ãƒ«æ›´æ–°
  ["weight","days","timesPerDay","globalForm","bunpo"].forEach(function(id){
    var el=byId(id);
    el.addEventListener("input", function(){ if(id==="globalForm") updateFormLabels(); recalc(); });
    el.addEventListener("change", function(){ if(id==="globalForm") updateFormLabels(); recalc(); });
  });

  byId("addDrug").addEventListener("click",function(){ addRow(); });
  byId("clearAll").addEventListener("click",function(){ listEl.innerHTML=""; addRow(); });

  byId("copySimple").addEventListener("click",function(){
    navigator.clipboard.writeText(byId("outputSimple").textContent); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
  });
  byId("copyDetail").addEventListener("click",function(){
    navigator.clipboard.writeText(byId("outputDetail").textContent); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
  });
}

init();
</script>
</body>
</html>
