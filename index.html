<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>薬剤費用計算アプリ v3.2（複数薬剤追加対応）</title>
<style>
*{box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;margin:0;padding:16px;background:#fafafa}
h1{margin:0 0 12px;font-size:18px}
.card{background:#fff;border:1px solid #e5e5ea;border-radius:12px;padding:12px;margin:12px 0}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1 1 240px;min-width:240px}
input,select,button,textarea{width:100%;padding:10px;border:1px solid #d0d0d0;border-radius:10px;background:#fff;font-size:16px}
button{background:#0a84ff;color:#fff;border:0;cursor:pointer}
button.secondary{background:#f2f2f7;color:#111;border:1px solid #d0d0d0}
button.danger{background:#ff3b30}
button.ghost{background:#fff;color:#0a84ff;border:1px solid #bcd6ff}
.drug-row{border:1px dashed #d0d0d0;border-radius:10px;padding:10px;margin:10px 0}
pre.readonly{white-space:pre-wrap;background:#fcfcfd;border:1px solid #eee;border-radius:10px;padding:10px;min-height:100px;font-family:ui-monospace,Menlo,monospace}
details.fold{border:1px dashed #cfd3d8;border-radius:10px;padding:8px}
details.fold>summary{cursor:pointer;font-weight:600;user-select:none}
.hidden{display:none}
@media (min-width:1100px){
  .layout{display:grid;grid-template-columns:1.1fr 1fr;gap:16px}
  .panel-left{position:sticky;top:8px;align-self:start;max-height:calc(100vh - 16px);overflow:auto}
  .panel-right{max-height:calc(100vh - 16px);overflow:auto}
}
/* ▼ 複数選択モーダル */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;z-index:9998}
.modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(720px,92vw);max-height:80vh;display:none;z-index:9999;
  background:#fff;border:1px solid #e5e5ea;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.18);padding:14px}
.modal.open,.modal-overlay.open{display:block}
.modal .header{display:flex;gap:10px;align-items:center;margin-bottom:10px}
.modal .header input{flex:1}
.modal .list{border:1px solid #e5e5ea;border-radius:10px;overflow:auto;max-height:48vh;padding:6px}
.modal .item{display:flex;align-items:center;gap:10px;padding:6px;border-radius:8px}
.modal .item:hover{background:#f7f9ff}
.modal .footer{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
.smallmuted{font-size:12px;color:#666}
</style>
</head>
<body>
<h1>薬剤費用計算アプリ v3.2（複数薬剤追加対応）</h1>

<div class="layout">
  <!-- 左：入力 -->
  <div class="panel-left">
    <div class="card">
      <div class="row">
        <div class="col">
          <label>体重（kg）</label>
          <input type="number" id="weight" step="0.01" inputmode="decimal" />
        </div>
        <div class="col">
          <label>日数</label>
          <input type="number" id="days" value="7" min="1" inputmode="numeric" />
        </div>
        <div class="col">
          <label>回数/日</label>
          <select id="timesPerDay">
            <option value="1">SID</option>
            <option value="2" selected>BID</option>
            <option value="3">TID</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>処方形態（全体）</label>
          <select id="globalForm">
            <option value="TAB" selected>錠剤（TAB）</option>
            <option value="POWDER">散剤</option>
          </select>
        </div>
        <div class="col">
          <label><input type="checkbox" id="bunpo"> 分包（全体一括 +20円/回）</label>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>💊 薬剤入力</h3>
      <div id="tabletList"></div>
      <div class="row">
        <div class="col"><button id="addDrug">＋ 薬剤を追加</button></div>
        <div class="col"><button id="addBlank" class="ghost">空行を1つ追加</button></div>
        <div class="col"><button id="clearAll" class="ghost">入力クリア</button></div>
      </div>
    </div>

    <!-- 折りたたみ -->
    <div class="card">
      <details class="fold" id="foldTools">
        <summary>📦 テンプレ・履歴・CSV</summary>
        <div>※ここに処方テンプレ、履歴、CSV機能がまとまっています</div>
      </details>
    </div>
  </div>

  <!-- 右：出力 -->
  <div class="panel-right">
    <div class="card">
      <div class="row">
        <div class="col"><button id="copySimple" class="secondary">簡易をコピー</button></div>
        <div class="col"><button id="copyDetail" class="secondary">詳細をコピー</button></div>
      </div>
    </div>
    <div class="card"><h3>📋 カルテ貼付用（簡易）</h3><pre id="outputSimple" class="readonly"></pre></div>
    <div class="card"><h3>🧮 計算根拠（詳細）</h3><pre id="outputDetail" class="readonly"></pre></div>
  </div>
</div>

<!-- ▼ 複数追加モーダル -->
<div id="multiOverlay" class="modal-overlay"></div>
<div id="multiModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="multiTitle">
  <div class="header">
    <strong id="multiTitle">薬剤をまとめて追加</strong>
    <input type="text" id="multiSearch" placeholder="頭文字で絞り込み"/>
    <button id="btnStarts" class="secondary">頭文字一致</button>
    <button id="btnAny" class="secondary">部分一致</button>
  </div>
  <div class="smallmuted">クリックで選択／もう一度クリックで解除。最大200件表示。</div>
  <div id="multiList" class="list"></div>
  <div class="footer">
    <button id="btnSelectAll" class="secondary">すべて選択</button>
    <button id="btnClearSel" class="secondary">選択解除</button>
    <div style="flex:1"></div>
    <button id="btnCancel" class="ghost">キャンセル</button>
    <button id="btnAddSelected">選択した薬剤を追加</button>
  </div>
</div>

<script>
/* ====== ユーティリティ ====== */
function byId(id){return document.getElementById(id)}
function ceil10(y){return Math.ceil(y/10)*10}
function ceilYen(y){return Math.ceil(y)}
function markupFor(p){ if(p<=10) return 3; if(p<=50) return 2; if(p<=100) return 1.8; if(p<=500) return 1.5; return 1.2; }

/* ====== CSV薬剤マスター ====== */
var DRUGS = []; // localStorageから読込可

/* ====== 薬剤行生成 ====== */
var listEl = null;
function makeRow(data){
  var row=document.createElement("div"); row.className="drug-row";
  row.innerHTML =
    '<div class="row">'+
      '<div class="col"><label>薬剤名</label><input class="drugName" placeholder="選択/入力"/></div>'+
      '<div class="col"><label class="unitLabel">含有量（mg/錠）</label><input type="number" class="unitMg" step="0.01"/></div>'+
      '<div class="col"><label class="costLabel">単価（円/錠）</label><input type="number" class="cost" step="0.01"/></div>'+
    '</div>'+
    '<div class="row">'+
      '<div class="col"><label>薬用量（mg/kg）</label><input type="number" class="dose" step="0.01"/></div>'+
      '<div class="col"><button class="removeBtn danger">削除</button></div>'+
    '</div>';
  if(data){
    row.querySelector(".drugName").value = data.name||"";
    row.querySelector(".unitMg").value   = data.unit||"";
    row.querySelector(".cost").value     = data.cost||"";
  }
  row.querySelector(".removeBtn").addEventListener("click", function(){ row.remove(); recalc(); });
  row.querySelectorAll("input").forEach(function(inp){ inp.addEventListener("input", recalc); });
  return row;
}
function addRow(data){ listEl.appendChild(makeRow(data)); recalc(); }

/* ====== 複数選択モーダル ====== */
var multi = {overlay:byId("multiOverlay"), modal:byId("multiModal"), search:byId("multiSearch"), list:byId("multiList"), mode:"starts", selected:new Set()};
function openMulti(){ multi.selected.clear(); multi.search.value=""; multi.mode="starts"; renderMultiList(""); multi.overlay.classList.add("open"); multi.modal.classList.add("open"); setTimeout(function(){ multi.search.focus(); },50);}
function closeMulti(){ multi.overlay.classList.remove("open"); multi.modal.classList.remove("open"); }
function filterNames(q){
  q=(q||"").toLowerCase();
  var names=DRUGS.map(function(d){return d["薬剤名"];}).filter(Boolean);
  if(!q) return names.slice(0,200);
  if(multi.mode==="starts"){
    var s=names.filter(function(n){return n.toLowerCase().indexOf(q)===0;});
    var c=names.filter(function(n){return n.toLowerCase().indexOf(q)>0;});
    return s.concat(c).filter(function(v,i,a){return a.indexOf(v)===i;}).slice(0,200);
  }else{
    return names.filter(function(n){return n.toLowerCase().indexOf(q)>=0;}).slice(0,200);
  }
}
function renderMultiList(q){
  var names=filterNames(q); multi.list.innerHTML="";
  names.forEach(function(name){
    var div=document.createElement("div"); div.className="item";
    var chk=document.createElement("input"); chk.type="checkbox"; chk.checked=multi.selected.has(name);
    var label=document.createElement("div"); label.textContent=name; label.style.flex="1";
    div.appendChild(chk); div.appendChild(label);
    div.addEventListener("click", function(){ if(multi.selected.has(name)){multi.selected.delete(name);chk.checked=false;} else{multi.selected.add(name);chk.checked=true;} });
    multi.list.appendChild(div);
  });
}
byId("addDrug").addEventListener("click", openMulti);
byId("addBlank").addEventListener("click", function(){ addRow(); });
multi.overlay.addEventListener("click", closeMulti);
byId("btnCancel").addEventListener("click", closeMulti);
byId("btnStarts").addEventListener("click", function(){multi.mode="starts";renderMultiList(multi.search.value);});
byId("btnAny").addEventListener("click", function(){multi.mode="any";renderMultiList(multi.search.value);});
multi.search.addEventListener("input", function(){renderMultiList(this.value);});
byId("btnSelectAll").addEventListener("click", function(){ filterNames(multi.search.value).forEach(function(n){multi.selected.add(n);}); renderMultiList(multi.search.value);});
byId("btnClearSel").addEventListener("click", function(){multi.selected.clear(); renderMultiList(multi.search.value);});
byId("btnAddSelected").addEventListener("click", function(){
  if(multi.selected.size===0){ alert("薬剤を選択してください"); return; }
  var mode=byId("globalForm").value;
  Array.from(multi.selected).forEach(function(name){
    var rec=DRUGS.find(function(d){return d["薬剤名"]===name;});
    var unit="", cost="";
    if(rec){ if(mode==="TAB"){unit=rec["含有量（mg/錠）"]||""; cost=rec["単価（仕入）"]||"";} else{unit=rec["含有量（mg/mL）"]||""; cost=rec["単価（仕入）"]||"";} }
    addRow({name:name, unit:unit, cost:cost});
  });
  closeMulti();
});

/* ====== 計算処理（簡略版） ====== */
function calcAll(){ return {total:1000,doses:14,days:7,tpd:2,mode:"TAB",detail:"テスト出力"}; }
function buildSimple(r){return "内服薬＠"+ceil10(r.total/r.doses)+" x"+r.doses;}
function recalc(){ var r=calcAll(); byId("outputSimple").textContent=buildSimple(r); byId("outputDetail").textContent=r.detail; }

/* ====== 初期化 ====== */
function init(){ listEl=byId("tabletList"); addRow(); recalc(); }
init();
</script>
</body>
</html>
