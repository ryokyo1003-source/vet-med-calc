<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v3.0ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬&å±¥æ­´ä»˜ãï¼‰</title>
<style>
:root{ --gap:14px; --fz:18px; --pad:12px; --btnh:46px; }
@media (min-width:768px){ :root{ --fz:16px; --pad:10px; --btnh:42px; } }
*{box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;margin:0;padding:16px;font-size:var(--fz);background:#fafafa}
h1{font-size:calc(var(--fz) + 2px);margin:0 0 10px}
h3{margin:0 0 8px}
.row{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center}
.col{flex:1 1 220px;min-width:220px}
input,select,button,textarea{width:100%;font-size:var(--fz);padding:var(--pad);min-height:var(--btnh);border-radius:12px;border:1px solid #d0d0d0;background:#fff}
button{background:#0a84ff;color:#fff;border:0;cursor:pointer}
button.secondary{background:#f2f2f7;color:#111;border:1px solid #d0d0d0}
button.danger{background:#ff3b30}
button.ghost{background:#fff;color:#0a84ff;border:1px solid #bcd6ff}
.card{border:1px solid #e5e5ea;border-radius:14px;padding:14px;margin:14px 0;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.muted{color:#666;font-size:calc(var(--fz) - 3px)}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef5ff;border:1px solid #cbdcff;color:#225}
.layout{display:block}
@media (min-width:1200px){
  .layout{display:grid;grid-template-columns:1.05fr 1fr;gap:18px;align-items:start}
  .panel-left{position:sticky;top:10px;align-self:start;height:calc(100vh - 20px);overflow:auto;padding-right:2px}
  .panel-right{max-height:calc(100vh - 20px);overflow:auto;padding-left:2px}
}
.drug-row{border:1px dashed #d0d0d0;border-radius:12px;padding:12px;margin:10px 0}
.label-inline{display:flex;align-items:center;gap:8px}
.pill{padding:4px 8px;border-radius:999px;background:#f4f7ff;border:1px solid #dbe6ff;color:#123}
pre.readonly{white-space:pre-wrap;background:#fcfcfd;border:1px solid #eee;border-radius:12px;padding:12px;min-height:140px;font-family:ui-monospace, Menlo, monospace}
.actions{display:flex;gap:10px;flex-wrap:wrap}
.primary-actions button{background:#0a84ff}
.secondary-actions button{background:#f2f2f7;color:#111;border:1px solid #d0d0d0}
.hidden{display:none}
.small{font-size:0.85em;color:#666}
.checkboxline{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
.list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
.list .rowline{display:flex;gap:8px;align-items:center}
.list .rowline .title{flex:1}
hr.sep{border:0;border-top:1px dashed #ddd;margin:10px 0}
</style>
</head>
<body>
<h1>è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v3.0</h1>

<div class="layout">
  <!-- å·¦ï¼šå…¥åŠ›ï¼†ãƒ†ãƒ³ãƒ—ãƒ¬ -->
  <div class="panel-left">
    <div class="card">
      <div class="row">
        <div class="col"><label>ä½“é‡ï¼ˆkgï¼‰</label><input type="number" id="weight" step="0.01" inputmode="decimal"/></div>
        <div class="col"><label>æ—¥æ•°</label><input type="number" id="days" value="7" min="1" inputmode="numeric"/></div>
        <div class="col"><label>å›æ•°/æ—¥</label>
          <select id="timesPerDay"><option value="1">SID</option><option value="2" selected>BID</option><option value="3">TID</option></select>
        </div>
      </div>
      <div class="row">
        <div class="col"><label>å‡¦æ–¹å½¢æ…‹ï¼ˆå…¨ä½“ï¼‰</label>
          <select id="globalForm">
            <option value="TAB" selected>éŒ å‰¤ï¼ˆTABï¼‰</option>
            <option value="POWDER">æ•£å‰¤</option>
          </select>
        </div>
        <div class="col checkboxline">
          <label class="label-inline"><input type="checkbox" id="bunpo"/> åˆ†åŒ…ï¼ˆå…¨ä½“ä¸€æ‹¬ +20å††/å›ï¼‰</label>
          <span class="muted">ï¼ ï¼åˆè¨ˆÃ·(å›æ•°Ã—æ—¥æ•°)ã‚’10å††åˆ‡ä¸Šã’ï¼è‡ªå‹•å†è¨ˆç®—</span>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>ğŸ§° å‡¦æ–¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h3>
      <div class="row">
        <div class="col"><input id="tplName" placeholder="ä¾‹ï¼‰ä¸‹ç—¢æ­¢ã‚ã‚»ãƒƒãƒˆ"/></div>
        <div class="col actions">
          <button id="saveTpl">ç¾åœ¨ã®å…¥åŠ›ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ä¿å­˜</button>
          <button id="overwriteTpl" class="ghost">åŒåã«ä¸Šæ›¸ã</button>
        </div>
      </div>
      <div class="row">
        <div class="col"><select id="tplSelect"></select></div>
        <div class="col actions">
          <button id="loadTpl" class="secondary">ãƒ†ãƒ³ãƒ—ãƒ¬èª­è¾¼</button>
          <button id="deleteTpl" class="danger">ãƒ†ãƒ³ãƒ—ãƒ¬å‰Šé™¤</button>
          <button id="exportTpl" class="ghost">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <button id="importTpl" class="ghost">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        </div>
      </div>
      <div class="small">ãƒ†ãƒ³ãƒ—ãƒ¬ã¯ç«¯æœ«ã® <code>localStorage</code> ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>
    </div>

    <div class="card">
      <h3>ğŸ’Š è–¬å‰¤å…¥åŠ›</h3>
      <div id="tabletList"></div>
      <div class="actions">
        <div class="primary-actions"><button id="addDrug">ï¼‹ è–¬å‰¤ã‚’è¿½åŠ </button></div>
        <div class="secondary-actions">
          <button id="clearAll" class="ghost">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
        </div>
      </div>
      <hr class="sep"/>
      <h3>ğŸ“¦ è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ï¼ˆCSVï¼‰ <span class="badge">ç«¯æœ«ä¿å­˜</span></h3>
      <div class="row">
        <div class="col"><input type="file" id="csvInput" accept=".csv"/></div>
        <div class="col"><button id="saveCsv" class="secondary">ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’CSVä¿å­˜</button></div>
      </div>
      <div class="small">åˆ—ï¼šè–¬å‰¤å, å‰¤å‹, å˜ä¾¡ï¼ˆä»•å…¥ï¼‰, å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰, ï¼ˆä»»æ„ï¼‰å«æœ‰é‡ï¼ˆmg/mLï¼‰</div>
    </div>
  </div>

  <!-- å³ï¼šå‡ºåŠ›ï¼†å±¥æ­´ -->
  <div class="panel-right">
    <div class="card">
      <div class="actions">
        <div class="secondary-actions">
          <button id="copySimple" class="secondary">ç°¡æ˜“ã‚’ã‚³ãƒ”ãƒ¼</button>
          <button id="copyDetail" class="secondary">è©³ç´°ã‚’ã‚³ãƒ”ãƒ¼</button>
          <button id="saveHistory" class="ghost">ã“ã®å‡¦æ–¹ã‚’å±¥æ­´ä¿å­˜</button>
        </div>
      </div>
    </div>
    <div class="card">
      <h3>ğŸ“‹ ã‚«ãƒ«ãƒ†è²¼ä»˜ç”¨ï¼ˆç°¡æ˜“ï¼‰</h3>
      <pre id="outputSimple" class="readonly"></pre>
    </div>
    <div class="card">
      <h3>ğŸ§® è¨ˆç®—æ ¹æ‹ ï¼ˆè©³ç´°ï¼‰</h3>
      <pre id="outputDetail" class="readonly"></pre>
    </div>

    <div class="card">
      <h3>ğŸ“š å‡¦æ–¹å±¥æ­´</h3>
      <div class="row">
        <div class="col"><input id="histFilter" placeholder="æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«/è–¬å‰¤åï¼‰"/></div>
        <div class="col actions">
          <button id="exportHist" class="ghost">å±¥æ­´ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <button id="clearHist" class="danger">å±¥æ­´å…¨å‰Šé™¤</button>
        </div>
      </div>
      <div id="historyList" class="list"></div>
    </div>
  </div>
</div>

<!-- datalistï¼ˆCSVã‹ã‚‰å‹•çš„ç”Ÿæˆï¼‰ -->
<datalist id="drugList"></datalist>

<script>
/* ===== Utility & Keys ===== */
function ceil10(y){return Math.ceil(y/10)*10}
function ceilYen(y){return Math.ceil(y)}
function byId(id){return document.getElementById(id)}
const KEY_MASTER="drugMasterSimple";
const KEY_NOTES="drugNotesV1";
const KEY_TPL="rxTemplatesV1";
const KEY_HIST="rxHistoryV1";

/* æ›ã‘ç‡ */
function markupFor(p){ if(p<=10) return 3; if(p<=50) return 2; if(p<=100) return 1.8; if(p<=500) return 1.5; return 1.2; }

/* ===== CSV Master ===== */
let DRUGS = JSON.parse(localStorage.getItem(KEY_MASTER)||"null") || [];
function saveDrugs(list){ localStorage.setItem(KEY_MASTER, JSON.stringify(list)); }
function loadNotes(){ return JSON.parse(localStorage.getItem(KEY_NOTES)||"{}"); }
function saveNotes(map){ localStorage.setItem(KEY_NOTES, JSON.stringify(map)); }
function refreshDatalist(){
  const list=byId("drugList"); list.innerHTML="";
  (DRUGS||[]).forEach(d=>{ const o=document.createElement("option"); o.value=d.è–¬å‰¤å; list.appendChild(o); });
}

/* CSVå…¥å‡ºåŠ› */
byId("csvInput").addEventListener("change",(ev)=>{
  const f=ev.target.files && ev.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=(e)=>{
    const text=e.target.result;
    const lines=text.split(/\r?\n/).filter(x=>x.trim());
    if(lines.length<2){ alert("CSVãŒç©ºã§ã™"); return; }
    const header=lines[0].split(",");
    const idx={ name:header.indexOf("è–¬å‰¤å"), type:header.indexOf("å‰¤å‹"), cost:header.indexOf("å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"), unitTab:header.indexOf("å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"), unitMl:header.indexOf("å«æœ‰é‡ï¼ˆmg/mL)") };
    // NOTE: ä¸€éƒ¨CSVã§ (mg/mL) ã®æ‹¬å¼§ãŒå…¨è§’ãƒ»åŠè§’é•ã„ã®å¯èƒ½æ€§ã‚ã‚Šå¯¾å¿œ:
    if(idx.unitMl<0) idx.unitMl=header.findIndex(h=>h.replace(/\s/g,'').includes("å«æœ‰é‡ï¼ˆmg/mLï¼‰"));
    const list=[];
    for(let i=1;i<lines.length;i++){
      const c=lines[i].split(",");
      const rec={ è–¬å‰¤å:c[idx.name]||"", å‰¤å‹:c[idx.type]||"", "å˜ä¾¡ï¼ˆä»•å…¥ï¼‰":parseFloat(c[idx.cost]||"0")||0,
        "å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰":(idx.unitTab>=0&&c[idx.unitTab])?parseFloat(c[idx.unitTab]):"",
        "å«æœ‰é‡ï¼ˆmg/mLï¼‰":(idx.unitMl>=0&&c[idx.unitMl])?parseFloat(c[idx.unitMl]):"" };
      if(rec.è–¬å‰¤å) list.push(rec);
    }
    DRUGS=list; saveDrugs(DRUGS); refreshDatalist(); recalc();
    alert(`è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ${list.length}ä»¶ï¼‰`);
  };
  reader.readAsText(f,"utf-8");
});
byId("saveCsv").addEventListener("click",()=>{
  const header=["è–¬å‰¤å","å‰¤å‹","å˜ä¾¡ï¼ˆä»•å…¥ï¼‰","å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰","å«æœ‰é‡ï¼ˆmg/mLï¼‰"];
  const rows=[header.join(",")].concat((DRUGS||[]).map(d=>[d.è–¬å‰¤å,d.å‰¤å‹,d["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"],d["å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"]||"",d["å«æœ‰é‡ï¼ˆmg/mLï¼‰"]||""].join(",")));
  const blob=new Blob([rows.join("\n")],{type:"text/csv"}); const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="drug_master_export.csv"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

/* ===== è–¬å‰¤è¡Œï¼ˆæ•£å‰¤ã®ã¿ æº¶è§£/ã‚«ãƒ—ã‚»ãƒ«ï¼‰ ===== */
function makeRow(data){
  const row=document.createElement("div"); row.className="drug-row";
  row.innerHTML=`
    <div class="row">
      <div class="col"><label>è–¬å‰¤å</label><input type="text" class="drugName" list="drugList" placeholder="é¸æŠã¾ãŸã¯å…¥åŠ›"/></div>
      <div class="col"><label class="unitLabel">å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰</label><input type="number" class="unitMg" step="0.01"/></div>
      <div class="col"><label class="costLabel">å˜ä¾¡ï¼ˆå††/éŒ ï¼‰</label><input type="number" class="cost" step="0.01"/></div>
    </div>
    <div class="row">
      <div class="col">
        <label class="label-inline">è–¬ç”¨é‡ï¼ˆmg/kgï¼‰ <span class="pill">å®ŸåŠ¹ï¼š<span class="effDose">-</span> mg/kg</span></label>
        <input type="number" class="dose" step="0.01" placeholder="ä¾‹ï¼š10"/>
      </div>
      <div class="col"><button class="removeBtn danger">å‰Šé™¤</button></div>
    </div>
    <div class="row powderOnly hidden">
      <div class="col checkboxline">
        <label><input type="checkbox" class="syrupChk"/> ã‚·ãƒ­ãƒƒãƒ—æº¶è§£ï¼ˆ+500å††ï¼‰</label>
        <label><input type="checkbox" class="capsuleChk"/> ã‚«ãƒ—ã‚»ãƒ«è©°ã‚ï¼ˆ+800å††ï¼‰</label>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>ãƒ¡ãƒ¢ï¼ˆè–¬å‰¤ã”ã¨ã«ä¿å­˜ï¼‰</label>
        <textarea class="noteArea" style="height:90px"></textarea>
        <button class="secondary saveNoteBtn" style="margin-top:8px">ã“ã®è–¬ã®ãƒ¡ãƒ¢ã‚’ä¿å­˜</button>
        <div class="small">â€»ç«¯æœ«ã«ä¿å­˜ã€è–¬å‰¤åã‚­ãƒ¼ã§è‡ªå‹•å¾©å…ƒ</div>
      </div>
    </div>
  `;
  // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‚ç…§
  const nameInput=row.querySelector(".drugName");
  const unitInput=row.querySelector(".unitMg");
  const costInput=row.querySelector(".cost");
  const doseInput=row.querySelector(".dose");
  const noteArea=row.querySelector(".noteArea");
  const syrupChk=row.querySelector(".syrupChk");
  const capsuleChk=row.querySelector(".capsuleChk");

  // åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ
  if(data){
    nameInput.value=data.name||"";
    unitInput.value=(data.unit ?? "");
    costInput.value=(data.cost ?? "");
    doseInput.value=(data.dose ?? "");
    noteArea.value=data.note||"";
    if(syrupChk) syrupChk.checked=!!data.syrup;
    if(capsuleChk) capsuleChk.checked=!!data.capsule;
  }

  row.querySelector(".removeBtn").addEventListener("click",()=>{ row.remove(); recalc(); });

  function loadFromCsv(name){
    const d=(DRUGS||[]).find(x=>x.è–¬å‰¤å===name);
    if(!d) return;
    const mode=byId("globalForm").value;
    if(mode==="TAB"){ unitInput.value=d["å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"]||""; costInput.value=d["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"]||""; }
    else{ unitInput.value=d["å«æœ‰é‡ï¼ˆmg/mLï¼‰"]||""; costInput.value=d["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"]||""; }
    const notes=loadNotes(); noteArea.value=notes[name]||noteArea.value;
    recalc();
  }
  nameInput.addEventListener("change",()=>loadFromCsv(nameInput.value));
  nameInput.addEventListener("blur",()=>loadFromCsv(nameInput.value));

  row.querySelector(".saveNoteBtn").addEventListener("click",()=>{
    const name=nameInput.value.trim();
    if(!name){ alert("è–¬å‰¤åã‚’å…¥åŠ›/é¸æŠã—ã¦ãã ã•ã„"); return; }
    const notes=loadNotes(); notes[name]=noteArea.value||""; saveNotes(notes);
    alert("ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
  });

  // å…¥åŠ›ã®åº¦ã«å†è¨ˆç®—
  row.querySelectorAll("input,select,textarea").forEach(el=>{
    el.addEventListener("input",recalc);
    el.addEventListener("change",recalc);
  });

  return row;
}

const list=byId("tabletList");
function addRow(data){ list.appendChild(makeRow(data)); applyGlobalFormUI(); recalc(); }
byId("addDrug").addEventListener("click",()=>addRow());
byId("clearAll").addEventListener("click",()=>{ list.innerHTML=""; addRow(); });

/* å½¢æ…‹åˆ‡æ›¿ï¼šãƒ©ãƒ™ãƒ«ã¨æ•£å‰¤å°‚ç”¨UIã®è¡¨ç¤º */
function applyGlobalFormUI(){
  const mode=byId("globalForm").value; // TAB or POWDER
  document.querySelectorAll(".unitLabel").forEach(l=>l.textContent = (mode==="TAB" ? "å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰" : "å«æœ‰é‡ï¼ˆmg/mLï¼‰"));
  document.querySelectorAll(".costLabel").forEach(l=>l.textContent = (mode==="TAB" ? "å˜ä¾¡ï¼ˆå††/éŒ ï¼‰" : "å˜ä¾¡ï¼ˆå††/mLï¼‰"));
  document.querySelectorAll(".powderOnly").forEach(e=>e.classList.toggle("hidden", !(mode==="POWDER")));
}
["weight","days","timesPerDay","bunpo","globalForm"].forEach(id=>{
  byId(id).addEventListener("input",()=>{ applyGlobalFormUI(); recalc(); });
  byId(id).addEventListener("change",()=>{ applyGlobalFormUI(); recalc(); });
});

/* ===== TABç”¨ï¼š1/4éŒ å˜ä½ã§è‡ªå‹•æœ€é©åŒ– ===== */
function optimizeTablets(totalMg, unitMgPerTab){
  if(!(unitMgPerTab>0)){ return {whole:0, halves:0, quarters:0, billed:0, achievedMg:0}; }
  const qNeeded = Math.ceil(totalMg / (unitMgPerTab/4)); // 1/4éŒ å˜ä½åˆ‡ä¸Šã’
  const whole = Math.floor(qNeeded/4);
  const rem = qNeeded % 4;
  const halves = Math.floor(rem/2);
  const quarters = rem % 2;
  const billed = Math.ceil(qNeeded/4); // å®Ÿéš›ã®è£½é€ éŒ æ•°
  const achievedMg = (whole + halves*0.5 + quarters*0.25) * unitMgPerTab;
  return {whole, halves, quarters, billed, achievedMg};
}

/* ===== è¨ˆç®—æœ¬ä½“ï¼ˆå®Œå…¨è²»ç”¨ãƒ«ãƒ¼ãƒ«ï¼‰ ===== */
function calcAll(){
  const days=parseInt(byId("days").value||"0");
  const tpd=parseInt(byId("timesPerDay").value||"0");
  const doses=tpd*days;
  const weight=parseFloat(byId("weight").value||"0");
  const mode=byId("globalForm").value; // TAB or POWDER
  const bunpo=byId("bunpo").checked;

  let detail="", subtotal=0, items=0;
  let splitFeeTotal=0, packFeeTotal=0, syrupFeeTotal=0, capsuleFeeTotal=0;
  let needsHalf=false, needsQuarter=false;

  const rows=[...list.querySelectorAll(".drug-row")];
  rows.forEach(row=>{
    const name=row.querySelector(".drugName").value.trim();
    const unit=parseFloat(row.querySelector(".unitMg").value||"0");
    const cost=parseFloat(row.querySelector(".cost").value||"0");
    const dose=parseFloat(row.querySelector(".dose").value||"0");
    const effSpan=row.querySelector(".effDose");
    const syrupChk=row.querySelector(".syrupChk");
    const capsuleChk=row.querySelector(".capsuleChk");
    const noteArea=row.querySelector(".noteArea");

    if(effSpan) effSpan.textContent="-";
    if(!name||!unit||!cost||!dose||!weight||!days||!tpd) return;

    const mgPerDose=weight*dose;
    const totalMg  = mgPerDose*doses;
    const pricePer = ceil10(cost * markupFor(cost));

    if(mode==="TAB"){
      const opt = optimizeTablets(totalMg, unit);
      const billedTabs = opt.billed;
      const drugCost = ceilYen(pricePer * billedTabs);
      subtotal += drugCost; items++;
      if(opt.quarters>0){ needsQuarter = true; } else if(opt.halves>0){ needsHalf = true; }

      const achievedMgPerKg = (opt.achievedMg / doses) / weight;
      if(effSpan) effSpan.textContent = isFinite(achievedMgPerKg)? achievedMgPerKg.toFixed(2) : "-";
      const parts=[]; if(opt.whole) parts.push(`${opt.whole}t`); if(opt.halves) parts.push(`${opt.halves}Ã—1/2t`); if(opt.quarters) parts.push(`${opt.quarters}Ã—1/4t`);
      const comp = parts.length ? parts.join(" + ") : "0t";
      detail += `ã€éŒ å‰¤ã€‘${name} ${unit}mg/éŒ 
ç›®æ¨™ï¼š${dose}mg/kg Ã— ${tpd}å› Ã— ${days}æ—¥ï¼ˆä½“é‡ï¼š${weight}kgï¼‰
å¿…è¦é‡ï¼š${Math.round(totalMg)}mg
â†’ å®Ÿèª¿æ•´ï¼š${comp}ï¼ˆè¨ˆ ${billedTabs}éŒ  è£½é€ ï¼‰
ã€€å®ŸåŠ¹ç”¨é‡ï¼š${achievedMgPerKg.toFixed(2)} mg/kgï¼ˆåˆè¨ˆ ${Math.round(opt.achievedMg)}mgï¼‰
è–¬å‰¤æ–™ï¼š${drugCost}å††ï¼ˆ${pricePer}å††/éŒ  Ã— ${billedTabs}éŒ ï¼‰
${noteArea.value?`ãƒ¡ãƒ¢ï¼š${noteArea.value}\n`:``}
`;

    }else{ // POWDER
      const ml = Math.ceil((totalMg / unit) * 100)/100;
      const drugCost=ceilYen(pricePer*ml);
      subtotal+=drugCost; items++;
      const achievedMgPerKg = (totalMg / doses) / weight;
      if(effSpan) effSpan.textContent = isFinite(achievedMgPerKg)? achievedMgPerKg.toFixed(2) : "-";

      let extraLines="";
      if(syrupChk?.checked){ syrupFeeTotal += 500; extraLines += `ã‚·ãƒ­ãƒƒãƒ—æº¶è§£ï¼š500å††\n`; }
      if(capsuleChk?.checked){ capsuleFeeTotal += 800; extraLines += `ã‚«ãƒ—ã‚»ãƒ«è©°ã‚ï¼š800å††\n`; }

      detail += `ã€æ•£å‰¤ã€‘${name} ${unit}${isFinite(unit)&&unit>0?"mg/mL":""}
ç›®æ¨™ï¼š${dose}mg/kg Ã— ${tpd}å› Ã— ${days}æ—¥ï¼ˆä½“é‡ï¼š${weight}kgï¼‰
å¿…è¦é‡ï¼š${Math.round(totalMg)}mgï¼ˆç´„${ml.toFixed(2)}mLç›¸å½“ï¼‰
ã€€å®ŸåŠ¹ç”¨é‡ï¼š${achievedMgPerKg.toFixed(2)} mg/kg
è–¬å‰¤æ–™ï¼š${drugCost}å††ï¼ˆ${pricePer}å††/mL Ã— ${ml.toFixed(2)}mLï¼‰
${extraLines}${noteArea.value?`ãƒ¡ãƒ¢ï¼š${noteArea.value}\n`:``}
`;
    }
  });

  if(mode==="TAB"){
    if(needsQuarter) splitFeeTotal += 20*doses;
    else if(needsHalf) splitFeeTotal += 10*doses;
  }
  if(bunpo){ packFeeTotal += 20*doses; }

  const scriptFee = (items>0) ? ceilYen(80*days + 40*days*(items-1)) : 0;
  const total = ceilYen(subtotal + splitFeeTotal + packFeeTotal + syrupFeeTotal + capsuleFeeTotal + scriptFee);
  return {detail, subtotal, splitFeeTotal, packFeeTotal, syrupFeeTotal, capsuleFeeTotal, scriptFee, total, items, mode, doses, days, tpd};
}

/* å‡ºåŠ› */
function buildSimple({mode, doses, days, tpd, total}){
  const unit = doses>0 ? ceil10(total/doses) : 0;
  const freq = (tpd===1?"SID":tpd===2?"BID":"TID");
  const header = `å†…æœè–¬ï¼ ${unit} x${doses}`;
  const tail = mode==="TAB" ? `TAB ${doses}ãƒ¶ ${freq} ${days}æ—¥åˆ†` : `ç²‰ ${doses}åŒ… ${freq} ${days}æ—¥åˆ†`;
  return [header, tail].join("\n");
}
function recalc(){
  const r=calcAll(); if(!r) return;
  byId("outputSimple").textContent = buildSimple(r);
  let d = r.detail;
  if(r.splitFeeTotal>0)   d += `åˆ†å‰²æ–™åˆè¨ˆï¼š${r.splitFeeTotal}å††\n`;
  if(r.packFeeTotal>0)    d += `åˆ†åŒ…æ–™ï¼š${r.packFeeTotal}å††\n`;
  if(r.syrupFeeTotal>0)   d += `ã‚·ãƒ­ãƒƒãƒ—æº¶è§£åˆè¨ˆï¼š${r.syrupFeeTotal}å††\n`;
  if(r.capsuleFeeTotal>0) d += `ã‚«ãƒ—ã‚»ãƒ«è©°ã‚åˆè¨ˆï¼š${r.capsuleFeeTotal}å††\n`;
  d += `å‡¦æ–¹æ–™ï¼š${r.scriptFee}å††\nâ€”â€”â€”\nåˆè¨ˆï¼š${r.total}å††`;
  byId("outputDetail").textContent = d.trim();
}

/* ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ */
function copyPre(id){
  const text=byId(id).textContent;
  navigator.clipboard?.writeText(text).then(()=>alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ")).catch(()=>{
    const ta=document.createElement("textarea"); ta.value=text; document.body.appendChild(ta);
    ta.select(); document.execCommand("copy"); ta.remove(); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
  });
}
byId("copySimple").addEventListener("click",()=>copyPre("outputSimple"));
byId("copyDetail").addEventListener("click",()=>copyPre("outputDetail"));

/* ===== ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½ ===== */
function loadTemplates(){ return JSON.parse(localStorage.getItem(KEY_TPL)||"[]"); }
function saveTemplates(arr){ localStorage.setItem(KEY_TPL, JSON.stringify(arr)); }
function currentFormData(){
  const items=[...list.querySelectorAll(".drug-row")].map(row=>{
    return {
      name: row.querySelector(".drugName").value.trim(),
      unit: parseFloat(row.querySelector(".unitMg").value||""),
      cost: parseFloat(row.querySelector(".cost").value||""),
      dose: parseFloat(row.querySelector(".dose").value||""),
      note: row.querySelector(".noteArea").value||"",
      syrup: !!row.querySelector(".syrupChk")?.checked,
      capsule: !!row.querySelector(".capsuleChk")?.checked
    };
  }).filter(x=>x.name);
  return {
    name: byId("tplName").value.trim(),
    mode: byId("globalForm").value,
    bunpo: byId("bunpo").checked,
    items
  };
}
function applyFormData(data){
  byId("globalForm").value = data.mode || "TAB";
  byId("bunpo").checked = !!data.bunpo;
  list.innerHTML="";
  (data.items||[]).forEach(it=>addRow(it));
  if((data.items||[]).length===0) addRow();
  applyGlobalFormUI(); recalc();
}
function refreshTplSelect(){
  const sel=byId("tplSelect"); const arr=loadTemplates();
  sel.innerHTML=""; arr.forEach((t,i)=>{ const opt=document.createElement("option"); opt.value=i; opt.textContent=t.name; sel.appendChild(opt); });
}

byId("saveTpl").addEventListener("click",()=>{
  const data=currentFormData(); if(!data.name){ alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  const arr=loadTemplates();
  if(arr.find(t=>t.name===data.name)){ alert("åŒåã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒæ—¢ã«ã‚ã‚Šã¾ã™ã€‚ã€åŒåã«ä¸Šæ›¸ãã€ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚"); return;}
  arr.push(data); saveTemplates(arr); refreshTplSelect(); alert("ä¿å­˜ã—ã¾ã—ãŸ");
});
byId("overwriteTpl").addEventListener("click",()=>{
  const data=currentFormData(); if(!data.name){ alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  const arr=loadTemplates(); const idx=arr.findIndex(t=>t.name===data.name);
  if(idx<0){ alert("åŒåãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã€ãƒ†ãƒ³ãƒ—ãƒ¬ä¿å­˜ã€ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚"); return;}
  arr[idx]=data; saveTemplates(arr); refreshTplSelect(); alert("ä¸Šæ›¸ãã—ã¾ã—ãŸ");
});
byId("loadTpl").addEventListener("click",()=>{
  const arr=loadTemplates(); const idx=parseInt(byId("tplSelect").value||"-1");
  if(!(idx>=0 && arr[idx])){ alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„"); return;}
  byId("tplName").value=arr[idx].name;
  applyFormData(arr[idx]);
});
byId("deleteTpl").addEventListener("click",()=>{
  const arr=loadTemplates(); const idx=parseInt(byId("tplSelect").value||"-1");
  if(!(idx>=0 && arr[idx])){ alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„"); return;}
  if(!confirm(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ${arr[idx].name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  arr.splice(idx,1); saveTemplates(arr); refreshTplSelect(); alert("å‰Šé™¤ã—ã¾ã—ãŸ");
});
byId("exportTpl").addEventListener("click",()=>{
  const arr=loadTemplates(); const blob=new Blob([JSON.stringify(arr,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="templates.json";
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
byId("importTpl").addEventListener("click",()=>{
  const inp=document.createElement("input"); inp.type="file"; inp.accept=".json,application/json";
  inp.onchange=(e)=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader(); r.onload=ev=>{
      try{ const arr=JSON.parse(ev.target.result); if(!Array.isArray(arr)) throw new Error("å½¢å¼ä¸æ­£");
        saveTemplates(arr); refreshTplSelect(); alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ");
      }catch(e){ alert("JSONã®å½¢å¼ãŒä¸æ­£ã§ã™"); }
    }; r.readAsText(f,"utf-8");
  }; inp.click();
});

/* ===== å±¥æ­´ ===== */
function loadHistory(){ return JSON.parse(localStorage.getItem(KEY_HIST)||"[]"); }
function saveHistory(arr){ localStorage.setItem(KEY_HIST, JSON.stringify(arr)); }
function pushHistory(){
  const title = prompt("å±¥æ­´ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹ï¼šä¸‹ç—¢æ­¢ã‚ 10kg BID7æ—¥ï¼‰",""); 
  const simple=byId("outputSimple").textContent; const detail=byId("outputDetail").textContent;
  const snapshot=currentFormData(); // ç¾åœ¨ã®å…¥åŠ›æ§‹æˆã‚‚ä¸¸ã”ã¨ä¿å­˜
  const item={ id: Date.now(), ts:new Date().toISOString(), title: title|| (snapshot.items?.map(i=>i.name).slice(0,2).join("ï¼‹") || "å‡¦æ–¹"), simple, detail, snapshot };
  const arr=loadHistory(); arr.unshift(item); while(arr.length>100) arr.pop(); saveHistory(arr); renderHistory(); alert("å±¥æ­´ã«ä¿å­˜ã—ã¾ã—ãŸ");
}
function renderHistory(){
  const listEl=byId("historyList"); const filter=byId("histFilter").value.trim().toLowerCase();
  const arr=loadHistory(); listEl.innerHTML="";
  arr.filter(it=>{
    if(!filter) return true;
    return (it.title||"").toLowerCase().includes(filter) || (it.snapshot?.items||[]).some(d=>d.name.toLowerCase().includes(filter));
  }).forEach(it=>{
    const line=document.createElement("div"); line.className="rowline";
    const when=new Date(it.ts); const label=`${when.toLocaleString()}ï½œ${it.title}`;
    line.innerHTML=`
      <div class="title">${label}</div>
      <button class="secondary" data-act="load">å†èª­è¾¼</button>
      <button class="secondary" data-act="copyS">ç°¡æ˜“ã‚³ãƒ”ãƒ¼</button>
      <button class="secondary" data-act="copyD">è©³ç´°ã‚³ãƒ”ãƒ¼</button>
      <button class="danger" data-act="del">å‰Šé™¤</button>
    `;
    line.querySelector('[data-act="load"]').addEventListener("click",()=>applyFormData(it.snapshot));
    line.querySelector('[data-act="copyS"]').addEventListener("click",()=>{ navigator.clipboard.writeText(it.simple); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); });
    line.querySelector('[data-act="copyD"]').addEventListener("click",()=>{ navigator.clipboard.writeText(it.detail); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); });
    line.querySelector('[data-act="del"]').addEventListener("click",()=>{
      const arr2=loadHistory().filter(x=>x.id!==it.id); saveHistory(arr2); renderHistory();
    });
    listEl.appendChild(line);
  });
}
byId("saveHistory").addEventListener("click",pushHistory);
byId("exportHist").addEventListener("click",()=>{
  const arr=loadHistory(); const blob=new Blob([JSON.stringify(arr,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="rx_history.json";
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
byId("clearHist").addEventListener("click",()=>{
  if(!confirm("å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  saveHistory([]); renderHistory();
});
byId("histFilter").addEventListener("input",renderHistory);

/* ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ */
byId("copySimple").addEventListener("click",()=>copyPre("outputSimple"));
byId("copyDetail").addEventListener("click",()=>copyPre("outputDetail"));

/* ===== å†è¨ˆç®—ãƒ•ãƒ­ãƒ¼ ===== */
function buildSimple({mode, doses, days, tpd, total}){
  const unit = doses>0 ? ceil10(total/doses) : 0;
  const freq = (tpd===1?"SID":tpd===2?"BID":"TID");
  const header = `å†…æœè–¬ï¼ ${unit} x${doses}`;
  const tail = mode==="TAB" ? `TAB ${doses}ãƒ¶ ${freq} ${days}æ—¥åˆ†` : `ç²‰ ${doses}åŒ… ${freq} ${days}æ—¥åˆ†`;
  return [header, tail].join("\n");
}
function recalc(){
  const r=calcAll(); if(!r) return;
  byId("outputSimple").textContent = buildSimple(r);
  let d = r.detail;
  if(r.splitFeeTotal>0)   d += `åˆ†å‰²æ–™åˆè¨ˆï¼š${r.splitFeeTotal}å††\n`;
  if(r.packFeeTotal>0)    d += `åˆ†åŒ…æ–™ï¼š${r.packFeeTotal}å††\n`;
  if(r.syrupFeeTotal>0)   d += `ã‚·ãƒ­ãƒƒãƒ—æº¶è§£åˆè¨ˆï¼š${r.syrupFeeTotal}å††\n`;
  if(r.capsuleFeeTotal>0) d += `ã‚«ãƒ—ã‚»ãƒ«è©°ã‚åˆè¨ˆï¼š${r.capsuleFeeTotal}å††\n`;
  d += `å‡¦æ–¹æ–™ï¼š${r.scriptFee}å††\nâ€”â€”â€”\nåˆè¨ˆï¼š${r.total}å††`;
  byId("outputDetail").textContent = d.trim();
}

/* ===== è¨ˆç®—æœ¬ä½“ï¼ˆv2.9ã¨åŒç­‰ï¼‰ ===== */
function calcAll(){
  const days=parseInt(byId("days").value||"0");
  const tpd=parseInt(byId("timesPerDay").value||"0");
  const doses=tpd*days;
  const weight=parseFloat(byId("weight").value||"0");
  const mode=byId("globalForm").value;
  const bunpo=byId("bunpo").checked;
  let detail="", subtotal=0, items=0;
  let splitFeeTotal=0, packFeeTotal=0, syrupFeeTotal=0, capsuleFeeTotal=0;
  let needsHalf=false, needsQuarter=false;

  [...list.querySelectorAll(".drug-row")].forEach(row=>{
    const name=row.querySelector(".drugName").value.trim();
    const unit=parseFloat(row.querySelector(".unitMg").value||"0");
    const cost=parseFloat(row.querySelector(".cost").value||"0");
    const dose=parseFloat(row.querySelector(".dose").value||"0");
    const effSpan=row.querySelector(".effDose");
    const syrupChk=row.querySelector(".syrupChk");
    const capsuleChk=row.querySelector(".capsuleChk");
    const noteArea=row.querySelector(".noteArea");
    if(effSpan) effSpan.textContent="-";
    if(!name||!unit||!cost||!dose||!weight||!days||!tpd) return;

    const mgPerDose=weight*dose;
    const totalMg  = mgPerDose*doses;
    const pricePer = ceil10(cost * markupFor(cost));

    if(mode==="TAB"){
      const opt=optimizeTablets(totalMg, unit);
      const billedTabs=opt.billed;
      const drugCost=ceilYen(pricePer*billedTabs);
      subtotal+=drugCost; items++;
      if(opt.quarters>0){ needsQuarter=true; } else if(opt.halves>0){ needsHalf=true; }
      const achievedMgPerKg=(opt.achievedMg/doses)/weight; if(effSpan) effSpan.textContent=isFinite(achievedMgPerKg)?achievedMgPerKg.toFixed(2):"-";
      const parts=[]; if(opt.whole) parts.push(`${opt.whole}t`); if(opt.halves) parts.push(`${opt.halves}Ã—1/2t`); if(opt.quarters) parts.push(`${opt.quarters}Ã—1/4t`);
      const comp=parts.length?parts.join(" + "):"0t";
      detail += `ã€éŒ å‰¤ã€‘${name} ${unit}mg/éŒ 
ç›®æ¨™ï¼š${dose}mg/kg Ã— ${tpd}å› Ã— ${days}æ—¥ï¼ˆä½“é‡ï¼š${weight}kgï¼‰
å¿…è¦é‡ï¼š${Math.round(totalMg)}mg
â†’ å®Ÿèª¿æ•´ï¼š${comp}ï¼ˆè¨ˆ ${billedTabs}éŒ  è£½é€ ï¼‰
ã€€å®ŸåŠ¹ç”¨é‡ï¼š${achievedMgPerKg.toFixed(2)} mg/kgï¼ˆåˆè¨ˆ ${Math.round(opt.achievedMg)}mgï¼‰
è–¬å‰¤æ–™ï¼š${drugCost}å††ï¼ˆ${pricePer}å††/éŒ  Ã— ${billedTabs}éŒ ï¼‰
${noteArea.value?`ãƒ¡ãƒ¢ï¼š${noteArea.value}\n`:``}
`;
    }else{
      const ml=Math.ceil((totalMg/unit)*100)/100;
      const drugCost=ceilYen(pricePer*ml);
      subtotal+=drugCost; items++;
      const achievedMgPerKg=(totalMg/doses)/weight; if(effSpan) effSpan.textContent=isFinite(achievedMgPerKg)?achievedMgPerKg.toFixed(2):"-";
      let extraLines="";
      if(syrupChk?.checked){ syrupFeeTotal+=500; extraLines+=`ã‚·ãƒ­ãƒƒãƒ—æº¶è§£ï¼š500å††\n`; }
      if(capsuleChk?.checked){ capsuleFeeTotal+=800; extraLines+=`ã‚«ãƒ—ã‚»ãƒ«è©°ã‚ï¼š800å††\n`; }
      detail += `ã€æ•£å‰¤ã€‘${name} ${unit}${isFinite(unit)&&unit>0?"mg/mL":""}
ç›®æ¨™ï¼š${dose}mg/kg Ã— ${tpd}å› Ã— ${days}æ—¥ï¼ˆä½“é‡ï¼š${weight}kgï¼‰
å¿…è¦é‡ï¼š${Math.round(totalMg)}mgï¼ˆç´„${ml.toFixed(2)}mLç›¸å½“ï¼‰
ã€€å®ŸåŠ¹ç”¨é‡ï¼š${achievedMgPerKg.toFixed(2)} mg/kg
è–¬å‰¤æ–™ï¼š${drugCost}å††ï¼ˆ${pricePer}å††/mL Ã— ${ml.toFixed(2)}mLï¼‰
${extraLines}${noteArea.value?`ãƒ¡ãƒ¢ï¼š${noteArea.value}\n`:``}
`;
    }
  });

  if(mode==="TAB"){ if(needsQuarter) splitFeeTotal+=20*doses; else if(needsHalf) splitFeeTotal+=10*doses; }
  if(bunpo){ packFeeTotal+=20*doses; }
  const scriptFee=(items>0)?ceilYen(80*days + 40*days*(items-1)):0;
  const total=ceilYen(subtotal + splitFeeTotal + packFeeTotal + syrupFeeTotal + capsuleFeeTotal + scriptFee);
  return {detail, subtotal, splitFeeTotal, packFeeTotal, syrupFeeTotal, capsuleFeeTotal, scriptFee, total, items, mode, doses, days, tpd};
}

/* åˆæœŸåŒ–ï¼šãƒ†ãƒ³ãƒ—ãƒ¬/å±¥æ­´UI */
function refreshTplSelect(){ const sel=byId("tplSelect"); const arr=JSON.parse(localStorage.getItem(KEY_TPL)||"[]"); sel.innerHTML=""; arr.forEach((t,i)=>{ const o=document.createElement("option"); o.value=i; o.textContent=t.name; sel.appendChild(o); }); }
function renderHistory(){ const listEl=byId("historyList"); const filter=byId("histFilter").value.trim().toLowerCase(); const arr=loadHistory(); listEl.innerHTML="";
  arr.filter(it=>{ if(!filter) return true; return (it.title||"").toLowerCase().includes(filter) || (it.snapshot?.items||[]).some(d=>d.name.toLowerCase().includes(filter)); })
  .forEach(it=>{ const line=document.createElement("div"); line.className="rowline";
    const when=new Date(it.ts); const label=`${when.toLocaleString()}ï½œ${it.title}`;
    line.innerHTML=`<div class="title">${label}</div>
      <button class="secondary" data-act="load">å†èª­è¾¼</button>
      <button class="secondary" data-act="copyS">ç°¡æ˜“ã‚³ãƒ”ãƒ¼</button>
      <button class="secondary" data-act="copyD">è©³ç´°ã‚³ãƒ”ãƒ¼</button>
      <button class="danger" data-act="del">å‰Šé™¤</button>`;
    line.querySelector('[data-act="load"]').addEventListener("click",()=>applyFormData(it.snapshot));
    line.querySelector('[data-act="copyS"]').addEventListener("click",()=>{ navigator.clipboard.writeText(it.simple); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); });
    line.querySelector('[data-act="copyD"]').addEventListener("click",()=>{ navigator.clipboard.writeText(it.detail); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); });
    line.querySelector('[data-act="del"]').addEventListener("click",()=>{ const arr2=loadHistory().filter(x=>x.id!==it.id); saveHistory(arr2); renderHistory(); });
    listEl.appendChild(line);
  });
}
byId("saveHistory").addEventListener("click",pushHistory);

/* åˆæœŸã‚»ãƒƒãƒˆ */
function init(){
  refreshDatalist();
  addRow();
  applyGlobalFormUI();
  recalc();
  refreshTplSelect();
  renderHistory();
}
init();
</script>
</body>
</html>
