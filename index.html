<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>薬剤費用計算アプリ v2.9（RT計算・完全費用ルール・散剤のみ溶解/カプセル）</title>
<style>
:root{ --gap:14px; --fz:18px; --pad:12px; --btnh:46px; }
@media (min-width:768px){ :root{ --fz:16px; --pad:10px; --btnh:42px; } }
*{box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;margin:0;padding:16px;font-size:var(--fz);background:#fafafa}
h1{font-size:calc(var(--fz) + 2px);margin:0 0 10px}
.row{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center}
.col{flex:1 1 220px;min-width:220px}
input,select,button,textarea{width:100%;font-size:var(--fz);padding:var(--pad);min-height:var(--btnh);border-radius:12px;border:1px solid #d0d0d0;background:#fff}
button{background:#0a84ff;color:#fff;border:0;cursor:pointer}
button.secondary{background:#f2f2f7;color:#111;border:1px solid #d0d0d0}
button.danger{background:#ff3b30}
button.ghost{background:#fff;color:#0a84ff;border:1px solid #bcd6ff}
.card{border:1px solid #e5e5ea;border-radius:14px;padding:14px;margin:14px 0;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.muted{color:#666;font-size:calc(var(--fz) - 3px)}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef5ff;border:1px solid #cbdcff;color:#225}
.layout{display:block}
@media (min-width:1100px){
  .layout{display:grid;grid-template-columns:1.05fr 1fr;gap:18px;align-items:start}
  .panel-left{position:sticky;top:10px;align-self:start;height:calc(100vh - 20px);overflow:auto;padding-right:2px}
  .panel-right{max-height:calc(100vh - 20px);overflow:auto;padding-left:2px}
}
.drug-row{border:1px dashed #d0d0d0;border-radius:12px;padding:12px;margin:10px 0}
.label-inline{display:flex;align-items:center;gap:8px}
.pill{padding:4px 8px;border-radius:999px;background:#f4f7ff;border:1px solid #dbe6ff;color:#123}
pre.readonly{white-space:pre-wrap;background:#fcfcfd;border:1px solid #eee;border-radius:12px;padding:12px;min-height:140px;font-family:ui-monospace, SFMono-Regular, Menlo, monospace}
.actions{display:flex;gap:10px;flex-wrap:wrap}
.primary-actions button{background:#0a84ff}
.secondary-actions button{background:#f2f2f7;color:#111;border:1px solid #d0d0d0}
.hidden{display:none}
.small{font-size:0.85em;color:#666}
.checkboxline{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
</style>
</head>
<body>
<h1>薬剤費用計算アプリ v2.9</h1>

<div class="layout">
  <!-- 左：入力 -->
  <div class="panel-left">
    <div class="card">
      <div class="row">
        <div class="col"><label>体重（kg）</label><input type="number" id="weight" step="0.01" inputmode="decimal"/></div>
        <div class="col"><label>日数</label><input type="number" id="days" value="7" min="1" inputmode="numeric"/></div>
        <div class="col"><label>回数/日</label>
          <select id="timesPerDay"><option value="1">SID</option><option value="2" selected>BID</option><option value="3">TID</option></select>
        </div>
      </div>
      <div class="row">
        <div class="col"><label>処方形態（全体）</label>
          <select id="globalForm">
            <option value="TAB" selected>錠剤（TAB）</option>
            <option value="POWDER">散剤</option>
          </select>
        </div>
        <div class="col checkboxline">
          <label class="label-inline"><input type="checkbox" id="bunpo"/> 分包（全体一括 +20円/回）</label>
          <span class="muted">＠＝合計÷(回数×日数)を10円切上げ／自動再計算</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div id="tabletList"></div>
      <div class="actions">
        <div class="primary-actions"><button id="addDrug">＋ 薬剤を追加</button></div>
        <div class="secondary-actions">
          <button id="clearAll" class="ghost">入力クリア</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>📦 薬剤データ（CSV） <span class="badge">端末に保存</span></h3>
      <div class="row">
        <div class="col"><input type="file" id="csvInput" accept=".csv"/></div>
        <div class="col"><button id="saveCsv" class="secondary">現在のデータをCSV保存</button></div>
      </div>
      <div class="small">列：薬剤名, 剤型, 単価（仕入）, 含有量（mg/錠）, （任意）含有量（mg/mL）</div>
    </div>
  </div>

  <!-- 右：出力 -->
  <div class="panel-right">
    <div class="card">
      <div class="actions">
        <div class="secondary-actions">
          <button id="copySimple" class="secondary">簡易をコピー</button>
          <button id="copyDetail" class="secondary">詳細をコピー</button>
        </div>
      </div>
    </div>
    <div class="card">
      <h3>📋 カルテ貼付用（簡易）</h3>
      <pre id="outputSimple" class="readonly"></pre>
    </div>
    <div class="card">
      <h3>🧮 計算根拠（詳細）</h3>
      <pre id="outputDetail" class="readonly"></pre>
    </div>
  </div>
</div>

<!-- datalist（CSVから動的生成） -->
<datalist id="drugList"></datalist>

<script>
/* ===== Utility ===== */
function ceil10(y){return Math.ceil(y/10)*10}
function ceilYen(y){return Math.ceil(y)}
function byId(id){return document.getElementById(id)}
const STORAGE_KEY_MASTER="drugMasterSimple";
const STORAGE_KEY_NOTES="drugNotesV1";

/* 掛け率 */
function markupFor(p){
  if(p<=10) return 3;
  if(p<=50) return 2;
  if(p<=100) return 1.8;
  if(p<=500) return 1.5;
  return 1.2;
}

/* ===== CSV Master ===== */
let DRUGS = JSON.parse(localStorage.getItem(STORAGE_KEY_MASTER)||"null") || [];
function saveDrugs(list){ localStorage.setItem(STORAGE_KEY_MASTER, JSON.stringify(list)); }
function loadNotes(){ return JSON.parse(localStorage.getItem(STORAGE_KEY_NOTES)||"{}"); }
function saveNotes(map){ localStorage.setItem(STORAGE_KEY_NOTES, JSON.stringify(map)); }

function refreshDatalist(){
  const list=byId("drugList"); list.innerHTML="";
  (DRUGS||[]).forEach(d=>{ const o=document.createElement("option"); o.value=d.薬剤名; list.appendChild(o); });
}

/* CSV読込 */
byId("csvInput").addEventListener("change",(ev)=>{
  const f=ev.target.files && ev.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=(e)=>{
    const text=e.target.result;
    const lines=text.split(/\r?\n/).filter(x=>x.trim());
    if(lines.length<2){ alert("CSVが空です"); return; }
    const header=lines[0].split(",");
    const idx={
      name:header.indexOf("薬剤名"),
      type:header.indexOf("剤型"),
      cost:header.indexOf("単価（仕入）"),
      unitTab:header.indexOf("含有量（mg/錠）"),
      unitMl:header.indexOf("含有量（mg/mL）")
    };
    const list=[];
    for(let i=1;i<lines.length;i++){
      const c=lines[i].split(",");
      const rec={
        薬剤名:c[idx.name]||"",
        剤型:c[idx.type]||"",
        "単価（仕入）":parseFloat(c[idx.cost]||"0")||0,
        "含有量（mg/錠）":(idx.unitTab>=0&&c[idx.unitTab])?parseFloat(c[idx.unitTab]):"",
        "含有量（mg/mL）":(idx.unitMl>=0&&c[idx.unitMl])?parseFloat(c[idx.unitMl]):""
      };
      if(rec.薬剤名) list.push(rec);
    }
    DRUGS=list; saveDrugs(DRUGS); refreshDatalist(); recalc();
    alert(`薬剤データを読み込みました（${list.length}件）`);
  };
  reader.readAsText(f,"utf-8");
});

/* CSV保存 */
byId("saveCsv").addEventListener("click",()=>{
  const header=["薬剤名","剤型","単価（仕入）","含有量（mg/錠）","含有量（mg/mL）"];
  const rows=[header.join(",")].concat((DRUGS||[]).map(d=>[d.薬剤名,d.剤型,d["単価（仕入）"],d["含有量（mg/錠）"]||"",d["含有量（mg/mL）"]||""].join(",")));
  const blob=new Blob([rows.join("\n")],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="drug_master_export.csv"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

/* ===== 入力行（TAB/POWDER共通。散剤のみ 溶解/カプセル を表示） ===== */
function makeRow(){
  const row=document.createElement("div"); row.className="drug-row";
  row.innerHTML=`
    <div class="row">
      <div class="col"><label>薬剤名</label><input type="text" class="drugName" list="drugList" placeholder="選択または入力"/></div>
      <div class="col"><label class="unitLabel">含有量（mg/錠）</label><input type="number" class="unitMg" step="0.01"/></div>
      <div class="col"><label class="costLabel">単価（円/錠）</label><input type="number" class="cost" step="0.01"/></div>
    </div>
    <div class="row">
      <div class="col">
        <label class="label-inline">薬用量（mg/kg） <span class="pill">実効：<span class="effDose">-</span> mg/kg</span></label>
        <input type="number" class="dose" step="0.01" placeholder="例：10"/>
      </div>
      <div class="col"><button class="removeBtn danger">削除</button></div>
    </div>
    <div class="row powderOnly hidden">
      <div class="col checkboxline">
        <label><input type="checkbox" class="syrupChk"/> シロップ溶解（+500円）</label>
        <label><input type="checkbox" class="capsuleChk"/> カプセル詰め（+800円）</label>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>メモ（薬剤ごとに保存）</label>
        <textarea class="noteArea" style="height:90px"></textarea>
        <button class="secondary saveNoteBtn" style="margin-top:8px">この薬のメモを保存</button>
        <div class="small">※端末内に保存、薬剤名キーで自動復元</div>
      </div>
    </div>
  `;
  row.querySelector(".removeBtn").addEventListener("click",()=>{ row.remove(); recalc(); });

  // CSV選択で自動入力＋メモ復元
  const nameInput=row.querySelector(".drugName");
  const unitInput=row.querySelector(".unitMg");
  const costInput=row.querySelector(".cost");
  const noteArea=row.querySelector(".noteArea");
  const saveBtn=row.querySelector(".saveNoteBtn");

  function loadFromCsv(name){
    const d=(DRUGS||[]).find(x=>x.薬剤名===name);
    if(!d) return;
    const mode=byId("globalForm").value;
    if(mode==="TAB"){ unitInput.value=d["含有量（mg/錠）"]||""; costInput.value=d["単価（仕入）"]||""; }
    else{ unitInput.value=d["含有量（mg/mL）"]||""; costInput.value=d["単価（仕入）"]||""; }
    const notes=loadNotes(); noteArea.value=notes[name]||"";
    recalc();
  }
  nameInput.addEventListener("change",()=>loadFromCsv(nameInput.value));
  nameInput.addEventListener("blur",()=>loadFromCsv(nameInput.value));

  saveBtn.addEventListener("click",()=>{
    const name=nameInput.value.trim();
    if(!name){ alert("薬剤名を入力/選択してください"); return; }
    const notes=loadNotes(); notes[name]=noteArea.value||""; saveNotes(notes);
    alert("メモを保存しました");
  });

  // 入力の度に再計算
  row.querySelectorAll("input,select,textarea").forEach(el=>{
    el.addEventListener("input",recalc);
    el.addEventListener("change",recalc);
  });

  return row;
}

const list=byId("tabletList");
function addRow(){ list.appendChild(makeRow()); applyGlobalFormUI(); recalc(); }
byId("addDrug").addEventListener("click",addRow);
byId("clearAll").addEventListener("click",()=>{ list.innerHTML=""; addRow(); });

/* 形態切替：ラベルと散剤専用UIの表示 */
function applyGlobalFormUI(){
  const mode=byId("globalForm").value; // TAB or POWDER
  document.querySelectorAll(".unitLabel").forEach(l=>l.textContent = (mode==="TAB" ? "含有量（mg/錠）" : "含有量（mg/mL）"));
  document.querySelectorAll(".costLabel").forEach(l=>l.textContent = (mode==="TAB" ? "単価（円/錠）" : "単価（円/mL）"));
  document.querySelectorAll(".powderOnly").forEach(e=>e.classList.toggle("hidden", !(mode==="POWDER")));
}

/* 体重/日数/回数/分包 チェンジで即再計算 */
["weight","days","timesPerDay","bunpo","globalForm"].forEach(id=>{
  byId(id).addEventListener("input",()=>{ applyGlobalFormUI(); recalc(); });
  byId(id).addEventListener("change",()=>{ applyGlobalFormUI(); recalc(); });
});

/* ===== TAB用：1/4錠単位で自動最適化 ===== */
function optimizeTablets(totalMg, unitMgPerTab){
  if(!(unitMgPerTab>0)){ return {whole:0, halves:0, quarters:0, billed:0, achievedMg:0}; }
  const qNeeded = Math.ceil(totalMg / (unitMgPerTab/4)); // 1/4錠単位切上げ
  const whole = Math.floor(qNeeded/4);
  const rem = qNeeded % 4;
  const halves = Math.floor(rem/2);
  const quarters = rem % 2;
  const billed = Math.ceil(qNeeded/4); // 実際の製造錠数
  const achievedMg = (whole + halves*0.5 + quarters*0.25) * unitMgPerTab;
  return {whole, halves, quarters, billed, achievedMg};
}

/* ===== 計算本体（元ルール完全対応） ===== */
function calcAll(){
  const days=parseInt(byId("days").value||"0");
  const tpd=parseInt(byId("timesPerDay").value||"0");
  const doses=tpd*days;
  const weight=parseFloat(byId("weight").value||"0");
  const mode=byId("globalForm").value; // TAB or POWDER
  const bunpo=byId("bunpo").checked;

  let detail="", subtotal=0, items=0;
  let splitFeeTotal=0, packFeeTotal=0, syrupFeeTotal=0, capsuleFeeTotal=0;
  let needsHalf=false, needsQuarter=false; // TABで1/2 or 1/4を使ったか

  const rows=[...list.querySelectorAll(".drug-row")];
  rows.forEach(row=>{
    const name=row.querySelector(".drugName").value.trim();
    const unit=parseFloat(row.querySelector(".unitMg").value||"0");   // mg/錠 or mg/mL
    const cost=parseFloat(row.querySelector(".cost").value||"0");
    const dose=parseFloat(row.querySelector(".dose").value||"0");
    const effSpan=row.querySelector(".effDose");
    const syrupChk=row.querySelector(".syrupChk");
    const capsuleChk=row.querySelector(".capsuleChk");

    if(effSpan) effSpan.textContent="-";

    if(!name||!unit||!cost||!dose||!weight||!days||!tpd) return;

    const mgPerDose=weight*dose;
    const totalMg  = mgPerDose*doses;
    const pricePer = ceil10(cost * markupFor(cost));

    if(mode==="TAB"){
      // 1/4刻み最適化
      const opt = optimizeTablets(totalMg, unit);
      const billedTabs = opt.billed;
      const drugCost = ceilYen(pricePer * billedTabs);
      subtotal += drugCost; items++;

      // 分割フラグ
      if(opt.quarters>0){ needsQuarter = true; }
      else if(opt.halves>0){ needsHalf = true; }

      // 実効 mg/kg
      const achievedMgPerKg = (opt.achievedMg / doses) / weight;
      if(effSpan) effSpan.textContent = isFinite(achievedMgPerKg)? achievedMgPerKg.toFixed(2) : "-";

      const parts=[];
      if(opt.whole) parts.push(`${opt.whole}t`);
      if(opt.halves) parts.push(`${opt.halves}×1/2t`);
      if(opt.quarters) parts.push(`${opt.quarters}×1/4t`);
      const comp = parts.length ? parts.join(" + ") : "0t";

      detail += `【錠剤】${name} ${unit}mg/錠
目標：${dose}mg/kg × ${tpd}回 × ${days}日（体重：${weight}kg）
必要量：${Math.round(totalMg)}mg
→ 実調整：${comp}（計 ${billedTabs}錠 製造）
　実効用量：${achievedMgPerKg.toFixed(2)} mg/kg（合計 ${Math.round(opt.achievedMg)}mg）
薬剤料：${drugCost}円（${pricePer}円/錠 × ${billedTabs}錠）

`;

    }else{ // POWDER（散剤）
      const ml = Math.ceil((totalMg / unit) * 100)/100; // 0.01mL切上げ
      const drugCost=ceilYen(pricePer*ml);
      subtotal+=drugCost; items++;

      const achievedMgPerKg = (totalMg / doses) / weight;
      if(effSpan) effSpan.textContent = isFinite(achievedMgPerKg)? achievedMgPerKg.toFixed(2) : "-";

      // 散剤のみ：シロップ溶解/カプセル詰め（薬剤ごと）
      let extraLines="";
      if(syrupChk?.checked){ syrupFeeTotal += 500; extraLines += `シロップ溶解：500円\n`; }
      if(capsuleChk?.checked){ capsuleFeeTotal += 800; extraLines += `カプセル詰め：800円\n`; }

      detail += `【散剤】${name} ${unit}${isFinite(unit)&&unit>0?"mg/mL":""}
目標：${dose}mg/kg × ${tpd}回 × ${days}日（体重：${weight}kg）
必要量：${Math.round(totalMg)}mg（約${ml.toFixed(2)}mL相当）
　実効用量：${achievedMgPerKg.toFixed(2)} mg/kg
薬剤料：${drugCost}円（${pricePer}円/mL × ${ml.toFixed(2)}mL）
${extraLines ? extraLines : ""}
`;
    }
  });

  // 分割料（TAB 全体で一回）
  if(byId("globalForm").value==="TAB"){
    if(needsQuarter)      splitFeeTotal += 20*(tpd*days);
    else if(needsHalf)    splitFeeTotal += 10*(tpd*days);
  }

  // 分包料（全体一括）
  if(bunpo){ packFeeTotal += 20*(tpd*days); }

  // 処方料：1剤目80円/日 + 2剤目以降40円/日
  const scriptFee = (items>0) ? ceilYen( 80*days + 40*days*(items-1) ) : 0;

  const total = ceilYen(subtotal + splitFeeTotal + packFeeTotal + syrupFeeTotal + capsuleFeeTotal + scriptFee);
  return {detail, subtotal, splitFeeTotal, packFeeTotal, syrupFeeTotal, capsuleFeeTotal, scriptFee, total, items, mode:byId("globalForm").value, doses, days, tpd};
}

/* 簡易出力 */
function buildSimple({mode, doses, days, tpd, total}){
  const unit = doses>0 ? ceil10(total/doses) : 0;
  const freq = (tpd===1?"SID":tpd===2?"BID":"TID");
  const header = `内服薬＠${unit} x${doses}`;
  const tail = mode==="TAB" ? `TAB ${doses}ヶ ${freq} ${days}日分` : `粉 ${doses}包 ${freq} ${days}日分`;
  return [header, tail].join("\n");
}

/* クリップボード（preから） */
function copyTextFromPre(id){
  const el=byId(id);
  const text=el.textContent;
  navigator.clipboard?.writeText(text).then(()=>alert("コピーしました")).catch(()=>{
    const ta=document.createElement("textarea"); ta.value=text; document.body.appendChild(ta);
    ta.select(); document.execCommand("copy"); ta.remove(); alert("コピーしました");
  });
}
byId("copySimple").addEventListener("click",()=>copyTextFromPre("outputSimple"));
byId("copyDetail").addEventListener("click",()=>copyTextFromPre("outputDetail"));

/* 再計算 → 出力更新 */
function recalc(){
  const r=calcAll(); if(!r) return;
  byId("outputSimple").textContent = buildSimple(r);
  let d = r.detail;
  if(r.splitFeeTotal>0)   d += `分割料合計：${r.splitFeeTotal}円\n`;
  if(r.packFeeTotal>0)    d += `分包料：${r.packFeeTotal}円\n`;
  if(r.syrupFeeTotal>0)   d += `シロップ溶解合計：${r.syrupFeeTotal}円\n`;
  if(r.capsuleFeeTotal>0) d += `カプセル詰め合計：${r.capsuleFeeTotal}円\n`;
  d += `処方料：${r.scriptFee}円\n———\n合計：${r.total}円`;
  byId("outputDetail").textContent = d.trim();
}

/* 初期化 */
function init(){
  refreshDatalist();
  addRow();
  applyGlobalFormUI();
  recalc();
}
init();
</script>
</body>
</html>
