<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v2.5ï¼ˆCSVï¼‹ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼‹TAB/ç²‰åˆ‡æ›¿ï¼‰</title>
<style>
:root{ --gap:14px; --fz:18px; --pad:14px; --btnh:50px; }
@media (min-width:768px){ :root{ --fz:16px; --pad:10px; --btnh:44px; } }
*{box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;margin:0;padding:16px;font-size:var(--fz);-webkit-text-size-adjust:100%;background:#fafafa}
h1{font-size:calc(var(--fz) + 2px);margin:0 0 8px 0}
.row{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center}
.col{flex:1 1 210px;min-width:210px}
input,select,button,textarea{width:100%;font-size:var(--fz);padding:var(--pad);min-height:var(--btnh);border-radius:12px;border:1px solid #d0d0d0;background:#fff}
button{background:#0a84ff;color:#fff;border:0;cursor:pointer}
button.secondary{background:#f2f2f7;color:#111;border:1px solid #d0d0d0}
button.danger{background:#ff3b30}
textarea{height:160px}
.card{border:1px solid #e5e5ea;border-radius:14px;padding:14px;margin:14px 0;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.muted{color:#666;font-size:calc(var(--fz) - 3px)}
.tabs{display:flex;gap:8px;margin-bottom:8px}
.tab{padding:10px 14px;border:1px solid #d0d0d0;border-radius:999px;background:#f2f2f7;cursor:pointer;user-select:none}
.tab.active{background:#e7f1ff;border-color:#7aa7ff}
.section{display:none}.section.active{display:block}
.drug-row{border:1px dashed #d0d0d0;border-radius:12px;padding:12px;margin:10px 0}
.switch{display:flex;align-items:center;gap:10px}
kbd{background:#f2f2f7;border:1px solid #d0d0d0;border-radius:6px;padding:2px 6px}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef5ff;border:1px solid #cbdcff;color:#225}

.layout{display:block}
@media (min-width:1000px){
  .layout{display:grid;grid-template-columns:1.1fr 1fr;gap:18px;align-items:start}
  .panel-left{position:sticky;top:10px;align-self:start;height:calc(100vh - 20px);overflow:auto;padding-right:2px}
  .panel-right{max-height:calc(100vh - 20px);overflow:auto;padding-left:2px}
}
.panel-right textarea{height:220px}
.small{font-size:0.85em;color:#666}
</style>
</head>
<body>
<h1>è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v2.5ï¼ˆCSVï¼‹ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼‹TAB/ç²‰åˆ‡æ›¿ï¼‰</h1>

<div class="layout">
  <!-- å·¦ï¼šå…¥åŠ› -->
  <div class="panel-left">
    <div class="card">
      <div class="row">
        <div class="col"><label>ä½“é‡ï¼ˆkgï¼‰</label><input type="number" id="weight" step="0.01" inputmode="decimal"/></div>
        <div class="col"><label>æ—¥æ•°</label><input type="number" id="days" value="7" min="1" inputmode="numeric"/></div>
        <div class="col"><label>å›æ•°/æ—¥</label>
          <select id="timesPerDay"><option value="1">SID</option><option value="2" selected>BID</option><option value="3">TID</option></select>
        </div>
      </div>
      <div class="row">
        <div class="col switch"><input type="checkbox" id="bunpo"/><label for="bunpo">åˆ†åŒ…æ©Ÿä½¿ç”¨ï¼ˆ+20å††/å›ï¼‰</label></div>
        <div class="col muted">CSVã¯ç«¯æœ«ã«ä¿å­˜ã•ã‚Œã¾ã™ / <kbd>å†…æœè–¬ï¼ </kbd>ã¯åˆè¨ˆã‚’å›æ•°Ã—æ—¥æ•°ã§å‰²ã£ã¦10å††åˆ‡ä¸Šã’</div>
      </div>
    </div>

    <div class="card">
      <div class="tabs">
        <div class="tab active" data-target="tab-tabl">éŒ å‰¤ãƒ»ã‚«ãƒ—ã‚»ãƒ«ãƒ»ãƒãƒ¥ã‚¢ãƒ–ãƒ«</div>
        <div class="tab" data-target="tab-syrp">ã‚·ãƒ­ãƒƒãƒ—ãƒ»ç²‰è–¬</div>
      </div>

      <!-- éŒ å‰¤ -->
      <div id="tab-tabl" class="section active">
        <div id="tabletList"></div>
        <button id="addTablet">ï¼‹ éŒ å‰¤ã‚’è¿½åŠ </button>
      </div>

      <!-- ã‚·ãƒ­ãƒƒãƒ— -->
      <div id="tab-syrp" class="section">
        <div id="syrupList"></div>
        <div class="row">
          <div class="col switch"><input type="checkbox" id="syrupDissolve"/><label for="syrupDissolve">ã‚·ãƒ­ãƒƒãƒ—ã«æº¶ã‹ã™ï¼ˆ+500å††ï¼‰</label></div>
        </div>
        <button id="addSyrup">ï¼‹ ã‚·ãƒ­ãƒƒãƒ—ãƒ»ç²‰è–¬ã‚’è¿½åŠ </button>
      </div>
    </div>

    <div class="card">
      <h3>ğŸ“¦ è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ï¼ˆCSVï¼‰ <span class="badge">ç«¯æœ«ã«ä¿å­˜</span></h3>
      <div class="row">
        <div class="col"><input type="file" id="csvInput" accept=".csv"/></div>
        <div class="col"><button id="saveCsv" class="secondary">ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’CSVä¿å­˜</button></div>
      </div>
      <div class="small">
        æƒ³å®šåˆ—ï¼š<code>è–¬å‰¤å, å‰¤å‹, å˜ä¾¡ï¼ˆä»•å…¥ï¼‰, å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰, ï¼ˆä»»æ„ï¼‰å«æœ‰é‡ï¼ˆmg/mLï¼‰</code><br/>
        ã‚«ãƒ—ã‚»ãƒ«/ãƒãƒ¥ã‚¢ãƒ–ãƒ«ã¯éŒ å‰¤æ‰±ã„ã¨ã—ã¦ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«å…¥ã‚Šã¾ã™ã€‚
      </div>
    </div>
  </div>

  <!-- å³ï¼šå‡ºåŠ› -->
  <div class="panel-right">
    <div class="card">
      <div class="row" style="gap:10px">
        <button id="calcBtn">è¨ˆç®—ã™ã‚‹</button>
        <button id="copySimple" class="secondary">ç°¡æ˜“ã‚’ã‚³ãƒ”ãƒ¼</button>
        <button id="copyDetail" class="secondary">è©³ç´°ã‚’ã‚³ãƒ”ãƒ¼</button>
        <button id="clearBtn"  class="secondary">CSVãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>
    <div class="card">
      <h3>ğŸ“‹ ã‚«ãƒ«ãƒ†è²¼ä»˜ç”¨ï¼ˆç°¡æ˜“ï¼‰</h3>
      <textarea id="outputSimple" readonly></textarea>
    </div>
    <div class="card">
      <h3>ğŸ§® è¨ˆç®—æ ¹æ‹ ï¼ˆè©³ç´°ï¼‰</h3>
      <textarea id="outputDetail" readonly></textarea>
    </div>
  </div>
</div>

<!-- datalistï¼ˆCSVã‹ã‚‰å‹•çš„ç”Ÿæˆï¼‰ -->
<datalist id="drugListTablet"></datalist>
<datalist id="drugListSyrup"></datalist>

<script>
/* ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========== */
function ceil10(y){return Math.ceil(y/10)*10}
function ceilYen(y){return Math.ceil(y)}
function byId(id){return document.getElementById(id)}
const STORAGE_KEY_MASTER = "drugMasterV4";
const STORAGE_KEY_NOTES  = "drugNotesV1";

/* ========== ä¿‚æ•°ï¼ˆè–¬å‰¤æ–™ã®æ›ã‘ç‡ï¼‰ ========== */
function markupFor(p){
  if(p<=10) return 3;
  if(p<=50) return 2;
  if(p<=100) return 1.8;
  if(p<=500) return 1.5;
  return 1.2;
}

/* ========== CSVãƒã‚¹ã‚¿ãƒ¼ç®¡ç† ========== */
let DRUGS = JSON.parse(localStorage.getItem(STORAGE_KEY_MASTER)||"null") || [];
function saveDrugs(list){ localStorage.setItem(STORAGE_KEY_MASTER, JSON.stringify(list)); }
function loadNotes(){ return JSON.parse(localStorage.getItem(STORAGE_KEY_NOTES)||"{}"); }
function saveNotes(map){ localStorage.setItem(STORAGE_KEY_NOTES, JSON.stringify(map)); }

/* ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆdatalistï¼‰ã‚’å†æ§‹ç¯‰ */
function refreshDatalists(){
  const listTab  = byId("drugListTablet");
  const listSyrp = byId("drugListSyrup");
  listTab.innerHTML=""; listSyrp.innerHTML="";

  (DRUGS||[]).forEach(d=>{
    const form = (d.å‰¤å‹||"").toString();
    const opt = document.createElement("option");
    opt.value = d.è–¬å‰¤å;

    if(/ã‚·ãƒ­ãƒƒãƒ—|å†…ç”¨æ¶²|æ¶²|æ‡¸æ¿|ç²‰|æ•£/i.test(form)){
      listSyrp.appendChild(opt);
    }else{
      // éŒ å‰¤ / ã‚«ãƒ—ã‚»ãƒ« / ãƒãƒ¥ã‚¢ãƒ–ãƒ« / ä¸æ˜ â†’ éŒ å‰¤å´ã¸
      listTab.appendChild(opt);
    }
  });
}

/* CSVèª­è¾¼ */
byId("csvInput").addEventListener("change",(ev)=>{
  const f=ev.target.files && ev.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=(e)=>{
    const text=e.target.result;
    const lines=text.split(/\r?\n/).filter(x=>x.trim().length>0);
    if(lines.length<2){ alert("CSVå†…å®¹ãŒç©ºã§ã™"); return; }
    const header=lines[0].split(",");
    function col(n){ return header.indexOf(n); }
    const idx={
      name:col("è–¬å‰¤å"),
      type:col("å‰¤å‹"),
      cost:col("å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"),
      unitTab:col("å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"),
      unitMl: col("å«æœ‰é‡ï¼ˆmg/mLï¼‰")
    };
    const list=[];
    for(let i=1;i<lines.length;i++){
      const cols=lines[i].split(",");
      const rec={
        è–¬å‰¤å: cols[idx.name] || "",
        å‰¤å‹:   cols[idx.type] || "",
        "å˜ä¾¡ï¼ˆä»•å…¥ï¼‰": parseFloat(cols[idx.cost]||"0") || 0,
        "å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰": (idx.unitTab>=0 && cols[idx.unitTab])? parseFloat(cols[idx.unitTab]) : "",
        "å«æœ‰é‡ï¼ˆmg/mLï¼‰": (idx.unitMl>=0  && cols[idx.unitMl]) ? parseFloat(cols[idx.unitMl])  : ""
      };
      if(rec.è–¬å‰¤å) list.push(rec);
    }
    DRUGS = list; saveDrugs(DRUGS); refreshDatalists();
    alert(`è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ${list.length}ä»¶ï¼‰`);
  };
  reader.readAsText(f,"utf-8");
});

/* CSVä¿å­˜ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰ */
byId("saveCsv").addEventListener("click",()=>{
  const header=["è–¬å‰¤å","å‰¤å‹","å˜ä¾¡ï¼ˆä»•å…¥ï¼‰","å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰","å«æœ‰é‡ï¼ˆmg/mLï¼‰"];
  const rows=[header.join(",")].concat((DRUGS||[]).map(d=>[
    d.è–¬å‰¤å, d.å‰¤å‹, d["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"],
    d["å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"]||"", d["å«æœ‰é‡ï¼ˆmg/mLï¼‰"]||""
  ].join(",")));
  const blob=new Blob([rows.join("\n")],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="drug_master_export.csv";
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

/* CSVãƒªã‚»ãƒƒãƒˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã®æ¶ˆå»ï¼‰ */
byId("clearBtn").addEventListener("click",()=>{
  localStorage.removeItem(STORAGE_KEY_MASTER);
  alert("ç«¯æœ«ã«ä¿å­˜ã—ã¦ã„ãŸCSVãƒã‚¹ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸã€‚");
  location.reload();
});

/* ========== å…¥åŠ›è¡Œç”Ÿæˆï¼ˆdatalistï¼‹ãƒ¡ãƒ¢ä¿å­˜ï¼‰ ========== */
function makeDrugRow({type}){
  const row=document.createElement("div"); row.className="drug-row";
  const listId=(type==="éŒ å‰¤"?"drugListTablet":"drugListSyrup");
  const unitLabel=(type==="éŒ å‰¤"?"å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰":"å«æœ‰é‡ï¼ˆmg/mLï¼‰");
  const costUnit =(type==="éŒ å‰¤"?"ï¼ˆå††/éŒ ï¼‰":"ï¼ˆå††/mLï¼‰");

  row.innerHTML=`
    <div class="row">
      <div class="col">
        <label>è–¬å‰¤åï¼ˆ${type}ï¼‰</label>
        <input type="text" class="drugName" list="${listId}" placeholder="é¸æŠã¾ãŸã¯å…¥åŠ›"/>
      </div>
      <div class="col"><label>${unitLabel}</label><input type="number" class="unitMg" step="0.01"/></div>
      <div class="col"><label>å˜ä¾¡ ${costUnit}</label><input type="number" class="cost" step="0.01"/></div>
    </div>
    <div class="row">
      <div class="col"><label>è–¬ç”¨é‡ï¼ˆmg/kgï¼‰</label><input type="number" class="dose" step="0.01"/></div>
      <div class="col"><label>å‡¦æ–¹å½¢æ…‹</label>
        <select class="split">
          <option value="powder">æ•£å‰¤</option>
          <option value="1" selected>åˆ†å‰²ãªã—</option>
          <option value="0.5">1/2ï¼ˆ+10å††/å›ï¼‰</option>
          <option value="0.25">1/4ï¼ˆ+20å††/å›ï¼‰</option>
        </select>
      </div>
      <div class="col"><button class="removeBtn danger">å‰Šé™¤</button></div>
    </div>
    <div class="row">
      <div class="col">
        <label>ãƒ¡ãƒ¢ï¼ˆè–¬å‰¤ã”ã¨ã«ä¿å­˜ï¼‰</label>
        <textarea class="noteArea" style="height:100px"></textarea>
        <button class="secondary saveNoteBtn" style="margin-top:8px">ã“ã®è–¬ã®ãƒ¡ãƒ¢ã‚’ä¿å­˜</button>
        <div class="small">â€»ç«¯æœ«ã«ä¿å­˜ã•ã‚Œã€æ¬¡å›è‡ªå‹•å¾©å…ƒã•ã‚Œã¾ã™</div>
      </div>
    </div>
  `;

  // å‰Šé™¤
  row.querySelector(".removeBtn").addEventListener("click",()=>row.remove());

  // é¸æŠã§è‡ªå‹•ã‚»ãƒƒãƒˆï¼†ãƒ¡ãƒ¢å¾©å…ƒ
  const nameInput=row.querySelector(".drugName");
  const unitInput=row.querySelector(".unitMg");
  const costInput=row.querySelector(".cost");
  const noteArea =row.querySelector(".noteArea");
  const saveBtn  =row.querySelector(".saveNoteBtn");

  function loadDrugToRow(name){
    const d=(DRUGS||[]).find(x=>x.è–¬å‰¤å===name);
    if(!d) return;
    if(type==="éŒ å‰¤"){ unitInput.value = d["å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"] || ""; }
    else{ unitInput.value = d["å«æœ‰é‡ï¼ˆmg/mLï¼‰"] || ""; }
    costInput.value = d["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"] || "";
    const notes=loadNotes(); noteArea.value = notes[name] || "";
  }
  nameInput.addEventListener("change",()=>loadDrugToRow(nameInput.value));
  nameInput.addEventListener("blur",  ()=>loadDrugToRow(nameInput.value));

  // ãƒ¡ãƒ¢ä¿å­˜
  saveBtn.addEventListener("click",()=>{
    const name=nameInput.value.trim();
    if(!name){ alert("è–¬å‰¤åã‚’é¸æŠ/å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    const notes=loadNotes(); notes[name]=noteArea.value||""; saveNotes(notes);
    alert("ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
  });

  return row;
}

/* è¡Œè¿½åŠ  */
function addTablet(){ byId("tabletList").appendChild(makeDrugRow({type:"éŒ å‰¤"})); }
function addSyrup(){ byId("syrupList").appendChild(makeDrugRow({type:"ã‚·ãƒ­ãƒƒãƒ—"})); }
byId("addTablet").addEventListener("click",addTablet);
byId("addSyrup").addEventListener("click",addSyrup);
addTablet(); // åˆæœŸ1è¡Œ

/* ã‚¿ãƒ–åˆ‡æ›¿ */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    tab.classList.add("active");
    byId(tab.dataset.target).classList.add("active");
  });
});

/* ========== è¨ˆç®—ï¼ˆTAB/ç²‰åˆ‡æ›¿å¯¾å¿œï¼‰ ========== */
function calcSection(type, container){
  const days=parseInt(byId("days").value||"0");
  const tpd =parseInt(byId("timesPerDay").value||"0");
  const weight=parseFloat(byId("weight").value||"0");
  const bunpo=byId("bunpo").checked;

  let detailText=""; let subtotal=0; let itemsCount=0;
  let anyPowder=false, anyTab=false;
  let packFeeTotal=0, splitFeeTotal=0;

  container.querySelectorAll(".drug-row").forEach(row=>{
    const name=row.querySelector(".drugName").value.trim();
    const unit=parseFloat(row.querySelector(".unitMg").value||"0");   // mg/éŒ  or mg/mL
    const cost=parseFloat(row.querySelector(".cost").value||"0");
    const dose=parseFloat(row.querySelector(".dose").value||"0");
    const splitRaw=row.querySelector(".split")?.value || "1";

    if(!name||!unit||!cost||!dose||!weight||!days||!tpd) return;

    const mgPerDose=weight*dose;
    const totalMg  =mgPerDose*tpd*days;

    // å˜ä¾¡ï¼šåŸä¾¡Ã—ä¿‚æ•° â†’ 10å††å˜ä½åˆ‡ä¸Šã’
    const pricePer = ceil10(cost * markupFor(cost));

    if(type==="éŒ å‰¤"){
      const count = Math.ceil(totalMg / unit);       // éŒ æ•°ï¼ˆç«¯æ•°åˆ‡ä¸Šã’ï¼‰
      const drugCost = ceilYen(pricePer * count);    // 1å††å˜ä½åˆ‡ä¸Šã’
      subtotal += drugCost; itemsCount++;

      // åˆ†åŒ…æ–™ï¼ˆåˆ†åŒ…æ©Ÿä½¿ç”¨æ™‚ï¼‰
      const packFee = bunpo ? 20 * (tpd * days) : 0;
      packFeeTotal += packFee;

      // åˆ†å‰²æ–™
      let splitFee = 0;
      if(splitRaw==="0.5") splitFee = 10 * (tpd * days);
      if(splitRaw==="0.25") splitFee = 20 * (tpd * days);
      splitFeeTotal += splitFee;

      // ç²‰/TABãƒ•ãƒ©ã‚°
      if(splitRaw==="powder") anyPowder = true; else anyTab = true;

      // è©³ç´°
      detailText += `ã€éŒ å‰¤ã€‘${name} ${unit}mg/éŒ 
${dose}mg/kg Ã— ${tpd}å› Ã— ${days}æ—¥åˆ†ï¼ˆä½“é‡ï¼š${weight}kgï¼‰
â†’ å¿…è¦é‡ï¼š${Math.round(totalMg)}mgï¼ˆ${count}éŒ ï¼‰
è–¬å‰¤æ–™ï¼š${drugCost}å††ï¼ˆ${pricePer}å††/éŒ  Ã— ${count}éŒ ï¼‰
`;
      if(packFee>0)  detailText += `åˆ†åŒ…æ–™ï¼š${packFee}å††\n`;
      if(splitFee>0) detailText += `åˆ†å‰²æ–™ï¼š${splitFee}å††\n`;
      detailText += `\n`;

    }else{ // ã‚·ãƒ­ãƒƒãƒ—/ç²‰è–¬ï¼ˆæ¶²é‡æ›ç®—ï¼‰
      const ml = Math.ceil((totalMg / unit) * 100) / 100; // 0.01mLåˆ‡ä¸Šã’
      const drugCost = ceilYen(pricePer * ml);
      subtotal += drugCost; itemsCount++;

      detailText += `ã€ã‚·ãƒ­ãƒƒãƒ—ã€‘${name} ${unit}mg/mL
${dose}mg/kg Ã— ${tpd}å› Ã— ${days}æ—¥åˆ†ï¼ˆä½“é‡ï¼š${weight}kgï¼‰
â†’ å¿…è¦é‡ï¼š${Math.round(totalMg)}mgï¼ˆç´„${ml.toFixed(2)}mLï¼‰
è–¬å‰¤æ–™ï¼š${drugCost}å††ï¼ˆ${pricePer}å††/mL Ã— ${ml.toFixed(2)}mLï¼‰

`;
    }
  });

  return {detailText, subtotal, itemsCount, anyPowder, anyTab, packFeeTotal, splitFeeTotal};
}

/* ç°¡æ˜“ï¼ˆã‚«ãƒ«ãƒ†ç”¨ï¼‰ */
function buildSimpleLine({tablet, syrup, total}){
  const d   = parseInt(byId("days").value||"0");
  const tpd = parseInt(byId("timesPerDay").value||"0");
  const doses = tpd * d;
  const unit  = doses>0 ? ceil10(total / doses) : 0;
  const freq  = (tpd===1?"SID":tpd===2?"BID":"TID");

  const lines=[];
  lines.push(`å†…æœè–¬ï¼ ${unit} x${doses}`);
  // è–¬åï¼‹éŒ æ•°ã¯å¾“æ¥é€šã‚Šï¼ˆéŒ å‰¤ã®ã¿ï¼‰
  // â†’ tablet.detailText ã«å€‹ã€…ã®è¨ˆç®—æ ¹æ‹ ãŒã‚ã‚‹ã®ã§ã€ç°¡æ˜“ã¯ç·é‡ãƒ©ã‚¤ãƒ³ä¸­å¿ƒ
  if(tablet.anyTab)    lines.push(`TAB ${doses}ãƒ¶ ${freq} ${d}æ—¥åˆ†`);
  if(tablet.anyPowder) lines.push(`ç²‰ ${doses}åŒ… ${freq} ${d}æ—¥åˆ†`);
  if(syrup.itemsCount>0) lines.push(`ã‚·ãƒ­ãƒƒãƒ— ${doses}mL ${freq} ${d}æ—¥åˆ†`);
  return lines.join("\n");
}

/* è¨ˆç®—ãƒœã‚¿ãƒ³ */
byId("calcBtn").addEventListener("click",()=>{
  const days=parseInt(byId("days").value||"0");

  const tablet = calcSection("éŒ å‰¤",   byId("tabletList"));
  const syrup  = calcSection("ã‚·ãƒ­ãƒƒãƒ—",byId("syrupList"));

  const itemsTotal = tablet.itemsCount + syrup.itemsCount;
  const scriptFee = (itemsTotal>0)
    ? ceilYen(80*days + 40*days*(itemsTotal-1))
    : 0;

  const syrupDissolve = byId("syrupDissolve")?.checked ? 500 : 0;

  const total = ceilYen(
    tablet.subtotal + syrup.subtotal +
    tablet.packFeeTotal + tablet.splitFeeTotal +
    scriptFee + syrupDissolve
  );

  window.__lastTotal = total;

  // ç°¡æ˜“
  byId("outputSimple").value = buildSimpleLine({tablet, syrup, total});

  // è©³ç´°
  let detail = "";
  detail += tablet.detailText;
  detail += syrup.detailText;
  if(syrupDissolve) detail += `ã€èª¿å‰¤ã€‘ã‚·ãƒ­ãƒƒãƒ—æº¶è§£ï¼š${syrupDissolve}å††\n\n`;
  detail += `å‡¦æ–¹æ–™ï¼š${scriptFee}å††\n`;
  if(tablet.packFeeTotal>0)  detail += `åˆ†åŒ…æ–™åˆè¨ˆï¼š${tablet.packFeeTotal}å††\n`;
  if(tablet.splitFeeTotal>0) detail += `åˆ†å‰²æ–™åˆè¨ˆï¼š${tablet.splitFeeTotal}å††\n`;
  detail += `â€”â€”â€”\nåˆè¨ˆï¼š${total}å††`;
  byId("outputDetail").value = detail.trim();
});

/* ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ */
function copy(id){ const ta=byId(id); ta.select(); document.execCommand("copy"); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); }
byId("copySimple").addEventListener("click",()=>copy("outputSimple"));
byId("copyDetail").addEventListener("click",()=>copy("outputDetail"));

/* åˆæœŸåŒ– */
refreshDatalists();
</script>
</body>
</html>
