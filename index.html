<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v5.2ï¼ˆ1/4éŒ åˆ†å‰²å¯¾å¿œï¼‰</title>
    <style>
        /* ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š */
        *{box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;margin:0;padding:16px;background:#fafafa;color:#333}
        h1{margin:0 0 12px;font-size:18px;color:#0a84ff}
        .card{background:#fff;border:1px solid #e5e5ea;border-radius:12px;padding:12px;margin:12px 0;box-shadow:0 1px 3px rgba(0,0,0,0.05)}
        .row{display:flex;gap:12px;flex-wrap:wrap}
        .col{flex:1 1 200px;min-width:200px}
        label{display:block;margin-bottom:4px;font-size:13px;font-weight:600;color:#666}
        input,select,button,textarea{width:100%;padding:10px;border:1px solid #d0d0d0;border-radius:10px;background:#fff;font-size:16px}
        button{background:#0a84ff;color:#fff;border:0;cursor:pointer;font-weight:600;transition:opacity 0.2s}
        button:hover{opacity:0.8}
        button.secondary{background:#f2f2f7;color:#111;border:1px solid #d0d0d0}
        button.danger{background:#ff3b30;color:#fff}
        button.ghost{background:#fff;color:#0a84ff;border:1px solid #0a84ff}
        .drug-row{border:1px dashed #d0d0d0;border-radius:10px;padding:12px;margin:10px 0;background:#fafbfc}
        .suggest{position:absolute;z-index:999;background:#fff;border:1px solid #d0d0d0;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.1);max-height:200px;overflow:auto;display:none;width:100%}
        .suggest-item{padding:8px 12px;cursor:pointer;border-bottom:1px solid #f0f0f0}
        .suggest-item:hover{background:#eef5ff}
        pre.readonly{white-space:pre-wrap;background:#f8f9fa;border:1px solid #eee;border-radius:10px;padding:12px;min-height:100px;font-size:14px;line-height:1.5}
        .status{padding:8px;border-radius:8px;font-size:12px;margin-top:8px;background:#e8f4fd;color:#0a84ff}
        @media (min-width:900px){ .layout{display:grid;grid-template-columns:1fr 1fr;gap:20px} }
    </style>
</head>
<body>

<h1>ğŸ¥ è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v5.2</h1>

<div class="layout">
    <div class="panel-left">
        <div class="card">
            <label>åŸºæœ¬è¨­å®š</label>
            <div class="row">
                <div class="col"><label>ä½“é‡ (kg)</label><input type="number" id="weight" step="0.01" placeholder="5.0"></div>
                <div class="col"><label>æ—¥æ•°</label><input type="number" id="days" value="7"></div>
                <div class="col">
                    <label>å›æ•°/æ—¥</label>
                    <select id="timesPerDay">
                        <option value="1">SID (1å›)</option>
                        <option value="2" selected>BID (2å›)</option>
                        <option value="3">TID (3å›)</option>
                    </select>
                </div>
            </div>
            <div class="row" style="margin-top:10px">
                <div class="col">
                    <label>å‡¦æ–¹å½¢æ…‹</label>
                    <select id="globalForm">
                        <option value="TAB">éŒ å‰¤ (ãã®ã¾ã¾)</option>
                        <option value="POWDER">æ•£å‰¤ (éŒ å‰¤ã‚’ç²‰ç •)</option>
                    </select>
                </div>
                <div class="col">
                    <label>&nbsp;</label>
                    <label><input type="checkbox" id="bunpo" checked style="width:auto"> åˆ†åŒ…æ©Ÿä½¿ç”¨ (+20å††/åŒ…)</label>
                </div>
            </div>
        </div>

        <div class="card">
            <label>ğŸ’Š è–¬å‰¤å…¥åŠ›</label>
            <div id="tabletList"></div>
            <button id="addDrug" style="margin-top:10px">ï¼‹ è–¬å‰¤ã‚’è¿½åŠ </button>
        </div>

        <div class="card">
            <details>
                <summary>ğŸ“¦ ãƒ‡ãƒ¼ã‚¿ç®¡ç† (CSV/ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ)</summary>
                <div style="margin-top:10px">
                    <label>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå</label>
                    <div class="row">
                        <input id="tplName" style="flex:2" placeholder="ä¾‹ï¼šä¸‹ç—¢æ­¢ã‚ã‚»ãƒƒãƒˆ">
                        <button id="saveTpl" style="flex:1">ä¿å­˜</button>
                    </div>
                    <label style="margin-top:10px">ä¿å­˜æ¸ˆã¿</label>
                    <div class="row">
                        <select id="tplSelect" style="flex:2"></select>
                        <button id="loadTpl" class="secondary" style="flex:1">èª­è¾¼</button>
                    </div>
                    <hr style="margin:15px 0; border:0; border-top:1px solid #eee">
                    <input type="file" id="csvInput" accept=".csv" style="display:none">
                    <button onclick="document.getElementById('csvInput').click()" class="ghost">ğŸ“ è–¬å‰¤CSVã‚’èª­ã¿è¾¼ã‚€</button>
                    <div id="csvStatus" class="status">è–¬å‰¤ãƒ‡ãƒ¼ã‚¿: 0ä»¶</div>
                </div>
            </details>
        </div>
    </div>

    <div class="panel-right">
        <div class="card">
            <div class="row">
                <button id="copySimple" class="secondary">ğŸ“‹ ç°¡æ˜“ç‰ˆã‚’ã‚³ãƒ”ãƒ¼</button>
                <button id="copyDetail" class="secondary">ğŸ“Š è©³ç´°ç‰ˆã‚’ã‚³ãƒ”ãƒ¼</button>
            </div>
        </div>
        <div class="card">
            <label>ğŸ“‹ ã‚«ãƒ«ãƒ†è²¼ä»˜ç”¨ (ç°¡æ˜“ç‰ˆ)</label>
            <pre id="outputSimple" class="readonly">æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</pre>
        </div>
        <div class="card">
            <label>ğŸ§® è¨ˆç®—æ ¹æ‹  (è©³ç´°ç‰ˆ)</label>
            <pre id="outputDetail" class="readonly">æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</pre>
        </div>
    </div>
</div>

<script>
/* ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
const byId = id => document.getElementById(id);
const toNumber = v => parseFloat(String(v).replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 65248)).replace(/[^0-9.]/g, '')) || 0;
const ceil10 = v => Math.ceil(v / 10) * 10;
const markupFor = p => p <= 10 ? 3 : p <= 50 ? 2 : p <= 100 ? 1.8 : p <= 500 ? 1.5 : 1.2;

/* ====== ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç®¡ç† ====== */
let DRUG_MASTER = JSON.parse(localStorage.getItem("drugMasterV5") || "[]");
let TEMPLATES = JSON.parse(localStorage.getItem("rxTemplatesV5") || "[]");

/* ====== 1/4éŒ å¯¾å¿œãƒ­ã‚¸ãƒƒã‚¯ ====== */
function optimizeTablets(targetMgPerDose, unitMg, totalDoses) {
    if (unitMg <= 0) return { billed: 0, achievedMg: 0, usageText: "0t", fraction: 0 };
    
    // 1å›ã‚ãŸã‚Šã®å¿…è¦ã‚¯ã‚©ãƒ¼ã‚¿ãƒ¼æ•° (1/4éŒ ãŒã„ãã¤åˆ†ã‹)
    const quarters = Math.ceil(targetMgPerDose / (unitMg / 4));
    const usagePerDose = quarters / 4;
    const totalNeededTablets = usagePerDose * totalDoses;
    const billed = Math.ceil(totalNeededTablets);
    
    const whole = Math.floor(usagePerDose);
    const frac = usagePerDose - whole;
    let fracText = "";
    if (frac === 0.25) fracText = "1/4";
    if (frac === 0.5) fracText = "1/2";
    if (frac === 0.75) fracText = "3/4";
    
    const usageText = (whole > 0 ? whole : "") + (fracText ? (whole > 0 ? "ã¨" : "") + fracText : "") + (usagePerDose === 0 ? "0" : "") + "éŒ ";
    
    return {
        billed,
        usagePerDose,
        usageText,
        fraction: frac,
        totalActualMg: usagePerDose * unitMg * totalDoses
    };
}

/* ====== ãƒ¡ã‚¤ãƒ³è¨ˆç®— ====== */
function calcAll() {
    const weight = toNumber(byId("weight").value);
    const days = parseInt(byId("days").value) || 0;
    const tpd = parseInt(byId("timesPerDay").value) || 0;
    const totalDoses = days * tpd;
    const isPowder = byId("globalForm").value === "POWDER";
    const useBunpo = byId("bunpo").checked;

    if (weight <= 0 || days <= 0) {
        return { simple: "ä½“é‡ã¨æ—¥æ•°ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„", detail: "è¨ˆç®—å¾…æ©Ÿä¸­..." };
    }

    let subtotal = 0, splitFee = 0, packFee = 0, scriptFee = 500;
    let detail = "", simpleLines = [];

    const rows = document.querySelectorAll(".drug-row");
    rows.forEach(row => {
        const name = row.querySelector(".drugName").value;
        const unit = toNumber(row.querySelector(".unitMg").value);
        const cost = toNumber(row.querySelector(".cost").value);
        const dose = toNumber(row.querySelector(".dose").value);

        if (!name || unit <= 0 || dose <= 0) return;

        const mgPerDose = weight * dose;
        const pricePer = ceil10(cost * markupFor(cost));
        
        if (!isPowder) {
            // éŒ å‰¤ãƒ¢ãƒ¼ãƒ‰
            const opt = optimizeTablets(mgPerDose, unit, totalDoses);
            const drugCost = Math.ceil(pricePer * opt.billed);
            subtotal += drugCost;
            
            if (opt.fraction === 0.5) splitFee += 10 * totalDoses;
            else if (opt.fraction > 0) splitFee += 20 * totalDoses;

            detail += `ã€éŒ å‰¤ã€‘${name} (${unit}mg/éŒ )\n`;
            detail += `  1å›é‡: ${opt.usageText} (ç›®æ¨™:${mgPerDose.toFixed(2)}mg)\n`;
            detail += `  åˆè¨ˆ: ${opt.billed}éŒ åˆ† / è–¬å‰¤æ–™: ${drugCost}å††\n`;
            detail += `  â˜…å®Ÿç”¨é‡: ${(opt.totalActualMg / totalDoses / weight).toFixed(2)}mg/kg\n\n`;
            simpleLines.push(`${name} ${opt.usageText} Ã—${totalDoses}å›`);
        } else {
            // æ•£å‰¤ï¼ˆç²‰ç •ï¼‰ãƒ¢ãƒ¼ãƒ‰
            const totalMgNeeded = mgPerDose * totalDoses;
            const billed = Math.ceil(totalMgNeeded / unit);
            const drugCost = Math.ceil(pricePer * billed);
            subtotal += drugCost;

            detail += `ã€ç²‰ç •ã€‘${name} (${unit}mg/éŒ )\n`;
            detail += `  ç·å¿…è¦é‡: ${totalMgNeeded.toFixed(2)}mg â†’ ${billed}éŒ åˆ†ã‚’ç²‰ç •\n`;
            detail += `  è–¬å‰¤æ–™: ${drugCost}å††\n`;
            detail += `  â˜…å®Ÿç”¨é‡: ${(billed * unit / totalDoses / weight).toFixed(2)}mg/kg\n\n`;
            simpleLines.push(`${name}(ç²‰ç •) ${billed}tåˆ†`);
        }
    });

    if (useBunpo) packFee = 20 * totalDoses;
    const total = subtotal + splitFee + packFee + scriptFee;

    const resDetail = detail + `------------------------------\nè–¬å‰¤æ–™ï¼š${subtotal}å††\nåˆ†å‰²æ‰‹æ•°æ–™ï¼š${splitFee}å††\nåˆ†åŒ…æ–™ï¼š${packFee}å††\nå‡¦æ–¹æ–™ï¼š${scriptFee}å††\n==============================\nåˆè¨ˆï¼š${total}å††ï¼ˆç¨è¾¼ï¼‰`;
    const resSimple = simpleLines.join("ã€") + `\n${days}æ—¥åˆ† ${tpd===1?'SID':tpd===2?'BID':'TID'} åˆ†åŒ…\nåˆè¨ˆï¼š${total}å††`;

    return { simple: resSimple, detail: resDetail };
}

function updateUI() {
    const res = calcAll();
    byId("outputSimple").textContent = res.simple;
    byId("outputDetail").textContent = res.detail;
}

/* ====== è¡Œç®¡ç† ====== */
function addRow(data = {}) {
    const container = byId("tabletList");
    const div = document.createElement("div");
    div.className = "drug-row";
    div.innerHTML = `
        <div class="row">
            <div class="col" style="position:relative">
                <label>è–¬å‰¤å</label><input class="drugName" value="${data.name||''}">
                <div class="suggest"></div>
            </div>
            <div class="col"><label>å«æœ‰é‡(mg/éŒ )</label><input type="number" step="0.01" class="unitMg" value="${data.unit||''}"></div>
            <div class="col"><label>å˜ä¾¡(å††)</label><input type="number" step="0.01" class="cost" value="${data.cost||''}"></div>
            <div class="col"><label>ç”¨é‡(mg/kg)</label><input type="number" step="0.01" class="dose" value="${data.dose||''}"></div>
            <div class="col" style="min-width:50px; flex:0"><label>&nbsp;</label><button class="danger" onclick="this.closest('.drug-row').remove();updateUI();">Ã—</button></div>
        </div>
    `;
    container.appendChild(div);
    const input = div.querySelector(".drugName");
    input.addEventListener("input", e => showSuggest(e.target));
    div.querySelectorAll("input").forEach(i => i.addEventListener("input", updateUI));
}

/* ====== ã‚µã‚¸ã‚§ã‚¹ãƒˆæ©Ÿèƒ½ ====== */
function showSuggest(el) {
    const q = el.value.toLowerCase();
    const box = el.nextElementSibling;
    if (!q) { box.style.display="none"; return; }
    const matches = DRUG_MASTER.filter(d => d.name.toLowerCase().includes(q)).slice(0, 10);
    if (matches.length === 0) { box.style.display="none"; return; }
    box.innerHTML = matches.map(m => `<div class="suggest-item" data-unit="${m.unit}" data-cost="${m.cost}">${m.name}</div>`).join("");
    box.style.display = "block";
    box.querySelectorAll(".suggest-item").forEach(item => {
        item.onclick = () => {
            el.value = item.textContent;
            const row = el.closest(".drug-row");
            row.querySelector(".unitMg").value = item.dataset.unit;
            row.querySelector(".cost").value = item.dataset.cost;
            box.style.display = "none";
            updateUI();
        };
    });
}

/* ====== CSVå‡¦ç† ====== */
byId("csvInput").onchange = e => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = () => {
        const lines = reader.result.split("\n").slice(1);
        DRUG_MASTER = lines.map(l => {
            const [name, type, cost, unit] = l.split(",");
            return { name, cost: toNumber(cost), unit: toNumber(unit) };
        }).filter(d => d.name);
        localStorage.setItem("drugMasterV5", JSON.stringify(DRUG_MASTER));
        byId("csvStatus").textContent = `è–¬å‰¤ãƒ‡ãƒ¼ã‚¿: ${DRUG_MASTER.length}ä»¶`;
        alert("èª­ã¿è¾¼ã¿å®Œäº†");
    };
    reader.readAsText(file);
};

/* ====== åˆæœŸåŒ– ====== */
window.onload = () => {
    addRow();
    byId("csvStatus").textContent = `è–¬å‰¤ãƒ‡ãƒ¼ã‚¿: ${DRUG_MASTER.length}ä»¶`;
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠæ›´æ–°
    const refreshTpl = () => {
        byId("tplSelect").innerHTML = TEMPLATES.map((t,i) => `<option value="${i}">${t.tplName}</option>`).join("");
    };
    refreshTpl();

    byId("saveTpl").onclick = () => {
        const tplName = byId("tplName").value;
        if(!tplName) return alert("åå‰ã‚’å…¥åŠ›");
        const items = Array.from(document.querySelectorAll(".drug-row")).map(row => ({
            name: row.querySelector(".drugName").value,
            unit: row.querySelector(".unitMg").value,
            cost: row.querySelector(".cost").value,
            dose: row.querySelector(".dose").value
        }));
        TEMPLATES.push({ tplName, items });
        localStorage.setItem("rxTemplatesV5", JSON.stringify(TEMPLATES));
        refreshTpl();
        alert("ä¿å­˜ã—ã¾ã—ãŸ");
    };

    byId("loadTpl").onclick = () => {
        const tpl = TEMPLATES[byId("tplSelect").value];
        if(!tpl) return;
        byId("tabletList").innerHTML = "";
        tpl.items.forEach(addRow);
        updateUI();
    };

    byId("addDrug").onclick = () => addRow();
    ["weight", "days", "timesPerDay", "globalForm", "bunpo"].forEach(id => byId(id).onchange = updateUI);
    
    byId("copySimple").onclick = () => { navigator.clipboard.writeText(byId("outputSimple").textContent); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); };
    byId("copyDetail").onclick = () => { navigator.clipboard.writeText(byId("outputDetail").textContent); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); };
};
</script>
</body>
</html>
