<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>è–¬å‰¤è²»ç”¨è¨ˆç®— v6.8.1 - Phase 1.5 å®Œæˆç‰ˆ</title>
    <style>
        :root {
            --primary: #0a84ff;
            --danger: #d70015;
            --warning: #ff9500;
            --success: #34c759;
            --bg: #f5f5f7;
            --card: #ffffff;
            --border: #e5e5ea;
            --text: #333333;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg) 0%, #ffffff 100%);
            margin: 0;
            padding: 0;
            color: var(--text);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: var(--card);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 32px;
            color: var(--primary);
        }

        .header .version {
            font-size: 13px;
            color: var(--success);
            margin-top: 8px;
            font-weight: 600;
        }

        .features-badge {
            display: inline-block;
            background: #e7f5ff;
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            margin-top: 10px;
            font-weight: 600;
        }

        .layout {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1024px) {
            .layout {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .card h2 {
            margin-top: 0;
            margin-bottom: 18px;
            font-size: 18px;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.1);
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
            margin-top: 10px;
            font-size: 15px;
        }

        .btn-primary:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(10, 132, 255, 0.3);
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
            background: var(--danger);
            color: white;
        }

        .btn-small:hover {
            opacity: 0.9;
        }

        .btn-add {
            padding: 12px;
            background: var(--bg);
            color: var(--primary);
            font-weight: 600;
            border: 2px dashed var(--primary);
            margin-top: 10px;
            width: 100%;
        }

        .btn-add:hover {
            background: var(--primary);
            color: white;
        }

        .btn-export {
            padding: 10px 15px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            margin: 5px 5px 5px 0;
        }

        .btn-export:hover {
            opacity: 0.9;
        }

        .alert {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
            line-height: 1.6;
        }

        .alert-danger {
            background: #fee;
            border-left: 4px solid var(--danger);
            color: #c41e3a;
        }

        .alert-warning {
            background: #fef3cd;
            border-left: 4px solid var(--warning);
            color: #856404;
        }

        .alert-success {
            background: #d4edda;
            border-left: 4px solid var(--success);
            color: #155724;
        }

        .alert-info {
            background: #cfe2ff;
            border-left: 4px solid var(--primary);
            color: #084298;
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 13px;
        }

        .result-table th {
            background: var(--bg);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border);
        }

        .result-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        .result-table tr:hover {
            background: #fafafa;
        }

        .total-cost {
            background: linear-gradient(135deg, var(--primary), #0070ff);
            color: white;
            font-size: 22px;
            font-weight: bold;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 15px 0;
        }

        .drug-input-row {
            background: var(--bg);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary);
        }

        .drug-input-row .inputs {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 8px;
            align-items: end;
        }

        @media (max-width: 800px) {
            .drug-input-row .inputs {
                grid-template-columns: 1fr;
            }
        }

        .pill {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 5px;
        }

        .pills-danger {
            background: var(--danger);
        }

        .pills-warning {
            background: var(--warning);
        }

        .pills-success {
            background: var(--success);
        }

        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            background: var(--bg);
            transition: all 0.3s;
        }

        .drop-zone:hover {
            border-color: var(--primary);
            background: #f0f8ff;
        }

        .drop-zone.dragover {
            border-color: var(--primary);
            background: #e7f5ff;
        }

        .history-item {
            background: var(--bg);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 4px solid var(--primary);
            font-size: 12px;
        }

        .hidden {
            display: none;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .tab-btn {
            padding: 10px 15px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #999;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .csv-status {
            padding: 10px;
            background: #d4edda;
            color: #155724;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 4px solid var(--success);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¥ è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ </h1>
            <div class="version">v6.8.1 - Phase 1.5 å®Œæˆç‰ˆ (ä¿®æ­£ç‰ˆ)</div>
            <div class="features-badge">
                âœ… CSVèª­ã¿è¾¼ã¿ | ğŸ“Š è¨ˆç®—æ ¹æ‹ è¡¨ç¤º | ğŸ’¾ å±¥æ­´ä¿å­˜ | ğŸ“¥ çµæœã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            </div>
        </div>

        <div id="globalAlerts"></div>

        <div class="layout">
            <!-- å·¦ã‚«ãƒ©ãƒ : å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div>
                <div class="card">
                    <h2>ğŸ“‹ åŸºæœ¬è¨­å®š</h2>
                    
                    <div class="form-group">
                        <label>ä½“é‡ (kg) *</label>
                        <input type="number" id="weight" placeholder="5.0" step="0.1" min="0.1" max="500" value="5.0">
                    </div>

                    <div class="form-group">
                        <label>æŠ•ä¸æ—¥æ•° (æ—¥) *</label>
                        <input type="number" id="days" placeholder="7" min="1" max="365" value="7">
                    </div>

                    <div class="form-group">
                        <label>1æ—¥æŠ•ä¸å›æ•°</label>
                        <select id="frequency">
                            <option value="1">1å›/æ—¥ (SID)</option>
                            <option value="2" selected>2å›/æ—¥ (BID)</option>
                            <option value="3">3å›/æ—¥ (TID)</option>
                            <option value="4">4å›/æ—¥ (QID)</option>
                        </select>
                    </div>

                    <hr>

                    <h3 style="margin-top: 20px; margin-bottom: 15px;">ğŸ’Š è–¬å‰¤ç®¡ç†</h3>
                    
                    <div id="csvStatus"></div>
                    
                    <div id="drugsList"></div>
                    
                    <button class="btn-add" onclick="addDrugRow()">+ è–¬å‰¤ã‚’è¿½åŠ </button>
                    <button class="btn-primary" onclick="calculateAll()">ğŸ“Š è¨ˆç®—å®Ÿè¡Œ</button>

                    <hr style="margin: 20px 0;">

                    <h3 style="margin-bottom: 15px;">ğŸ“ CSVãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
                    <div class="form-group">
                        <label>è–¬å‰¤CSVã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
                        <div class="drop-zone" id="dropZone" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="document.getElementById('csvFile').click();">
                            ğŸ“ CSVã‚’ãƒ‰ãƒ­ãƒƒãƒ— or ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                        </div>
                        <input type="file" id="csvFile" accept=".csv" style="display:none;" onchange="handleFileSelect(event)">
                    </div>
                    <small style="color: #666; display: block;">å½¢å¼: è–¬å‰¤å, å‰¤å‹, å˜ä¾¡, å«æœ‰é‡(mg/éŒ )</small>
                </div>
            </div>

            <!-- å³ã‚«ãƒ©ãƒ : çµæœè¡¨ç¤º -->
            <div>
                <div class="card">
                    <div class="tabs">
                        <button class="tab-btn active" onclick="switchTab('results')">ğŸ“ˆ è¨ˆç®—çµæœ</button>
                        <button class="tab-btn" onclick="switchTab('safety')">ğŸ” å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯</button>
                        <button class="tab-btn" onclick="switchTab('history')">â±ï¸ å±¥æ­´</button>
                    </div>

                    <div id="results" class="tab-content active">
                        <h2>è¨ˆç®—çµæœ</h2>
                        <div id="resultArea">
                            <p style="color: #999; text-align: center;">è¨ˆç®—çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                        </div>
                    </div>

                    <div id="safety" class="tab-content">
                        <h2>å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯</h2>
                        <div id="safetyAlerts">
                            <p style="color: #999;">å…¥åŠ›å€¤ã«åŸºã¥ã„ãŸè­¦å‘ŠãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                        </div>
                    </div>

                    <div id="history" class="tab-content">
                        <h2>è¨ˆç®—å±¥æ­´</h2>
                        <div id="historyArea">
                            <p style="color: #999;">è¨ˆç®—å±¥æ­´ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- datalistï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã«1ã¤ã ã‘ï¼‰ -->
    <datalist id="drugList"></datalist>

    <script>
        // =========================================
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        // =========================================
        let DRUG_MASTER = {};
        let CALCULATION_HISTORY = [];

        // =========================================
        // CSVè§£æé–¢æ•°ï¼ˆä¿®æ­£ç‰ˆï¼‰
        // =========================================
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\\n');
            if (lines.length < 2) {
                throw new Error('CSVãŒç©ºã¾ãŸã¯ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
            }

            const drugData = {};
            
            // æœ€åˆã®è¡Œã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã—ã¦èªè­˜
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const parts = line.split(',').map(p => p.trim());
                
                if (parts.length < 3) continue;

                const drugName = parts[0];
                const formulation = parts[1] || 'æœªè¨˜è¼‰';
                const unitPrice = parseFloat(parts[2]);
                const dose = parseFloat(parts[3]) || 0;

                if (drugName && !isNaN(unitPrice) && unitPrice > 0) {
                    drugData[drugName] = {
                        name: drugName,
                        formulation: formulation,
                        unitPrice: unitPrice,
                        dose: dose
                    };
                }
            }

            if (Object.keys(drugData).length === 0) {
                throw new Error('æœ‰åŠ¹ãªè–¬å‰¤ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            return drugData;
        }

        // =========================================
        // CSVèª­ã¿è¾¼ã¿å‡¦ç†ï¼ˆä¿®æ­£ç‰ˆï¼‰
        // =========================================
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    DRUG_MASTER = parseCSV(e.target.result);
                    
                    // datalistã‚’æ›´æ–°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ãªã‚‚ã®ã‚’ä½¿ç”¨ï¼‰
                    const datalist = document.getElementById('drugList');
                    datalist.innerHTML = '';
                    Object.keys(DRUG_MASTER).forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        datalist.appendChild(option);
                    });

                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    const statusDiv = document.getElementById('csvStatus');
                    statusDiv.innerHTML = `<div class="csv-status">âœ… CSVãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ (${Object.keys(DRUG_MASTER).length}ç¨®ã®è–¬å‰¤)</div>`;
                    
                    showAlert(`âœ… CSVãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ (${Object.keys(DRUG_MASTER).length}ç¨®ã®è–¬å‰¤)`, 'success');
                    console.log('CSV Loaded:', DRUG_MASTER);
                } catch (error) {
                    showAlert(`âŒ CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'danger');
                    console.error('CSV Parse Error:', error);
                }
            };
            reader.onerror = function() {
                showAlert('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
            };
            reader.readAsText(file, 'UTF-8');
        }

        // =========================================
        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
        // =========================================
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                // FileListã‚’Arrayã«å¤‰æ›ã—ã¦inputã«è¨­å®š
                const input = document.getElementById('csvFile');
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(files[0]);
                input.files = dataTransfer.files;
                
                // handleFileSelectã‚’å‘¼ã³å‡ºã—
                const event = { target: input };
                handleFileSelect(event);
            }
        }

        // =========================================
        // è–¬å‰¤è¡Œã®è¿½åŠ ãƒ»å‰Šé™¤
        // =========================================
        function addDrugRow() {
            const drugsList = document.getElementById('drugsList');
            const rowId = `drug_${Date.now()}`;
            
            const row = document.createElement('div');
            row.className = 'drug-input-row';
            row.id = rowId;
            row.innerHTML = `
                <div class="inputs">
                    <input type="text" placeholder="è–¬å‰¤å" list="drugList" class="drugName" autocomplete="off">
                    <input type="number" placeholder="ç”¨é‡" step="0.1" class="drugDose" min="0" value="1">
                    <input type="number" placeholder="ä¾¡æ ¼" step="1" class="drugPrice" min="0" value="100">
                    <input type="text" placeholder="mg/kg" class="drugUnit" value="mg/kg" disabled>
                    <button class="btn-small" onclick="removeDrugRow('${rowId}')">âœ•</button>
                </div>
            `;

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            row.querySelector('.drugName').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') calculateAll();
            });
            row.querySelector('.drugDose').addEventListener('change', calculateAll);
            row.querySelector('.drugPrice').addEventListener('change', calculateAll);

            drugsList.appendChild(row);
        }

        function removeDrugRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
                calculateAll();
            }
        }

        // =========================================
        // å…¥åŠ›å€¤æ¤œè¨¼
        // =========================================
        function validateBasicInputs() {
            const weight = parseFloat(document.getElementById('weight').value);
            const days = parseInt(document.getElementById('days').value);
            const frequency = parseInt(document.getElementById('frequency').value);
            
            const errors = [];
            
            if (!weight || isNaN(weight) || weight <= 0 || weight > 500) {
                errors.push("âŒ ä½“é‡ã¯0ï½500kg ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
            }
            
            if (!days || isNaN(days) || days <= 0 || days > 365) {
                errors.push("âŒ æŠ•ä¸æ—¥æ•°ã¯1ï½365æ—¥ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
            }
            
            if (!frequency || isNaN(frequency) || frequency <= 0 || frequency > 10) {
                errors.push("âŒ 1æ—¥æŠ•ä¸å›æ•°ã¯1ï½10å›ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
            }
            
            if (errors.length > 0) {
                showAlert(errors.join('<br>'), 'danger');
                return null;
            }
            
            return { weight, days, frequency };
        }

        // =========================================
        // å…¨ä½“è¨ˆç®—å®Ÿè¡Œ
        // =========================================
        function calculateAll() {
            const validated = validateBasicInputs();
            if (!validated) return;

            const { weight, days, frequency } = validated;
            const resultDiv = document.getElementById('resultArea');
            const safetyDiv = document.getElementById('safetyAlerts');

            let allWarnings = [];
            let allDangers = [];
            let resultHTML = '';
            let totalCost = 0;
            let calculations = [];

            // è–¬å‰¤è¡Œã‚’åé›†
            const drugRows = document.querySelectorAll('.drug-input-row');
            if (drugRows.length === 0) {
                resultDiv.innerHTML = '<div class="alert alert-warning">âš ï¸ è–¬å‰¤ã‚’1ç¨®ä»¥ä¸Šè¿½åŠ ã—ã¦ãã ã•ã„</div>';
                return;
            }

            resultHTML += `
                <table class="result-table">
                    <thead>
                        <tr>
                            <th>è–¬å‰¤å</th>
                            <th>ç”¨é‡</th>
                            <th>1å›é‡</th>
                            <th>1æ—¥é‡</th>
                            <th>ç·é‡</th>
                            <th>è²»ç”¨</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            drugRows.forEach((row) => {
                const drugName = row.querySelector('.drugName').value;
                const dosage = parseFloat(row.querySelector('.drugDose').value);
                const price = parseFloat(row.querySelector('.drugPrice').value);

                if (!drugName || isNaN(dosage) || isNaN(price) || dosage <= 0 || price <= 0) return;

                // è¨ˆç®—
                const singleDose = weight * dosage;
                const dailyAmount = singleDose * frequency;
                const totalAmount = dailyAmount * days;
                const cost = price * dosage * weight * frequency * days;

                totalCost += cost;

                const safetyBadge = '<span class="pill pills-success">è¨ˆç®—å®Œäº†</span>';

                resultHTML += `
                    <tr>
                        <td><strong>${drugName}</strong><br>${safetyBadge}</td>
                        <td>${dosage} mg/kg</td>
                        <td>${singleDose.toFixed(2)} mg</td>
                        <td>${dailyAmount.toFixed(2)} mg</td>
                        <td>${totalAmount.toFixed(2)} mg</td>
                        <td>Â¥${cost.toFixed(0)}</td>
                    </tr>
                `;

                calculations.push({
                    drug: drugName,
                    weight,
                    dosage,
                    price,
                    cost,
                    timestamp: new Date().toLocaleString('ja-JP')
                });
            });

            resultHTML += `
                    </tbody>
                </table>
                <div class="total-cost">ğŸ’° ç·è²»ç”¨: Â¥${totalCost.toFixed(0)}</div>
                <div style="margin-top: 15px;">
                    <button class="btn-export" onclick="exportCSV()">ğŸ“¥ CSVã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    <button class="btn-export" onclick="copyToClipboard()">ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</button>
                </div>
            `;

            resultDiv.innerHTML = resultHTML;

            // å®‰å…¨æ€§è­¦å‘Šè¡¨ç¤º
            safetyDiv.innerHTML = '<div class="alert alert-success">âœ… è¨ˆç®—å®Œäº†ã—ã¾ã—ãŸ</div>';

            // å±¥æ­´ã«ä¿å­˜
            CALCULATION_HISTORY.unshift({
                timestamp: new Date(),
                weight,
                days,
                frequency,
                totalCost,
                drugs: calculations.length
            });
            if (CALCULATION_HISTORY.length > 10) CALCULATION_HISTORY.pop();
            updateHistory();

            // LocalStorageã«ä¿å­˜
            localStorage.setItem('vet_calc_history', JSON.stringify(CALCULATION_HISTORY));
        }

        // =========================================
        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        // =========================================
        function exportCSV() {
            const table = document.querySelector('.result-table');
            if (!table) {
                alert('è¨ˆç®—çµæœãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            let csv = 'data:text/csv;charset=utf-8,';
            csv += 'è–¬å‰¤è²»ç”¨è¨ˆç®—çµæœ\\n';
            csv += `è¨ˆç®—æ—¥æ™‚,${new Date().toLocaleString('ja-JP')}\\n`;
            csv += `ä½“é‡,${document.getElementById('weight').value}kg\\n`;
            csv += `æŠ•ä¸æ—¥æ•°,${document.getElementById('days').value}æ—¥\\n\\n`;

            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('th, td');
                const rowData = Array.from(cells).map(cell => `"${cell.textContent.trim()}"`).join(',');
                csv += rowData + '\\n';
            });

            const encodedUri = encodeURI(csv);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `è–¬å‰¤è¨ˆç®—_${new Date().getTime()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function copyToClipboard() {
            const table = document.querySelector('.result-table');
            if (!table) {
                alert('è¨ˆç®—çµæœãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            let text = 'è–¬å‰¤è²»ç”¨è¨ˆç®—çµæœ\\n';
            text += `ä½“é‡: ${document.getElementById('weight').value}kg\\n`;
            text += `æŠ•ä¸æ—¥æ•°: ${document.getElementById('days').value}æ—¥\\n\\n`;

            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('th, td');
                text += Array.from(cells).map(cell => cell.textContent.trim()).join('\\t') + '\\n';
            });

            navigator.clipboard.writeText(text).then(() => {
                showAlert('âœ… çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
            });
        }

        // =========================================
        // å±¥æ­´æ©Ÿèƒ½
        // =========================================
        function updateHistory() {
            const historyArea = document.getElementById('historyArea');
            if (CALCULATION_HISTORY.length === 0) {
                historyArea.innerHTML = '<p style="color: #999;">è¨ˆç®—å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            let html = '';
            CALCULATION_HISTORY.forEach((calc, index) => {
                const date = calc.timestamp instanceof Date ? calc.timestamp : new Date(calc.timestamp);
                html += `
                    <div class="history-item">
                        <div><strong>${index + 1}. ${date.toLocaleString('ja-JP')}</strong></div>
                        <div style="font-size: 11px; color: #666;">
                            ä½“é‡: ${calc.weight}kg | æ—¥æ•°: ${calc.days}æ—¥ | è–¬å‰¤: ${calc.drugs}ç¨®
                        </div>
                        <div style="font-size: 12px; color: var(--primary); font-weight: 600;">
                            ç·è²»ç”¨: Â¥${calc.totalCost.toFixed(0)}
                        </div>
                    </div>
                `;
            });

            historyArea.innerHTML = html;
        }

        // =========================================
        // UIè£œåŠ©é–¢æ•°
        // =========================================
        function showAlert(message, type) {
            const alertsDiv = document.getElementById('globalAlerts');
            const alertClass = `alert alert-${type}`;
            alertsDiv.innerHTML = `<div class="${alertClass}">${message}</div>`;
            setTimeout(() => {
                alertsDiv.innerHTML = '';
            }, 5000);
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
        }

        // =========================================
        // åˆæœŸåŒ–
        // =========================================
        window.addEventListener('load', () => {
            addDrugRow();
            
            const saved = localStorage.getItem('vet_calc_history');
            if (saved) {
                CALCULATION_HISTORY = JSON.parse(saved);
                updateHistory();
            }

            console.log('%cğŸ¥ vet-med-calc v6.8.1 - Phase 1.5 å®Œæˆç‰ˆ (ä¿®æ­£ç‰ˆ) ãƒ­ãƒ¼ãƒ‰å®Œäº†', 'color: green; font-size: 16px; font-weight: bold;');
        });

        // è‡ªå‹•è¨ˆç®—
        document.addEventListener('input', (e) => {
            if (e.target.id === 'weight' || e.target.id === 'days' || e.target.id === 'frequency') {
                calculateAll();
            }
        });
    </script>
</body>
</html>
```

---
