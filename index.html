<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v5.5</title>
    <style>
        :root { --primary: #0a84ff; --bg: #f5f5f7; --card: #ffffff; --border: #d2d2d7; }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 16px; color: #1d1d1f; }
        h1 { font-size: 20px; margin-bottom: 16px; color: var(--primary); text-align: center; }
        .layout { display: grid; grid-template-columns: 1fr; gap: 16px; max-width: 1200px; margin: 0 auto; }
        @media (min-width: 900px) { .layout { grid-template-columns: 1fr 1fr; } }
        
        .card { background: var(--card); border-radius: 12px; padding: 16px; border: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.02); height: fit-content; }
        .section-title { font-weight: bold; margin-bottom: 12px; font-size: 14px; color: #86868b; border-bottom: 1px solid #eee; padding-bottom: 4px; }
        
        .row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
        .col { flex: 1; min-width: 80px; }
        label { display: block; font-size: 12px; margin-bottom: 4px; font-weight: 600; }
        input, select, button { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 15px; outline: none; }
        input:focus { border-color: var(--primary); }
        
        /* ãƒœã‚¿ãƒ³é¡ */
        button { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; transition: opacity 0.2s; }
        button:hover { opacity: 0.8; }
        button.secondary { background: #e5e5ea; color: #1d1d1f; border: 1px solid #d2d2d7; }
        button.danger { background: #ff3b30; }

        /* ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ */
        .drop-zone { border: 2px dashed var(--primary); border-radius: 12px; padding: 20px; text-align: center; background: #f0f7ff; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        .drop-zone:hover, .drop-zone.dragover { background: #e1efff; border-style: solid; }
        .drop-zone p { margin: 0; font-size: 13px; color: var(--primary); pointer-events: none; }

        /* è–¬å‰¤è¡Œ */
        .drug-row { background: #f9f9fb; border: 1px solid #e5e5ea; border-radius: 10px; padding: 12px; margin-bottom: 10px; position: relative; }
        .suggest { position: absolute; z-index: 100; background: white; border: 1px solid var(--border); width: 100%; max-height: 150px; overflow-y: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; }
        .suggest-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 13px; }
        .suggest-item:hover { background: #f0f7ff; }

        /* å‡ºåŠ›ã‚¨ãƒªã‚¢ */
        pre.readonly { white-space: pre-wrap; background: #1d1d1f; color: #f5f5f7; padding: 16px; border-radius: 10px; font-size: 13px; font-family: "SFMono-Regular", Consolas, monospace; min-height: 100px; }
        .status-badge { display: inline-block; padding: 2px 8px; background: #34c759; color: white; border-radius: 4px; font-size: 11px; margin-top: 8px; }
    </style>
</head>
<body>

<h1>ğŸ¥ è–¬å‰¤è²»ç”¨è¨ˆç®— v5.5 (1/4éŒ å¯¾å¿œ)</h1>

<div class="layout">
    <div class="panel">
        <div class="card">
            <div class="section-title">åŸºæœ¬è¨­å®š</div>
            <div class="row">
                <div class="col"><label>ä½“é‡ (kg)</label><input type="number" id="weight" step="0.01" value="5.0"></div>
                <div class="col"><label>æ—¥æ•°</label><input type="number" id="days" value="7"></div>
                <div class="col">
                    <label>å›æ•°/æ—¥</label>
                    <select id="timesPerDay">
                        <option value="1">SID (1å›)</option>
                        <option value="2" selected>BID (2å›)</option>
                        <option value="3">TID (3å›)</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <label>å‡¦æ–¹å½¢æ…‹</label>
                    <select id="globalForm">
                        <option value="TAB">éŒ å‰¤ (ãã®ã¾ã¾)</option>
                        <option value="POWDER">æ•£å‰¤ (éŒ å‰¤ã‚’ç²‰ç •)</option>
                    </select>
                </div>
                <div class="col" style="padding-top:20px">
                    <label style="display:inline"><input type="checkbox" id="bunpo" checked style="width:auto"> åˆ†åŒ…æ©Ÿä½¿ç”¨</label>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top:16px">
            <div class="section-title">è–¬å‰¤å…¥åŠ›</div>
            <div id="tabletList"></div>
            <button id="addDrug" class="secondary">ï¼‹ è–¬å‰¤ã‚’è¿½åŠ </button>
        </div>

        <div class="card" style="margin-top:16px">
            <div class="section-title">è–¬å‰¤ãƒ‡ãƒ¼ã‚¿(CSV)ã®èª­ã¿è¾¼ã¿</div>
            <div id="dropZone" class="drop-zone">
                <p>ğŸ“„ ã“ã“ã«CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—<br>ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
                <input type="file" id="csvInput" accept=".csv" style="display:none">
            </div>
            <div id="csvStatus" class="status-badge" style="background:#86868b">è–¬å‰¤ãƒ‡ãƒ¼ã‚¿: æœªèª­ã¿è¾¼ã¿</div>
        </div>
    </div>

    <div class="panel">
        <div class="card">
            <div class="section-title">è¨ˆç®—çµæœ (ç°¡æ˜“ç‰ˆ / ã‚«ãƒ«ãƒ†ç”¨)</div>
            <pre id="outputSimple" class="readonly">æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</pre>
            <button id="copySimple" style="margin-top:8px">ğŸ“‹ ç°¡æ˜“ç‰ˆã‚’ã‚³ãƒ”ãƒ¼</button>
        </div>

        <div class="card" style="margin-top:16px">
            <div class="section-title">æ˜ç´° (è©³ç´°ç‰ˆ)</div>
            <pre id="outputDetail" class="readonly">è¨ˆç®—å¾…æ©Ÿä¸­...</pre>
            <button id="copyDetail" class="secondary" style="margin-top:8px">ğŸ“Š æ˜ç´°ã‚’ã‚³ãƒ”ãƒ¼</button>
        </div>
    </div>
</div>

<script>
/* --- å®šæ•°ãƒ»ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ --- */
const byId = id => document.getElementById(id);
let DRUG_MASTER = JSON.parse(localStorage.getItem("drugMasterV5_5") || "[]");

/* --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ --- */
const toNumber = v => {
    if(!v) return 0;
    const s = String(v).replace(/[ï¼-ï¼™]/g, m => String.fromCharCode(m.charCodeAt(0) - 65248)).replace(/[^0-9.]/g, '');
    return parseFloat(s) || 0;
};
const ceil10 = v => Math.ceil(v / 10) * 10;
const markupFor = p => p <= 10 ? 3 : p <= 50 ? 2 : p <= 100 ? 1.8 : p <= 500 ? 1.5 : 1.2;

/* --- 1/4éŒ è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ --- */
function optimizeTablets(targetMgPerDose, unitMg, totalDoses) {
    if (unitMg <= 0) return { billed: 0, usageText: "0éŒ ", fraction: 0, totalActualMg: 0 };
    
    // 1/4(0.25)éŒ å˜ä½ã§åˆ‡ã‚Šä¸Šã’
    const qCount = Math.ceil(targetMgPerDose / (unitMg / 4));
    const usagePerDose = qCount / 4;
    const billed = Math.ceil(usagePerDose * totalDoses);
    
    const whole = Math.floor(usagePerDose);
    const frac = usagePerDose - whole;
    let fracText = "";
    if (frac === 0.25) fracText = "1/4";
    else if (frac === 0.5) fracText = "1/2";
    else if (frac === 0.75) fracText = "3/4";

    const usageText = (whole > 0 ? whole : "") + (fracText ? (whole > 0 ? "ã¨" : "") + fracText : "") + (usagePerDose === 0 ? "0" : "") + "éŒ ";
    
    return {
        billed,
        usagePerDose,
        usageText,
        fraction: frac,
        totalActualMg: usagePerDose * unitMg * totalDoses
    };
}

/* --- ãƒ¡ã‚¤ãƒ³è¨ˆç®— --- */
function calcAll() {
    const weight = toNumber(byId("weight").value);
    const days = parseInt(byId("days").value) || 0;
    const tpd = parseInt(byId("timesPerDay").value) || 0;
    const totalDoses = days * tpd;
    const isPowder = byId("globalForm").value === "POWDER";
    const useBunpo = byId("bunpo").checked;

    if (weight <= 0 || days <= 0 || totalDoses <= 0) {
        byId("outputSimple").textContent = "ä½“é‡ãƒ»æ—¥æ•°ãƒ»å›æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
        return;
    }

    let subtotal = 0, splitFee = 0, packFee = 0, scriptFee = 500;
    let detail = "", simpleLines = [];

    document.querySelectorAll(".drug-row").forEach(row => {
        const name = row.querySelector(".drugName").value;
        const unit = toNumber(row.querySelector(".unitMg").value);
        const cost = toNumber(row.querySelector(".cost").value);
        const dose = toNumber(row.querySelector(".dose").value);

        if (!name || unit <= 0 || dose <= 0) return;

        const mgPerDose = weight * dose;
        const pricePer = ceil10(cost * markupFor(cost));
        
        if (!isPowder) {
            const opt = optimizeTablets(mgPerDose, unit, totalDoses);
            const drugCost = Math.ceil(pricePer * opt.billed);
            subtotal += drugCost;
            
            // åˆ†å‰²æ‰‹æ•°æ–™è¨ˆç®—
            if (opt.fraction === 0.5) splitFee += 10 * totalDoses;
            else if (opt.fraction > 0) splitFee += 20 * totalDoses;

            detail += `ã€éŒ å‰¤ã€‘${name} (${unit}mg)\n  1å›é‡: ${opt.usageText} (è¨ˆ${opt.billed}éŒ åˆ†)\n  è–¬å‰¤æ–™: ${drugCost}å†† (å˜ä¾¡:${pricePer}å††)\n  â˜…å®Ÿé‡: ${(opt.totalActualMg / totalDoses / weight).toFixed(2)}mg/kg\n\n`;
            simpleLines.push(`${name} ${opt.usageText} Ã—${totalDoses}å›`);
        } else {
            const totalMgNeeded = mgPerDose * totalDoses;
            const billed = Math.ceil(totalMgNeeded / unit);
            const drugCost = Math.ceil(pricePer * billed);
            subtotal += drugCost;
            detail += `ã€ç²‰ç •ã€‘${name} (${unit}mg)\n  ç·é‡: ${totalMgNeeded.toFixed(1)}mg (${billed}éŒ ç²‰ç •)\n  è–¬å‰¤æ–™: ${drugCost}å††\n  â˜…å®Ÿé‡: ${(billed * unit / totalDoses / weight).toFixed(2)}mg/kg\n\n`;
            simpleLines.push(`${name}(ç²‰ç •) ${billed}tåˆ†`);
        }
    });

    if (useBunpo) packFee = 20 * totalDoses;
    const total = subtotal + splitFee + packFee + scriptFee;

    byId("outputSimple").textContent = simpleLines.join("ã€") + `\n${days}æ—¥åˆ† ${tpd===1?'SID':tpd===2?'BID':'TID'} åˆ†åŒ…\nåˆè¨ˆï¼š${total.toLocaleString()}å††`;
    byId("outputDetail").textContent = detail + `------------------------------\nè–¬å‰¤æ–™ï¼š${subtotal}å††\nåˆ†å‰²æ–™ï¼š${splitFee}å††\nåˆ†åŒ…æ–™ï¼š${packFee}å††\nå‡¦æ–¹æ–™ï¼š${scriptFee}å††\n==============================\nåˆè¨ˆï¼š${total.toLocaleString()}å††ï¼ˆç¨è¾¼ï¼‰`;
}

/* --- CSVèª­ã¿è¾¼ã¿å‡¦ç† --- */
function processCSV(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const content = e.target.result;
            const lines = content.split(/\r?\n/).filter(l => l.trim() !== "");
            if (lines.length < 2) return alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã‹ã€å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");

            // ãƒ˜ãƒƒãƒ€ãƒ¼è§£æ
            const header = lines[0].split(",");
            const idxName = header.findIndex(h => h.includes("è–¬å‰¤å"));
            const idxCost = header.findIndex(h => h.includes("å˜ä¾¡"));
            const idxUnit = header.findIndex(h => h.includes("å«æœ‰é‡"));

            const newData = lines.slice(1).map(line => {
                const cols = line.split(",");
                return {
                    name: cols[idxName]?.trim(),
                    cost: toNumber(cols[idxCost]),
                    unit: toNumber(cols[idxUnit])
                };
            }).filter(d => d.name && d.unit > 0);

            if (newData.length > 0) {
                DRUG_MASTER = newData;
                localStorage.setItem("drugMasterV5_5", JSON.stringify(DRUG_MASTER));
                byId("csvStatus").textContent = `è–¬å‰¤ãƒ‡ãƒ¼ã‚¿: ${DRUG_MASTER.length}ä»¶ï¼ˆèª­è¾¼æ¸ˆï¼‰`;
                byId("csvStatus").style.background = "#34c759";
                alert(`${DRUG_MASTER.length}ä»¶ã®è–¬å‰¤ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`);
            }
        } catch (err) {
            console.error(err);
            alert("CSVã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        }
    };
    reader.readAsText(file, "UTF-8");
}

/* --- ã‚µã‚¸ã‚§ã‚¹ãƒˆè¡¨ç¤º --- */
function showSuggest(el) {
    const q = el.value.toLowerCase();
    const box = el.nextElementSibling;
    if (!q) { box.style.display="none"; return; }
    const matches = DRUG_MASTER.filter(d => d.name.toLowerCase().includes(q)).slice(0, 15);
    if (matches.length === 0) { box.style.display="none"; return; }
    
    box.innerHTML = matches.map(m => `<div class="suggest-item" data-unit="${m.unit}" data-cost="${m.cost}">${m.name}</div>`).join("");
    box.style.display = "block";
    box.querySelectorAll(".suggest-item").forEach(item => {
        item.onclick = () => {
            el.value = item.textContent;
            const row = el.closest(".drug-row");
            row.querySelector(".unitMg").value = item.dataset.unit;
            row.querySelector(".cost").value = item.dataset.cost;
            box.style.display = "none";
            calcAll();
        };
    });
}

/* --- è¡Œè¿½åŠ  --- */
function addDrugRow() {
    const div = document.createElement("div");
    div.className = "drug-row";
    div.innerHTML = `
        <div class="row">
            <div class="col" style="position:relative"><label>è–¬å‰¤å</label><input class="drugName" placeholder="åç§°å…¥åŠ›..."><div class="suggest"></div></div>
            <div class="col" style="flex:0.5"><label>å«æœ‰é‡(mg)</label><input type="number" step="0.01" class="unitMg"></div>
            <div class="col" style="flex:0.5"><label>å˜ä¾¡(ä»•å…¥)</label><input type="number" step="0.01" class="cost"></div>
            <div class="col" style="flex:0.5"><label>ç”¨é‡(mg/kg)</label><input type="number" step="0.01" class="dose"></div>
            <div class="col" style="flex:0; min-width:40px"><label>&nbsp;</label><button class="danger" onclick="this.closest('.drug-row').remove();calcAll();">Ã—</button></div>
        </div>`;
    byId("tabletList").appendChild(div);
    div.querySelector(".drugName").oninput = (e) => showSuggest(e.target);
    div.querySelectorAll("input").forEach(i => i.oninput = calcAll);
}

/* --- ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š --- */
window.onload = () => {
    addDrugRow();
    if (DRUG_MASTER.length > 0) {
        byId("csvStatus").textContent = `è–¬å‰¤ãƒ‡ãƒ¼ã‚¿: ${DRUG_MASTER.length}ä»¶ï¼ˆèª­è¾¼æ¸ˆï¼‰`;
        byId("csvStatus").style.background = "#34c759";
    }

    // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®š
    const dz = byId("dropZone");
    const ci = byId("csvInput");
    dz.onclick = () => ci.click();
    dz.ondragover = (e) => { e.preventDefault(); dz.classList.add("dragover"); };
    dz.ondragleave = () => dz.classList.remove("dragover");
    dz.ondrop = (e) => {
        e.preventDefault();
        dz.classList.remove("dragover");
        processCSV(e.dataTransfer.files[0]);
    };
    ci.onchange = (e) => processCSV(e.target.files[0]);

    // ãã®ä»–
    byId("addDrug").onclick = addDrugRow;
    ["weight", "days", "timesPerDay", "globalForm", "bunpo"].forEach(id => byId(id).onchange = calcAll);
    byId("copySimple").onclick = () => { navigator.clipboard.writeText(byId("outputSimple").textContent); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); };
    byId("copyDetail").onclick = () => { navigator.clipboard.writeText(byId("outputDetail").textContent); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); };
};
</script>
</body>
</html>
