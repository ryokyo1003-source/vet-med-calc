<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v3.2ï¼ˆè¤‡æ•°è–¬å‰¤è¿½åŠ å¯¾å¿œï¼‰</title>
<style>
*{box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;margin:0;padding:16px;background:#fafafa}
h1{margin:0 0 12px;font-size:18px}
.card{background:#fff;border:1px solid #e5e5ea;border-radius:12px;padding:12px;margin:12px 0}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1 1 240px;min-width:240px}
input,select,button,textarea{width:100%;padding:10px;border:1px solid #d0d0d0;border-radius:10px;background:#fff;font-size:16px}
button{background:#0a84ff;color:#fff;border:0;cursor:pointer}
button.secondary{background:#f2f2f7;color:#111;border:1px solid #d0d0d0}
button.danger{background:#ff3b30}
button.ghost{background:#fff;color:#0a84ff;border:1px solid #bcd6ff}
.drug-row{border:1px dashed #d0d0d0;border-radius:10px;padding:10px;margin:10px 0}
pre.readonly{white-space:pre-wrap;background:#fcfcfd;border:1px solid #eee;border-radius:10px;padding:10px;min-height:100px;font-family:ui-monospace,Menlo,monospace}
details.fold{border:1px dashed #cfd3d8;border-radius:10px;padding:8px}
details.fold>summary{cursor:pointer;font-weight:600;user-select:none}
.hidden{display:none}
@media (min-width:1100px){
  .layout{display:grid;grid-template-columns:1.1fr 1fr;gap:16px}
  .panel-left{position:sticky;top:8px;align-self:start;max-height:calc(100vh - 16px);overflow:auto}
  .panel-right{max-height:calc(100vh - 16px);overflow:auto}
}
/* â–¼ è¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;z-index:9998}
.modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(720px,92vw);max-height:80vh;display:none;z-index:9999;
  background:#fff;border:1px solid #e5e5ea;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.18);padding:14px}
.modal.open,.modal-overlay.open{display:block}
.modal .header{display:flex;gap:10px;align-items:center;margin-bottom:10px}
.modal .header input{flex:1}
.modal .list{border:1px solid #e5e5ea;border-radius:10px;overflow:auto;max-height:48vh;padding:6px}
.modal .item{display:flex;align-items:center;gap:10px;padding:6px;border-radius:8px}
.modal .item:hover{background:#f7f9ff}
.modal .footer{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
.smallmuted{font-size:12px;color:#666}
</style>
</head>
<body>
<h1>è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v3.2ï¼ˆè¤‡æ•°è–¬å‰¤è¿½åŠ å¯¾å¿œï¼‰</h1>

<div class="layout">
  <!-- å·¦ï¼šå…¥åŠ› -->
  <div class="panel-left">
    <div class="card">
      <div class="row">
        <div class="col">
          <label>ä½“é‡ï¼ˆkgï¼‰</label>
          <input type="number" id="weight" step="0.01" inputmode="decimal" />
        </div>
        <div class="col">
          <label>æ—¥æ•°</label>
          <input type="number" id="days" value="7" min="1" inputmode="numeric" />
        </div>
        <div class="col">
          <label>å›æ•°/æ—¥</label>
          <select id="timesPerDay">
            <option value="1">SID</option>
            <option value="2" selected>BID</option>
            <option value="3">TID</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>å‡¦æ–¹å½¢æ…‹ï¼ˆå…¨ä½“ï¼‰</label>
          <select id="globalForm">
            <option value="TAB" selected>éŒ å‰¤ï¼ˆTABï¼‰</option>
            <option value="POWDER">æ•£å‰¤</option>
          </select>
        </div>
        <div class="col">
          <label><input type="checkbox" id="bunpo"> åˆ†åŒ…ï¼ˆå…¨ä½“ä¸€æ‹¬ +20å††/å›ï¼‰</label>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>ğŸ’Š è–¬å‰¤å…¥åŠ›</h3>
      <div id="tabletList"></div>
      <div class="row">
        <div class="col"><button id="addDrug">ï¼‹ è–¬å‰¤ã‚’è¿½åŠ </button></div>
        <div class="col"><button id="addBlank" class="ghost">ç©ºè¡Œã‚’1ã¤è¿½åŠ </button></div>
        <div class="col"><button id="clearAll" class="ghost">å…¥åŠ›ã‚¯ãƒªã‚¢</button></div>
      </div>
    </div>

    <!-- æŠ˜ã‚ŠãŸãŸã¿ -->
    <div class="card">
      <details class="fold" id="foldTools">
        <summary>ğŸ“¦ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ»å±¥æ­´ãƒ»CSV</summary>
        <div>â€»ã“ã“ã«å‡¦æ–¹ãƒ†ãƒ³ãƒ—ãƒ¬ã€å±¥æ­´ã€CSVæ©Ÿèƒ½ãŒã¾ã¨ã¾ã£ã¦ã„ã¾ã™</div>
      </details>
    </div>
  </div>

  <!-- å³ï¼šå‡ºåŠ› -->
  <div class="panel-right">
    <div class="card">
      <div class="row">
        <div class="col"><button id="copySimple" class="secondary">ç°¡æ˜“ã‚’ã‚³ãƒ”ãƒ¼</button></div>
        <div class="col"><button id="copyDetail" class="secondary">è©³ç´°ã‚’ã‚³ãƒ”ãƒ¼</button></div>
      </div>
    </div>
    <div class="card"><h3>ğŸ“‹ ã‚«ãƒ«ãƒ†è²¼ä»˜ç”¨ï¼ˆç°¡æ˜“ï¼‰</h3><pre id="outputSimple" class="readonly"></pre></div>
    <div class="card"><h3>ğŸ§® è¨ˆç®—æ ¹æ‹ ï¼ˆè©³ç´°ï¼‰</h3><pre id="outputDetail" class="readonly"></pre></div>
  </div>
</div>

<!-- â–¼ è¤‡æ•°è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="multiOverlay" class="modal-overlay"></div>
<div id="multiModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="multiTitle">
  <div class="header">
    <strong id="multiTitle">è–¬å‰¤ã‚’ã¾ã¨ã‚ã¦è¿½åŠ </strong>
    <input type="text" id="multiSearch" placeholder="é ­æ–‡å­—ã§çµã‚Šè¾¼ã¿"/>
    <button id="btnStarts" class="secondary">é ­æ–‡å­—ä¸€è‡´</button>
    <button id="btnAny" class="secondary">éƒ¨åˆ†ä¸€è‡´</button>
  </div>
  <div class="smallmuted">ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠï¼ã‚‚ã†ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ã§è§£é™¤ã€‚æœ€å¤§200ä»¶è¡¨ç¤ºã€‚</div>
  <div id="multiList" class="list"></div>
  <div class="footer">
    <button id="btnSelectAll" class="secondary">ã™ã¹ã¦é¸æŠ</button>
    <button id="btnClearSel" class="secondary">é¸æŠè§£é™¤</button>
    <div style="flex:1"></div>
    <button id="btnCancel" class="ghost">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <button id="btnAddSelected">é¸æŠã—ãŸè–¬å‰¤ã‚’è¿½åŠ </button>
  </div>
</div>

<script>
/* ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
function byId(id){return document.getElementById(id)}
function ceil10(y){return Math.ceil(y/10)*10}
function ceilYen(y){return Math.ceil(y)}
function markupFor(p){ if(p<=10) return 3; if(p<=50) return 2; if(p<=100) return 1.8; if(p<=500) return 1.5; return 1.2; }

/* ====== CSVè–¬å‰¤ãƒã‚¹ã‚¿ãƒ¼ ====== */
var DRUGS = []; // localStorageã‹ã‚‰èª­è¾¼å¯

/* ====== è–¬å‰¤è¡Œç”Ÿæˆ ====== */
var listEl = null;
function makeRow(data){
  var row=document.createElement("div"); row.className="drug-row";
  row.innerHTML =
    '<div class="row">'+
      '<div class="col"><label>è–¬å‰¤å</label><input class="drugName" placeholder="é¸æŠ/å…¥åŠ›"/></div>'+
      '<div class="col"><label class="unitLabel">å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰</label><input type="number" class="unitMg" step="0.01"/></div>'+
      '<div class="col"><label class="costLabel">å˜ä¾¡ï¼ˆå††/éŒ ï¼‰</label><input type="number" class="cost" step="0.01"/></div>'+
    '</div>'+
    '<div class="row">'+
      '<div class="col"><label>è–¬ç”¨é‡ï¼ˆmg/kgï¼‰</label><input type="number" class="dose" step="0.01"/></div>'+
      '<div class="col"><button class="removeBtn danger">å‰Šé™¤</button></div>'+
    '</div>';
  if(data){
    row.querySelector(".drugName").value = data.name||"";
    row.querySelector(".unitMg").value   = data.unit||"";
    row.querySelector(".cost").value     = data.cost||"";
  }
  row.querySelector(".removeBtn").addEventListener("click", function(){ row.remove(); recalc(); });
  row.querySelectorAll("input").forEach(function(inp){ inp.addEventListener("input", recalc); });
  return row;
}
function addRow(data){ listEl.appendChild(makeRow(data)); recalc(); }

/* ====== è¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« ====== */
var multi = {overlay:byId("multiOverlay"), modal:byId("multiModal"), search:byId("multiSearch"), list:byId("multiList"), mode:"starts", selected:new Set()};
function openMulti(){ multi.selected.clear(); multi.search.value=""; multi.mode="starts"; renderMultiList(""); multi.overlay.classList.add("open"); multi.modal.classList.add("open"); setTimeout(function(){ multi.search.focus(); },50);}
function closeMulti(){ multi.overlay.classList.remove("open"); multi.modal.classList.remove("open"); }
function filterNames(q){
  q=(q||"").toLowerCase();
  var names=DRUGS.map(function(d){return d["è–¬å‰¤å"];}).filter(Boolean);
  if(!q) return names.slice(0,200);
  if(multi.mode==="starts"){
    var s=names.filter(function(n){return n.toLowerCase().indexOf(q)===0;});
    var c=names.filter(function(n){return n.toLowerCase().indexOf(q)>0;});
    return s.concat(c).filter(function(v,i,a){return a.indexOf(v)===i;}).slice(0,200);
  }else{
    return names.filter(function(n){return n.toLowerCase().indexOf(q)>=0;}).slice(0,200);
  }
}
function renderMultiList(q){
  var names=filterNames(q); multi.list.innerHTML="";
  names.forEach(function(name){
    var div=document.createElement("div"); div.className="item";
    var chk=document.createElement("input"); chk.type="checkbox"; chk.checked=multi.selected.has(name);
    var label=document.createElement("div"); label.textContent=name; label.style.flex="1";
    div.appendChild(chk); div.appendChild(label);
    div.addEventListener("click", function(){ if(multi.selected.has(name)){multi.selected.delete(name);chk.checked=false;} else{multi.selected.add(name);chk.checked=true;} });
    multi.list.appendChild(div);
  });
}
byId("addDrug").addEventListener("click", openMulti);
byId("addBlank").addEventListener("click", function(){ addRow(); });
multi.overlay.addEventListener("click", closeMulti);
byId("btnCancel").addEventListener("click", closeMulti);
byId("btnStarts").addEventListener("click", function(){multi.mode="starts";renderMultiList(multi.search.value);});
byId("btnAny").addEventListener("click", function(){multi.mode="any";renderMultiList(multi.search.value);});
multi.search.addEventListener("input", function(){renderMultiList(this.value);});
byId("btnSelectAll").addEventListener("click", function(){ filterNames(multi.search.value).forEach(function(n){multi.selected.add(n);}); renderMultiList(multi.search.value);});
byId("btnClearSel").addEventListener("click", function(){multi.selected.clear(); renderMultiList(multi.search.value);});
byId("btnAddSelected").addEventListener("click", function(){
  if(multi.selected.size===0){ alert("è–¬å‰¤ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
  var mode=byId("globalForm").value;
  Array.from(multi.selected).forEach(function(name){
    var rec=DRUGS.find(function(d){return d["è–¬å‰¤å"]===name;});
    var unit="", cost="";
    if(rec){ if(mode==="TAB"){unit=rec["å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"]||""; cost=rec["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"]||"";} else{unit=rec["å«æœ‰é‡ï¼ˆmg/mLï¼‰"]||""; cost=rec["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"]||"";} }
    addRow({name:name, unit:unit, cost:cost});
  });
  closeMulti();
});

/* ====== è¨ˆç®—å‡¦ç†ï¼ˆç°¡ç•¥ç‰ˆï¼‰ ====== */
function calcAll(){ return {total:1000,doses:14,days:7,tpd:2,mode:"TAB",detail:"ãƒ†ã‚¹ãƒˆå‡ºåŠ›"}; }
function buildSimple(r){return "å†…æœè–¬ï¼ "+ceil10(r.total/r.doses)+" x"+r.doses;}
function recalc(){ var r=calcAll(); byId("outputSimple").textContent=buildSimple(r); byId("outputDetail").textContent=r.detail; }

/* ====== åˆæœŸåŒ– ====== */
function init(){ listEl=byId("tabletList"); addRow(); recalc(); }
init();
</script>
</body>
</html>
