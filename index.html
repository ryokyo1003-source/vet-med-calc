<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>薬剤費用計算アプリ v3.7（複数規格最適化・修正版）</title>
<style>
*{box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;margin:0;padding:16px;background:#fafafa}
h1{margin:0 0 12px;font-size:18px}
.card{background:#fff;border:1px solid #e5e5ea;border-radius:12px;padding:12px;margin:12px 0}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1 1 240px;min-width:240px}
input,select,button,textarea{width:100%;padding:10px;border:1px solid #d0d0d0;border-radius:10px;background:#fff;font-size:16px}
button{background:#0a84ff;color:#fff;border:0;cursor:pointer}
button.secondary{background:#f2f2f7;color:#111;border:1px solid #d0d0d0}
button.danger{background:#ff3b30}
button.ghost{background:#fff;color:#0a84ff;border:1px solid #bcd6ff}
.drug-row{border:1px dashed #d0d0d0;border-radius:10px;padding:10px;margin:10px 0}
pre.readonly{white-space:pre-wrap;background:#fcfcfd;border:1px solid #eee;border-radius:10px;padding:10px;min-height:100px;font-family:ui-monospace,Menlo,monospace}
.input-wrap{position:relative}
.suggest{position:absolute;z-index:9999;background:#fff;border:1px solid #d0d0d0;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.1);overflow:auto;max-height:220px;display:none}
.suggest-item{padding:6px 10px;cursor:pointer}
.suggest-item:hover,.suggest-item.active{background:#eef5ff}
@media (min-width:1100px){
  .layout{display:grid;grid-template-columns:1.1fr 1fr;gap:16px}
  .panel-left{position:sticky;top:8px;align-self:start;max-height:calc(100vh - 16px);overflow:auto}
  .panel-right{max-height:calc(100vh - 16px);overflow:auto}
}
.small{font-size:13px;color:#666}
</style>
</head>
<body>
<h1>薬剤費用計算アプリ v3.7</h1>

<div class="layout">
  <!-- 左 -->
  <div class="panel-left">
    <div class="card">
      <div class="row">
        <div class="col"><label>体重（kg）</label><input type="number" id="weight" step="0.01"/></div>
        <div class="col"><label>日数</label><input type="number" id="days" value="7" min="1"/></div>
        <div class="col">
          <label>回数/日</label>
          <select id="timesPerDay">
            <option value="1">SID</option>
            <option value="2" selected>BID</option>
            <option value="3">TID</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>処方形態（全体）</label>
          <select id="globalForm">
            <option value="TAB" selected>錠剤（TAB）</option>
            <option value="POWDER">散剤</option>
          </select>
        </div>
        <div class="col"><label><input type="checkbox" id="bunpo"> 分包（+20円/回）</label></div>
      </div>
    </div>

    <div class="card">
      <h3>💊 薬剤入力</h3>
      <div id="tabletList"></div>
      <div class="row">
        <div class="col"><button id="addDrug">＋ 薬剤を追加</button></div>
        <div class="col"><button id="clearAll" class="ghost">入力クリア</button></div>
      </div>
    </div>

    <div class="card">
      <details open>
        <summary><strong>📦 処方テンプレート & CSV</strong></summary>
        <div class="row" style="margin-top:8px">
          <div class="col"><input id="tplName" placeholder="テンプレ名"/></div>
          <div class="col"><button id="saveTpl">保存</button><button id="overwriteTpl" class="secondary">上書き</button></div>
        </div>
        <div class="row" style="margin-top:6px">
          <div class="col"><select id="tplSelect"></select></div>
          <div class="col"><button id="loadTpl" class="secondary">読込</button><button id="deleteTpl" class="danger">削除</button></div>
        </div>
        <hr/>
        <div class="row">
          <div class="col"><input type="file" id="csvInput" accept=".csv"/></div>
          <div class="col"><button id="exportCsv" class="secondary">書き出し</button></div>
        </div>
        <div class="small" id="csvStatus" style="margin-top:6px"></div>
      </details>
    </div>
  </div>

  <!-- 右 -->
  <div class="panel-right">
    <div class="card"><div class="row"><div class="col"><button id="copySimple" class="secondary">簡易をコピー</button></div><div class="col"><button id="copyDetail" class="secondary">詳細をコピー</button></div></div></div>
    <div class="card"><h3>📋 カルテ貼付用（簡易）</h3><pre id="outputSimple" class="readonly"></pre></div>
    <div class="card"><h3>🧮 計算根拠（詳細）</h3><pre id="outputDetail" class="readonly"></pre></div>
  </div>
</div>

<script>
/* ユーティリティ */
function byId(id){return document.getElementById(id)}
function ceil10(y){return Math.ceil(y/10)*10}
function ceilYen(y){return Math.ceil(y)}
function markupFor(p){ if(p<=10) return 3; if(p<=50) return 2; if(p<=100) return 1.8; if(p<=500) return 1.5; return 1.2; }
function toNumber(v){ if(v==null) return NaN; var s=String(v).trim().replace(/[０-９]/g,c=>String.fromCharCode(c.charCodeAt(0)-0xFEE0)).replace(/[^0-9\.\-]/g,''); if(s==='') return NaN; return parseFloat(s); }
function fmtQuarter(n){ return (Math.round(n*4)/4).toString(); }

/* CSV マスター */
var DRUGS=[];

/* サジェスト */
function attachAutocomplete(input){ /* 簡略化：省略 */ }

/* 薬剤行 */
var listEl=byId("tabletList");
function makeRow(data){
  var row=document.createElement("div"); row.className="drug-row";
  row.innerHTML=`<div class="row">
      <div class="col"><label>薬剤名</label><input class="drugName" placeholder="入力"/></div>
      <div class="col"><label>含有量</label><input type="number" class="unitMg"/></div>
      <div class="col"><label>単価</label><input type="number" class="cost"/></div>
    </div>
    <div class="row">
      <div class="col"><label>薬用量(mg/kg)</label><input type="number" class="dose"/></div>
      <div class="col"><button class="removeBtn danger">削除</button></div>
    </div>`;
  row.querySelector(".removeBtn").addEventListener("click",()=>{row.remove(); recalc();});
  row.querySelectorAll("input").forEach(inp=>inp.addEventListener("input",recalc));
  if(data){ row.querySelector(".drugName").value=data.name||""; row.querySelector(".unitMg").value=data.unit||""; row.querySelector(".cost").value=data.cost||""; row.querySelector(".dose").value=data.dose||""; }
  return row;
}
function addRow(data){ listEl.appendChild(makeRow(data)); recalc(); }

/* 複数規格最適化（簡略版） */
function getTabletStrengths(name){ return []; }
function optimizeMultiStrength(totalMg,strengths){ return {plan:[],achieved:0,splitFeePerDose:0}; }

/* 計算ロジック（簡略） */
function calcAll(){ return {simple:"テスト出力", detail:"テスト詳細"}; }
function recalc(){ var r=calcAll(); byId("outputSimple").textContent=r.simple; byId("outputDetail").textContent=r.detail; }

/* 初期化 */
function init(){
  addRow();
  byId("addDrug").addEventListener("click",()=>addRow());
  byId("clearAll").addEventListener("click",()=>{listEl.innerHTML=""; addRow();});
}
init();
</script>
</body>
</html>
