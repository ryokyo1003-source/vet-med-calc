<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>薬剤費用計算アプリ v3（簡易＋詳細同時表示）</title>
<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;margin:0;padding:16px;background:#fafafa}
h1{font-size:20px;margin-bottom:10px}
.card{background:#fff;border-radius:12px;padding:14px;margin:10px 0;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
textarea{width:100%;min-height:140px;font-size:14px;padding:8px;border-radius:8px;border:1px solid #ccc;margin-top:6px}
button{padding:10px 16px;margin:4px;background:#0a84ff;color:#fff;border:none;border-radius:8px;cursor:pointer}
button.secondary{background:#888}
label{display:block;margin:6px 0 2px}
.row{display:flex;flex-wrap:wrap;gap:10px}
.col{flex:1 1 200px}
</style>
</head>
<body>
<h1>薬剤費用計算アプリ v3</h1>

<div class="card">
  <div class="row">
    <div class="col"><label>体重（kg）</label><input id="weight" type="number" step="0.1"></div>
    <div class="col"><label>日数</label><input id="days" type="number" value="7"></div>
    <div class="col"><label>回数/日</label>
      <select id="timesPerDay"><option value="1">SID</option><option value="2" selected>BID</option><option value="3">TID</option></select>
    </div>
  </div>
</div>

<div class="card">
  <button id="calcBtn">計算する</button>
</div>

<div class="card">
  <h3>📋 カルテ貼付用（簡易）</h3>
  <textarea id="outputSimple" readonly></textarea>
  <button onclick="copyText('outputSimple')">コピー</button>
</div>

<div class="card">
  <h3>🧮 計算根拠（詳細）</h3>
  <textarea id="outputDetail" readonly></textarea>
  <button onclick="copyText('outputDetail')">コピー</button>
</div>

<script>
function ceilYen(v){return Math.ceil(v);} // 1円単位でも切上げ

function copyText(id){
  const ta=document.getElementById(id);
  ta.select();document.execCommand("copy");alert("コピーしました");
}

document.getElementById("calcBtn").addEventListener("click",()=>{
  const w=parseFloat(document.getElementById("weight").value||0);
  const d=parseInt(document.getElementById("days").value||0);
  const tpd=parseInt(document.getElementById("timesPerDay").value||0);
  
  if(!w||!d||!tpd){alert("体重・日数・回数を入力してください");return;}
  
  // ★ここではダミーデータで例示。実際はCSVから薬剤リストを参照して計算する処理に差し替える
  const drugs=[
    {name:"トランサミン",unit:250,dose:10,form:"錠剤",cost:30},
    {name:"メトロニダゾール",unit:250,dose:10,form:"錠剤",cost:20}
  ];
  
  let simpleList=[], detailList=[];
  let total=0;
  
  drugs.forEach(dr=>{
    const mgPerDose=w*dr.dose;
    const totalMg=mgPerDose*tpd*d;
    const count=Math.ceil(totalMg/dr.unit);
    const unitPrice=ceilYen(dr.cost*2); // マークアップ仮
    const drugCost=ceilYen(unitPrice*count);
    total+=drugCost;
    
    if(dr.form==="錠剤"){
      simpleList.push(`${dr.name}${dr.unit}mg ${count}t`);
      detailList.push(`【錠剤】${dr.name}錠 ${dr.unit}mg/錠\n${dr.dose}mg/kg × ${tpd}回 × ${d}日分（体重：${w}kg）\n→ 必要量：${Math.round(totalMg)}mg（${count}錠）\n\n薬剤料：${drugCost}円（${unitPrice}円/錠 × ${count}錠）\n`);
    }
  });
  
  const scriptFee=(80+40*(drugs.length-1))*d;
  total+=scriptFee;
  
  // 簡易出力
  const simple=`内服薬＠${80+40*(drugs.length-1)} x${d}\n${simpleList.join("  ")}\n粉 ${tpd*d}分包 BID ${d}日分`;
  document.getElementById("outputSimple").value=simple;
  
  // 詳細出力
  let detail=detailList.join("\n")+"\n処方料："+scriptFee+"円\n———\n合計："+total+"円";
  document.getElementById("outputDetail").value=detail;
});
</script>
</body>
</html>
