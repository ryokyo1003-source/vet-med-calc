<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v3.4ï¼ˆå®Œæˆç‰ˆï¼‰</title>
<style>
*{box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;margin:0;padding:16px;background:#fafafa}
h1{margin:0 0 12px;font-size:18px}
.card{background:#fff;border:1px solid #e5e5ea;border-radius:12px;padding:12px;margin:12px 0}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1 1 240px;min-width:240px}
input,select,button,textarea{width:100%;padding:10px;border:1px solid #d0d0d0;border-radius:10px;background:#fff;font-size:16px}
button{background:#0a84ff;color:#fff;border:0;cursor:pointer}
button.secondary{background:#f2f2f7;color:#111;border:1px solid #d0d0d0}
button.danger{background:#ff3b30}
button.ghost{background:#fff;color:#0a84ff;border:1px solid #bcd6ff}
.drug-row{border:1px dashed #d0d0d0;border-radius:10px;padding:10px;margin:10px 0}
pre.readonly{white-space:pre-wrap;background:#fcfcfd;border:1px solid #eee;border-radius:10px;padding:10px;min-height:100px;font-family:ui-monospace,Menlo,monospace}
.suggest{position:absolute;z-index:9999;background:#fff;border:1px solid #d0d0d0;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.1);overflow:auto;max-height:200px}
.suggest-item{padding:6px 10px;cursor:pointer}
.suggest-item:hover,.suggest-item.active{background:#eef5ff}
.input-wrap{position:relative}
@media (min-width:1100px){
  .layout{display:grid;grid-template-columns:1.1fr 1fr;gap:16px}
  .panel-left{position:sticky;top:8px;align-self:start;max-height:calc(100vh - 16px);overflow:auto}
  .panel-right{max-height:calc(100vh - 16px);overflow:auto}
}
</style>
</head>
<body>
<h1>è–¬å‰¤è²»ç”¨è¨ˆç®—ã‚¢ãƒ—ãƒª v3.4ï¼ˆå®Œæˆç‰ˆï¼‰</h1>

<div class="layout">
  <!-- å·¦ï¼šå…¥åŠ› -->
  <div class="panel-left">
    <div class="card">
      <div class="row">
        <div class="col">
          <label>ä½“é‡ï¼ˆkgï¼‰</label>
          <input type="number" id="weight" step="0.01"/>
        </div>
        <div class="col">
          <label>æ—¥æ•°</label>
          <input type="number" id="days" value="7" min="1"/>
        </div>
        <div class="col">
          <label>å›æ•°/æ—¥</label>
          <select id="timesPerDay">
            <option value="1">SID</option>
            <option value="2" selected>BID</option>
            <option value="3">TID</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>å‡¦æ–¹å½¢æ…‹ï¼ˆå…¨ä½“ï¼‰</label>
          <select id="globalForm">
            <option value="TAB" selected>éŒ å‰¤ï¼ˆTABï¼‰</option>
            <option value="POWDER">æ•£å‰¤</option>
          </select>
        </div>
        <div class="col">
          <label><input type="checkbox" id="bunpo"> åˆ†åŒ…ï¼ˆå…¨ä½“ä¸€æ‹¬ +20å††/å›ï¼‰</label>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>ğŸ’Š è–¬å‰¤å…¥åŠ›</h3>
      <div id="tabletList"></div>
      <div class="row">
        <div class="col"><button id="addDrug">ï¼‹ è–¬å‰¤ã‚’è¿½åŠ </button></div>
        <div class="col"><button id="clearAll" class="ghost">å…¥åŠ›ã‚¯ãƒªã‚¢</button></div>
      </div>
    </div>
  </div>

  <!-- å³ï¼šå‡ºåŠ› -->
  <div class="panel-right">
    <div class="card">
      <div class="row">
        <div class="col"><button id="copySimple" class="secondary">ç°¡æ˜“ã‚’ã‚³ãƒ”ãƒ¼</button></div>
        <div class="col"><button id="copyDetail" class="secondary">è©³ç´°ã‚’ã‚³ãƒ”ãƒ¼</button></div>
      </div>
    </div>
    <div class="card"><h3>ğŸ“‹ ã‚«ãƒ«ãƒ†è²¼ä»˜ç”¨ï¼ˆç°¡æ˜“ï¼‰</h3><pre id="outputSimple" class="readonly"></pre></div>
    <div class="card"><h3>ğŸ§® è¨ˆç®—æ ¹æ‹ ï¼ˆè©³ç´°ï¼‰</h3><pre id="outputDetail" class="readonly"></pre></div>
  </div>
</div>

<script>
/* ==== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==== */
function byId(id){return document.getElementById(id)}
function ceil10(y){return Math.ceil(y/10)*10}
function ceilYen(y){return Math.ceil(y)}
function markupFor(p){ if(p<=10) return 3; if(p<=50) return 2; if(p<=100) return 1.8; if(p<=500) return 1.5; return 1.2; }

/* ==== CSVãƒã‚¹ã‚¿ãƒ¼ ==== */
var DRUGS=[];

/* ==== ã‚µã‚¸ã‚§ã‚¹ãƒˆæ©Ÿèƒ½ ==== */
function attachAutocomplete(input, unitEl, costEl){
  var box=document.createElement("div"); box.className="suggest hidden"; input.parentNode.appendChild(box);
  var active=-1;
  function close(){ box.classList.add("hidden"); box.innerHTML=""; active=-1; }
  function open(){ box.classList.remove("hidden"); }
  function render(list){
    box.innerHTML="";
    list.forEach(function(name,i){
      var div=document.createElement("div"); div.className="suggest-item"; div.textContent=name;
      div.addEventListener("mousedown", function(e){ e.preventDefault(); select(name); });
      box.appendChild(div);
    });
    if(list.length===0) close(); else open();
  }
  function filter(q){
    q=q.trim().toLowerCase();
    if(!q){ close(); return; }
    var names=DRUGS.map(d=>d["è–¬å‰¤å"]).filter(Boolean);
    var starts=names.filter(n=>n.toLowerCase().indexOf(q)===0);
    var contains=names.filter(n=>n.toLowerCase().indexOf(q)>0);
    var all=starts.concat(contains).filter((v,i,a)=>a.indexOf(v)===i).slice(0,50);
    render(all);
  }
  function select(val){
    input.value=val;
    var rec=DRUGS.find(d=>d["è–¬å‰¤å"]===val);
    if(rec){
      if(byId("globalForm").value==="TAB"){ unitEl.value=rec["å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰"]||""; costEl.value=rec["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"]||""; }
      else{ unitEl.value=rec["å«æœ‰é‡ï¼ˆmg/mLï¼‰"]||""; costEl.value=rec["å˜ä¾¡ï¼ˆä»•å…¥ï¼‰"]||""; }
    }
    close(); recalc();
  }
  input.addEventListener("input", function(){ filter(input.value); });
  input.addEventListener("focus", function(){ if(input.value) filter(input.value); });
  input.addEventListener("blur", function(){ setTimeout(close,100); });
  input.addEventListener("keydown", function(e){
    var items=box.querySelectorAll(".suggest-item");
    if(e.key==="ArrowDown"){ active=(active+1)%items.length; items.forEach((el,i)=>el.classList.toggle("active",i===active)); e.preventDefault();}
    else if(e.key==="ArrowUp"){ active=(active-1+items.length)%items.length; items.forEach((el,i)=>el.classList.toggle("active",i===active)); e.preventDefault();}
    else if(e.key==="Enter"){ if(active>=0&&items[active]){ select(items[active].textContent); e.preventDefault(); }}
    else if(e.key==="Escape"){ close(); }
  });
}

/* ==== è–¬å‰¤è¡Œ ==== */
var listEl;
function makeRow(data){
  var row=document.createElement("div"); row.className="drug-row";
  row.innerHTML=
    '<div class="row">'+
      '<div class="col"><label>è–¬å‰¤å</label><div class="input-wrap"><input class="drugName" placeholder="é¸æŠ/å…¥åŠ›"/></div></div>'+
      '<div class="col"><label class="unitLabel">å«æœ‰é‡ï¼ˆmg/éŒ ï¼‰</label><input type="number" class="unitMg" step="0.01"/></div>'+
      '<div class="col"><label class="costLabel">å˜ä¾¡ï¼ˆå††/éŒ ï¼‰</label><input type="number" class="cost" step="0.01"/></div>'+
    '</div>'+
    '<div class="row">'+
      '<div class="col"><label>è–¬ç”¨é‡ï¼ˆmg/kgï¼‰</label><input type="number" class="dose" step="0.01"/></div>'+
      '<div class="col"><button class="removeBtn danger">å‰Šé™¤</button></div>'+
    '</div>';
  var nameEl=row.querySelector(".drugName");
  var unitEl=row.querySelector(".unitMg");
  var costEl=row.querySelector(".cost");
  attachAutocomplete(nameEl,unitEl,costEl);
  row.querySelector(".removeBtn").addEventListener("click",()=>{row.remove();recalc();});
  row.querySelectorAll("input").forEach(inp=>inp.addEventListener("input",recalc));
  if(data){ nameEl.value=data.name||""; unitEl.value=data.unit||""; costEl.value=data.cost||""; }
  return row;
}
function addRow(data){ listEl.appendChild(makeRow(data)); recalc(); }

/* ==== è²»ç”¨è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ==== */
function optimizeTablets(totalMg, unitMg){
  if(!(unitMg>0)) return {billed:0, achievedMg:0, split:""};
  var q=Math.ceil(totalMg/(unitMg/4)); // 1/4éŒ å˜ä½
  var billed=Math.ceil(q/4);
  var achieved=billed*unitMg;
  var split="";
  if(q%4===2) split="1/2";
  if(q%4===1||q%4===3) split="1/4"; // 1/4ãŒå¿…è¦ãªå ´åˆ
  return {billed:billed, achievedMg:achieved, split:split};
}

function calcAll(){
  var days=parseInt(byId("days").value||"0",10);
  var tpd=parseInt(byId("timesPerDay").value||"0",10);
  var doses=tpd*days;
  var weight=parseFloat(byId("weight").value||"0");
  var mode=byId("globalForm").value;
  var bunpo=byId("bunpo").checked;

  var subtotal=0, items=0, splitFee=0, packFee=0, scriptFee=0;
  var detail="", simpleLines=[];

  var rows=listEl.querySelectorAll(".drug-row");
  rows.forEach((row,idx)=>{
    var name=row.querySelector(".drugName").value.trim();
    var unit=parseFloat(row.querySelector(".unitMg").value||"0");
    var cost=parseFloat(row.querySelector(".cost").value||"0");
    var dose=parseFloat(row.querySelector(".dose").value||"0");
    if(!name||!unit||!cost||!dose||!weight||!days||!tpd) return;
    var mgPerDose=weight*dose;
    var totalMg=mgPerDose*doses;
    var pricePer=ceil10(cost*markupFor(cost));
    if(mode==="TAB"){
      var opt=optimizeTablets(totalMg,unit);
      var drugCost=ceilYen(pricePer*opt.billed);
      subtotal+=drugCost; items++;
      if(opt.split==="1/2") splitFee+=10*doses;
      if(opt.split==="1/4") splitFee+=20*doses;
      detail+=`ã€éŒ å‰¤ã€‘${name} ${unit}mg/éŒ 
${dose}mg/kg Ã— ${tpd}å› Ã— ${days}æ—¥åˆ†ï¼ˆä½“é‡:${weight}kgï¼‰
â†’ å¿…è¦é‡:${Math.round(totalMg)}mgï¼ˆ${opt.billed}éŒ ï¼‰
è–¬å‰¤æ–™:${drugCost}å††ï¼ˆ${pricePer}å††/éŒ  Ã— ${opt.billed}éŒ ï¼‰
\n`;
      simpleLines.push(`${name}${unit}mg ${opt.billed}t`);
    }else{
      var ml=Math.ceil((totalMg/unit)*100)/100;
      var drugCost=ceilYen(pricePer*ml);
      subtotal+=drugCost; items++;
      detail+=`ã€æ•£å‰¤ã€‘${name} ${unit}mg/mL
${dose}mg/kg Ã— ${tpd}å› Ã— ${days}æ—¥åˆ†ï¼ˆä½“é‡:${weight}kgï¼‰
â†’ å¿…è¦é‡:${Math.round(totalMg)}mgï¼ˆç´„${ml}mLï¼‰
è–¬å‰¤æ–™:${drugCost}å††
\n`;
      simpleLines.push(`${name} ${ml}mL`);
    }
  });

  if(bunpo) packFee+=20*doses;
  if(items>0) scriptFee=ceilYen(80*days+40*days*(items-1));
  var total=ceilYen(subtotal+splitFee+packFee+scriptFee);

  var freq=(tpd===1?"SID":tpd===2?"BID":"TID");
  var tail=(mode==="TAB"?`TAB ${doses}ãƒ¶ ${freq} ${days}æ—¥åˆ†`:`ç²‰ ${doses}åŒ… ${freq} ${days}æ—¥åˆ†`);
  var simple=`å†…æœè–¬ï¼ ${ceil10(total/doses)} x${doses}
${simpleLines.join("  ")}
${tail}`;

  detail+=`å‡¦æ–¹æ–™:${scriptFee}å††\n`;
  if(packFee>0) detail+=`åˆ†åŒ…æ–™:${packFee}å††\n`;
  if(splitFee>0) detail+=`åˆ†å‰²æ–™:${splitFee}å††\n`;
  detail+=`â€”â€”â€”\nåˆè¨ˆ:${total}å††`;

  return {simple:simple, detail:detail};
}

/* ==== å‡ºåŠ›æ›´æ–° ==== */
function recalc(){
  var r=calcAll();
  byId("outputSimple").textContent=r.simple;
  byId("outputDetail").textContent=r.detail;
}

/* ==== åˆæœŸåŒ– ==== */
function init(){ listEl=byId("tabletList"); addRow(); }
byId("addDrug").addEventListener("click",()=>addRow());
byId("clearAll").addEventListener("click",()=>{listEl.innerHTML=""; addRow();});
byId("copySimple").addEventListener("click",()=>{navigator.clipboard.writeText(byId("outputSimple").textContent); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");});
byId("copyDetail").addEventListener("click",()=>{navigator.clipboard.writeText(byId("outputDetail").textContent); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");});
init();
</script>
</body>
</html>
